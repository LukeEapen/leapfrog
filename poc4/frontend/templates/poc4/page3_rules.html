<!-- htmlhint doctype-first:false -->
{% extends 'poc4/base.html' %}
{% block content %}
<!-- Banner -->
<div class="bg-danger text-white py-3 mb-4 rounded shadow-sm text-center">
  <h2 class="mb-0">POC4 Data Migration & Reconciliation</h2>
  <small>Modern Data Migration Workflow</small>
</div>

{% include 'poc4/_subnav.j2' %}
{% include 'poc4/_steps.j2' %}

<style>
  /* Two-column rules layout */
  .rules-table th, .rules-table td { vertical-align: middle; }
  .rules-table td input { font-size: .8rem; padding: .25rem .4rem; }
  .rule-row { font-size: .75rem; }
  .rules-wrapper .card-body { max-height: 70vh; overflow: auto; }
  /* Stacked target field + table name */
  .field-stack strong { display:block; font-size:.8rem; line-height:1.15; }
  .field-stack .tbl { display:block; font-size:.55rem; text-transform:uppercase; letter-spacing:.5px; color:#6c757d; line-height:1; margin-top:2px; }
  .rules-table tbody tr:hover .field-stack strong { color:#b71c1c; }
  /* Floating chat (like page2) */
  .chat-float{position:fixed;right:1.25rem;top:6.5rem;z-index:1050;width:340px;box-shadow:0 4px 18px rgba(0,0,0,.15)}
  .chat-float .card-body{height:300px;overflow-y:auto}
  @media (max-width:1200px){ .chat-float{top:8rem;width:300px} }
  @media (max-width:992px){ .chat-float{position:static;width:100%;margin-top:1rem} }
</style>

<form method="post" id="rules-form">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="form-check form-switch small mb-0">
      <input class="form-check-input" type="checkbox" id="toggleQualified" checked>
      <label class="form-check-label" for="toggleQualified">Show table names</label>
    </div>
    <div class="d-flex gap-2">
      <button name="action" value="apply_all" class="btn btn-danger btn-sm" type="submit" title="Apply recommended variant to all rules">Apply All recommended</button>
      <button name="action" value="regenerate" class="btn btn-outline-secondary btn-sm" type="submit" formnovalidate title="Rebuild rules from current mapping">Regenerate Rules</button>
      <button name="action" value="next" class="btn btn-danger btn-sm" id="validate-btn">Validate & Simulate</button>
    </div>
  </div>
  <div class="row g-4 rules-wrapper">
    <div class="col-12">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-light text-danger fw-bold d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <span>Origin ➜ Target Rules</span>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="filter-source">
              <label class="form-check-label" for="filter-source"><span class="badge bg-danger">DATA SOURCE 1</span></label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="filter-legacy">
              <label class="form-check-label" for="filter-legacy"><span class="badge bg-dark">DATA SOURCE 2</span></label>
            </div>
            <button class="btn btn-sm btn-outline-secondary" type="button" id="minimize-source" title="Minimize DS1 rows">Minimize DS1</button>
            <button class="btn btn-sm btn-outline-secondary" type="button" id="minimize-legacy" title="Minimize DS2 rows">Minimize DS2</button>
            {# Dynamic DS3+ chips based on rules origins #}
            {% set ns = namespace(extras=[]) %}
            {% for rule in rules %}
              {% set o = rule.origin %}
              {% if o not in ['source','legacy'] and o not in ns.extras %}
                {% set _ = ns.extras.append(o) %}
              {% endif %}
            {% endfor %}
            {% for o in ns.extras %}
            <div class="form-check form-check-inline align-items-center d-flex gap-1">
              <input class="form-check-input filter-extra" type="checkbox" id="filter-{{ o }}" data-origin="{{ o }}">
              <label class="form-check-label" for="filter-{{ o }}">
                {% if o[:2]|lower == 'ds' %}<span class="badge bg-secondary">DATA SOURCE {{ o[2:]|int }}</span>{% else %}<span class="badge bg-secondary">{{ o|upper }}</span>{% endif %}
              </label>
              <button class="btn btn-xs btn-outline-secondary minimize-extra" type="button" data-origin="{{ o }}" title="Minimize {{ o|upper }} rows">–</button>
            </div>
            {% endfor %}
          </div>
          <div class="d-flex align-items-center gap-2">
            <button name="action" value="apply_all_source" class="btn btn-outline-danger btn-sm" type="submit" title="Apply recommended to all Data Source 1 rules">Apply All (Data Source 1)</button>
            <button name="action" value="apply_all_legacy" class="btn btn-outline-dark btn-sm" type="submit" title="Apply recommended to all Data Source 2 rules">Apply All (Data Source 2)</button>
          </div>
        </div>
        <div class="card-body p-0">
          <table class="table table-sm table-striped table-hover mb-0 rules-table">
            <thead class="table-light">
              <tr class="small">
                <th style="width:90px">Origin</th>
                <th style="min-width:170px">Target Field</th>
                <th style="min-width:140px">Source/Legacy Field(s)</th>
                <th style="min-width:240px">Rule</th>
                <th style="min-width:260px">Example</th>
                <th style="width:50px"></th>
              </tr>
            </thead>
            <tbody>
              {% for rule in rules %}
              <tr class="rule-row" data-origin="{{ rule.origin }}" title="{{ rule.field_full }} :: {{ rule.sources_display }} :: {{ rule.example }}" style="display:none;">
                <td>
                  {% if rule.origin=='source' %}
                    <span class="badge bg-danger">DATA SOURCE 1</span>
                  {% elif rule.origin=='legacy' %}
                    <span class="badge bg-dark">DATA SOURCE 2</span>
                  {% elif rule.origin[:2]|lower == 'ds' %}
                    <span class="badge bg-secondary">DATA SOURCE {{ rule.origin[2:]|int }}</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ rule.origin|upper }}</span>
                  {% endif %}
                </td>
                <td>
                  <div class="field-stack" data-field-full="{{ rule.field_full }}" data-field-name="{{ rule.field_name }}">
                    <strong class="field-label">{{ rule.field_full }}</strong>
                    {% set _tbl = rule.target_table or (rule.field_full.split('.')[0] if '.' in rule.field_full else '') %}
                    {% if _tbl %}<span class="tbl">{{ _tbl }}</span>{% endif %}
                  </div>
                </td>
                <td class="text-muted">{{ rule.sources_display }}</td>
                <td>
                  <div class="d-flex gap-2 align-items-center">
                    <input type="text" name="rule_{{ loop.index0 }}" value="{{ rule.rule }}" class="form-control form-control-sm" />
                    {% if rule.variants %}
                    <select class="form-select form-select-sm" name="preferred_{{ loop.index0 }}" title="Preferred variant" data-current="{{ rule.preferred|e if rule.preferred else '' }}">
                      <option value="">Preferred…</option>
                      {% for v in rule.variants %}
                      <option value="{{ v }}">{{ v }}</option>
                      {% endfor %}
                    </select>
                    <button type="button" class="btn btn-outline-secondary btn-xs apply-selected" data-index="{{ loop.index0 }}" title="Apply selected variant">Apply</button>
                    {% endif %}
                  </div>
                </td>
                <td class="text-muted">
                  <div>{{ rule.example }}</div>
                  {% if rule.variants %}
                  {% set _row_index = loop.index0 %}
                  <div class="small text-secondary mt-1">Variants:
                    <ul class="mb-0 ps-3 mt-1">
                      {% for v in rule.variants %}<li>{{ v }}</li>{% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                </td>
                <td><button type="button" class="btn btn-outline-danger btn-sm edit-rule-btn" data-index="{{ loop.index0 }}">Edit</button></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
</form>

<!-- Floating Chat Panel -->
<div class="card chat-float border-0" id="chat-widget">
  <div class="card-header bg-danger text-white py-2 d-flex justify-content-between align-items-center">
    <span class="small fw-semibold d-flex align-items-center gap-1"><i class="bi bi-robot"></i> Chatbot Assistant</span>
    <button class="btn btn-sm btn-light py-0 px-1 d-flex align-items-center justify-content-center" id="chat-min-btn" type="button" aria-label="Minimize chat"><i class="bi bi-chevron-down" id="chat-min-icon"></i></button>
  </div>
  <div class="card-body p-2" id="chat-body">
    <div class="text-muted small" id="chat-messages">Ask about transformation rules, lineage, or validation logic...</div>
  </div>
  <div class="card-footer p-2" id="chat-footer">
    <form id="chat-form" onsubmit="return sendMessage(event);" class="d-flex gap-1">
      <input type="text" class="form-control form-control-sm" id="chat-input" placeholder="Type question..." required>
      <button class="btn btn-danger btn-sm" type="submit">Send</button>
    </form>
  </div>
</div>

<script>
  async function sendMessage(e){ e.preventDefault(); const input=document.getElementById('chat-input'); const msg=input.value.trim(); if(!msg) return false; appendMessage('You', msg); input.value=''; try{ const res= await fetch('/poc4/chat',{method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:'message='+encodeURIComponent(msg)}); const data= await res.json(); appendMessage('Bot', data.response);}catch(err){ appendMessage('Bot','(error)'); } return false; }
  function appendMessage(sender,text){ const chat=document.getElementById('chat-messages'); const div=document.createElement('div'); div.className='mb-1'; div.innerHTML=`<strong>${sender}:</strong> ${text}`; chat.appendChild(div); chat.scrollTop=chat.scrollHeight; }
  function editRule(i){ const inp=document.querySelector(`input[name='rule_${i}']`); if(!inp) return; const val=prompt('Edit rule:', inp.value); if(val!==null){ inp.value=val; } }
  document.querySelectorAll('.edit-rule-btn').forEach(btn=>{ btn.addEventListener('click', ()=> editRule(parseInt(btn.dataset.index))); });
  // Apply selected variant (single button per row)
  document.querySelectorAll('.apply-selected').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const idx = parseInt(btn.dataset.index);
      const sel = document.querySelector(`select[name='preferred_${idx}']`);
      const inp = document.querySelector(`input[name='rule_${idx}']`);
      if (!sel || !inp) return;
      const val = sel.value;
      if (val) { inp.value = val; inp.focus(); }
    });
  });
  // Minimize chat
  function toggleChat(){ const body=document.getElementById('chat-body'); const footer=document.getElementById('chat-footer'); const icon=document.getElementById('chat-min-icon'); const hidden=body.style.display==='none'; body.style.display= hidden? 'block':'none'; footer.style.display= hidden? 'block':'none'; icon.classList.toggle('bi-chevron-down', !hidden); icon.classList.toggle('bi-chevron-up', hidden);} 
  document.getElementById('chat-min-btn').addEventListener('click', toggleChat);
  // Start minimized
  toggleChat();

  // Filter origin toggles with persistence (DS1/DS2 default OFF, DS3+ default ON)
  const filterSource = document.getElementById('filter-source');
  const filterLegacy = document.getElementById('filter-legacy');
  const extraFilters = Array.from(document.querySelectorAll('.filter-extra'));
  const ORIGIN_FILTERS_KEY = 'poc4_origin_filters';
  const ORIGIN_MIN_KEY = 'poc4_origin_min';
  function loadFilterPrefs(){ try{ return JSON.parse(localStorage.getItem(ORIGIN_FILTERS_KEY)||'{}')||{}; }catch(e){ return {}; } }
  function saveFilterPrefs(state){ try{ localStorage.setItem(ORIGIN_FILTERS_KEY, JSON.stringify(state||{})); }catch(e){} }
  function currentFilterState(){
    const stored = loadFilterPrefs();
    const state = { ...stored };
    if(filterSource) state['source'] = !!filterSource.checked;
    if(filterLegacy) state['legacy'] = !!filterLegacy.checked;
    extraFilters.forEach(cb=>{ const o=(cb.dataset.origin||'').toLowerCase(); if(o){ state[o]=!!cb.checked; }});
    return state;
  }
  function applyStoredPrefs(){
    const stored = loadFilterPrefs();
    if(filterSource){ filterSource.checked = !!stored['source']; }
    if(filterLegacy){ filterLegacy.checked = !!stored['legacy']; }
    extraFilters.forEach(cb=>{ const o=(cb.dataset.origin||'').toLowerCase(); cb.checked = (o in stored) ? !!stored[o] : true; });
  }
  function isOn(origin, state){
    const o = (origin||'').toLowerCase();
    if(o in state) return !!state[o];
    return (o !== 'source' && o !== 'legacy');
  }
  function applyFilters(){
    const state = currentFilterState();
    document.querySelectorAll('.rule-row[data-origin]').forEach(row=>{
      const origin = (row.getAttribute('data-origin') || '').toLowerCase();
      const ok = isOn(origin, state);
      row.style.display = ok ? 'table-row' : 'none';
    });
    saveFilterPrefs(state);
  try{ applyMin(); }catch(e){}
  }
  filterSource?.addEventListener('change', applyFilters);
  filterLegacy?.addEventListener('change', applyFilters);
  extraFilters.forEach(cb=> cb.addEventListener('change', applyFilters));
  applyStoredPrefs();
  applyFilters();

  // Minimize per origin (collapse rows but keep filter state)
  function getMin(){ try{ return JSON.parse(localStorage.getItem(ORIGIN_MIN_KEY)||'{}')||{}; }catch(e){ return {}; } }
  function setMin(k,v){ try{ const s=getMin(); s[k]=!!v; localStorage.setItem(ORIGIN_MIN_KEY, JSON.stringify(s)); }catch(e){} }
  function applyMin(){
    const s=getMin();
    document.querySelectorAll('.rule-row[data-origin]').forEach(row=>{
      const o=(row.getAttribute('data-origin')||'').toLowerCase();
      const minimized = !!s[o];
      row.style.display = row.style.display; // keep filter effect
      row.classList.toggle('collapsed-origin', minimized);
      row.style.visibility = minimized? 'collapse' : '';
    });
  }
  document.getElementById('minimize-source')?.addEventListener('click', ()=>{ const s=getMin(); setMin('source', !s['source']); applyMin(); });
  document.getElementById('minimize-legacy')?.addEventListener('click', ()=>{ const s=getMin(); setMin('legacy', !s['legacy']); applyMin(); });
  document.querySelectorAll('.minimize-extra').forEach(btn=>{
    btn.addEventListener('click', ()=>{ const o=(btn.dataset.origin||'').toLowerCase(); const s=getMin(); setMin(o, !s[o]); applyMin(); });
  });
  applyMin();

  // Toggle qualified/unqualified
  const toggle = document.getElementById('toggleQualified');
  const PREF_KEY = 'poc4_rules_show_qualified';
  // Load preference
  const storedPref = localStorage.getItem(PREF_KEY);
  if(storedPref !== null){ toggle.checked = storedPref === '1'; }
  function applyQualification(){
    const showQualified = toggle.checked;
    document.querySelectorAll('.field-stack').forEach(fs=>{
      const full = fs.getAttribute('data-field-full');
      const nameOnly = fs.getAttribute('data-field-name') || full;
      const labelEl = fs.querySelector('.field-label');
      if(labelEl){ labelEl.textContent = showQualified ? full : nameOnly.split('.').slice(-1)[0]; }
      // Always show table line (requirement: display table name along with field)
      const tblEl = fs.querySelector('.tbl');
      if(tblEl){ tblEl.style.display = 'block'; }
    });
  }
  toggle.addEventListener('change', ()=>{ localStorage.setItem(PREF_KEY, toggle.checked ? '1':'0'); applyQualification(); });
  applyQualification();

  // Initialize preferred dropdowns
  document.querySelectorAll('select[name^="preferred_"]').forEach(sel => {
    const cur = sel.getAttribute('data-current');
    if (cur) {
      for (const opt of sel.options) {
        if (opt.value === cur) { opt.selected = true; break; }
      }
    }
  });
  // Simple chat commands
  document.getElementById('chat-form')?.addEventListener('submit', (e)=>{
    // The sendMessage already posts; here we add quick actions before network
    const val = document.getElementById('chat-input')?.value?.toLowerCase() || '';
    if(val==='next' || val.includes('validate')){ e.preventDefault(); document.getElementById('validate-btn')?.click(); return false; }
  }, {capture:true});
</script>
{% endblock %}
