{% extends 'poc4/base.html' %}
{% block content %}
<!-- Banner -->
<div class="bg-danger text-white py-3 mb-4 rounded shadow-sm text-center">
  <h2 class="mb-0">Data Modelling, Migration & Reconciliation</h2>
  <small>Modern Data Migration Workflow</small>
</div>

{% include 'poc4/_subnav.j2' %}
{% include 'poc4/_steps.j2' %}

<style>
  .nav-pills .nav-link {border-radius:2rem;margin:0 .25rem;font-weight:500;color:#d32f2f;background:#fff;border:1px solid #d32f2f;transition:.2s}
  .nav-pills .nav-link.active,.nav-pills .show>.nav-link{background:linear-gradient(90deg,#d32f2f 60%,#b71c1c);color:#fff !important;font-weight:700;box-shadow:0 2px 8px rgba(211,47,47,.1)}
  .map-row{border-bottom:1px solid #eee;padding:.35rem .5rem;white-space:normal;align-items:flex-start}
  .map-header{background:#fafafa;font-weight:600;border-bottom:2px solid #e3e3e3;position:sticky;top:0;z-index:1}
  .map-row:hover{background:#fffdfd}
  /* Allow full source/legacy field names to wrap instead of being cut */
  .map-row strong{flex:0 0 auto; min-width:170px; max-width:300px; white-space:normal; word-break:break-word}
  .map-row strong.text-truncate{overflow:visible!important; text-overflow:unset!important; white-space:normal!important}
  .map-row .target-table{flex:0 0 140px; max-width:160px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  .map-row .target-badge{flex:0 0 160px;display:inline-block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .map-row .justification{flex:1 1 auto;max-width:none;white-space:normal}
  .mapping-section .card-body{max-height:70vh;overflow:auto}
  .map-row .meta{font-size:.65rem;color:#555}
  /* Chat is handled by shared ChatPanel partial */
  @media (max-width:1200px){.justification{max-width:260px}}
  @media (max-width:992px){.justification{display:none}}
  /* Graph column */
  .graph-card .card-body{max-height:70vh;overflow:auto}
  .graph-card .mermaid svg{max-width:100%}
  .graph-card .mermaid{min-height:240px}
  .legend-pill{display:inline-flex;align-items:center;gap:.35rem;padding:.15rem .5rem;border-radius:999px;border:1px solid #e5e7eb;background:#fff;font-size:.8rem}
  .legend-swatch{width:12px;height:12px;border-radius:3px;display:inline-block}
  .node-click-hint{color:#6b7280}
</style>

<form method="post" id="mapping-form">
  <!-- Top action bar just below tabs -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-3">
      <span class="small text-muted">Filter origins:</span>
      <div class="form-check form-check-inline align-items-center d-flex gap-1">
        <input class="form-check-input" type="checkbox" id="filter-source">
  <label class="form-check-label" for="filter-source"><span class="badge bg-danger">SOURCE</span></label>
        <button class="btn btn-xs btn-outline-secondary minimize-origin" type="button" data-origin="source" title="Minimize DS1 rows">–</button>
      </div>
      <div class="form-check form-check-inline align-items-center d-flex gap-1">
        <input class="form-check-input" type="checkbox" id="filter-legacy">
  <label class="form-check-label" for="filter-legacy"><span class="badge bg-dark">LEGACY</span></label>
        <button class="btn btn-xs btn-outline-secondary minimize-origin" type="button" data-origin="legacy" title="Minimize DS2 rows">–</button>
      </div>
      <!-- Dynamic DS3+ chips -->
      {% set ns = namespace(extras=[]) %}
      {% for m in mapping %}
        {% set o = m.get('origin','source') %}
        {% if o not in ['source','legacy'] and o not in ns.extras %}
          {% set _ = ns.extras.append(o) %}
        {% endif %}
      {% endfor %}
      {% for o in ns.extras %}
      <div class="form-check form-check-inline align-items-center d-flex gap-1">
        <input class="form-check-input filter-extra" type="checkbox" id="filter-{{ o }}" data-origin="{{ o }}">
        <label class="form-check-label" for="filter-{{ o }}">
          {% if o[:2]|lower == 'ds' %}<span class="badge bg-secondary">DATA SOURCE {{ o[2:]|int }}</span>{% else %}<span class="badge bg-secondary">{{ o|upper }}</span>{% endif %}
        </label>
  <button class="btn btn-xs btn-outline-secondary minimize-origin" type="button" data-origin="{{ o }}" title="Minimize {{ o|upper }} rows">–</button>
      </div>
      {% endfor %}
    </div>
    <button type="submit" class="btn btn-danger px-4" id="next-btn">Next</button>
  </div>

  <div class="row g-4 mapping-section">
    <div class="col-lg-7">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-light text-danger fw-bold d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-sm btn-outline-danger collapse-btn" data-target="#map-body" aria-label="Collapse mappings">−</button>
            <span>Origin ➜ Target (Mapped Only)</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-secondary">COMBINED</span>
          </div>
        </div>
        <div class="card-body p-0" id="map-body">
          <div class="map-row map-header d-flex gap-2 small">
            <div style="width:90px" class="sort-header" data-key="origin">Origin</div>
            <div style="min-width:170px;max-width:300px;" class="sort-header" data-key="source">Field</div>
            <div style="width:16px"></div>
            <div class="target-table sort-header" data-key="target_table">Target Table</div>
            <div class="target-badge sort-header" data-key="target">Target Field</div>
            <div style="width:70px" class="sort-header" data-key="type">Type</div>
            <div style="width:55px" class="sort-header" data-key="similarity" title="Similarity %">Sim</div>
            <div class="flex-fill">Justification</div>
          </div>
          {% set any_any = false %}
          {% for m in mapping %}
            {% set origin = m.get('origin','source') %}
            {# Render rows for any source field; target may be unassigned initially #}
            {% if m.source %}
              {% set any_any = true %}
              <div class="map-row d-flex gap-2 small" data-origin="{{ origin }}" data-source="{{ m.source }}" data-target="{{ m.target }}" data-target_table="{{ m.target_table or '' }}" data-type="{{ target_types.get(m.target,'') }}" data-similarity="{{ (m.get('similarity',0)*100)|round(4) }}" title="{{ m.source }} ➜ {{ m.target }} :: {{ m.get('justification') or m.get('description') }}">
                <span style="width:90px">
                  {% if origin=='source' %}
                    <span class="badge bg-danger">SOURCE</span>
                  {% elif origin=='legacy' %}
                    <span class="badge bg-dark">LEGACY</span>
                  {% elif origin[:2]|lower == 'ds' %}
                    <span class="badge bg-secondary">DATA SOURCE {{ origin[2:]|int }}</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ origin|upper }}</span>
                  {% endif %}
                </span>
                <strong class="text-truncate">{% if m.source_table %}{{ m.source_table }}.{% endif %}{{ m.source }}</strong>
                <i class="bi bi-arrow-right text-muted mt-1"></i>
                <span class="target-table text-muted small" title="{{ m.target_table or '' }}">{{ m.target_table or '' }}</span>
                <select class="form-select form-select-sm target-badge target-select" name="target_{{ loop.index0 }}" aria-label="Select target field" style="max-width:240px;" data-current="{{ m.target }}">
                  <option value="">— Select target —</option>
                  {% for tf in target_fields %}
                    <option value="{{ tf }}">{{ tf }}</option>
                  {% endfor %}
                </select>
                {% if target_types.get(m.target) %}<span class="badge bg-light text-dark border mt-1">{{ target_types.get(m.target) }}</span>{% endif %}
                {% if m.get('similarity') %}<span class="meta mt-1">{{ (m.get('similarity',0)*100)|round(1) }}%</span>{% endif %}
                <span class="text-muted justification">— {{ m.get('justification') or m.get('description') or 'Mapping created automatically.' }}</span>
                <input type="hidden" name="target_type_{{ loop.index0 }}" value="{{ target_types.get(m.target,'') }}">
              </div>
            {% endif %}
          {% endfor %}
          {% if not any_any %}
            <div class="p-3 text-muted small">No mappings available.</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="card h-100 shadow-sm graph-card">
        <div class="card-header bg-light text-danger fw-bold">
          <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
            <span>Mapping Graph</span>
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <div id="graph-filters" class="d-flex align-items-center gap-2"></div>
              <select class="form-select form-select-sm" id="detail-table-select" title="Show detail for a specific target table">
                <option value="">Overview</option>
              </select>
            </div>
          </div>
        </div>
        <div class="card-body p-2">
          <div class="small text-muted mb-2">Use Overview to see flow from origins to target tables. Pick a table to view field-level links. Click rows or nodes to focus; click nodes to see details.</div>
          <div class="small mb-2" id="graph-legend"></div>
          <div id="graph-overview" class="mermaid small"></div>
          <div id="graph-detail" class="mermaid small" style="display:none"></div>
          <div class="small text-muted mt-2" id="graph-note"></div>
          <div id="graph-info" class="small mt-2 border rounded p-2" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

</form>

{% include 'poc4/_chatpanel.j2' %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<script id="target-types-json" type="application/json">{{ target_types | tojson | safe }}</script>
<script id="mapping-json" type="application/json">{{ mapping | tojson | safe }}</script>
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
// Load target type map for client-side updates
try {
  const el = document.getElementById('target-types-json');
  window.__poc4TargetTypes = el ? JSON.parse(el.textContent) : {};
} catch(e){ window.__poc4TargetTypes = {}; }

// Page-specific ChatPanel commands for Mapping page
window.handleChatCommand = function(cmd, api){
  const t = (cmd||'').trim().toLowerCase();
  // Filters
  if(t.includes('filter source')){
    const on = !(t.includes('off')||t.includes('false')||t.includes('disable'));
    api.append('assistant',`Turning SOURCE ${on?'on':'off'}`);
    api.setLastAction(()=>{ const cb=document.getElementById('filter-source'); if(cb){ cb.checked=on; cb.dispatchEvent(new Event('change')); } });
    return true;
  }
  if(t.includes('filter legacy')){
    const on = !(t.includes('off')||t.includes('false')||t.includes('disable'));
    api.append('assistant',`Turning LEGACY ${on?'on':'off'}`);
    api.setLastAction(()=>{ const cb=document.getElementById('filter-legacy'); if(cb){ cb.checked=on; cb.dispatchEvent(new Event('change')); } });
    return true;
  }
  if(t.match(/filter\s+ds\d+/)){
    const m = t.match(/ds(\d+)/); const idx = m? m[1] : null; const on = !(t.includes('off')||t.includes('false')||t.includes('disable'));
    if(idx){ api.append('assistant',`Turning DS${idx} ${on?'on':'off'}`); api.setLastAction(()=>{ const cb=document.getElementById('filter-ds'+idx); if(cb){ cb.checked=on; cb.dispatchEvent(new Event('change')); } }); return true; }
  }
  // Minimize
  if(t.includes('minimize source')){ api.append('assistant','Will minimize SOURCE rows'); api.setLastAction(()=> document.querySelector('.minimize-origin[data-origin="source"]')?.click()); return true; }
  if(t.includes('minimize legacy')){ api.append('assistant','Will minimize LEGACY rows'); api.setLastAction(()=> document.querySelector('.minimize-origin[data-origin="legacy"]')?.click()); return true; }
  // Sort commands
  if(t.startsWith('sort by ')){
    const key = t.replace('sort by ','').trim().replace(' ','_');
    api.append('assistant',`Sorting by ${key}`);
    api.setLastAction(()=> sortRows(key));
    return true;
  }
  // Focus table in graph
  if(t.startsWith('focus table ')){
    const table = t.replace('focus table ','').trim();
    api.append('assistant',`Focusing table ${table}`);
    api.setLastAction(()=>{ const sel=document.getElementById('detail-table-select'); if(sel){ sel.value=table; sel.dispatchEvent(new Event('change')); } });
    return true;
  }
  // Regenerate mapping
  if(t.includes('regenerate')){
    api.append('assistant','Will regenerate mapping suggestions');
    api.setLastAction(async ()=>{ try{ const r=await fetch('/poc4/auto_mapping'); if(!r.ok) throw new Error('Failed'); await r.json(); }catch(_){ } });
    return true;
  }
  // Next
  if(['next','go next','continue'].includes(t)){
    api.append('assistant','Proceeding to next step…');
    api.setLastAction(()=> document.getElementById('next-btn')?.click());
    return true;
  }
  return false;
};

// --- Collapse logic for Combined section ---
document.querySelectorAll('.collapse-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const targetSel = btn.getAttribute('data-target');
    const bodyEl = document.querySelector(targetSel);
    if(!bodyEl) return;
    const hidden = bodyEl.style.display==='none';
    bodyEl.style.display = hidden? 'block':'none';
    btn.textContent = hidden? '−':'+';
  });
});

// --- Filter logic with persistence (no defaults for DS1/DS2; DS3+ default ON) ---
const filterSource = document.getElementById('filter-source');
const filterLegacy = document.getElementById('filter-legacy');
const extraFilters = Array.from(document.querySelectorAll('.filter-extra'));
const ORIGIN_FILTERS_KEY = 'poc4_origin_filters';
const ORIGIN_MIN_KEY = 'poc4_origin_min';

function loadFilterPrefs(){
  try{ return JSON.parse(localStorage.getItem(ORIGIN_FILTERS_KEY) || '{}') || {}; }catch(e){ return {}; }
}
function saveFilterPrefs(state){
  try{ localStorage.setItem(ORIGIN_FILTERS_KEY, JSON.stringify(state||{})); }catch(e){}
}
function currentFilterState(){
  const stored = loadFilterPrefs();
  const state = { ...stored };
  if(filterSource) state['source'] = !!filterSource.checked;
  if(filterLegacy) state['legacy'] = !!filterLegacy.checked;
  extraFilters.forEach(cb=>{ const o = (cb.dataset.origin||'').toLowerCase(); if(o){ state[o] = !!cb.checked; }});
  return state;
}
function applyStoredPrefs(){
  const stored = loadFilterPrefs();
  // DS1/DS2 default false when not stored
  if(filterSource){ filterSource.checked = !!stored['source']; }
  if(filterLegacy){ filterLegacy.checked = !!stored['legacy']; }
  // DS3+ default true when not stored
  extraFilters.forEach(cb=>{
    const o = (cb.dataset.origin||'').toLowerCase();
    cb.checked = (o in stored) ? !!stored[o] : true;
  });
}
function isOn(origin, state){
  const o = (origin||'').toLowerCase();
  if(o in state) return !!state[o];
  // default: extras ON, DS1/DS2 OFF
  return (o !== 'source' && o !== 'legacy');
}
function applyFilters(){
  const state = currentFilterState();
  document.querySelectorAll('#map-body .map-row[data-origin]').forEach(row=>{
    const origin = (row.getAttribute('data-origin') || '').toLowerCase();
    const ok = isOn(origin, state);
    row.style.display = ok? 'flex':'none';
  });
  saveFilterPrefs(state);
  // Re-apply minimize state so collapsed origins remain hidden
  try{ applyMin(); }catch(e){}
}
filterSource?.addEventListener('change', applyFilters);
filterLegacy?.addEventListener('change', applyFilters);
extraFilters.forEach(cb=> cb.addEventListener('change', applyFilters));
// Ensure at least one filter is ON to avoid an empty view on first load
function ensureSomeFiltersOn(){
  const anyOn = (
    (filterSource && filterSource.checked) ||
    (filterLegacy && filterLegacy.checked) ||
    extraFilters.some(cb => cb.checked)
  );
  if(!anyOn){
    if(filterSource) filterSource.checked = true;
    if(filterLegacy) filterLegacy.checked = true;
    extraFilters.forEach(cb => cb.checked = true);
    saveFilterPrefs(currentFilterState());
  }
}
applyStoredPrefs();
ensureSomeFiltersOn();
applyFilters();

// --- Minimize per origin (collapse rows but keep filter state) ---
function getMin(){ try{ return JSON.parse(localStorage.getItem(ORIGIN_MIN_KEY)||'{}')||{}; }catch(e){ return {}; } }
function setMin(k,v){ try{ const s=getMin(); s[k]=!!v; localStorage.setItem(ORIGIN_MIN_KEY, JSON.stringify(s)); }catch(e){} }
function applyMin(){
  const s=getMin();
  document.querySelectorAll('#map-body .map-row[data-origin]').forEach(row=>{
    const o=(row.getAttribute('data-origin')||'').toLowerCase();
    const minimized = !!s[o];
    row.classList.toggle('collapsed-origin', minimized);
    row.style.maxHeight = minimized? '0' : '';
    row.style.overflow = minimized? 'hidden' : '';
    row.style.paddingTop = row.style.paddingBottom = minimized? '0' : '';
    row.style.margin = minimized? '0' : '';
  });
}
document.querySelectorAll('.minimize-origin').forEach(btn=>{
  btn.addEventListener('click', ()=>{ const o=(btn.dataset.origin||'').toLowerCase(); const s=getMin(); setMin(o, !s[o]); applyMin(); });
});
applyMin();

// --- Sorting logic (combined) ---
const sortState = {};
function sortRows(key){
  const container = document.getElementById('map-body');
  if(!container) return;
  const rows = Array.from(container.querySelectorAll(`.map-row[data-origin]`));
  if(!rows.length) return;
  const currentDir = sortState[key] === 'asc'? 'desc':'asc';
  sortState[key] = currentDir;
  rows.sort((a,b)=>{
    let av = a.getAttribute(`data-${key}`)||''; let bv = b.getAttribute(`data-${key}`)||'';
    // origin ordering: source before legacy if asc
    if(key==='origin'){
      av = (av||'').toLowerCase(); bv = (bv||'').toLowerCase();
      if(av===bv) return 0;
      return currentDir==='asc' ? (av==='source'? -1:1) : (av==='source'? 1:-1);
    }
    const anum = parseFloat(av); const bnum = parseFloat(bv);
    if(!isNaN(anum) && !isNaN(bnum)){
      return currentDir==='asc'? anum - bnum : bnum - anum;
    }
    av = (av||'').toLowerCase(); bv = (bv||'').toLowerCase();
    if(av < bv) return currentDir==='asc'? -1:1;
    if(av > bv) return currentDir==='asc'? 1:-1;
    return 0;
  });
  const header = container.querySelector('.map-header');
  rows.forEach(r=> container.appendChild(r));
  container.querySelectorAll('.sort-header').forEach(h=> h.classList.remove('sorted-asc','sorted-desc'));
  const activeHeader = container.querySelector(`.sort-header[data-key='${key}']`);
  if(activeHeader){ activeHeader.classList.add(currentDir==='asc'? 'sorted-asc':'sorted-desc'); }
}
document.querySelectorAll('.sort-header').forEach(h=>{
  h.style.cursor='pointer';
  h.addEventListener('click', ()=> sortRows(h.getAttribute('data-key')));
});

// Initialize target selects and keep hidden type in sync
document.querySelectorAll('.map-row').forEach(row=>{
  const sel = row.querySelector('select.target-select');
  if (!sel) return;
  const hiddenType = row.querySelector('input[name^="target_type_"]');
  const current = sel.getAttribute('data-current');
  if (current) {
    for (const opt of sel.options){ if (opt.value === current){ opt.selected = true; break; } }
  }
  sel.addEventListener('change', ()=>{
    // Look up type via data map printed server-side in a script tag if present; fallback: clear
    const typeMap = window.__poc4TargetTypes || {};
    const t = typeMap[sel.value] || '';
    if (hiddenType) hiddenType.value = t;
  });
  // Click-to-focus: clicking a row will select the detail graph for its target table
  row.addEventListener('click', (e)=>{
    // avoid when clicking a control
    if(e.target.closest('select,button,input,label')) return;
    const t = row.getAttribute('data-target_table') || '';
    const selEl = document.getElementById('detail-table-select');
    if(selEl){ selEl.value = t; selEl.dispatchEvent(new Event('change')); }
  });
});

// --- Mapping Graph (Mermaid) ---
function getRowsFromDOM(){
  const rows=[];
  document.querySelectorAll('#map-body .map-row[data-origin]').forEach(r=>{
    rows.push({
      origin: r.getAttribute('data-origin')||'source',
      source_label: (r.querySelector('strong')?.textContent||'').trim(),
      target_table: r.getAttribute('data-target_table')||'',
      target: r.getAttribute('data-target')||''
    });
  });
  return rows;
}
function loadMapping(){
  const domRows = getRowsFromDOM();
  if(domRows && domRows.length) return domRows;
  try{ const el=document.getElementById('mapping-json'); return el? JSON.parse(el.textContent): []; }catch(e){ return []; }
}
function safeId(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9_]/g,'_'); }
function labelForOrigin(o){
  const k=(o||'').toLowerCase();
  if(k==='source') return 'SOURCE';
  if(k==='legacy') return 'LEGACY';
  if(k.startsWith('ds')) return `DATA_SOURCE_${k.slice(2)}`;
  return (o||'').toUpperCase();
}
function buildOverviewDef(rows){
  // Group by origin -> target_table counts; respect overview filter state
  const counts = new Map();
  const targets = new Set();
  const origins = new Set();
  const filter = window.__graphFilter||{};
  rows.forEach(r=>{
    const o = labelForOrigin(r.origin||'source');
    const t = r.target_table || '(none)';
    if(filter && Object.keys(filter).length){
      const ok = !!filter[o];
      if(!ok) return;
    }
    const key = o+'||'+t;
    counts.set(key, (counts.get(key)||0)+1);
    targets.add(t); origins.add(o);
  });
  let def = 'flowchart LR\n';
  origins.forEach(o=>{ def += `${safeId(o)}([${o}]):::origin\n`; });
  targets.forEach(t=>{ def += `${safeId('t_'+t)}([${t}]):::target\n`; });
  counts.forEach((n,key)=>{
    const [o,t] = key.split('||');
    def += `${safeId(o)} -->|${n}| ${safeId('t_'+t)}\n`;
  });
  def += 'classDef origin fill:#ffe8e6,stroke:#d32f2f,color:#b71c1c,stroke-width:1px;\n';
  def += 'classDef target fill:#eef2ff,stroke:#4f46e5,color:#1f2937,stroke-width:1px;\n';
  return def;
}
function buildDetailDef(rows, table){
  const filtered = rows.filter(r=> (r.target_table||'')===table);
  const limit = 15;
  let trimmed = false;
  let def = 'flowchart LR\n';
  def += `subgraph ${table}\n${safeId('t_'+table)}([${table}]):::target\nend\n`;
  const seenFields = new Set();
  const fieldCounts = new Map();
  filtered.forEach(r=>{
    const tf = r.target || '';
    if(tf){ fieldCounts.set(tf, (fieldCounts.get(tf)||0)+1); }
  });
  filtered.forEach((r,idx)=>{
    if(idx>=limit){ trimmed=true; return; }
    const o = labelForOrigin(r.origin||'source');
  const srcField = r.source_label || '';
    const tf = r.target || '';
    const ofId = safeId(o+'_'+srcField);
    const tfId = safeId('tf_'+tf);
    if(!seenFields.has(ofId)){
      def += `${ofId}([${o}: ${srcField}]):::origin\n`;
      seenFields.add(ofId);
    }
    if(tf){
      if(!seenFields.has(tfId)){
        const c = fieldCounts.get(tf)||0;
        def += `${tfId}([${tf} (${c})]):::field\n`;
        seenFields.add(tfId);
      }
      def += `${ofId} --> ${tfId}\n`;
    } else {
      def += `${ofId} --> ${safeId('t_'+table)}\n`;
    }
  });
  def += 'classDef origin fill:#ffe8e6,stroke:#d32f2f,color:#b71c1c,stroke-width:1px;\n';
  def += 'classDef target fill:#eef2ff,stroke:#4f46e5,color:#1f2937,stroke-width:1px;\n';
  def += 'classDef field fill:#f1f5f9,stroke:#64748b,color:#111827,stroke-width:1px;\n';
  return {def, trimmed};
}
function renderMermaidOnce(el, def){ if(!window.mermaid||!el) return; el.textContent = def; try{ mermaid.initialize({startOnLoad:false, securityLevel:'loose'}); mermaid.init(undefined, el);}catch(e){} }
function initGraph(){
  const rows = loadMapping();
  const overviewEl = document.getElementById('graph-overview');
  const detailEl = document.getElementById('graph-detail');
  const noteEl = document.getElementById('graph-note');
  const legendEl = document.getElementById('graph-legend');
  const infoEl = document.getElementById('graph-info');
  const sel = document.getElementById('detail-table-select');
  const chips = document.getElementById('graph-filters');
  // Populate tables
  const tables = Array.from(new Set(rows.map(r=> r.target_table || '').filter(Boolean))).sort();
  tables.forEach(t=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; sel.appendChild(opt); });
  // Legend
  legendEl.innerHTML = `
    <span class="legend-pill"><span class="legend-swatch" style="background:#ffe8e6;border:1px solid #d32f2f"></span> Origin</span>
    <span class="legend-pill"><span class="legend-swatch" style="background:#eef2ff;border:1px solid #4f46e5"></span> Target Table</span>
    <span class="legend-pill"><span class="legend-swatch" style="background:#f1f5f9;border:1px solid #64748b"></span> Target Field (count)</span>
    <span class="node-click-hint ms-2">Tip: Click list rows or graph nodes to focus</span>
  `;
  // Build origin chips mirrored from left filters
  const origins = Array.from(new Set(rows.map(r=> labelForOrigin(r.origin||'source')))).sort();
  window.__graphFilter = {};
  origins.forEach(o=>{
    const id = `chip_${safeId(o)}`;
    const div = document.createElement('div');
    div.className = 'form-check form-check-inline align-items-center d-flex gap-1';
    div.innerHTML = `<input class="form-check-input graph-chip" type="checkbox" id="${id}" data-origin="${o}">
                     <label class="form-check-label" for="${id}"><span class="badge ${o==='SOURCE'?'bg-danger':(o==='LEGACY'?'bg-dark':'bg-secondary')}">${o}</span></label>`;
    chips.appendChild(div);
  });
  function currentChipState(){ const s={}; document.querySelectorAll('.graph-chip').forEach(cb=>{ const o=cb.dataset.origin; s[o]=!!cb.checked; }); return s; }
  function syncChipsFromLeft(){
    const map = {}; // build map from left toolbar
    map['SOURCE'] = !!document.getElementById('filter-source')?.checked;
    map['LEGACY'] = !!document.getElementById('filter-legacy')?.checked;
    document.querySelectorAll('.filter-extra').forEach(cb=>{ const o=(cb.dataset.origin||'').toUpperCase(); if(o) map[o.startsWith('DS')? `DATA_SOURCE_${o.slice(2)}` : o] = !!cb.checked; });
    document.querySelectorAll('.graph-chip').forEach(cb=>{ const o=cb.dataset.origin; cb.checked = !!map[o]; });
    window.__graphFilter = map;
  }
  function applyChipFilter(){ window.__graphFilter = currentChipState(); rerender(overviewEl, buildOverviewDef(rows)); updateOverviewNote(); }
  syncChipsFromLeft();
  document.getElementById('filter-source')?.addEventListener('change', ()=>{ syncChipsFromLeft(); applyChipFilter(); });
  document.getElementById('filter-legacy')?.addEventListener('change', ()=>{ syncChipsFromLeft(); applyChipFilter(); });
  document.querySelectorAll('.filter-extra').forEach(cb=> cb.addEventListener('change', ()=>{ syncChipsFromLeft(); applyChipFilter(); }));
  document.querySelectorAll('.graph-chip').forEach(cb=> cb.addEventListener('change', applyChipFilter));
  // helper to re-render and wire clicks
  function rerender(el, def){ renderMermaidOnce(el, def); wireGraphClicks(); }
  // Summary helpers
  function updateOverviewNote(){
    const filter = window.__graphFilter||{};
    const activeOrigins = Object.keys(filter).filter(k=> filter[k]);
    const total = rows.length;
    const tablesCount = tables.length;
    const originsText = activeOrigins.length? activeOrigins.join(', ') : 'All origins';
    noteEl.innerHTML = `<span class="text-muted">Overview · ${tablesCount} tables · ${total} mappings · Origins: ${originsText}</span>`;
  }
  function updateDetailNote(t){
    const subset = rows.filter(r=> (r.target_table||'')===t);
    const uniques = new Set(subset.map(r=> r.target).filter(Boolean)).size;
    const origins = new Set(subset.map(r=> labelForOrigin(r.origin||'source'))).size;
    noteEl.innerHTML = `<span class="text-muted">Detail · Table: <strong>${t}</strong> · ${subset.length} mappings · ${uniques} target fields · ${origins} origins</span>`;
  }
  // Initial overview
  rerender(overviewEl, buildOverviewDef(rows));
  updateOverviewNote();
  sel.addEventListener('change', ()=>{
    const t = sel.value;
  if(!t){ overviewEl.style.display='block'; detailEl.style.display='none'; updateOverviewNote(); rerender(overviewEl, buildOverviewDef(rows)); return; }
  const d = buildDetailDef(rows, t);
  overviewEl.style.display='none'; detailEl.style.display='block';
  rerender(detailEl, d.def);
  updateDetailNote(t);
  if(d.trimmed){ noteEl.innerHTML += ' · <em>Showing first 15 mappings (trimmed)</em>'; }
    infoEl.style.display='none';
  });
  // Clickable graph nodes -> focus
  function wireGraphClicks(){
    // Mermaid renders SVGs; wait a tick
    setTimeout(()=>{
      const svg = detailEl.style.display==='block' ? detailEl.querySelector('svg') : overviewEl.querySelector('svg');
      if(!svg) return;
      svg.querySelectorAll('g.node').forEach(g=>{
        g.style.cursor='pointer';
        g.addEventListener('click', ()=>{
          const label = (g.querySelector('text')?.textContent || '').trim();
          // If clicking target field label (ends with ) count), select its table in dropdown
          const tableFromField = sel.value || '';
          if(tableFromField){
            // Find a few matching rows for context
            const matches = rows.filter(r=> (r.target_table||'')===tableFromField && ((r.target||'') && label.startsWith(r.target)) ).slice(0,6);
            const list = matches.map(r=>`<li>${labelForOrigin(r.origin)}: ${r.source_table? r.source_table+'.':''}${r.source} ➜ ${r.target}</li>`).join('');
            infoEl.style.display='block';
            infoEl.innerHTML = `<div class="fw-semibold">${label}</div><ul class="mb-0 ps-3">${list || '<li>No direct rows found (trimmed or unmapped edge).</li>'}</ul>`;
          } else {
            // In overview, clicking a target table should select detail
            const tableset = new Set(tables);
            if(tableset.has(label)){
              sel.value=label; sel.dispatchEvent(new Event('change'));
            }
          }
        });
      });
    }, 100);
  }
  // Initial wire
  wireGraphClicks();
}
document.addEventListener('DOMContentLoaded', initGraph);
</script>
<!-- Ensure Bootstrap Icons for header robot icon -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
{% endblock %}
