{% extends 'poc4/base.html' %}
{% block content %}
<!-- Banner -->
<div class="bg-danger text-white py-3 mb-4 rounded shadow-sm text-center">
  <h2 class="mb-0">POC4 Data Migration & Reconciliation</h2>
  <small>Modern Data Migration Workflow</small>
</div>

<style>
  .nav-pills .nav-link {border-radius:2rem;margin:0 .25rem;font-weight:500;color:#d32f2f;background:#fff;border:1px solid #d32f2f;transition:.2s}
  .nav-pills .nav-link.active,.nav-pills .show>.nav-link{background:linear-gradient(90deg,#d32f2f 60%,#b71c1c);color:#fff !important;font-weight:700;box-shadow:0 2px 8px rgba(211,47,47,.1)}
  .map-row{border-bottom:1px solid #eee;padding:.35rem .5rem;white-space:normal;align-items:flex-start}
  .map-row strong{flex:0 0 170px}
  .map-row .target-badge{flex:0 0 220px;display:inline-block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .map-row .justification{flex:1 1 auto;max-width:none;white-space:normal}
  .mapping-section .card-body{max-height:70vh;overflow:auto}
  .map-row .meta{font-size:.65rem;color:#555}
  .chat-float{position:fixed;right:1.25rem;bottom:1.25rem;z-index:1050;width:340px;box-shadow:0 4px 18px rgba(0,0,0,.15)}
  .chat-float .card-body{height:300px;overflow-y:auto}
  @media (max-width:1200px){.justification{max-width:260px}}
  @media (max-width:992px){.justification{display:none}}
</style>
<ul class="nav nav-pills mb-4 justify-content-center" id="poc4Tabs">
  <li class="nav-item"><a class="nav-link" href="{{ url_for('poc4.page1') }}">1. Upload</a></li>
  <li class="nav-item"><a class="nav-link active" href="{{ url_for('poc4.page2') }}">2. Mapping</a></li>
  <li class="nav-item"><a class="nav-link" href="{{ url_for('poc4.page3') }}">3. Rules</a></li>
  <li class="nav-item"><a class="nav-link" href="{{ url_for('poc4.page4') }}">4. Validation</a></li>
  <li class="nav-item"><a class="nav-link" href="{{ url_for('poc4.page5') }}">5. Reconciliation</a></li>
</ul>

<form method="post" id="mapping-form">
  <div class="row g-4 mapping-section">
    <!-- Source -> Target Column (takes half width) -->
    <div class="col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-light text-danger fw-bold d-flex justify-content-between align-items-center">
          <span>Source ➜ Target (Mapped Only)</span>
          <span class="badge bg-danger origin-badge">SOURCE</span>
        </div>
        <div class="card-body p-0">
          {% set any_source = false %}
          {% for m in mapping %}
            {% set origin = m.get('origin','source') %}
            {% if origin == 'source' and m.target %}
              {% set any_source = true %}
              <div class="map-row d-flex gap-2 small" title="{{ m.source }} ➜ {{ m.target }} :: {{ m.get('justification') or m.get('description') }}">
                <strong class="text-truncate">{% if m.source_table %}{{ m.source_table }}.{% endif %}{{ m.source }}</strong>
                <i class="bi bi-arrow-right text-muted mt-1"></i>
                <span class="badge bg-secondary target-badge" title="{% if m.target_table %}{{ m.target_table }}.{% endif %}{{ m.target }}">{% if m.target_table %}{{ m.target_table }}.{% endif %}{{ m.target }}</span>
                {% if target_types.get(m.target) %}<span class="badge bg-light text-dark border mt-1">{{ target_types.get(m.target) }}</span>{% endif %}
                {% if m.get('similarity') %}<span class="meta mt-1">{{ (m.get('similarity',0)*100)|round(1) }}%</span>{% endif %}
                <span class="text-muted justification">— {{ m.get('justification') or m.get('description') or 'Mapping created automatically.' }}</span>
                <input type="hidden" name="target_{{ loop.index0 }}" value="{{ m.target }}">
                <input type="hidden" name="target_type_{{ loop.index0 }}" value="{{ target_types.get(m.target,'') }}">
              </div>
            {% endif %}
          {% endfor %}
          {% if not any_source %}
            <div class="p-3 text-muted small">No Source mappings available.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Legacy -> Target Column (takes half width) -->
    <div class="col-lg-6">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-light text-danger fw-bold d-flex justify-content-between align-items-center">
          <span>Legacy ➜ Target (Mapped Only)</span>
          <span class="badge bg-dark origin-badge">LEGACY</span>
        </div>
        <div class="card-body p-0">
          {% set any_legacy = false %}
          {% for m in mapping %}
            {% set origin = m.get('origin','source') %}
            {% if origin == 'legacy' and m.target %}
              {% set any_legacy = true %}
              <div class="map-row d-flex gap-2 small" title="{{ m.source }} ➜ {{ m.target }} :: {{ m.get('justification') or m.get('description') }}">
                <strong class="text-truncate">{% if m.source_table %}{{ m.source_table }}.{% endif %}{{ m.source }}</strong>
                <i class="bi bi-arrow-right text-muted mt-1"></i>
                <span class="badge bg-secondary target-badge" title="{% if m.target_table %}{{ m.target_table }}.{% endif %}{{ m.target }}">{% if m.target_table %}{{ m.target_table }}.{% endif %}{{ m.target }}</span>
                {% if target_types.get(m.target) %}<span class="badge bg-light text-dark border mt-1">{{ target_types.get(m.target) }}</span>{% endif %}
                {% if m.get('similarity') %}<span class="meta mt-1">{{ (m.get('similarity',0)*100)|round(1) }}%</span>{% endif %}
                <span class="text-muted justification">— {{ m.get('justification') or m.get('description') or 'Mapping created automatically.' }}</span>
                <input type="hidden" name="target_{{ loop.index0 }}" value="{{ m.target }}">
                <input type="hidden" name="target_type_{{ loop.index0 }}" value="{{ target_types.get(m.target,'') }}">
              </div>
            {% endif %}
          {% endfor %}
          {% if not any_legacy %}
            <div class="p-3 text-muted small">No Legacy mappings available.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="mt-4 d-flex justify-content-end">
    <button type="submit" class="btn btn-danger px-4">Next</button>
  </div>
</form>

<!-- Floating Chat Panel -->
<div class="card chat-float border-0">
  <div class="card-header bg-danger text-white py-2 d-flex justify-content-between align-items-center">
    <span class="small fw-semibold">Chatbot Assistant</span>
    <button class="btn btn-sm btn-light py-0 px-1" type="button" onclick="document.getElementById('chat-messages').classList.toggle('d-none')"><i class="bi bi-chevron-expand"></i></button>
  </div>
  <div class="card-body p-2" id="chat-messages">
    <div class="text-muted small">Ask about mapping decisions, lineage, or transformation logic...</div>
  </div>
  <div class="card-footer p-2">
    <form onsubmit="return sendMessage(event)" class="d-flex gap-1">
      <input type="text" class="form-control form-control-sm" id="chat-input" placeholder="Type question..." required>
      <button class="btn btn-danger btn-sm" type="submit">Send</button>
    </form>
    <button type="button" class="btn btn-outline-danger w-100 btn-sm mt-2" id="regenerate-btn">Regenerate Mapping</button>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<script>
async function sendMessage(e){ e.preventDefault(); const input=document.getElementById('chat-input'); const msg=input.value.trim(); if(!msg)return false; appendMessage('You',msg); input.value=''; try{ const res=await fetch('/poc4/chat',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'message='+encodeURIComponent(msg)}); const data=await res.json(); appendMessage('Bot',data.response);}catch(err){ appendMessage('Bot','(error)'); } return false; }
function appendMessage(sender,text){ const chat=document.getElementById('chat-messages'); const div=document.createElement('div'); div.className='mb-1'; div.innerHTML=`<strong>${sender}:</strong> ${text}`; chat.appendChild(div); chat.scrollTop=chat.scrollHeight; }
const regenBtn=document.getElementById('regenerate-btn');
if(regenBtn){ regenBtn.addEventListener('click', async ()=>{ try{ const res=await fetch('/poc4/auto_mapping'); if(!res.ok){ throw new Error('Failed'); } await res.json(); appendMessage('Bot','Regenerated mapping suggestions. Reload page to view.'); }catch(e){ appendMessage('Bot','Failed to regenerate mapping.'); } }); }
</script>
{% endblock %}
