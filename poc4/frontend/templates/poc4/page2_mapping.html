{% extends 'poc4/base.html' %}
{% block content %}
<!-- Banner -->
<div class="bg-danger text-white py-3 mb-4 rounded shadow-sm text-center">
  <h2 class="mb-0">POC4 Data Migration & Reconciliation</h2>
  <small>Modern Data Migration Workflow</small>
</div>

{% include 'poc4/_subnav.j2' %}
{% include 'poc4/_steps.j2' %}

<style>
  .nav-pills .nav-link {border-radius:2rem;margin:0 .25rem;font-weight:500;color:#d32f2f;background:#fff;border:1px solid #d32f2f;transition:.2s}
  .nav-pills .nav-link.active,.nav-pills .show>.nav-link{background:linear-gradient(90deg,#d32f2f 60%,#b71c1c);color:#fff !important;font-weight:700;box-shadow:0 2px 8px rgba(211,47,47,.1)}
  .map-row{border-bottom:1px solid #eee;padding:.35rem .5rem;white-space:normal;align-items:flex-start}
  .map-header{background:#fafafa;font-weight:600;border-bottom:2px solid #e3e3e3;}
  /* Allow full source/legacy field names to wrap instead of being cut */
  .map-row strong{flex:0 0 auto; min-width:170px; max-width:300px; white-space:normal; word-break:break-word}
  .map-row strong.text-truncate{overflow:visible!important; text-overflow:unset!important; white-space:normal!important}
  .map-row .target-table{flex:0 0 140px; max-width:160px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  .map-row .target-badge{flex:0 0 160px;display:inline-block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .map-row .justification{flex:1 1 auto;max-width:none;white-space:normal}
  .mapping-section .card-body{max-height:70vh;overflow:auto}
  .map-row .meta{font-size:.65rem;color:#555}
  /* Reposition chat to top-right to prevent overlap with navigation/Next buttons */
  .chat-float{position:fixed;right:1.25rem;top:6.5rem;z-index:1050;width:340px;box-shadow:0 4px 18px rgba(0,0,0,.15)}
  .chat-float .card-body{height:300px;overflow-y:auto}
  @media (max-width:1200px){.justification{max-width:260px}}
  @media (max-width:992px){.justification{display:none}}
</style>

<form method="post" id="mapping-form">
  <!-- Top action bar just below tabs -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-3">
      <span class="small text-muted">Filter origins:</span>
      <div class="form-check form-check-inline align-items-center d-flex gap-1">
        <input class="form-check-input" type="checkbox" id="filter-source">
        <label class="form-check-label" for="filter-source"><span class="badge bg-danger">DATA SOURCE 1</span></label>
        <button class="btn btn-xs btn-outline-secondary minimize-origin" type="button" data-origin="source" title="Minimize DS1 rows">–</button>
      </div>
      <div class="form-check form-check-inline align-items-center d-flex gap-1">
        <input class="form-check-input" type="checkbox" id="filter-legacy">
        <label class="form-check-label" for="filter-legacy"><span class="badge bg-dark">DATA SOURCE 2</span></label>
        <button class="btn btn-xs btn-outline-secondary minimize-origin" type="button" data-origin="legacy" title="Minimize DS2 rows">–</button>
      </div>
      <!-- Dynamic DS3+ chips -->
      {% set ns = namespace(extras=[]) %}
      {% for m in mapping %}
        {% set o = m.get('origin','source') %}
        {% if o not in ['source','legacy'] and o not in ns.extras %}
          {% set _ = ns.extras.append(o) %}
        {% endif %}
      {% endfor %}
      {% for o in ns.extras %}
      <div class="form-check form-check-inline align-items-center d-flex gap-1">
        <input class="form-check-input filter-extra" type="checkbox" id="filter-{{ o }}" data-origin="{{ o }}">
        <label class="form-check-label" for="filter-{{ o }}">
          {% if o[:2]|lower == 'ds' %}<span class="badge bg-secondary">DATA SOURCE {{ o[2:]|int }}</span>{% else %}<span class="badge bg-secondary">{{ o|upper }}</span>{% endif %}
        </label>
  <button class="btn btn-xs btn-outline-secondary minimize-origin" type="button" data-origin="{{ o }}" title="Minimize {{ o|upper }} rows">–</button>
      </div>
      {% endfor %}
    </div>
    <button type="submit" class="btn btn-danger px-4" id="next-btn">Next</button>
  </div>

  <div class="row g-4 mapping-section">
    <div class="col-12">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-light text-danger fw-bold d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-2">
            <button type="button" class="btn btn-sm btn-outline-danger collapse-btn" data-target="#map-body" aria-label="Collapse mappings">−</button>
            <span>Origin ➜ Target (Mapped Only)</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-secondary">COMBINED</span>
          </div>
        </div>
        <div class="card-body p-0" id="map-body">
          <div class="map-row map-header d-flex gap-2 small">
            <div style="width:90px" class="sort-header" data-key="origin">Origin</div>
            <div style="min-width:170px;max-width:300px;" class="sort-header" data-key="source">Field</div>
            <div style="width:16px"></div>
            <div class="target-table sort-header" data-key="target_table">Target Table</div>
            <div class="target-badge sort-header" data-key="target">Target Field</div>
            <div style="width:70px" class="sort-header" data-key="type">Type</div>
            <div style="width:55px" class="sort-header" data-key="similarity" title="Similarity %">Sim</div>
            <div class="flex-fill">Justification</div>
          </div>
          {% set any_any = false %}
          {% for m in mapping %}
            {% set origin = m.get('origin','source') %}
            {% if m.target %}
              {% set any_any = true %}
              <div class="map-row d-flex gap-2 small" data-origin="{{ origin }}" data-source="{{ m.source }}" data-target="{{ m.target }}" data-target_table="{{ m.target_table or '' }}" data-type="{{ target_types.get(m.target,'') }}" data-similarity="{{ (m.get('similarity',0)*100)|round(4) }}" title="{{ m.source }} ➜ {{ m.target }} :: {{ m.get('justification') or m.get('description') }}" style="display:none;">
                <span style="width:90px">
                  {% if origin=='source' %}
                    <span class="badge bg-danger">DATA SOURCE 1</span>
                  {% elif origin=='legacy' %}
                    <span class="badge bg-dark">DATA SOURCE 2</span>
                  {% elif origin[:2]|lower == 'ds' %}
                    <span class="badge bg-secondary">DATA SOURCE {{ origin[2:]|int }}</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ origin|upper }}</span>
                  {% endif %}
                </span>
                <strong class="text-truncate">{% if m.source_table %}{{ m.source_table }}.{% endif %}{{ m.source }}</strong>
                <i class="bi bi-arrow-right text-muted mt-1"></i>
                <span class="target-table text-muted small" title="{{ m.target_table or '' }}">{{ m.target_table or '' }}</span>
                <select class="form-select form-select-sm target-badge target-select" name="target_{{ loop.index0 }}" aria-label="Select target field" style="max-width:240px;" data-current="{{ m.target }}">
                  {% for tf in target_fields %}
                    <option value="{{ tf }}">{{ tf }}</option>
                  {% endfor %}
                </select>
                {% if target_types.get(m.target) %}<span class="badge bg-light text-dark border mt-1">{{ target_types.get(m.target) }}</span>{% endif %}
                {% if m.get('similarity') %}<span class="meta mt-1">{{ (m.get('similarity',0)*100)|round(1) }}%</span>{% endif %}
                <span class="text-muted justification">— {{ m.get('justification') or m.get('description') or 'Mapping created automatically.' }}</span>
                <input type="hidden" name="target_type_{{ loop.index0 }}" value="{{ target_types.get(m.target,'') }}">
              </div>
            {% endif %}
          {% endfor %}
          {% if not any_any %}
            <div class="p-3 text-muted small">No mappings available.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</form>

<!-- Floating Chat Panel -->
<div class="card chat-float border-0" id="chat-widget">
  <div class="card-header bg-danger text-white py-2 d-flex justify-content-between align-items-center">
    <span class="small fw-semibold d-flex align-items-center gap-1"><i class="bi bi-robot"></i> Chatbot Assistant</span>
    <button class="btn btn-sm btn-light py-0 px-1 d-flex align-items-center justify-content-center" id="chat-min-btn" type="button" aria-label="Minimize chat"><i class="bi bi-chevron-down" id="chat-min-icon"></i></button>
  </div>
  <div class="card-body p-2" id="chat-body">
    <div class="text-muted small" id="chat-messages">Ask about mapping decisions, lineage, or transformation logic...</div>
  </div>
  <div class="card-footer p-2" id="chat-footer">
    <form onsubmit="return sendMessage(event)" class="d-flex gap-1">
      <input type="text" class="form-control form-control-sm" id="chat-input" placeholder="Type question..." required>
      <button class="btn btn-danger btn-sm" type="submit">Send</button>
    </form>
    <button type="button" class="btn btn-outline-danger w-100 btn-sm mt-2" id="regenerate-btn">Regenerate Mapping</button>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<script id="target-types-json" type="application/json">{{ target_types | tojson | safe }}</script>
<script>
// Load target type map for client-side updates
try {
  const el = document.getElementById('target-types-json');
  window.__poc4TargetTypes = el ? JSON.parse(el.textContent) : {};
} catch(e){ window.__poc4TargetTypes = {}; }
async function sendMessage(e){ e.preventDefault(); const input=document.getElementById('chat-input'); const msg=input.value.trim(); if(!msg)return false; appendMessage('You',msg); input.value=''; try{ const res=await fetch('/poc4/chat',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'message='+encodeURIComponent(msg)}); const data=await res.json(); appendMessage('Bot',data.response);}catch(err){ appendMessage('Bot','(error)'); } return false; }
function appendMessage(sender,text){ const chat=document.getElementById('chat-messages'); const div=document.createElement('div'); div.className='mb-1'; div.innerHTML=`<strong>${sender}:</strong> ${text}`; chat.appendChild(div); chat.scrollTop=chat.scrollHeight; }
const regenBtn=document.getElementById('regenerate-btn');
if(regenBtn){ regenBtn.addEventListener('click', async ()=>{ try{ const res=await fetch('/poc4/auto_mapping'); if(!res.ok){ throw new Error('Failed'); } await res.json(); appendMessage('Bot','Regenerated mapping suggestions. Reload page to view.'); }catch(e){ appendMessage('Bot','Failed to regenerate mapping.'); } }); }
// Minimize / expand logic
function toggleChat(){ const body=document.getElementById('chat-body'); const footer=document.getElementById('chat-footer'); const icon=document.getElementById('chat-min-icon'); const hidden=body.style.display==='none'; body.style.display= hidden? 'block':'none'; footer.style.display= hidden? 'block':'none'; icon.classList.toggle('bi-chevron-down', !hidden); icon.classList.toggle('bi-chevron-up', hidden);} 
document.getElementById('chat-min-btn').addEventListener('click', toggleChat);

// --- Collapse logic for Combined section ---
document.querySelectorAll('.collapse-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const targetSel = btn.getAttribute('data-target');
    const bodyEl = document.querySelector(targetSel);
    if(!bodyEl) return;
    const hidden = bodyEl.style.display==='none';
    bodyEl.style.display = hidden? 'block':'none';
    btn.textContent = hidden? '−':'+';
  });
});

// --- Filter logic with persistence (no defaults for DS1/DS2; DS3+ default ON) ---
const filterSource = document.getElementById('filter-source');
const filterLegacy = document.getElementById('filter-legacy');
const extraFilters = Array.from(document.querySelectorAll('.filter-extra'));
const ORIGIN_FILTERS_KEY = 'poc4_origin_filters';
const ORIGIN_MIN_KEY = 'poc4_origin_min';

function loadFilterPrefs(){
  try{ return JSON.parse(localStorage.getItem(ORIGIN_FILTERS_KEY) || '{}') || {}; }catch(e){ return {}; }
}
function saveFilterPrefs(state){
  try{ localStorage.setItem(ORIGIN_FILTERS_KEY, JSON.stringify(state||{})); }catch(e){}
}
function currentFilterState(){
  const stored = loadFilterPrefs();
  const state = { ...stored };
  if(filterSource) state['source'] = !!filterSource.checked;
  if(filterLegacy) state['legacy'] = !!filterLegacy.checked;
  extraFilters.forEach(cb=>{ const o = (cb.dataset.origin||'').toLowerCase(); if(o){ state[o] = !!cb.checked; }});
  return state;
}
function applyStoredPrefs(){
  const stored = loadFilterPrefs();
  // DS1/DS2 default false when not stored
  if(filterSource){ filterSource.checked = !!stored['source']; }
  if(filterLegacy){ filterLegacy.checked = !!stored['legacy']; }
  // DS3+ default true when not stored
  extraFilters.forEach(cb=>{
    const o = (cb.dataset.origin||'').toLowerCase();
    cb.checked = (o in stored) ? !!stored[o] : true;
  });
}
function isOn(origin, state){
  const o = (origin||'').toLowerCase();
  if(o in state) return !!state[o];
  // default: extras ON, DS1/DS2 OFF
  return (o !== 'source' && o !== 'legacy');
}
function applyFilters(){
  const state = currentFilterState();
  document.querySelectorAll('#map-body .map-row[data-origin]').forEach(row=>{
    const origin = (row.getAttribute('data-origin') || '').toLowerCase();
    const ok = isOn(origin, state);
    row.style.display = ok? 'flex':'none';
  });
  saveFilterPrefs(state);
  // Re-apply minimize state so collapsed origins remain hidden
  try{ applyMin(); }catch(e){}
}
filterSource?.addEventListener('change', applyFilters);
filterLegacy?.addEventListener('change', applyFilters);
extraFilters.forEach(cb=> cb.addEventListener('change', applyFilters));
applyStoredPrefs();
applyFilters();

// --- Minimize per origin (collapse rows but keep filter state) ---
function getMin(){ try{ return JSON.parse(localStorage.getItem(ORIGIN_MIN_KEY)||'{}')||{}; }catch(e){ return {}; } }
function setMin(k,v){ try{ const s=getMin(); s[k]=!!v; localStorage.setItem(ORIGIN_MIN_KEY, JSON.stringify(s)); }catch(e){} }
function applyMin(){
  const s=getMin();
  document.querySelectorAll('#map-body .map-row[data-origin]').forEach(row=>{
    const o=(row.getAttribute('data-origin')||'').toLowerCase();
    const minimized = !!s[o];
    row.classList.toggle('collapsed-origin', minimized);
    row.style.maxHeight = minimized? '0' : '';
    row.style.overflow = minimized? 'hidden' : '';
    row.style.paddingTop = row.style.paddingBottom = minimized? '0' : '';
    row.style.margin = minimized? '0' : '';
  });
}
document.querySelectorAll('.minimize-origin').forEach(btn=>{
  btn.addEventListener('click', ()=>{ const o=(btn.dataset.origin||'').toLowerCase(); const s=getMin(); setMin(o, !s[o]); applyMin(); });
});
applyMin();

// --- Sorting logic (combined) ---
const sortState = {};
function sortRows(key){
  const container = document.getElementById('map-body');
  if(!container) return;
  const rows = Array.from(container.querySelectorAll(`.map-row[data-origin]`));
  if(!rows.length) return;
  const currentDir = sortState[key] === 'asc'? 'desc':'asc';
  sortState[key] = currentDir;
  rows.sort((a,b)=>{
    let av = a.getAttribute(`data-${key}`)||''; let bv = b.getAttribute(`data-${key}`)||'';
    // origin ordering: source before legacy if asc
    if(key==='origin'){
      av = (av||'').toLowerCase(); bv = (bv||'').toLowerCase();
      if(av===bv) return 0;
      return currentDir==='asc' ? (av==='source'? -1:1) : (av==='source'? 1:-1);
    }
    const anum = parseFloat(av); const bnum = parseFloat(bv);
    if(!isNaN(anum) && !isNaN(bnum)){
      return currentDir==='asc'? anum - bnum : bnum - anum;
    }
    av = (av||'').toLowerCase(); bv = (bv||'').toLowerCase();
    if(av < bv) return currentDir==='asc'? -1:1;
    if(av > bv) return currentDir==='asc'? 1:-1;
    return 0;
  });
  const header = container.querySelector('.map-header');
  rows.forEach(r=> container.appendChild(r));
  container.querySelectorAll('.sort-header').forEach(h=> h.classList.remove('sorted-asc','sorted-desc'));
  const activeHeader = container.querySelector(`.sort-header[data-key='${key}']`);
  if(activeHeader){ activeHeader.classList.add(currentDir==='asc'? 'sorted-asc':'sorted-desc'); }
}
document.querySelectorAll('.sort-header').forEach(h=>{
  h.style.cursor='pointer';
  h.addEventListener('click', ()=> sortRows(h.getAttribute('data-key')));
});

// Initialize target selects and keep hidden type in sync
document.querySelectorAll('.map-row').forEach(row=>{
  const sel = row.querySelector('select.target-select');
  if (!sel) return;
  const hiddenType = row.querySelector('input[name^="target_type_"]');
  const current = sel.getAttribute('data-current');
  if (current) {
    for (const opt of sel.options){ if (opt.value === current){ opt.selected = true; break; } }
  }
  sel.addEventListener('change', ()=>{
    // Look up type via data map printed server-side in a script tag if present; fallback: clear
    const typeMap = window.__poc4TargetTypes || {};
    const t = typeMap[sel.value] || '';
    if (hiddenType) hiddenType.value = t;
  });
});
</script>
{% endblock %}
