{% extends 'poc4/base.html' %}
{% block content %}
<div class="bg-danger text-white py-3 mb-4 rounded shadow-sm text-center">
  <h2 class="mb-0">Select Critical Fields</h2>
  <small>Choose key fields from Legacy, Source, and Target schemas</small>
</div>

{% include 'poc4/_subnav.j2' %}
{% include 'poc4/_steps.j2' %}
<form method="post" id="field-select-form">
  <!-- Top action bar -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <a href="{{ url_for('poc4.page1') }}" class="btn btn-outline-secondary">Back</a>
  <button type="submit" class="btn btn-danger" id="next-btn">Next</button>
  </div>
  <div class="row g-4">
    <div class="col-md-8">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-light text-danger fw-bold d-flex justify-content-between align-items-center">
          <div class="d-flex align-items-center gap-3">
            <span>Origin Fields</span>
            <span class="badge bg-light text-dark border">Source: {{ source_schema_file }}</span>
            <span class="badge bg-light text-dark border">Legacy: {{ legacy_schema_file }}</span>
          </div>
          <div class="d-flex align-items-center gap-3">
            <div class="form-check form-check-inline m-0 small">
              <input class="form-check-input" type="checkbox" id="filter-source">
              <label class="form-check-label" for="filter-source"><span class="badge bg-danger">SOURCE</span></label>
            </div>
            <div class="form-check form-check-inline m-0 small">
              <input class="form-check-input" type="checkbox" id="filter-legacy">
              <label class="form-check-label" for="filter-legacy"><span class="badge bg-dark">LEGACY</span></label>
            </div>
          </div>
        </div>
        <div class="card-body" style="max-height:60vh;overflow:auto;">
          <!-- Source section -->
      <div id="source-section" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-2">
  <span class="fw-semibold text-danger">Source ({{ source_schema_file }})</span>
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="p1b-min-source" type="button">Minimize</button>
                <div class="form-check m-0 small">
                  <input class="form-check-input" type="checkbox" id="select_all_source">
                  <label class="form-check-label" for="select_all_source">Select All</label>
                </div>
              </div>
            </div>
            <div id="p1b-body-source">
            {% for f in source_fields %}
            <div class="form-check small">
              <input class="form-check-input source-box" type="checkbox" name="source_field" value="{{ f.name }}" id="src_{{ loop.index }}">
              <label class="form-check-label" for="src_{{ loop.index }}">{{ f.table }}.{{ f.name }} <span class="badge bg-secondary">{{ f.type }}</span></label>
            </div>
            {% endfor %}
            {% if not source_fields %}<div class="text-muted small">No Source schema selected on Page 1.</div>{% endif %}
            <hr>
            </div>
          </div>
          <!-- Legacy section -->
      <div id="legacy-section" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-2">
  <span class="fw-semibold text-dark">Legacy ({{ legacy_schema_file }})</span>
              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="p1b-min-legacy" type="button">Minimize</button>
                <div class="form-check m-0 small">
                  <input class="form-check-input" type="checkbox" id="select_all_legacy">
                  <label class="form-check-label" for="select_all_legacy">Select All</label>
                </div>
              </div>
            </div>
            <div id="p1b-body-legacy">
            {% for f in legacy_fields %}
            <div class="form-check small">
              <input class="form-check-input legacy-box" type="checkbox" name="legacy_field" value="{{ f.name }}" id="leg_{{ loop.index }}">
              <label class="form-check-label" for="leg_{{ loop.index }}">{{ f.table }}.{{ f.name }} <span class="badge bg-secondary">{{ f.type }}</span></label>
            </div>
            {% endfor %}
            {% if not legacy_fields %}<div class="text-muted small">No Legacy schema selected on Page 1.</div>{% endif %}
            </div>
          </div>

          <!-- Extra Data Sources (DS3+) -->
          {% if extra_sources and extra_sources_fields %}
            {% for extra in extra_sources_fields %}
            <div id="extra-section-{{ extra.index }}" class="mb-3" style="display:none;">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-semibold text-danger">Data Source {{ extra.index + 3 }} ({{ extra.file }})</span>
                <div class="d-flex align-items-center gap-2">
                  <button class="btn btn-outline-secondary btn-sm" id="p1b-min-extra-{{ extra.index }}" type="button">Minimize</button>
                  <div class="form-check m-0 small">
                    <input class="form-check-input" type="checkbox" id="select_all_extra_{{ extra.index }}">
                    <label class="form-check-label" for="select_all_extra_{{ extra.index }}">Select All</label>
                  </div>
                </div>
              </div>
              <div id="p1b-body-extra-{{ extra.index }}">
              {% for f in extra.fields %}
              <div class="form-check small">
                <input class="form-check-input extra-box extra-idx-{{ extra.index }}" type="checkbox" name="extra_field::{{ extra.index }}" value="{{ f.name }}" id="ex_{{ extra.index }}_{{ loop.index }}">
                <label class="form-check-label" for="ex_{{ extra.index }}_{{ loop.index }}">{{ f.table }}.{{ f.name }} <span class="badge bg-secondary">{{ f.type }}</span></label>
              </div>
              {% endfor %}
              {% if not extra.fields %}<div class="text-muted small">No fields in this Data Source.</div>{% endif %}
              <hr>
              </div>
            </div>
            {% endfor %}
          {% endif %}
          </div>
        </div>
      </div>
    <div class="col-md-4">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-light text-danger fw-bold d-flex justify-content-between align-items-center">
          <span>Target ({{ target_schema_file }})</span>
          <div class="form-check m-0 small">
            <input class="form-check-input" type="checkbox" id="select_all_target">
            <label class="form-check-label" for="select_all_target">All</label>
          </div>
        </div>
        <div class="card-body" style="max-height:60vh;overflow:auto;">
          {% for f in target_fields %}
          <div class="form-check small">
            <input class="form-check-input target-box" type="checkbox" name="target_field" value="{{ f.name }}" id="tgt_{{ loop.index }}">
            <label class="form-check-label" for="tgt_{{ loop.index }}">{{ f.table }}.{{ f.name }} <span class="badge bg-secondary">{{ f.type }}</span></label>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
  <!-- ER Diagram Row -->
  <div class="row g-4 mt-4">
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-danger text-white py-2">Source ER Diagram</div>
        <div class="card-body p-2 small">
          <svg viewBox="0 0 320 200" class="w-100" style="max-height:190px">
            <style>.ent{fill:#fff;stroke:#d32f2f;stroke-width:1.2}.rel{stroke:#555;stroke-width:1.1;marker-end:url(#arrow)}</style>
            <defs><marker id="arrow" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto" fill="#555"><path d="M0,0 L6,3 L0,6 Z"/></marker></defs>
            <rect class="ent" x="10" y="10" width="90" height="40" rx="4"/><text x="55" y="35" font-size="10" text-anchor="middle">customer</text>
            <rect class="ent" x="120" y="10" width="90" height="40" rx="4"/><text x="165" y="35" font-size="10" text-anchor="middle">account</text>
            <rect class="ent" x="230" y="10" width="80" height="40" rx="4"/><text x="270" y="35" font-size="10" text-anchor="middle">transaction</text>
            <rect class="ent" x="120" y="80" width="90" height="40" rx="4"/><text x="165" y="105" font-size="10" text-anchor="middle">product</text>
            <line class="rel" x1="100" y1="30" x2="120" y2="30"/>
            <line class="rel" x1="210" y1="30" x2="230" y2="30"/>
            <line class="rel" x1="165" y1="50" x2="165" y2="80"/>
          </svg>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-danger text-white py-2">Legacy ER Diagram</div>
        <div class="card-body p-2 small">
          <svg viewBox="0 0 320 200" class="w-100" style="max-height:190px">
            <style>.ent{fill:#fff;stroke:#d32f2f;stroke-width:1.2}.rel{stroke:#555;stroke-width:1.1;marker-end:url(#arrow2)}</style>
            <defs><marker id="arrow2" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto" fill="#555"><path d="M0,0 L6,3 L0,6 Z"/></marker></defs>
            <rect class="ent" x="15" y="10" width="110" height="40" rx="4"/><text x="70" y="35" font-size="10" text-anchor="middle">legacy_customer</text>
            <rect class="ent" x="135" y="10" width="100" height="40" rx="4"/><text x="185" y="35" font-size="10" text-anchor="middle">legacy_account</text>
            <rect class="ent" x="245" y="10" width="70" height="40" rx="4"/><text x="280" y="35" font-size="10" text-anchor="middle">ledger</text>
            <line class="rel" x1="125" y1="30" x2="135" y2="30"/>
            <line class="rel" x1="235" y1="30" x2="245" y2="30"/>
          </svg>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-danger text-white py-2">Target ER Diagram</div>
        <div class="card-body p-2 small">
          <svg viewBox="0 0 320 160" class="w-100" style="max-height:160px">
            <style>.ent{fill:#fff;stroke:#d32f2f;stroke-width:1.2}.txt{font-size:11px}</style>
            <rect class="ent" x="40" y="30" width="240" height="70" rx="6"/>
            <text x="160" y="55" class="txt" text-anchor="middle">banking_olap_flat*</text>
            <text x="160" y="72" class="txt" text-anchor="middle">(denormalized unified view)</text>
          </svg>
          <div class="small text-muted">*Flattened star-less structure combining customer, account, transaction, product.</div>
        </div>
      </div>
    </div>
  </div>
</form>

<!-- Floating Chat Widget -->
<style>
  .floating-chat{position:fixed; top:90px; right:20px; width:340px; max-height:520px; z-index:1050; box-shadow:0 4px 18px rgba(0,0,0,.15)}
  .floating-chat .card-body{overflow-y:auto}
  @media (max-width: 992px){ .floating-chat{position:static; width:100%; max-height:none; margin-top:1rem} }
  .cmd-hint{font-size:.75rem; color:#6c757d}
  .cmd-hint code{background:#f8f9fa; padding:0 .2rem; border-radius:.2rem}
  .chat-min-btn{width:26px; height:26px}
  .chat-min-btn i{line-height:1}
  .chat-body-area{min-height:220px; max-height:340px}
  .small-muted{font-size:.85em; color:#6c757d}
</style>
<!-- Flags from server for pre-checking origin filters -->
<div id="p1b-flags" data-has-source="{% if source_fields|length > 0 %}1{% else %}0{% endif %}" data-has-legacy="{% if legacy_fields|length > 0 %}1{% else %}0{% endif %}" data-extra-count="{{ extra_sources|length if extra_sources else 0 }}" hidden></div>
<div class="card floating-chat" id="chat-widget">
  <div class="card-header bg-danger text-white py-2 d-flex justify-content-between align-items-center" style="cursor:move;">
    <span class="fw-semibold small d-flex align-items-center gap-1"><i class="bi bi-robot"></i> Assistant</span>
    <div class="d-flex align-items-center gap-1">
      <button class="btn btn-sm btn-light d-flex align-items-center justify-content-center chat-min-btn" id="chat-min-btn" type="button" aria-label="Minimize chat">
        <i class="bi bi-chevron-down" id="chat-min-icon"></i>
      </button>
    </div>
  </div>
  <div class="card-body p-2 chat-body-area" id="chat-body">
    <div id="chat-messages" class="small-muted">Commands: <code>select all source</code>, <code>deselect all legacy</code>, <code>select all target</code>, <code>next</code></div>
  </div>
  <div class="card-footer p-2" id="chat-footer">
    <form id="chat-form" onsubmit="return sendMessage(event);">
      <div class="input-group input-group-sm">
        <input type="text" class="form-control" id="chat-input" placeholder="Type command or question..." required>
        <button class="btn btn-danger" type="submit">Send</button>
      </div>
    </form>
  </div>
  <div class="px-2 pb-2 cmd-hint">Try <code>select all source</code> or <code>deselect all target</code></div>
  
</div>

<script>
// Select all handlers
function bindSelectAll(masterId, boxClass){
  const master=document.getElementById(masterId);
  if(!master) return;
  master.addEventListener('change',()=>{
    document.querySelectorAll('.'+boxClass).forEach(cb=>{ cb.checked=master.checked; });
  });
}
bindSelectAll('select_all_source','source-box');
bindSelectAll('select_all_legacy','legacy-box');
bindSelectAll('select_all_target','target-box');
// Bind for extra DS groups
try{
  const extraCount = parseInt(document.getElementById('p1b-flags')?.dataset.extraCount || '0');
  for(let i=0;i<extraCount;i++){
    const id = `select_all_extra_${i}`;
    const cls = `extra-idx-${i}`;
    bindSelectAll(id, cls);
  }
}catch(e){}

// Chat helpers
function toggleChatBody(){
  const body=document.getElementById('chat-body');
  const footer=document.getElementById('chat-footer');
  const icon=document.getElementById('chat-min-icon');
  const hidden = body.style.display==='none';
  body.style.display = hidden ? 'block':'none';
  footer.style.display = hidden ? 'block':'none';
  if(icon){ icon.classList.toggle('bi-chevron-down', hidden===false); icon.classList.toggle('bi-chevron-up', hidden===true); }
}
document.getElementById('chat-min-btn')?.addEventListener('click', toggleChatBody);
// Start minimized
toggleChatBody();

// Origin filter toggles (no defaults)
const filterSource = document.getElementById('filter-source');
const filterLegacy = document.getElementById('filter-legacy');
const sourceSection = document.getElementById('source-section');
const legacySection = document.getElementById('legacy-section');
function applyFilters(){
  const showSource = !!filterSource?.checked;
  const showLegacy = !!filterLegacy?.checked;
  if(sourceSection) sourceSection.style.display = showSource? 'block':'none';
  if(legacySection) legacySection.style.display = showLegacy? 'block':'none';
  // Toggle extra sections
  try{
    const extraCount = parseInt(document.getElementById('p1b-flags')?.dataset.extraCount || '0');
    for(let i=0;i<extraCount;i++){
      const sec = document.getElementById(`extra-section-${i}`);
      if(sec) sec.style.display = (showSource || showLegacy) ? 'block' : 'block'; // keep visible when any origin is shown; can refine with per-DS toggles later
    }
  }catch(e){}
}
filterSource?.addEventListener('change', applyFilters);
filterLegacy?.addEventListener('change', applyFilters);
// Pre-check filters based on whether fields are present (reflecting Page 1 enablement)
try{
  const flagsEl = document.getElementById('p1b-flags');
  const hasSource = flagsEl ? flagsEl.dataset.hasSource === '1' : false;
  const hasLegacy = flagsEl ? flagsEl.dataset.hasLegacy === '1' : false;
  if(filterSource) filterSource.checked = !!hasSource;
  if(filterLegacy) filterLegacy.checked = !!hasLegacy;
}catch(e){}
applyFilters();

// Minimize state (Page 1b)
const P1B_MIN_KEY = 'poc4_p1b_min';
function getMinState(){ try{ return JSON.parse(localStorage.getItem(P1B_MIN_KEY)||'{}')||{}; }catch(e){ return {}; } }
function setMinState(key, val){ try{ const s = getMinState(); s[key] = !!val; localStorage.setItem(P1B_MIN_KEY, JSON.stringify(s)); }catch(e){} }
function applyMinState(key, bodyEl, btn){ const s=getMinState(); const minimized=!!s[key]; if(bodyEl){ bodyEl.style.display = minimized? 'none':'block'; } if(btn){ btn.textContent = minimized? 'Expand':'Minimize'; } }
// Wire buttons
(function(){
  const sBtn = document.getElementById('p1b-min-source');
  const sBody = document.getElementById('p1b-body-source');
  if(sBtn && sBody){ applyMinState('source', sBody, sBtn); sBtn.addEventListener('click', ()=>{ const s=getMinState(); const cur=!!s['source']; setMinState('source', !cur); applyMinState('source', sBody, sBtn); }); }
  const lBtn = document.getElementById('p1b-min-legacy');
  const lBody = document.getElementById('p1b-body-legacy');
  if(lBtn && lBody){ applyMinState('legacy', lBody, lBtn); lBtn.addEventListener('click', ()=>{ const s=getMinState(); const cur=!!s['legacy']; setMinState('legacy', !cur); applyMinState('legacy', lBody, lBtn); }); }
  try{
    const extraCount = parseInt(document.getElementById('p1b-flags')?.dataset.extraCount || '0');
    for(let i=0;i<extraCount;i++){
      const btn = document.getElementById(`p1b-min-extra-${i}`);
      const body = document.getElementById(`p1b-body-extra-${i}`);
      const key = `extra-${i}`;
      if(btn && body){ applyMinState(key, body, btn); btn.addEventListener('click', ()=>{ const s=getMinState(); const cur=!!s[key]; setMinState(key, !cur); applyMinState(key, body, btn); }); }
    }
  }catch(e){}
})();

function setAllByChat(masterId, boxClass, checked){
  const master=document.getElementById(masterId);
  if(master){ master.checked = checked; master.dispatchEvent(new Event('change')); }
  else { document.querySelectorAll('.'+boxClass).forEach(cb=> cb.checked = checked); }
}

async function sendMessage(e){
  e.preventDefault();
  const input=document.getElementById('chat-input');
  const msg=input.value.trim();
  if(!msg) return false;
  appendMessage('You', msg);
  input.value='';
  const lower = msg.toLowerCase();
  // Commands
  if(lower.includes('select all source')){ setAllByChat('select_all_source','source-box', true); }
  if(lower.includes('deselect all source') || lower.includes('unselect all source')){ setAllByChat('select_all_source','source-box', false); }
  if(lower.includes('select all legacy')){ setAllByChat('select_all_legacy','legacy-box', true); }
  if(lower.includes('deselect all legacy') || lower.includes('unselect all legacy')){ setAllByChat('select_all_legacy','legacy-box', false); }
  if(lower.includes('select all target')){ setAllByChat('select_all_target','target-box', true); }
  if(lower.includes('deselect all target') || lower.includes('unselect all target')){ setAllByChat('select_all_target','target-box', false); }
  if(lower==='next' || lower==='go next' || lower==='continue'){
    document.getElementById('field-select-form')?.submit();
    return false;
  }
  // Fall back to server-side chat
  try{
    const res= await fetch('/poc4/chat',{method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:'message='+encodeURIComponent(msg)});
    const data= await res.json(); appendMessage('Bot', data.response);
  }catch(err){ appendMessage('Bot','(error)'); }
  return false;
}
function appendMessage(sender,text){ const chat=document.getElementById('chat-messages'); const div=document.createElement('div'); div.innerHTML=`<strong>${sender}:</strong> ${text}`; chat.appendChild(div); chat.scrollTop=chat.scrollHeight; }
</script>
{% endblock %}
