{% extends 'poc4/base.html' %}
{% block content %}
<!-- Banner -->
<div class="bg-danger text-white py-3 mb-4 rounded shadow-sm text-center">
  <h2 class="mb-0">Data Modelling, Migration & Reconciliation</h2>
  <small>Modern Data Migration Workflow</small>
</div>

<!-- Convenience: Back to Upload button (anchors to same page) -->
<div class="mb-3">
  <a href="{{ url_for('poc4.page1') }}" class="btn btn-outline-secondary btn-sm">
    <i class="bi bi-arrow-left"></i> Back to Upload
  </a>
  <span class="text-muted small ms-2">Returns to the Upload tab without changing the URL.</span>
  </div>

{% include 'poc4/_subnav.j2' %}

<style>
  /* Reposition chat to top-right to avoid covering form buttons */
  .floating-chat{position:fixed; top:90px; right:20px; width:340px; max-height:520px; z-index:1050; box-shadow:0 4px 18px rgba(0,0,0,.15)}
  .floating-chat .card-body{overflow-y:auto}
  @media (max-width: 992px){ .floating-chat{position:static; width:100%; max-height:none; margin-top:1rem} }
  /* Target column visual separation */
  .target-col .section-box{border:1px solid #e9ecef; border-left:4px solid #d32f2f; border-radius:.5rem; padding:.75rem; background:#fafafa}
  .target-col .section-box + .section-box{margin-top: .75rem}
  .target-col .section-box .form-text{margin-top:.25rem}
  /* Schema preview tables */
  .schema-preview-table{font-size:.85rem}
  .schema-preview-table th{position:sticky; top:0; background:#f8f9fa}
  .schema-preview-table td, .schema-preview-table th{padding:.35rem .5rem}
  .schema-preview-table{table-layout:auto; width:auto; max-width:100%}
  .schema-preview-table th:nth-child(2), .schema-preview-table td:nth-child(2){white-space:nowrap; width:1%}
  .schema-preview-wrap{max-height:260px; overflow:auto; max-width:760px}
  /* Allow full width in Column 1 */
  .origins-col .schema-preview-wrap{max-width:100%}
  .schema-preview-wrap .table-responsive{display:inline-block; width:auto; max-width:100%}
  /* Column 1 schema mini-containers */
  .origins-col .schema-card{border:1px solid #eee; border-left:4px solid #adb5bd; border-radius:.5rem; background:#fff}
  .origins-col .schema-card + .schema-card{margin-top:.5rem}
  .origins-col .schema-card-header{padding:.4rem .6rem; border-bottom:1px solid #f1f3f5}
  .origins-col .schema-card-body{padding:.5rem .6rem}
  .origins-col .accent-source{border-left-color:#d32f2f; background:#fff8f8}
  .origins-col .accent-legacy{border-left-color:#212529; background:#f8f9fa}
  .origins-col .accent-ds{border-left-color:#0d6efd; background:#f7faff}
  /* ER diagram container */
  .er-diagram-wrap{max-height:320px; overflow:auto; background:#fff; border:1px dashed #e9ecef; border-radius:.5rem; padding:.5rem}
  .schema-card .er-help{font-size:.8rem; color:#6c757d}
  /* Grid layout: compact left (tables), flexible right (ER) */
  .schema-grid{display:grid; grid-template-columns: minmax(240px, 340px) 1fr; gap:.5rem; align-items:start}
  .schema-grid-left{min-width:0}
  .schema-grid-right{min-width:0}
  @media (max-width: 992px){ .schema-grid{grid-template-columns:1fr} }
  /* Make ER diagram scale to available width */
  .er-diagram-wrap .mermaid{width:100%;}
  .er-diagram-wrap svg{max-width:100% !important; height:auto !important;}
</style>
{% include 'poc4/_steps.j2' %}

<!-- Top-right Help -->
<div class="d-flex justify-content-end mb-2">
  <button type="button" class="btn btn-help btn-sm" data-bs-toggle="modal" data-bs-target="#helpModalP1" aria-label="Help about Upload & Enablement">
    <i class="bi bi-question-circle-fill"></i>
    Help
  </button>
</div>

<form method="post" enctype="multipart/form-data" id="upload-form">
  <div class="row g-4">
    <!-- Combined Origins Column (Source + Legacy) -->
  <div class="col-lg-7 col-md-7 origins-col">
      <div class="card h-100 shadow-sm">
  <div class="card-header bg-light text-danger fw-bold d-flex justify-content-between align-items-center">
  <span>Origin Systems</span>
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-sm btn-outline-danger" type="button" id="add-datasource-btn" title="Add another Data Source">Add Data Source</button>
    </div>
  </div>
        <div class="card-body">
      <div class="mb-3">
            <label class="form-label">Select origin schemas (multiple allowed)</label>
            <div class="form-check form-check-inline">
      <input class="form-check-input" type="checkbox" id="source-enable" name="enable_source">
    <label class="form-check-label" for="source-enable">Source (Relational)</label>
    <button type="button" class="btn btn-sm btn-outline-danger ms-2" id="source-add-top" title="Add new Source schema">Add</button>
            </div>
            <div class="form-check form-check-inline">
      <input class="form-check-input" type="checkbox" id="legacy-enable" name="enable_legacy">
    <label class="form-check-label" for="legacy-enable">Legacy (Mainframe)</label>
    <button type="button" class="btn btn-sm btn-outline-danger ms-2" id="legacy-add-top" title="Add new Legacy schema">Add</button>
            </div>
          </div>
      <!-- Hidden file inputs for top-level quick add -->
      <input type="file" class="d-none" id="source-schema-upload-top" accept="application/json">
      <input type="file" class="d-none" id="legacy-schema-upload-top" accept="application/json">
          <!-- Source selector (shown when checked) -->
          <div id="source-section" class="mb-3" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label class="form-label m-0">Source Schema</label>
              <button class="btn btn-sm btn-outline-secondary" type="button" id="source-min-btn" title="Minimize this section">Minimize</button>
            </div>
            <div id="source-body">
            <div class="input-group mb-2">
              <select class="form-select" id="source-schema-select" name="source_schema">
                <option value="" selected disabled>Loading…</option>
              </select>
              <button class="btn btn-outline-secondary" type="button" id="source-rename-btn" title="Rename selected schema">Rename</button>
              <button class="btn btn-outline-danger" type="button" id="source-delete-btn" title="Delete selected schema">Delete</button>
              <button class="btn btn-outline-danger" type="button" id="source-add-btn" title="Add a new schema to the list">Add</button>
            </div>
              <input type="file" class="d-none" id="source-schema-upload" accept="application/json" aria-label="Upload custom Source schema JSON">
              <div class="form-text" id="source-upload-hint">Use Add to upload and register a JSON schema.</div>
            <div class="mt-2 schema-preview-wrap" id="source-schema-fields" data-origin="source"></div>
            </div>
          </div>
          <!-- Legacy selector (shown when checked) -->
          <div id="legacy-section" class="mb-3" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label class="form-label m-0">Legacy Schema</label>
              <button class="btn btn-sm btn-outline-secondary" type="button" id="legacy-min-btn" title="Minimize this section">Minimize</button>
            </div>
            <div id="legacy-body">
            <div class="input-group mb-2">
              <select class="form-select" id="legacy-schema-select" name="legacy_schema">
                <option value="" selected disabled>Loading…</option>
              </select>
              <button class="btn btn-outline-secondary" type="button" id="legacy-rename-btn" title="Rename selected schema">Rename</button>
              <button class="btn btn-outline-danger" type="button" id="legacy-delete-btn" title="Delete selected schema">Delete</button>
              <button class="btn btn-outline-danger" type="button" id="legacy-add-btn" title="Add a new schema to the list">Add</button>
            </div>
              <input type="file" class="d-none" id="legacy-schema-upload" accept="application/json" aria-label="Upload custom Legacy schema JSON">
              <div class="form-text" id="legacy-upload-hint">Use Add to upload and register a JSON schema.</div>
            <div class="mt-2 schema-preview-wrap" id="legacy-schema-fields" data-origin="legacy"></div>
            </div>
          </div>

          <!-- Dynamic extra data sources will be appended here -->
          <div id="extra-ds-container"></div>
        </div>
      </div>
    </div>
    <!-- Target Column -->
    <div class="col-lg-5 col-md-5 target-col">
      <div class="card h-100 shadow-sm">
  <div class="card-header bg-light text-danger fw-bold d-flex justify-content-between align-items-center">Target</div>
        <div class="card-body">
          <!-- Target mode selection -->
          <div class="mb-3 section-box target-mode-container">
            <label class="form-label mb-1">Target Mapping Mode</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="target_mode" id="target-mode-existing" value="existing">
              <label class="form-check-label" for="target-mode-existing">Map to Existing Target Schema</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="target_mode" id="target-mode-create" value="create">
              <label class="form-check-label" for="target-mode-create">Create Target Schema and Map</label>
            </div>
            <div class="small text-muted mt-1">Choose how you want to proceed: use an existing target schema, or design a new one and we’ll map for you.</div>
          </div>
          <!-- Distinct Section: Create Target Schema and Map -->
          <div id="create-target-container" class="mb-3 section-box">
            <fieldset id="create-target-fieldset" disabled>
              <div class="mb-2">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <label class="form-label m-0">Create Target Schema and Map</label>
                  <span class="badge bg-warning text-dark">Design New</span>
                </div>
                <div class="small text-muted mb-2">Design a new target model tailored to your selected origin schemas, then proceed to mapping automatically.</div>
                <button type="button" id="design-model-btn" class="btn btn-warning w-100">Design Target Model</button>
                <div class="form-text small mt-2">Saves selections, then opens the Target Model page and auto-generates a draft.</div>
              </div>
            </fieldset>
          </div>
          <!-- Distinct Section: Map to Existing Target Schema -->
      <div id="existing-target-container" class="mb-3 section-box">
            <fieldset id="existing-target-fieldset" disabled>
              <div class="mb-2">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <label class="form-label m-0">Map to Existing Target Schema</label>
                  <span class="badge bg-secondary">Use Existing</span>
                </div>
                <div class="small text-muted mb-2">Pick an existing target schema JSON, then continue to the Mapping step.</div>
                <div class="input-group mb-2">
                  <select class="form-select" id="target-schema-select" name="target_schema" required>
                    <option value="" selected disabled>Loading…</option>
                  </select>
                  <button class="btn btn-outline-secondary" type="button" id="target-rename-btn" title="Rename selected schema">Rename</button>
                  <button class="btn btn-outline-danger" type="button" id="target-delete-btn" title="Delete selected schema">Delete</button>
                  <!-- Move Next: Mapping into the same row -->
                  <button type="submit" class="btn btn-danger ms-2" id="next-btn" title="Proceed to Mapping">Next: Mapping</button>
                </div>
                <div class="input-group mt-2">
                  <input type="file" class="form-control" id="target-schema-upload" accept="application/json" aria-label="Upload custom Target schema JSON">
                  <button class="btn btn-outline-danger" type="button" id="target-add-btn" title="Add this schema to the list">Add to list</button>
                </div>
                <div class="form-text" id="target-upload-hint">Upload a JSON schema file, then click Add to register it.</div>
              </div>
        <div id="target-schema-fields" class="schema-preview-wrap"></div>
            </fieldset>
          </div>
          <hr>
        </div>
      </div>
    </div>
  </div>
  
</form>

<!-- Floating Chat Widget -->
  <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    try { mermaid.initialize({ startOnLoad: false, theme: 'default' }); } catch(e){}
    // Optional: re-render on theme changes could go here
  </script>
<script id="extra-sources-json" type="application/json">{{ (extra_sources or []) | tojson | safe }}</script>
{% include 'poc4/_chatpanel.j2' %}

<script>
// Page-specific ChatPanel command handler
window.handleChatCommand = function(cmd, api){
  const t = (cmd||'').trim().toLowerCase();
  const by = {
    source: {master:'select_all_source', cls:'.source-box'},
    legacy: {master:'select_all_legacy', cls:'.legacy-box'},
    target: {master:'select_all_target', cls:'.target-box'}
  };
  function setAll(kind, checked){
    const m = by[kind]; if(!m) return;
    const master = document.getElementById(m.master);
    if(master){ master.checked = checked; master.dispatchEvent(new Event('change')); }
    else { document.querySelectorAll(m.cls).forEach(cb=> cb.checked = checked); }
  }
  // Navigation
  if(['next','go next','continue'].includes(t)){
    api.append('assistant','Proceeding to Mapping…');
    api.setLastAction(()=> document.getElementById('next-btn')?.click());
    return true;
  }
  if(['design','design target','design model'].includes(t)){
    api.append('assistant','Opening Target Model designer…');
    api.setLastAction(()=> document.getElementById('design-model-btn')?.click());
    return true;
  }
  // Mode toggle
  if(t.includes('map to existing')){
    api.append('assistant','Switching to "Map to Existing Target Schema"');
    api.setLastAction(()=>{ const r=document.getElementById('target-mode-existing'); if(r){ r.checked=true; r.dispatchEvent(new Event('change')); } });
    return true;
  }
  if(t.includes('create target')){
    api.append('assistant','Switching to "Create Target Schema and Map"');
    api.setLastAction(()=>{ const r=document.getElementById('target-mode-create'); if(r){ r.checked=true; r.dispatchEvent(new Event('change')); } });
    return true;
  }
  // Selections
  if(t.startsWith('select all ')){
    if(t.endsWith('source')){ api.append('assistant','Will select all Source fields'); api.setLastAction(()=> setAll('source', true)); return true; }
    if(t.endsWith('legacy')){ api.append('assistant','Will select all Legacy fields'); api.setLastAction(()=> setAll('legacy', true)); return true; }
    if(t.endsWith('target')){ api.append('assistant','Will select all Target fields'); api.setLastAction(()=> setAll('target', true)); return true; }
  }
  if(t.startsWith('deselect all ') || t.startsWith('unselect all ')){
    if(t.endsWith('source')){ api.append('assistant','Will deselect all Source fields'); api.setLastAction(()=> setAll('source', false)); return true; }
    if(t.endsWith('legacy')){ api.append('assistant','Will deselect all Legacy fields'); api.setLastAction(()=> setAll('legacy', false)); return true; }
    if(t.endsWith('target')){ api.append('assistant','Will deselect all Target fields'); api.setLastAction(()=> setAll('target', false)); return true; }
  }
  // Show/hide sections
  if(t.includes('minimize source')){ api.append('assistant','Will minimize Source section'); api.setLastAction(()=> document.getElementById('source-min-btn')?.click()); return true; }
  if(t.includes('minimize legacy')){ api.append('assistant','Will minimize Legacy section'); api.setLastAction(()=> document.getElementById('legacy-min-btn')?.click()); return true; }
  if(t.includes('expand source')){ api.append('assistant','Will expand Source section'); api.setLastAction(()=>{ const b=document.getElementById('source-min-btn'); const s=localStorage.getItem('poc4_p1_min')||'{}'; if(b && JSON.parse(s).source){ b.click(); } }); return true; }
  if(t.includes('expand legacy')){ api.append('assistant','Will expand Legacy section'); api.setLastAction(()=>{ const b=document.getElementById('legacy-min-btn'); const s=localStorage.getItem('poc4_p1_min')||'{}'; if(b && JSON.parse(s).legacy){ b.click(); } }); return true; }
  return false;
};

async function loadSchema(file,target){ try{ const res= await fetch(`/poc4/static_schema/schemas/${file}`); const schema= await res.json(); renderSchemaFields(schema,target);}catch(e){ document.getElementById(target).innerHTML='<div class="text-danger">Failed to load schema.</div>'; }}
function renderSchemaFields(schema,target){
  const el = document.getElementById(target);
  if(!el){ return; }
  const origin = (el.getAttribute('data-origin')||'').toLowerCase();
  const accentClass = origin==='source' ? 'accent-source' : (origin==='legacy' ? 'accent-legacy' : (origin==='ds' ? 'accent-ds' : ''));
  let tablesHtml='';
  if(schema.tables && Array.isArray(schema.tables)){
    schema.tables.forEach(t=>{
      const fieldCount = (t.fields||[]).length;
      tablesHtml += `
        <div class="schema-card ${accentClass}">
          <div class="schema-card-header d-flex justify-content-between align-items-center">
            <div class="fw-semibold small text-uppercase">${t.name}</div>
            <span class="badge bg-light text-secondary border">${fieldCount} fields</span>
          </div>
          <div class="schema-card-body">
            <div class="small text-muted mb-2">Fields defined for ${t.name}. Review types before proceeding.</div>
            <div class="table-responsive">
              <table class="table table-sm table-striped schema-preview-table mb-0">
                <thead><tr><th>Field</th><th>Type</th></tr></thead>
                <tbody>
                  ${(t.fields||[]).map(f=>`<tr><td class="text-wrap">${f.name}</td><td><span class="badge bg-danger">${f.type}</span></td></tr>`).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>`;
    });
  }
  const er = schemaToMermaidER(schema);
  const erCard = `
    <div class="schema-card ${accentClass}">
      <div class="schema-card-header d-flex justify-content-between align-items-center">
        <div class="fw-semibold small text-uppercase">ER Diagram</div>
        <span class="er-help">Auto-generated from schema tables</span>
      </div>
      <div class="schema-card-body">
        <div class="er-diagram-wrap"><div class="mermaid">${er}</div></div>
      </div>
    </div>`;
  const html = `
    <div class="schema-grid">
      <div class="schema-grid-left">${tablesHtml || '<div class="text-muted small">No tables found in schema.</div>'}</div>
      <div class="schema-grid-right">${erCard}</div>
    </div>`;
  el.innerHTML = html;
  // Try rendering Mermaid diagrams if available
  try{
    if(window.mermaid && typeof window.mermaid.init === 'function'){
      window.mermaid.init(undefined, el.querySelectorAll('.mermaid'));
    }
  }catch(e){}
}

// Build a Mermaid ER diagram from schema JSON
function schemaToMermaidER(schema){
  const lines = ['erDiagram'];
  const tables = Array.isArray(schema?.tables) ? schema.tables : [];
  tables.forEach(t=>{
    lines.push(`  ${safeIdent(t.name)} {`);
    (t.fields||[]).forEach(f=>{
      lines.push(`    ${mapType(f.type)} ${safeIdent(f.name)}`);
    });
    lines.push('  }');
  });
  // Relationships not present in schema; omitted
  return lines.join('\n');
}
function safeIdent(name){
  return String(name||'UNKNOWN').replace(/[^A-Za-z0-9_]/g,'_');
}
function mapType(t){
  const s = String(t||'string').toLowerCase();
  if(s.includes('int')) return 'int';
  if(s.includes('char')||s.includes('text')||s.includes('string')) return 'string';
  if(s.includes('date')||s.includes('time')) return 'datetime';
  if(s.includes('bool')) return 'boolean';
  if(s.includes('dec')||s.includes('num')||s.includes('float')||s.includes('double')) return 'float';
  return 'string';
}

// Toggle Source/Legacy sections via checkboxes
const sourceEnable = document.getElementById('source-enable');
const legacyEnable = document.getElementById('legacy-enable');
const sourceSection = document.getElementById('source-section');
const legacySection = document.getElementById('legacy-section');
if (sourceEnable) sourceEnable.addEventListener('change', ()=>{ sourceSection.style.display = sourceEnable.checked ? 'block':'none'; });
if (legacyEnable) legacyEnable.addEventListener('change', ()=>{ legacySection.style.display = legacyEnable.checked ? 'block':'none'; });

['source','legacy','target'].forEach(kind=>{ const sel=document.getElementById(`${kind}-schema-select`); if(sel){ sel.addEventListener('change',()=>{ const val = sel.value; if(val){ loadSchema(val, `${kind}-schema-fields`); }}); }});
['source','legacy','target'].forEach(kind=>{ const up=document.getElementById(`${kind}-schema-upload`); if(up){ up.addEventListener('change', e=>{ const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=evt=>{ try{ const schema=JSON.parse(evt.target.result); renderSchemaFields(schema, `${kind}-schema-fields`);}catch(err){ document.getElementById(`${kind}-schema-fields`).innerHTML='<div class=\"text-danger\">Invalid JSON file.</div>'; } }; reader.readAsText(file); }); }});

// Initial load: do not auto-load any schemas; wait for user selection

// Add-to-list uploader for Source/Legacy
async function addSchemaToList(kind){
  const fileInput = document.getElementById(`${kind}-schema-upload`);
  const selectEl = document.getElementById(`${kind}-schema-select`);
  const hintEl = document.getElementById(`${kind}-upload-hint`);
  if(!fileInput || !fileInput.files || !fileInput.files[0]){
    if(hintEl) hintEl.textContent = 'Please choose a JSON file first.';
    return;
  }
  const fd = new FormData();
  fd.append('schemaFile', fileInput.files[0]);
  // Optional: suggested name
  fd.append('name', fileInput.files[0].name || `${kind}_schema.json`);
  // Tag kind for categorized lists
  fd.append('kind', kind === 'source' ? 'source' : (kind === 'legacy' ? 'legacy' : (kind === 'target' ? 'target' : '')));
  try{
    const res = await fetch('/poc4/upload_schema', { method:'POST', body: fd });
    const data = await res.json();
    if(!data.ok){ throw new Error(data.error || 'Upload failed'); }
    const fname = data.filename;
    if(selectEl){
      // Insert option if not exists
      let opt = Array.from(selectEl.options).find(o=>o.value===fname);
      if(!opt){ opt = document.createElement('option'); opt.value = fname; opt.textContent = fname; selectEl.appendChild(opt); }
      selectEl.value = fname;
      // Trigger field preview load
      loadSchema(fname, `${kind}-schema-fields`);
    }
    if(hintEl){ hintEl.textContent = `Added ${fname} to the list.`; }
  }catch(e){
    if(hintEl){ hintEl.textContent = `Add failed: ${e.message || e}`; }
  }
}
// Add buttons near selects
document.getElementById('source-add-btn')?.addEventListener('click', ()=> document.getElementById('source-schema-upload')?.click());
document.getElementById('legacy-add-btn')?.addEventListener('click', ()=> document.getElementById('legacy-schema-upload')?.click());
document.getElementById('target-add-btn')?.addEventListener('click', ()=> document.getElementById('target-schema-upload')?.click());
// When a file is chosen, upload and register
['source','legacy','target'].forEach(kind=>{
  const up = document.getElementById(`${kind}-schema-upload`);
  if(!up) return;
  up.addEventListener('change', ()=> addSchemaToList(kind));
});

// Rename selected schema option (safe server-side rename)
async function renameSelected(kind){
  const sel = document.getElementById(`${kind}-schema-select`);
  if(!sel || !sel.value){ return; }
  const oldName = sel.value;
  const proposed = prompt('New schema name (with or without .json):', oldName);
  if(!proposed){ return; }
  const fd = new FormData();
  fd.append('oldName', oldName);
  fd.append('newName', proposed);
  try{
    const res = await fetch('/poc4/rename_schema', { method:'POST', body: fd });
    const data = await res.json();
    if(!data.ok){ throw new Error(data.error || 'Rename failed'); }
    const newFile = data.filename;
    // Update select option
    let opt = Array.from(sel.options).find(o=>o.value===oldName);
    if(opt){ opt.value = newFile; opt.textContent = newFile; }
    sel.value = newFile;
  }catch(e){ alert(`Rename failed: ${e.message || e}`); }
}
document.getElementById('source-rename-btn')?.addEventListener('click', ()=> renameSelected('source'));
document.getElementById('legacy-rename-btn')?.addEventListener('click', ()=> renameSelected('legacy'));
document.getElementById('target-rename-btn')?.addEventListener('click', ()=> renameSelected('target'));

// Dynamic schema list loader for base kinds and any extra DS selects
async function populateSchemaSelects(){
  try{
    const res = await fetch('/poc4/list_schemas');
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || 'Failed to load schema list');
    const byKind = data.filesByKind || { source:[], legacy:[], target:[], uncategorized:[] };
    const fillSelect = (sel, files)=>{
      if(!sel) return;
      const current = sel.value;
      sel.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.disabled = true;
      placeholder.selected = true;
      placeholder.textContent = 'Select schema…';
      sel.appendChild(placeholder);
      (files || []).forEach(f=>{
        const opt = document.createElement('option');
        opt.value = f; opt.textContent = f;
        sel.appendChild(opt);
      });
    };
    ['source','legacy','target'].forEach(kind=>{
      const sel = document.getElementById(`${kind}-schema-select`);
      if(!sel) return;
      fillSelect(sel, byKind[kind]);
      // No defaults on load; keep placeholder until user selects
    });
    // Fill extra DS selects (they are tagged with data-kind="source")
    document.querySelectorAll('select.extra-ds-select').forEach(sel=>{
      fillSelect(sel, byKind['source']);
    });
  }catch(e){ console.warn('Schema list load failed', e); }
}
populateSchemaSelects();
// Top-level quick add buttons (beside the checkboxes)
document.getElementById('source-add-top')?.addEventListener('click', ()=> document.getElementById('source-schema-upload-top')?.click());
document.getElementById('legacy-add-top')?.addEventListener('click', ()=> document.getElementById('legacy-schema-upload-top')?.click());
document.getElementById('source-schema-upload-top')?.addEventListener('change', ()=>{
  // Mirror into section uploader and call add
  const top = document.getElementById('source-schema-upload-top');
  const sec = document.getElementById('source-schema-upload');
  if(top && sec && top.files?.length){ sec.files = top.files; addSchemaToList('source'); top.value=''; }
});
document.getElementById('legacy-schema-upload-top')?.addEventListener('change', ()=>{
  const top = document.getElementById('legacy-schema-upload-top');
  const sec = document.getElementById('legacy-schema-upload');
  if(top && sec && top.files?.length){ sec.files = top.files; addSchemaToList('legacy'); top.value=''; }
});

// Delete selected schema
async function deleteSelected(kind){
  const sel = document.getElementById(`${kind}-schema-select`);
  if(!sel || !sel.value){ return; }
  const name = sel.value;
  if(!confirm(`Delete schema ${name}?`)) return;
  const fd = new FormData(); fd.append('name', name);
  try{
    const res = await fetch('/poc4/delete_schema', { method:'POST', body: fd });
    const data = await res.json();
    if(!data.ok){ throw new Error(data.error || 'Delete failed'); }
    // Remove option and clear preview
    const opt = Array.from(sel.options).find(o=>o.value===name);
    if(opt) opt.remove();
    sel.value = '';
    const fieldsEl = document.getElementById(`${kind}-schema-fields`);
    if(fieldsEl) fieldsEl.innerHTML = '';
  }catch(e){ alert(`Delete failed: ${e.message || e}`); }
}
document.getElementById('source-delete-btn')?.addEventListener('click', ()=> deleteSelected('source'));
document.getElementById('legacy-delete-btn')?.addEventListener('click', ()=> deleteSelected('legacy'));
document.getElementById('target-delete-btn')?.addEventListener('click', ()=> deleteSelected('target'));

// ---- Dynamic extra Data Source sections (DS3+) ----
let dsCounter = 3; // start at 3 since 1 & 2 exist
const extraContainer = document.getElementById('extra-ds-container');
function createExtraDsSection(n){
  const id = `ds${n}`;
  const wrap = document.createElement('div');
  wrap.className = 'mb-3';
  wrap.innerHTML = `
    <div class="d-flex justify-content-between align-items-center mb-1">
      <label class="form-label m-0">Data Source ${n} Schema</label>
      <div class="btn-group btn-group-sm" role="group" aria-label="Extra DS ${n} actions">
        <button class="btn btn-outline-secondary" type="button" id="${id}-min" title="Minimize this section">Minimize</button>
        <button class="btn btn-outline-secondary" type="button" id="${id}-rename">Rename</button>
        <button class="btn btn-outline-danger" type="button" id="${id}-delete">Delete</button>
        <button class="btn btn-outline-danger" type="button" id="${id}-add">Add</button>
        <button class="btn btn-outline-secondary" type="button" id="${id}-remove-section" title="Remove this Data Source section">Remove Section</button>
      </div>
    </div>
    <div id="${id}-body">
    <div class="input-group mb-2">
      <select class="form-select extra-ds-select" id="${id}-select" name="extra_sources">
        <option value="" selected disabled>Loading…</option>
      </select>
    </div>
    <input type="file" class="d-none" id="${id}-upload" accept="application/json" aria-label="Upload custom schema JSON">
  <div class="form-text" id="${id}-hint">Use Add to upload and register a JSON schema for this Data Source.</div>
  <div class="mt-2 schema-preview-wrap" id="${id}-fields" data-origin="ds"></div>
    </div>
    <hr>
  `;
  extraContainer.appendChild(wrap);
  // Populate select with current list
  populateSchemaSelects();
  // Change handler: preview fields
  const sel = wrap.querySelector(`#${id}-select`);
  sel?.addEventListener('change', ()=>{
    const val = sel.value; if(val){ loadSchema(val, `${id}-fields`); }
  });
  // Minimize handler + apply stored state
  const minBtn = wrap.querySelector(`#${id}-min`);
  const bodyEl = wrap.querySelector(`#${id}-body`);
  applyMinState(id, bodyEl, minBtn);
  minBtn?.addEventListener('click', ()=>{
    const s = getMinState(); const cur = !!s[id]; setMinState(id, !cur); applyMinState(id, bodyEl, minBtn);
  });
  // Upload flow
  wrap.querySelector(`#${id}-add`)?.addEventListener('click', ()=> wrap.querySelector(`#${id}-upload`)?.click());
  const uploadEl = wrap.querySelector(`#${id}-upload`);
  uploadEl?.addEventListener('change', async ()=>{
    // Reuse uploader
    const fileInput = uploadEl;
    const hintEl = wrap.querySelector(`#${id}-hint`);
    if(!fileInput || !fileInput.files || !fileInput.files[0]){ if(hintEl) hintEl.textContent='Please choose a JSON file first.'; return; }
    const fd = new FormData();
    fd.append('schemaFile', fileInput.files[0]);
    fd.append('name', fileInput.files[0].name || `ds${n}_schema.json`);
    fd.append('kind', 'source');
    try{
      const res = await fetch('/poc4/upload_schema', { method:'POST', body: fd });
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || 'Upload failed');
      const fname = data.filename;
      // refresh and select
      await populateSchemaSelects();
      const sel2 = wrap.querySelector(`#${id}-select`);
      if(sel2){ sel2.value = fname; loadSchema(fname, `${id}-fields`); }
      if(hintEl) hintEl.textContent = `Added ${fname} to the list.`;
    }catch(e){ if(hintEl) hintEl.textContent = `Add failed: ${e.message || e}`; }
  });
  // Rename
  wrap.querySelector(`#${id}-rename`)?.addEventListener('click', async ()=>{
    const sel3 = wrap.querySelector(`#${id}-select`);
    if(!sel3 || !sel3.value) return;
    const oldName = sel3.value;
    const proposed = prompt('New schema name (with or without .json):', oldName);
    if(!proposed) return;
    const fd = new FormData();
    fd.append('oldName', oldName);
    fd.append('newName', proposed);
    try{
      const res = await fetch('/poc4/rename_schema', { method:'POST', body: fd });
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || 'Rename failed');
      const newFile = data.filename;
      await populateSchemaSelects();
      const sel4 = wrap.querySelector(`#${id}-select`);
      if(sel4){ sel4.value = newFile; }
    }catch(e){ alert(`Rename failed: ${e.message || e}`); }
  });
  // Delete
  wrap.querySelector(`#${id}-delete`)?.addEventListener('click', async ()=>{
    const sel5 = wrap.querySelector(`#${id}-select`);
    if(!sel5 || !sel5.value) return;
    const name = sel5.value;
    if(!confirm(`Delete schema ${name}?`)) return;
    const fd = new FormData(); fd.append('name', name);
    try{
      const res = await fetch('/poc4/delete_schema', { method:'POST', body: fd });
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || 'Delete failed');
      await populateSchemaSelects();
      sel5.value = '';
      const fieldsEl = wrap.querySelector(`#${id}-fields`);
      if(fieldsEl) fieldsEl.innerHTML='';
    }catch(e){ alert(`Delete failed: ${e.message || e}`); }
  });
  // Remove section (does not delete file; just removes this selector)
  wrap.querySelector(`#${id}-remove-section`)?.addEventListener('click', ()=>{
    wrap.remove();
  });
}

document.getElementById('add-datasource-btn')?.addEventListener('click', ()=>{
  createExtraDsSection(dsCounter++);
});
// Recreate any existing extra sources from server (pre-selected on previous visit)
try{
  const extraEl = document.getElementById('extra-sources-json');
  const existing = extraEl ? JSON.parse(extraEl.textContent || '[]') : [];
  if(Array.isArray(existing) && existing.length){
    for(let i=0;i<existing.length;i++){
      createExtraDsSection(dsCounter++);
    }
  // Do not pre-select any schema on load; user must choose explicitly
  }
}catch(e){}

// ---- Minimize state (Page 1) ----
const P1_MIN_KEY = 'poc4_p1_min';
function getMinState(){ try{ return JSON.parse(localStorage.getItem(P1_MIN_KEY)||'{}')||{}; }catch(e){ return {}; } }
function setMinState(key, val){ try{ const s = getMinState(); s[key] = !!val; localStorage.setItem(P1_MIN_KEY, JSON.stringify(s)); }catch(e){} }
function applyMinState(key, bodyEl, btn){ const s=getMinState(); const minimized=!!s[key]; if(bodyEl){ bodyEl.style.display = minimized? 'none':'block'; } if(btn){ btn.textContent = minimized? 'Expand':'Minimize'; } }
// Wire source/legacy minimize
(function(){
  const sBtn = document.getElementById('source-min-btn');
  const sBody = document.getElementById('source-body');
  applyMinState('source', sBody, sBtn);
  sBtn?.addEventListener('click', ()=>{ const s=getMinState(); const cur=!!s['source']; setMinState('source', !cur); applyMinState('source', sBody, sBtn); });
  const lBtn = document.getElementById('legacy-min-btn');
  const lBody = document.getElementById('legacy-body');
  applyMinState('legacy', lBody, lBtn);
  lBtn?.addEventListener('click', ()=>{ const s=getMinState(); const cur=!!s['legacy']; setMinState('legacy', !cur); applyMinState('legacy', lBody, lBtn); });
})();

// Quick action: Save selections and go to Target Model page with auto-design
document.getElementById('design-model-btn')?.addEventListener('click', async ()=>{
  try{
    const enable_source = document.getElementById('source-enable')?.checked ? 'on' : '';
    const enable_legacy = document.getElementById('legacy-enable')?.checked ? 'on' : '';
    const source_schema = document.getElementById('source-schema-select')?.value || '';
    const legacy_schema = document.getElementById('legacy-schema-select')?.value || '';
    const target_schema = document.getElementById('target-schema-select')?.value || '';
    const fd = new FormData();
    fd.append('enable_source', enable_source);
    fd.append('enable_legacy', enable_legacy);
    if(source_schema) fd.append('source_schema', source_schema);
    if(legacy_schema) fd.append('legacy_schema', legacy_schema);
    if(target_schema) fd.append('target_schema', target_schema);
    // Include any explicitly selected extra data sources (DS3+ selectors)
    document.querySelectorAll('select.extra-ds-select')?.forEach(sel=>{
      const v = sel.value; if(v){ fd.append('extra_sources', v); }
    });
    await fetch('/poc4/page1/save_selections', { method:'POST', body: fd });
  // Navigate to Target Model page with a hint to auto-run design (one-time)
  window.location.href = '/poc4/target_model?auto=1';
  }catch(e){ alert('Failed to save selections.'); }
});

// --- Target mode toggle (enable/disable sections) ---
(function(){
  const modeExisting = document.getElementById('target-mode-existing');
  const modeCreate = document.getElementById('target-mode-create');
  const designBtn = document.getElementById('design-model-btn');
  const existingFieldset = document.getElementById('existing-target-fieldset');
  const createFieldset = document.getElementById('create-target-fieldset');
  function applyTargetMode(){
    const useExisting = !!modeExisting?.checked;
    const createNew = !!modeCreate?.checked;
    if(createFieldset){ createFieldset.disabled = !createNew; }
    if(existingFieldset){ existingFieldset.disabled = !useExisting; }
    // Keep button in sync in case fieldset is not supported
    if(designBtn){ designBtn.disabled = !createNew; }
  }
  modeExisting?.addEventListener('change', applyTargetMode);
  modeCreate?.addEventListener('change', applyTargetMode);
  // Start with everything disabled until a choice is made
  applyTargetMode();
})();
</script>
<!-- Help Modal (Page 1: Upload & Enablement) -->
<div class="modal fade" id="helpModalP1" tabindex="-1" aria-labelledby="helpModalP1Label" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="helpModalP1Label">Help — Page 1: Upload & Enablement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>What this page does</strong></p>
        <p>Enable and load your Source and Legacy schemas. This prepares inputs for designing the target model and mapping. It parallels POC 3b’s “collect and structure” step, but focused on data schemas.</p>
        <p><strong>What you need to do</strong></p>
        <ul class="help-list">
          <li>Toggle Source/Legacy on if you plan to include them.</li>
          <li>Select a schema (from samples) or upload JSON. Repeat for each origin.</li>
          <li>Optionally add extra data sources (DS3+).</li>
          <li>Proceed to Target Model to generate a canonical design.</li>
        </ul>
        <p class="text-muted small">The chat panel can help explain fields, advise on structure, or suggest sample schemas.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
