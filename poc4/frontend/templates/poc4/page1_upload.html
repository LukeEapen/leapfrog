{% extends 'poc4/base.html' %}
{% block content %}
<!-- Banner -->
<div class="bg-danger text-white py-3 mb-4 rounded shadow-sm text-center">
  <h2 class="mb-0">POC4 Data Migration & Reconciliation</h2>
  <small>Modern Data Migration Workflow</small>
</div>

{% include 'poc4/_subnav.j2' %}

<style>
  /* Reposition chat to top-right to avoid covering form buttons */
  .floating-chat{position:fixed; top:90px; right:20px; width:340px; max-height:520px; z-index:1050; box-shadow:0 4px 18px rgba(0,0,0,.15)}
  .floating-chat .card-body{overflow-y:auto}
  @media (max-width: 992px){ .floating-chat{position:static; width:100%; max-height:none; margin-top:1rem} }
</style>
{% include 'poc4/_steps.j2' %}

<form method="post" enctype="multipart/form-data" id="upload-form">
  <!-- Top action bar just below tabs -->
  <div class="d-flex justify-content-end align-items-center mb-3">
    <button type="submit" class="btn btn-danger px-4" id="next-btn">Next</button>
  </div>
  <div class="row g-4">
    <!-- Source Column -->
    <div class="col-md-4">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-light text-danger fw-bold">Source System</div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Source Schema</label>
            <select class="form-select mb-2" id="source-schema-select" name="source_schema" required>
              <option value="source_schema.json" selected>Source (Relational)</option>
            </select>
            <input type="file" class="form-control" id="source-schema-upload" accept="application/json">
          </div>
          <div id="source-schema-fields"></div>
        </div>
      </div>
    </div>
    <!-- Legacy Column -->
    <div class="col-md-4">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-light text-danger fw-bold">Legacy System</div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Legacy Schema</label>
            <select class="form-select mb-2" id="legacy-schema-select" name="legacy_schema" required>
              <option value="legacy_schema.json" selected>Legacy Core (Mainframe)</option>
            </select>
            <input type="file" class="form-control" id="legacy-schema-upload" accept="application/json">
          </div>
          <div id="legacy-schema-fields"></div>
        </div>
      </div>
    </div>
    <!-- Target Column -->
    <div class="col-md-4">
      <div class="card h-100 shadow-sm">
        <div class="card-header bg-light text-danger fw-bold">Target System</div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Target Schema</label>
            <select class="form-select mb-2" id="target-schema-select" name="target_schema" required>
              <option value="target_schema.json" selected>Target OLAP Flat</option>
              <option value="target_schema_future.json">Future OLAP Enhanced</option>
            </select>
            <input type="file" class="form-control" id="target-schema-upload" accept="application/json">
          </div>
          <div id="target-schema-fields"></div>
        </div>
      </div>
    </div>
  </div>
</form>

<!-- Floating Chat Widget -->
<div class="card floating-chat" id="chat-widget">
  <div class="card-header bg-danger text-white py-2 d-flex justify-content-between align-items-center" style="cursor:move;">
    <span class="fw-semibold small d-flex align-items-center gap-1"><i class="bi bi-robot"></i> Assistant</span>
    <div class="d-flex align-items-center gap-1">
      <button class="btn btn-sm btn-light d-flex align-items-center justify-content-center" id="chat-min-btn" type="button" aria-label="Minimize chat" style="width:26px;height:26px;">
        <i class="bi bi-chevron-down" id="chat-min-icon"></i>
      </button>
    </div>
  </div>
  <div class="card-body p-2" id="chat-body" style="min-height:250px; max-height:360px;">
    <div id="chat-messages" class="small text-muted">Ask about the migration workflow...</div>
  </div>
  <div class="card-footer p-2" id="chat-footer">
    <form id="chat-form" onsubmit="return sendMessage(event);">
      <div class="input-group input-group-sm">
        <input type="text" class="form-control" id="chat-input" placeholder="Type..." required>
        <button class="btn btn-danger" type="submit">Send</button>
      </div>
    </form>
  </div>
</div>

<script>
function toggleChatBody(){
  const body=document.getElementById('chat-body');
  const footer=document.getElementById('chat-footer');
  const icon=document.getElementById('chat-min-icon');
  const hidden = body.style.display==='none';
  body.style.display = hidden ? 'block':'none';
  footer.style.display = hidden ? 'block':'none';
  icon.classList.toggle('bi-chevron-down', hidden===false);
  icon.classList.toggle('bi-chevron-up', hidden===true);
}
document.getElementById('chat-min-btn').addEventListener('click', toggleChatBody);
// Start chat minimized on load
toggleChatBody();
async function sendMessage(e){ e.preventDefault(); const input=document.getElementById('chat-input'); const msg=input.value.trim(); if(!msg) return false; appendMessage('You', msg); input.value='';
  // Simple commands
  const lower = msg.toLowerCase();
  if(lower==='next' || lower==='go next' || lower==='continue'){
    document.getElementById('next-btn')?.click();
    return false;
  }
  try{ const res= await fetch('/poc4/chat',{method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:'message='+encodeURIComponent(msg)}); const data= await res.json(); appendMessage('Bot', data.response);}catch(err){ appendMessage('Bot','(error)'); } return false; }
function appendMessage(sender,text){ const chat=document.getElementById('chat-messages'); const div=document.createElement('div'); div.innerHTML=`<strong>${sender}:</strong> ${text}`; chat.appendChild(div); chat.scrollTop=chat.scrollHeight; }

async function loadSchema(file,target){ try{ const res= await fetch(`/poc4/static_schema/schemas/${file}`); const schema= await res.json(); renderSchemaFields(schema,target);}catch(e){ document.getElementById(target).innerHTML='<div class="text-danger">Failed to load schema.</div>'; }}
function renderSchemaFields(schema,target){ let html=''; if(schema.tables){ schema.tables.forEach(t=>{ html+=`<div class=\"card mb-2\"><div class=\"card-header bg-light fw-bold\">${t.name}</div><div class=\"card-body p-2\"><ul class=\"list-group\">`; t.fields.forEach(f=>{ html+=`<li class=\"list-group-item d-flex justify-content-between align-items-center\"><span>${f.name}</span><span class=\"badge bg-danger\">${f.type}</span></li>`; }); html+='</ul></div></div>'; }); } document.getElementById(target).innerHTML=html; }

['source','legacy','target'].forEach(kind=>{ const sel=document.getElementById(`${kind}-schema-select`); if(sel){ sel.addEventListener('change',()=>{ loadSchema(sel.value, `${kind}-schema-fields`); }); }});
['source','legacy','target'].forEach(kind=>{ const up=document.getElementById(`${kind}-schema-upload`); if(up){ up.addEventListener('change', e=>{ const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=evt=>{ try{ const schema=JSON.parse(evt.target.result); renderSchemaFields(schema, `${kind}-schema-fields`);}catch(err){ document.getElementById(`${kind}-schema-fields`).innerHTML='<div class="text-danger">Invalid JSON file.</div>'; } }; reader.readAsText(file); }); }});

// Initial load
loadSchema('source_schema.json','source-schema-fields');
loadSchema('legacy_schema.json','legacy-schema-fields');
loadSchema('target_schema.json','target-schema-fields');
</script>
{% endblock %}
