{% extends 'poc4/base.html' %}
{% block content %}
<div class="bg-danger text-white py-3 mb-4 rounded shadow-sm text-center">
  <h2 class="mb-0">Target Model Designer</h2>
  <small>Design, review, approve, and download your target-state schema</small>
</div>

{% include 'poc4/_subnav.j2' %}

<!-- Meta flags for JS -->
<div id="tmodel-meta" data-has-draft="{{ '1' if target_model_draft else '0' }}" hidden></div>

<!-- Hidden form to allow auto-generation via ?auto=1 without showing a button -->
<form method="post" class="m-0" id="design-form" style="display:none;">
  <input type="hidden" name="action" value="design_target_model">
  <!-- button removed intentionally -->
  <!-- This hidden form is submitted by JS when ?auto=1 and no draft exists -->
  </form>

<!-- Action bar: Generate, Approve, Download, Next + Help -->
<div class="d-flex flex-wrap gap-2 justify-content-end align-items-center mb-3">
  <form method="post" class="d-inline">
    <input type="hidden" name="action" value="design_target_model">
    <button type="submit" class="btn btn-danger btn-sm">Generate Draft</button>
  </form>
  <form method="post" class="d-inline">
    <input type="hidden" name="action" value="approve_target_model">
    <button type="submit" class="btn btn-success btn-sm" {% if not target_model_draft %}disabled{% endif %}>Approve</button>
  </form>
  <a href="{{ url_for('poc4.download_target_model') }}" class="btn btn-outline-secondary btn-sm" {% if not (target_model_final or target_model_draft) %}aria-disabled="true" tabindex="-1" class="disabled"{% endif %}>Download JSON</a>
  <a href="{{ url_for('poc4.page2') }}" class="btn btn-danger btn-sm">Next: Mapping</a>
  <button type="button" class="btn btn-help btn-sm" data-bs-toggle="modal" data-bs-target="#helpModalTargetModel" aria-label="Help about Target Model">
    <i class="bi bi-question-circle-fill"></i>
    Help
  </button>
</div>

<div class="d-flex align-items-center mb-3">
  <div class="text-muted small">This page is independent of Validation; it won’t trigger migration.</div>
</div>

<div class="row g-4">
  <div class="col-md-8">
    <div class="card h-100 shadow-sm">
      <div class="card-header bg-light text-danger fw-bold">Draft Preview</div>
      <div class="card-body">
        {# Bring ER diagram and Standards alignment to the top #}
        {% if target_model_draft and not target_model_draft.error %}
          {% if target_model_draft.er_diagram_mermaid %}
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
              <span class="small text-muted">Entity-Relationship (Mermaid)</span>
              <span class="badge bg-light text-dark border">ER</span>
            </div>
            <div class="border rounded p-2 bg-white">
              <div class="mermaid" style="max-height: 260px; overflow:auto;">
{{ target_model_draft.er_diagram_mermaid }}
              </div>
            </div>
          </div>
          {% endif %}
          {% if target_model_draft.alignment %}
          <div class="mb-3">
            <div class="small text-muted mb-1">Standards alignment (BIAN/ISO)</div>
            <div class="d-flex flex-wrap gap-2">
              {% for t in target_model_draft.tables %}
                {% set a = (target_model_draft.alignment[t.name] if (target_model_draft.alignment and t.name in target_model_draft.alignment) else None) %}
                <div class="border rounded p-2 bg-light">
                  <div class="small"><code>{{ t.name }}</code></div>
                  {% if a %}
                    <span class="badge bg-danger-subtle text-danger border">BIAN: {{ a.BIAN }}</span>
                    <span class="badge bg-secondary-subtle text-dark border">ISO: {{ a.ISO20022 }}</span>
                  {% else %}
                    <span class="badge bg-secondary">No mapping</span>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        {% endif %}

        
  {% if not target_model_draft %}
          <div class="alert alert-info">Click Generate Draft to produce a target model from your selected sources.</div>
        {% elif target_model_draft.error %}
          <div class="alert alert-danger">{{ target_model_draft.error }}</div>
        {% else %}
          <div class="accordion" id="tmodelAccordion">
            {% for t in target_model_draft.tables %}
            <div class="accordion-item">
              <h2 class="accordion-header" id="head-{{ t.name }}">
                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#body-{{ t.name }}" aria-expanded="false" aria-controls="body-{{ t.name }}">
                  <span class="me-2"><code>{{ t.name }}</code></span>
                  <span class="badge bg-light text-dark border">{{ t.fields|length }} fields</span>
                </button>
              </h2>
              <div id="body-{{ t.name }}" class="accordion-collapse collapse" aria-labelledby="head-{{ t.name }}" data-bs-parent="#tmodelAccordion">
                <div class="accordion-body p-2">
                  <div class="d-flex flex-wrap gap-2">
                    {% for f in t.fields %}
                      <span class="badge {% if f.primary_key %}bg-danger text-white{% else %}bg-light text-dark border{% endif %}">
                        {{ f.name }}<span class="text-muted">:{{ f.type }}</span>{% if f.primary_key %}<span class="ms-1">(PK)</span>{% endif %}
                      </span>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
          <div class="border rounded p-2 bg-light mt-3" style="max-height:240px; overflow:auto;">
            <pre class="small mb-0">{{ target_model_draft | tojson(indent=2) }}</pre>
          </div>
        {% endif %}

        <!-- Mapping section moved to bottom; still renders without a draft -->
        <div class="mb-3 mt-3">
          <div class="d-flex justify-content-between align-items-center">
            <span class="small text-muted">Field Mapping (Source ➜ Target)</span>
            <span class="badge bg-light text-dark border">Mapping</span>
          </div>
          {% if target_model_draft and target_model_draft.tables %}
          <div class="small text-muted mt-2">Target tables</div>
          <div class="d-flex flex-wrap gap-2 mb-2">
            {% for t in target_model_draft.tables %}
              <span class="badge bg-light text-dark border">
                {{ t.name }} <span class="text-muted">{{ t.fields|length }} fields</span>
              </span>
            {% endfor %}
          </div>
          {% endif %}
          {% if mapping_mermaid %}
          <div class="border rounded p-2 bg-white mb-2">
            <div class="mermaid" style="max-height: 260px; overflow:auto;">
{{ mapping_mermaid }}
            </div>
          </div>
          {% endif %}
          <style>
            .badge.origin-badge.origin-source { background-color: #E8F0FF; }
            .badge.origin-badge.origin-legacy { background-color: #FFF3E0; }
            .badge.origin-badge.origin-ds { background-color: #E8F5E9; }
            .badge.origin-badge.origin-other { background-color: #F5F5F5; }
          </style>
          <div class="table-responsive border rounded">
            <table class="table table-sm table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 12rem;">Target Table</th>
                  <th style="width: 12rem;">Target Field</th>
                  <th style="width: 12rem;">Source Origin</th>
                  <th style="width: 16rem;">Source Table</th>
                  <th>Source Field</th>
                </tr>
              </thead>
              <tbody>
                {% if mapping_pairs %}
                  {# Use a namespace so last_tbl persists across loop iterations #}
                  {% set ns = namespace(last_tbl=None) %}
                  {% for r in mapping_pairs %}
                  <tr>
                    <td>
                      {% if ns.last_tbl != r.target_table %}
                        <code>{{ r.target_table or '—' }}</code>
                        {% set ns.last_tbl = r.target_table %}
                      {% endif %}
                    </td>
                    <td><code>{{ r.target }}</code></td>
                    <td>
                      <span class="badge origin-badge text-dark border {% if r.origin=='source' %}origin-source{% elif r.origin=='legacy' %}origin-legacy{% elif r.origin.startswith('ds') %}origin-ds{% else %}origin-other{% endif %}">
                        {{ r.origin|upper }}
                      </span>
                    </td>
                    <td><code>{{ r.source_table or '—' }}</code></td>
                    <td><code>{{ r.source }}</code></td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="5" class="text-muted small">No mappings found. Define mappings on Page 2 to populate this view.</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card h-100 shadow-sm">
      <div class="card-header bg-danger text-white">Actions</div>
      <div class="card-body">
        <ol class="small mb-0">
          <li>Click Generate Draft to infer a canonical model across your selected sources.</li>
          <li>Review the ER diagram, relationships, and fields.</li>
          <li>Approve to mark it final, or download JSON anytime.</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<!-- Bottom CTA: Next: Mapping -->
<div class="mt-3">
  <a href="{{ url_for('poc4.page2') }}" class="btn btn-danger w-100">Next: Mapping</a>
  <div class="form-text text-center mt-1">Proceed to map selected sources to the designed target schema.</div>
</div>

<!-- Mermaid -->
<script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
<script>
  try { mermaid.initialize({ startOnLoad: true, theme: 'default' }); } catch(e){}
  // Auto-generate once when navigated with ?auto=1 and no draft exists
  (function(){
    try{
      const p = new URLSearchParams(window.location.search);
      const meta = document.getElementById('tmodel-meta');
      const hasDraft = (meta?.dataset?.hasDraft === '1');
      if(p.get('auto')==='1' && !hasDraft){
        document.getElementById('design-form')?.submit();
      }
    }catch(e){}
  })();
</script>

<!-- Help Modal (Target Model) -->
<style>
  /* Ensure help modal sits above floating chat panel */
  .modal { z-index: 1080; }
  .modal-backdrop { z-index: 1070; }
  .help-list { margin-left: 1rem; }
  .help-list li { margin-bottom: .35rem; }
  .small-muted { font-size:.9rem; color:#6b7280; }
</style>
<div class="modal fade" id="helpModalTargetModel" tabindex="-1" aria-labelledby="helpModalTargetModelLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title" id="helpModalTargetModelLabel">Help — Target Model Designer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>What this page does</strong></p>
        <p>This designer turns your selected sources into a target‑state schema. It generates an initial ER diagram and table/field list you can review and approve. This mirrors the “clarify and structure” step from Requirements Insights (POC 3b), but focused on data modeling.</p>
        <p><strong>When to use it</strong></p>
        <ul class="help-list">
          <li>After selecting and preparing your Source/Legacy schemas on Page 1.</li>
          <li>Before mapping fields on Page 2 and defining transformation rules on Page 3.</li>
        </ul>
        <p><strong>What you need to do</strong></p>
        <ul class="help-list">
          <li>Click <em>Generate Draft</em> to create a canonical target model from your inputs.</li>
          <li>Review the ER diagram and tables/fields. Iterate as needed.</li>
          <li><em>Approve</em> to lock a version for mapping, or <em>Download JSON</em> for external review.</li>
          <li>Proceed to <em>Next: Mapping</em> to connect sources to target fields.</li>
        </ul>
        <p class="small-muted">Tip: You can reopen this page later to regenerate/compare drafts. The chat panel can answer “why” a table/field exists and suggest adjustments.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
 </div>
{% endblock %}
