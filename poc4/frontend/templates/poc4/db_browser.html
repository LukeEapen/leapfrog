<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>POC4 DB Browser</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body{background:#f8f9fa;}
    .card-header.bg-danger.text-white .badge{background:#fff!important;color:#d32f2f!important}
  </style>
</head>
<body>
<div class="container py-3">
  <div class="mb-2"><a href="/poc4/page1" class="btn btn-sm btn-outline-danger">&larr; Workflow</a></div>
<div class="bg-danger text-white py-3 mb-4 rounded shadow-sm text-center">
  <h2 class="mb-0">POC4 DB Browser</h2>
  <small>Inspect source / legacy / target SQLite stores</small>
</div>

<div class="row g-4">
  {% for db_key, tables in db_tables.items() %}
  <div class="col-md-4">
    <div class="card h-100 shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center {% if sel_db == db_key %}bg-danger text-white{% else %}bg-light{% endif %}">
        <span class="fw-semibold text-uppercase small mb-0">{{ db_key }}</span>
  {% if sel_db == db_key %}<span class="badge bg-light text-danger">ACTIVE</span>{% endif %}
      </div>
      <div class="card-body p-2" style="max-height:320px;overflow:auto;">
        {% if tables %}
          <ul class="list-unstyled mb-0 small">
            {% for t in tables %}
              <li class="d-flex justify-content-between align-items-center py-1 border-bottom">
                <a class="text-decoration-none {% if sel_db == db_key and sel_table == t.name %}fw-bold{% endif %}" href="{{ url_for('poc4.db_browser') }}?db={{ db_key }}&table={{ t.name }}">{{ t.name }}</a>
                <span class="badge bg-secondary">{{ t.count }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted small">No tables.</div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<hr class="my-4"/>
<h5 class="d-flex align-items-center gap-2">Table Preview {% if sel_table %}<span class="badge bg-danger">{{ sel_db }} :: {{ sel_table }}</span>{% endif %}</h5>
<form class="row gy-2 gx-3 align-items-center mb-3">
  <div class="col-auto">
    <label class="form-label small mb-0">DB</label>
    <select name="db" class="form-select form-select-sm" onchange="this.form.submit()">
      {% for db_key in db_tables.keys() %}
        {% if db_key == sel_db %}
          <option value="{{ db_key }}" selected>{{ db_key }}</option>
        {% else %}
          <option value="{{ db_key }}">{{ db_key }}</option>
        {% endif %}
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <label class="form-label small mb-0">Table</label>
    <select name="table" class="form-select form-select-sm" onchange="this.form.submit()">
      <option value="">-- select --</option>
      {% for t in db_tables[sel_db] %}
        {% if t.name == sel_table %}
          <option value="{{ t.name }}" selected>{{ t.name }}</option>
        {% else %}
          <option value="{{ t.name }}">{{ t.name }}</option>
        {% endif %}
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <label class="form-label small mb-0">Columns</label>
    <select name="cols" class="form-select form-select-sm" multiple size="5">
      {% for c in (available_columns or []) %}
        {% set is_sel = (selected_cols and (c in selected_cols)) %}
        {% if is_sel %}
          <option value="{{ c }}" selected>{{ c }}</option>
        {% else %}
          <option value="{{ c }}">{{ c }}</option>
        {% endif %}
      {% endfor %}
    </select>
    <div class="form-text small">Hold Ctrl (Cmd on Mac) to pick multiple; leave empty for all columns.</div>
  </div>
  <div class="col-auto">
    <label class="form-label small mb-0">Limit</label>
    <input type="number" name="limit" min="1" max="500" value="{{ limit }}" class="form-control form-control-sm"/>
  </div>
  <div class="col-auto align-self-end">
    <button class="btn btn-danger btn-sm">Refresh</button>
  </div>
</form>

{% if error %}
  <div class="alert alert-danger small">Error: {{ error }}</div>
{% endif %}
{% if sel_table and rows %}
  <div class="border rounded">
    <div class="table-responsive" style="overflow-x: auto;">
      <table class="table table-sm table-striped align-middle mb-0" style="min-width: max(100%, 800px);">
        <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
          <tr>
            {% for c in columns %}<th class="small" style="white-space: nowrap;">{{ c }}</th>{% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
            <tr>
              {% for c in columns %}<td class="small" style="white-space: nowrap;">{{ r[c] }}</td>{% endfor %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
{% elif sel_table %}
  <div class="text-muted small">No rows returned.</div>
{% else %}
  <div class="text-muted small">Select a database and table to preview data.</div>
{% endif %}

</div>
</body>
</html>
