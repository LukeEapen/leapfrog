<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Story Drafting Solution</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body {
      background-color: #2f323a;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .main-container {
      max-width: 900px;
      margin: 20px auto;
      background: #fff;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    .top-bar {
      background-color: #d0021b;
      color: white;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      position: relative;
    }
    .back-button {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 14px;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    .back-button:hover {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      transform: translateY(-1px);
    }
    .story-header {
      background-color: #444;
      color: white;
      padding: 16px 20px;
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    .content-container {
      background: white;
      margin: 0;
      padding: 28px;
      color: #000;
    }
    .epic-info-section {
      margin-bottom: 28px;
      padding: 20px;
      border-bottom: 1px solid #e2e8f0;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    .epic-label {
      color: #d0021b;
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .epic-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    .info-row {
      display: flex;
      gap: 28px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .info-item {
      display: flex;
      align-items: center;
      font-size: 14px;
      background: white;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .info-label {
      font-weight: 600;
      margin-right: 8px;
      color: #666;
    }
    .priority-high {
      color: #d0021b;
      font-weight: 600;
      padding: 2px 8px;
      background: rgba(208, 2, 27, 0.1);
      border-radius: 4px;
    }
    .section-container {
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .section-container:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .section-header {
      background-color: #444;
      color: white;
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 15px;
    }
    .section-content {
      padding: 20px;
      line-height: 1.6;
      color: #333;
      background: white;
    }
    .chat-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    .chat-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      transform: translateY(-1px);
    }
    .requirements-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .requirements-list li {
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 14px;
      color: #333;
      background: #f8f9fa;
      margin-bottom: 2px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    .requirements-list li:hover {
      background: #e9ecef;
      transform: translateX(4px);
    }
    .requirements-list li:last-child {
      border-bottom: none;
    }
    .tagged-requirements-section .section-content {
      background: #fff5f5;
      border: 1px solid #fed7d7;
      border-radius: 4px;
    }
    .criteria-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .criteria-list li {
      padding: 10px 16px;
      color: #333;
      font-size: 14px;
      position: relative;
      padding-left: 28px;
      background: #f8f9fa;
      margin-bottom: 4px;
      border-radius: 4px;
      border-left: 3px solid #d0021b;
      transition: all 0.2s ease;
    }
    .criteria-list li:hover {
      background: #e9ecef;
      border-left-color: #a0011a;
    }
    .criteria-list li:before {
      content: "✓";
      position: absolute;
      left: 8px;
      color: #d0021b;
      font-weight: bold;
    }
    .hardcoded-content {
      color: #007bff !important;
      font-style: italic;
      font-weight: 500;
    }
    .story-header .hardcoded-content {
      color: #e2e8f0 !important;
    }
    .epic-title .hardcoded-content {
      color: #007bff !important;
    }
    .submit-btn {
      background-color: #d0021b;
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 24px;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    .submit-btn:hover {
      background-color: #a0011a;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(208, 2, 27, 0.3);
    }
    .submit-btn:active {
      transform: translateY(0);
    }
    .hidden {
      display: none;
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
      .main-container {
        margin: 15px;
        max-width: none;
      }
    }
    
    @media (max-width: 768px) {
      .main-container {
        margin: 10px;
        border-radius: 4px;
      }
      .content-container {
        padding: 20px;
      }
      .info-row {
        flex-direction: column;
        gap: 12px;
      }
      .info-item {
        width: 100%;
        justify-content: space-between;
      }
      .chat-btn {
        padding: 6px 12px;
        font-size: 11px;
      }
    }
    
    @media (max-width: 480px) {
      .main-container {
        margin: 5px;
      }
      .content-container {
        padding: 16px;
      }
      .epic-info-section {
        padding: 16px;
      }
      .section-header {
        padding: 12px 16px;
        font-size: 14px;
      }
      .section-content {
        padding: 16px;
      }
    }
    
    /* Story name section styling */
    .story-name-section {
      background: white;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    
    /* Multiple stories summary styling */
    .multiple-stories-summary {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    
    .story-item {
      background: white !important;
      border-left: 3px solid #d0021b !important;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .story-item:hover {
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Chat Modal Styles - Right Bottom Corner Positioning */
    /* Chat Modal Styles - Right Side Full Height */
    .chat-modal {
      display: none !important;
      position: fixed !important;
      z-index: 99999 !important;
      right: 0px !important;
      top: 0px !important;
      width: 600px !important;
      height: 100vh !important;
      background-color: rgba(0, 0, 0, 0.1) !important;
      backdrop-filter: blur(2px);
    }
    
    .chat-modal[style*="display: block"] {
      display: block !important;
    }
    
    .chat-modal-content {
      background-color: white;
      margin: 0;
      padding: 0;
      border: none;
      border-radius: 12px 0 0 12px;
      width: 100%;
      height: 100%;
      box-shadow: -8px 0 32px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      border-left: 1px solid #e2e8f0;
    }
    
    .chat-header {
      background-color: #d0021b;
      color: white;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 16px;
    }
    
    .chat-close {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
      font-weight: normal;
    }
    
    .chat-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    .chat-messages {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    
    .chat-message {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      max-width: 80%;
    }
    
    .chat-message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    
    .chat-message.assistant {
      align-self: flex-start;
    }
    
    .chat-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    .chat-avatar.user {
      background: #d0021b;
      color: white;
    }
    
    .chat-avatar.assistant {
      background: #f8f9fa;
      color: #8B4513;
      border: 2px solid #007bff;
    }
    
    .chat-bubble {
      background: rgb(140, 138, 236);
      border-radius: 12px;
      padding: 12px 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
      word-wrap: break-word;
      line-height: 1.5;
      color: #8B4513;
    }
    
    .chat-message.user .chat-bubble {
      background: #d0021b;
      color: white;
      border-color: #d0021b;
    }
    
    .chat-input-area {
      padding: 24px;
      background: white;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 16px;
      align-items: flex-end;
    }
    
    .chat-input {
      flex: 1;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 14px;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      font-family: inherit;
    }
    
    .chat-input:focus {
      outline: none;
      border-color: #d0021b;
      box-shadow: 0 0 0 2px rgba(208, 2, 27, 0.1);
    }
    
    .chat-send-btn {
      background: #d0021b;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      height: 44px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .chat-send-btn:hover:not(:disabled) {
      background: #a0011a;
      transform: translateY(-1px);
    }
    
    .chat-send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .chat-loading {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #666;
      font-style: italic;
    }
    
    .chat-loading-dots {
      display: inline-block;
    }
    
    .chat-loading-dots::after {
      content: '';
      animation: chatLoading 1.5s infinite;
    }
    
    @keyframes chatLoading {
      0%, 33% { content: '.'; }
      34%, 66% { content: '..'; }
      67%, 100% { content: '...'; }
    }
    
    .current-description {
      background: #fff5f5;
      border: 1px solid #fed7d7;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 24px;
    }
    
    .current-description h6 {
      color: #d0021b;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .current-description-text {
      color: #333;
      line-height: 1.6;
      margin: 0;
    }
    
    /* Responsive Chat Modal */
    @media (max-width: 768px) {
      .chat-modal {
        right: 0px !important;
        top: 0px !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.3) !important;
      }
      
      .chat-modal-content {
        border-radius: 0;
        box-shadow: none;
        border: none;
      }
      
      .chat-message {
        max-width: 90%;
      }
      
      .chat-input-area {
        padding: 12px;
      }
      
      .chat-input {
        font-size: 13px;
        padding: 8px 12px;
      }
      
      .chat-send-btn {
        padding: 8px 12px;
        font-size: 13px;
      }
    }
    
    @media (max-width: 480px) {
      .chat-modal {
        right: 0px !important;
        top: 0px !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.5) !important;
      }
      
      .chat-header {
        padding: 12px 16px;
        font-size: 14px;
      }
      
      .chat-messages {
        padding: 15px;
        gap: 12px;
      }
      
      .chat-avatar {
        width: 30px;
        height: 30px;
        font-size: 14px;
      }
      
      .chat-bubble {
        padding: 10px 12px;
        font-size: 13px;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Top Navigation Bar -->
    <div class="top-bar">
      <button class="back-button" onclick="goBack()">
        &lt; Back
      </button>
      <span style="position: absolute; left: 50%; transform: translateX(-50%); font-weight: bold;">
        Jira ticket creation
      </span>
      <span style="position: absolute; right: 16px; top: 12px; font-size: 12px;">
        Use the 'Chat' interface to ask questions and edit outputs
      </span>
    </div>

    <!-- User Story Header -->
    <div class="story-header">
      {% if multiple_stories %}
        Multiple User Stories: {{ story_count }} stories selected
      {% else %}
        User story: {{ user_story_name or '<span class="hardcoded-content">Capture personal information during onboarding</span>' | safe }}
        <button class="chat-btn" onclick="openUserStoryChat()" style="margin-left: 10px; float: right;">
          <span>💬 Chat</span>
        </button>
      {% endif %}
    </div>

    <!-- Main Content -->
    <div class="content-container">
    
    <!-- Error Message Display -->
    {% if error_message %}
    <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 16px; border-radius: 6px; margin-bottom: 20px;">
      <strong>⚠️ Error:</strong> {{ error_message }}
    </div>
    {% endif %}
    
    <!-- Success Message Display -->
    {% if success_message %}
    <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 16px; border-radius: 6px; margin-bottom: 20px;">
      <strong>✅ Success:</strong> {{ success_message }}
    </div>
    {% endif %}
    
    <!-- Epic Information Section -->
    <div class="epic-info-section">
      <div class="epic-label">Epic:</div>
      <div class="epic-title">
        {{ epic_title or '<span class="hardcoded-content">******</span>' | safe }}
        <button class="chat-btn" onclick="openEpicChat()" style="margin-left: 10px;">
          <span>💬 Chat</span>
        </button>
      </div>

      <div class="info-row">
        <div class="info-item">
          <span class="info-label">Priority:</span>
          <span class="priority-high">{{ priority or '<span class="hardcoded-content">High</span>' | safe }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Responsible systems:</span>
          <span>{{ responsible_systems or '<span class="hardcoded-content">CAPS, CMS</span>' | safe }}</span>
        </div>
      </div>
    </div>

  
    <!-- Description Section -->
    <div class="section-container">
      <div class="section-header">
        <span>Description</span>
        <button class="chat-btn" onclick="openDescriptionChat()">
          <span>💬 Chat</span>
        </button>
      </div>
      <div class="section-content">
        {% if multiple_stories %}
          <!-- Multiple Stories Summary -->
          <div class="multiple-stories-summary">
            <h6>Selected Stories ({{ story_count }}):</h6>
            {% for story in stories %}
              <div class="story-item" style="margin-bottom: 12px; padding: 8px; border-left: 3px solid #dc3545; background: #f8f9fa;">
                <strong>{{ story.name }}</strong>
                <p style="margin: 4px 0; font-size: 14px; color: #666;">{{ story.description }}</p>
                <small style="color: #999;">Priority: {{ story.priority }} | System: {{ story.system }}</small>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <!-- Enhanced Description from User Description Agent -->
          <div class="enhanced-description">
            {{ user_story_description or '<span class="hardcoded-content">As a new borrower, I want to input my personal information (e.g., name, SSN) so that the system can accurately create my customer profile and initiate the onboarding process. This ensures that downstream verification steps (e.g. KYC, credit checks) can proceed without manual data correction or re-entry.</span>' | safe }}
          </div>
          
        {% endif %}
      </div>
    </div>

    <!-- Acceptance Criteria Section -->
    <div class="section-container">
      <div class="section-header">
        <span>Acceptance criteria</span>
        <button class="chat-btn" onclick="openAcceptanceCriteriaChat()">
          <span>💬 Chat</span>
        </button>
      </div>
      <div class="section-content">
        <ul class="criteria-list">
          {% if acceptance_criteria %}
            {% for criterion in acceptance_criteria %}
            <li>{{ criterion }}</li>
            {% endfor %}
          {% else %}
          <li><span class="hardcoded-content">System prompts for full name, date of birth, Social Security Number, email address, phone number, and residential address</span></li>
          <li><span class="hardcoded-content">Mandatory fields must be completed before progressing</span></li>
          <li><span class="hardcoded-content">Input formats are validated (e.g., MM/DD/YYYY for DOB, 9-digit SSN, phone with area code)</span></li>
          <li><span class="hardcoded-content">Errors are surfaced clearly and immediately for any missing or invalid entries</span></li>
          {% endif %}
        </ul>
      </div>
    </div>

    <!-- Tagged Requirements Section -->
    <div class="section-container tagged-requirements-section">
      <div class="section-header">
        <span>Tagged requirements</span>
        <button class="chat-btn" onclick="openRequirementsChat()">
          <span>💬 Chat</span>
        </button>
      </div>
      <div class="section-content">
        <ul class="requirements-list">
          {% if tagged_requirements %}
            {% for requirement in tagged_requirements %}
            <li>{{ requirement }}</li>
            {% endfor %}
          {% else %}
          <li><span class="hardcoded-content">TBD</span></li>

          {% endif %}
        </ul>
      </div>
    </div>

    <!-- Submit Button -->
    <button type="button" class="submit-btn" onclick="submitToJira()" id="jira-submit-btn">
      Submit & export to Jira
    </button>
    
    <!-- Data Validation Summary -->
    <div id="validation-summary" style="margin-top: 16px; padding: 12px; background: #f8f9fa; border-radius: 6px; border: 1px solid #ddd; display: none;">
      <h6 style="margin-bottom: 8px; color: #333;">📋 Submission Summary:</h6>
      <div id="validation-details" style="font-size: 14px; color: #666;"></div>
    </div>
    </div>
  </div>

  <!-- Hidden form with data for Jira submission -->
  <form id="jira-form" action="/submit-jira-ticket" method="POST" style="display: none;">
    <input type="hidden" name="epic_title" value="{{ epic_title or '' }}">
    <input type="hidden" name="user_story_name" value="{{ user_story_name or '' }}">
    <input type="hidden" name="user_story_description" value="{{ user_story_description or '' }}">
    <input type="hidden" name="priority" value="{{ priority or 'High' }}">
    <input type="hidden" name="responsible_systems" value="{{ responsible_systems or 'CAPS, CMS' }}">
    <input type="hidden" name="acceptance_criteria" value="{% if acceptance_criteria %}{{ acceptance_criteria|join('|||') }}{% else %}System prompts for full name, date of birth, Social Security Number, email address, phone number, and residential address|||Mandatory fields must be completed before progressing|||Input formats are validated (e.g., MM/DD/YYYY for DOB, 9-digit SSN, phone with area code)|||Errors are surfaced clearly and immediately for any missing or invalid entries{% endif %}">
    <input type="hidden" name="tagged_requirements" value="{% if tagged_requirements %}{{ tagged_requirements|join('|||') }}{% else %}TBD {% endif %}">
  </form>

  <!-- Description Chat Modal -->
  <div id="description-chat-modal" class="chat-modal">
    <div class="chat-modal-content">
      <div class="chat-header">
        <span>💬 Edit Description</span>
        <button class="chat-close" onclick="closeDescriptionChat()">&times;</button>
      </div>
      <div class="chat-container">
        <!-- Current Description Display -->
        <div class="current-description">
          <h6>Current Description:</h6>
          <p class="current-description-text" id="current-description-display"></p>
        </div>
        
        <!-- Chat Messages -->
        <div class="chat-messages" id="description-chat-messages">
          <div class="chat-message assistant">
            <div class="chat-avatar assistant">AI</div>
            <div class="chat-bubble">
              Hello! I'm here to help you refine your user story description. You can ask me to:
              <br>• Make it more detailed or concise
              <br>• Improve clarity and technical accuracy
              <br>• Add specific business context
              <br>• Adjust the tone or format
              <br><br>What would you like to change about the current description?
            </div>
          </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-area">
          <textarea id="description-chat-input" class="chat-input" placeholder="Ask me to revise the description..." rows="1"></textarea>
          <button class="chat-send-btn" onclick="sendDescriptionMessage()" id="description-send-btn">
            <span>📤</span>
            Send
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Acceptance Criteria Chat Modal -->
  <div id="acceptance-criteria-chat-modal" class="chat-modal">
    <div class="chat-modal-content">
      <div class="chat-header">
        <span>💬 Edit Acceptance Criteria</span>
        <button class="chat-close" onclick="closeAcceptanceCriteriaChat()">&times;</button>
      </div>
      <div class="chat-container">
        <!-- Current Criteria Display -->
        <div class="current-description">
          <h6>Current Acceptance Criteria:</h6>
          <ul id="current-criteria-display" class="criteria-list"></ul>
        </div>
        
        <!-- Chat Messages -->
        <div class="chat-messages" id="criteria-chat-messages">
          <div class="chat-message assistant">
            <div class="chat-avatar assistant">AI</div>
            <div class="chat-bubble">
              Hello! I'm here to help you refine your acceptance criteria. You can ask me to:
              <br>• Make them more detailed and specific
              <br>• Add security, performance, or accessibility requirements
              <br>• Format them using Given/When/Then structure
              <br>• Simplify or reorganize the criteria
              <br>• Add edge cases and negative scenarios
              <br><br>What would you like to change about the current criteria?
            </div>
          </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-area">
          <textarea id="criteria-chat-input" class="chat-input" placeholder="Ask me to improve the acceptance criteria..." rows="1"></textarea>
          <button class="chat-send-btn" onclick="sendAcceptanceCriteriaMessage()" id="criteria-send-btn">
            <span>📤</span>
            Send
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Tagged Requirements Chat Modal -->
  <div id="requirements-chat-modal" class="chat-modal">
    <div class="chat-modal-content">
      <div class="chat-header">
        <span>💬 Edit Tagged Requirements</span>
        <button class="chat-close" onclick="closeRequirementsChat()">&times;</button>
      </div>
      <div class="chat-container">
        <!-- Current Requirements Display -->
        <div class="current-description">
          <h6>Current Tagged Requirements:</h6>
          <ul id="current-requirements-display" class="requirements-list"></ul>
        </div>
        
        <!-- Chat Messages -->
        <div class="chat-messages" id="requirements-chat-messages">
          <div class="chat-message assistant">
            <div class="chat-avatar assistant">AI</div>
            <div class="chat-bubble">
              Hello! I'm here to help you refine your tagged requirements. You can ask me to:
              <br>• Add compliance and regulatory requirements
              <br>• Include security and privacy standards
              <br>• Add performance and scalability requirements
              <br>• Include integration and API requirements
              <br>• Add accessibility standards
              <br>• Include audit and monitoring requirements
              <br><br>What type of requirements would you like to add or modify?
            </div>
          </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-area">
          <textarea id="requirements-chat-input" class="chat-input" placeholder="Ask me to improve the tagged requirements..." rows="1"></textarea>
          <button class="chat-send-btn" onclick="sendRequirementsMessage()" id="requirements-send-btn">
            <span>📤</span>
            Send
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Epic Chat Modal -->
  <div id="epic-chat-modal" class="chat-modal">
    <div class="chat-modal-content">
      <div class="chat-header">
        <span>💬 Edit Epic</span>
        <button class="chat-close" onclick="closeEpicChat()">&times;</button>
      </div>
      <div class="chat-container">
        <!-- Current Epic Display -->
        <div class="current-description">
          <h6>Current Epic:</h6>
          <p class="current-epic-text" id="current-epic-display"></p>
        </div>
        
        <!-- Chat Messages -->
        <div class="chat-messages" id="epic-chat-messages">
          <div class="chat-message assistant">
            <div class="chat-avatar assistant">AI</div>
            <div class="chat-bubble">
              Hello! I'm here to help you refine your epic. You can ask me to:
              <br>• Make it more strategic and high-level
              <br>• Improve alignment with business objectives
              <br>• Add context about user value and benefits
              <br>• Adjust scope and structure
              <br>• Make it more actionable for the development team
              <br><br>What would you like to change about the current epic?
            </div>
          </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-area">
          <textarea id="epic-chat-input" class="chat-input" placeholder="Ask me to revise the epic..." rows="1"></textarea>
          <button class="chat-send-btn" onclick="sendEpicMessage()" id="epic-send-btn">
            <span>📤</span>
            Send
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- User Story Chat Modal -->
  <div id="user-story-chat-modal" class="chat-modal">
    <div class="chat-modal-content">
      <div class="chat-header">
        <span>💬 Edit User Story</span>
        <button class="chat-close" onclick="closeUserStoryChat()">&times;</button>
      </div>
      <div class="chat-container">
        <!-- Current User Story Display -->
        <div class="current-description">
          <h6>Current User Story:</h6>
          <p class="current-user-story-text" id="current-user-story-display"></p>
        </div>
        
        <!-- Chat Messages -->
        <div class="chat-messages" id="user-story-chat-messages">
          <div class="chat-message assistant">
            <div class="chat-avatar assistant">AI</div>
            <div class="chat-bubble">
              Hello! I'm here to help you refine your user story. You can ask me to:
              <br>• Improve the user story format (As a... I want... So that...)
              <br>• Make it more specific and actionable
              <br>• Add clarity about user needs and goals
              <br>• Ensure it's testable and deliverable
              <br>• Add context about user personas or scenarios
              <br><br>What would you like to change about the current user story?
            </div>
          </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-area">
          <textarea id="user-story-chat-input" class="chat-input" placeholder="Ask me to improve the user story..." rows="1"></textarea>
          <button class="chat-send-btn" onclick="sendUserStoryMessage()" id="user-story-send-btn">
            <span>📤</span>
            Send
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
  function goBack() {
    window.history.back();
  }

  function submitToJira() {
    console.log('Submitting to Jira...');
    
    // Show validation summary
    showValidationSummary();
    
    // Show loading state
    const submitBtn = document.querySelector('.submit-btn');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
      <span style="display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;"></span>
      Submitting to Jira...
    `;
    
    // Add CSS animation for spinner
    if (!document.getElementById('spinner-style')) {
      const style = document.createElement('style');
      style.id = 'spinner-style';
      style.textContent = `
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      `;
      document.head.appendChild(style);
    }
    
    // Get form data and validate
    const form = document.getElementById('jira-form');
    const formData = new FormData(form);
    
    // Log form data for debugging
    console.log('Form data being submitted:');
    for (let [key, value] of formData.entries()) {
      console.log(`${key}: ${value}`);
    }
    
    // Validate required fields
    const userStoryName = formData.get('user_story_name');
    const userStoryDescription = formData.get('user_story_description');
    
    if (!userStoryName || userStoryName.trim() === '') {
      alert('Error: User story name is required');
      resetSubmitButton(submitBtn, originalText);
      return;
    }
    
    if (!userStoryDescription || userStoryDescription.trim() === '') {
      alert('Error: User story description is required');
      resetSubmitButton(submitBtn, originalText);
      return;
    }
    
    // Ask for final confirmation
    const confirmMessage = `You are about to create a Jira ticket with the following details:

📋 Story: ${userStoryName}
🎯 Epic: ${formData.get('epic_title') || 'N/A'}
⚡ Priority: ${formData.get('priority') || 'High'}
🔧 Systems: ${formData.get('responsible_systems') || 'N/A'}

Do you want to proceed?`;
    
    if (!confirm(confirmMessage)) {
      resetSubmitButton(submitBtn, originalText);
      return;
    }
    
    // Submit the form
    fetch('/submit-jira-ticket', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.ok) {
        console.log('Jira submission successful');
        // Show success message briefly before redirect
        submitBtn.innerHTML = `
          <span style="margin-right: 8px;">✅</span>
          Success! Redirecting...
        `;
        
        // Redirect to the response page after a brief delay
        setTimeout(() => {
          return response.text().then(html => {
            document.open();
            document.write(html);
            document.close();
          });
        }, 1000);
      } else {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
    })
    .catch(error => {
      console.error('Error submitting to Jira:', error);
      alert(`Failed to submit to Jira: ${error.message}\n\nPlease check the console for more details and try again.`);
      resetSubmitButton(submitBtn, originalText);
    });
  }
  
  function showValidationSummary() {
    const form = document.getElementById('jira-form');
    const formData = new FormData(form);
    
    const summary = document.getElementById('validation-summary');
    const details = document.getElementById('validation-details');
    
    let html = '';
    html += `<strong>Story:</strong> ${formData.get('user_story_name') || 'Not provided'}<br>`;
    html += `<strong>Epic:</strong> ${formData.get('epic_title') || 'Not provided'}<br>`;
    html += `<strong>Priority:</strong> ${formData.get('priority') || 'High'}<br>`;
    html += `<strong>Systems:</strong> ${formData.get('responsible_systems') || 'Not provided'}<br>`;
    
    const acceptanceCriteria = formData.get('acceptance_criteria');
    const criteriaCount = acceptanceCriteria ? acceptanceCriteria.split('|||').filter(c => c.trim()).length : 0;
    html += `<strong>Acceptance Criteria:</strong> ${criteriaCount} items<br>`;
    
    const requirements = formData.get('tagged_requirements');
    const reqCount = requirements ? requirements.split('|||').filter(r => r.trim()).length : 0;
    html += `<strong>Tagged Requirements:</strong> ${reqCount} items`;
    
    details.innerHTML = html;
    summary.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      summary.style.display = 'none';
    }, 5000);
  }
  
  function resetSubmitButton(button, originalText) {
    button.disabled = false;
    button.innerHTML = originalText;
  }

  function openDescriptionChat() {
    console.log('openDescriptionChat called'); // Debug log
    
    // First, show an alert to confirm the function is being called
    // alert('Description chat function called!'); // Uncomment for testing
    
    const modal = document.getElementById('description-chat-modal');
    console.log('Modal element:', modal); // Debug log
    
    if (!modal) {
      console.error('Modal element not found!');
      alert('❌ Error: Chat modal not found. Please reload the page and try again.');
      return;
    }
    
    const currentDescriptionDisplay = document.getElementById('current-description-display');
    console.log('Current description display element:', currentDescriptionDisplay); // Debug log
    
    // Get current description from the form or display
    let currentDescription = '';
    const hiddenInput = document.querySelector('input[name="user_story_description"]');
    const displayElement = document.querySelector('.enhanced-description');
    
    if (hiddenInput && hiddenInput.value) {
      currentDescription = hiddenInput.value;
    } else if (displayElement) {
      currentDescription = displayElement.textContent.trim();
    } else {
      currentDescription = 'No description available';
    }
    
    console.log('Current description:', currentDescription); // Debug log
    
    // Update the current description display in the modal
    if (currentDescriptionDisplay) {
      currentDescriptionDisplay.textContent = currentDescription;
    }
    
    // Show the modal with extra styling to ensure visibility
    modal.style.display = 'block';
    modal.style.zIndex = '9999';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    
    console.log('Modal should now be visible with computed style:', window.getComputedStyle(modal).display);
    
    // Focus on the input after a short delay
    setTimeout(() => {
      const inputElement = document.getElementById('description-chat-input');
      if (inputElement) {
        inputElement.focus();
        console.log('Input focused');
      } else {
        console.error('Chat input element not found');
      }
    }, 200);
    
    // Add event listener for Enter key (only add once)
    const chatInput = document.getElementById('description-chat-input');
    if (chatInput && !chatInput.hasAttribute('data-listener-added')) {
      chatInput.setAttribute('data-listener-added', 'true');
      chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendDescriptionMessage();
        }
      });
    }
  }
  
  // Test function to debug modal issues
  function testDescriptionModal() {
    console.log('Test function called');
    alert('Test button clicked! Now trying to open modal...');
    
    const modal = document.getElementById('description-chat-modal');
    console.log('Modal found:', !!modal);
    
    if (modal) {
      modal.style.display = 'block';
      modal.style.zIndex = '99999';
      console.log('Modal display set to block');
      alert('Modal should be visible now. Check if you can see it behind this alert.');
    } else {
      alert('❌ Modal element not found!');
    }
  }
  
  function closeDescriptionChat() {
    const modal = document.getElementById('description-chat-modal');
    modal.style.display = 'none';
  }
  
  function sendDescriptionMessage() {
    const input = document.getElementById('description-chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addDescriptionChatMessage(message, 'user');
    
    // Clear input
    input.value = '';
    
    // Show loading state
    const sendBtn = document.getElementById('description-send-btn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="chat-loading-dots"></span> Processing';
    
    // Add loading message
    const loadingMessageId = addDescriptionChatMessage('', 'assistant', true);
    
    // Get current description
    const currentDescription = document.querySelector('input[name="user_story_description"]').value || 
                              document.querySelector('.enhanced-description').textContent.trim();
    
    // Call backend API
    fetch('/chat-description', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: message,
        current_description: currentDescription
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Description Chat API Response:', data);
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if (loadingMsg) loadingMsg.remove();
      
      if (data.success) {
        // Get the AI response - check both possible response properties
        const aiResponse = data.message || data.response || 'No response received';
        console.log('AI Response:', aiResponse);
        
        // Add AI response
        addDescriptionChatMessage(aiResponse, 'assistant');
        
        // If there's an updated description, offer to apply it
        if (data.updated_description && data.updated_description !== currentDescription) {
          const buttonId = 'apply-btn-' + Date.now();
          addDescriptionChatMessage(
            `Here's the updated description. Would you like me to apply this change?
            
            <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin: 8px 0; font-style: italic;">
              "${data.updated_description}"
            </div>
            
            <button id="${buttonId}" 
                    style="background: #d0021b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 8px;">
              ✓ Apply This Description
            </button>`, 
            'assistant'
          );
          
          // Add click event listener to the button
          setTimeout(() => {
            const button = document.getElementById(buttonId);
            if (button) {
              button.addEventListener('click', () => {
                applyDescriptionUpdate(data.updated_description);
              });
            }
          }, 100);
        }
      } else {
        addDescriptionChatMessage('Sorry, I encountered an error processing your request. Please try again.', 'assistant');
      }
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    })
    .catch(error => {
      console.error('Error calling chat API:', error);
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if (loadingMsg) loadingMsg.remove();
      
      // Show error message
      addDescriptionChatMessage('Sorry, I encountered a connection error. Please check your internet connection and try again.', 'assistant');
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    });
  }
  
  function addDescriptionChatMessage(message, sender, isLoading = false) {
    const messagesContainer = document.getElementById('description-chat-messages');
    const messageDiv = document.createElement('div');
    const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    messageDiv.id = messageId;
    messageDiv.className = `chat-message ${sender}`;
    
    if (isLoading) {
      messageDiv.innerHTML = `
        <div class="chat-avatar ${sender}">${sender === 'user' ? 'U' : 'AI'}</div>
        <div class="chat-bubble">
          <div class="chat-loading">
            <span class="chat-loading-dots"></span>
            Thinking about your request
          </div>
        </div>
      `;
    } else {
      messageDiv.innerHTML = `
        <div class="chat-avatar ${sender}">${sender === 'user' ? 'U' : 'AI'}</div>
        <div class="chat-bubble">${message}</div>
      `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
  }
  
  
  function applyDescriptionUpdate(newDescription) {
    // Decode HTML entities first
    const textarea = document.createElement('textarea');
    textarea.innerHTML = newDescription;
    const decodedDescription = textarea.value;
    
    // Update the hidden form field
    const hiddenInput = document.querySelector('input[name="user_story_description"]');
    if (hiddenInput) {
      hiddenInput.value = decodedDescription;
    }
    
    // Update the visible description on the page
    const descriptionDisplay = document.querySelector('.enhanced-description');
    if (descriptionDisplay) {
      descriptionDisplay.textContent = decodedDescription;
    }
    
    // Update the current description display in the modal
    const currentDescriptionDisplay = document.getElementById('current-description-display');
    if (currentDescriptionDisplay) {
      currentDescriptionDisplay.textContent = decodedDescription;
    }
    
    // Show success message
    addDescriptionChatMessage('✅ Description updated successfully! The changes are now applied to your user story.', 'assistant');
    
    // Auto-save the changes
    saveUserStoryData();
  }
  
  // Close modal when clicking outside
  window.addEventListener('click', function(e) {
    const descriptionModal = document.getElementById('description-chat-modal');
    const criteriaModal = document.getElementById('acceptance-criteria-chat-modal');
    const requirementsModal = document.getElementById('requirements-chat-modal');
    const epicModal = document.getElementById('epic-chat-modal');
    const userStoryModal = document.getElementById('user-story-chat-modal');
    
    if (e.target === descriptionModal) {
      closeDescriptionChat();
    }
    if (e.target === criteriaModal) {
      closeAcceptanceCriteriaChat();
    }
    if (e.target === requirementsModal) {
      closeRequirementsChat();
    }
    if (e.target === epicModal) {
      closeEpicChat();
    }
    if (e.target === userStoryModal) {
      closeUserStoryChat();
    }
  });

  function openAcceptanceCriteriaChat() {
    const modal = document.getElementById('acceptance-criteria-chat-modal');
    const currentCriteriaDisplay = document.getElementById('current-criteria-display');
    
    // Get current acceptance criteria
    const acceptanceCriteriaInput = document.querySelector('input[name="acceptance_criteria"]');
    let currentCriteria = [];
    
    if (acceptanceCriteriaInput && acceptanceCriteriaInput.value) {
      currentCriteria = acceptanceCriteriaInput.value.split('|||').filter(c => c.trim());
    } else {
      // Fallback: extract from displayed criteria
      const criteriaElements = document.querySelectorAll('.criteria-list li');
      currentCriteria = Array.from(criteriaElements).map(li => li.textContent.trim());
    }
    
    // Update the current criteria display in the modal
    currentCriteriaDisplay.innerHTML = '';
    currentCriteria.forEach(criterion => {
      const li = document.createElement('li');
      li.textContent = criterion;
      currentCriteriaDisplay.appendChild(li);
    });
    
    // Show the modal
    modal.style.display = 'block';
    
    // Focus on the input
    setTimeout(() => {
      document.getElementById('criteria-chat-input').focus();
    }, 100);
    
    // Add event listener for Enter key
    const chatInput = document.getElementById('criteria-chat-input');
    chatInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendAcceptanceCriteriaMessage();
      }
    });
  }
  
  function closeAcceptanceCriteriaChat() {
    const modal = document.getElementById('acceptance-criteria-chat-modal');
    modal.style.display = 'none';
  }
  
  function sendAcceptanceCriteriaMessage() {
    const input = document.getElementById('criteria-chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addAcceptanceCriteriaChatMessage(message, 'user');
    
    // Clear input
    input.value = '';
    
    // Show loading state
    const sendBtn = document.getElementById('criteria-send-btn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="chat-loading-dots"></span> Processing';
    
    // Add loading message
    const loadingMessageId = addAcceptanceCriteriaChatMessage('', 'assistant', true);
    
    // Get current criteria and story context
    const acceptanceCriteriaInput = document.querySelector('input[name="acceptance_criteria"]');
    let currentCriteria = [];
    
    if (acceptanceCriteriaInput && acceptanceCriteriaInput.value) {
      currentCriteria = acceptanceCriteriaInput.value.split('|||').filter(c => c.trim());
    } else {
      const criteriaElements = document.querySelectorAll('.criteria-list li');
      currentCriteria = Array.from(criteriaElements).map(li => li.textContent.trim());
    }
    
    const storyContext = document.querySelector('input[name="user_story_name"]').value + ': ' + 
                        document.querySelector('input[name="user_story_description"]').value;
    
    // Call backend API
    fetch('/chat-acceptance-criteria', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: message,
        current_criteria: currentCriteria,
        story_context: storyContext
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Acceptance Criteria Chat API Response:', data);
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if (loadingMsg) loadingMsg.remove();
      
      if (data.success) {
        // Get the AI response - check both possible response properties
        const aiResponse = data.message || data.response || 'No response received';
        console.log('AI Response:', aiResponse);
        
        // Add AI response
        addAcceptanceCriteriaChatMessage(aiResponse, 'assistant');
        
        // If there are updated criteria, offer to apply them
        if (data.updated_criteria && Array.isArray(data.updated_criteria) && data.updated_criteria.length > 0) {
          const criteriaPreview = data.updated_criteria.map(c => `• ${c}`).join('<br>');
          const buttonId = 'apply-criteria-btn-' + Date.now();
          
          addAcceptanceCriteriaChatMessage(
            `Here are the updated acceptance criteria. Would you like me to apply these changes?
            
            <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin: 8px 0; font-style: italic;">
              ${criteriaPreview}
            </div>
            
            <button id="${buttonId}" 
                    style="background: #d0021b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 8px;">
              ✓ Apply These Criteria
            </button>`, 
            'assistant'
          );
          
          // Add click event listener to the button
          setTimeout(() => {
            const button = document.getElementById(buttonId);
            if (button) {
              button.addEventListener('click', () => {
                applyAcceptanceCriteriaUpdate(data.updated_criteria);
              });
            }
          }, 100);
        }
      } else {
        addAcceptanceCriteriaChatMessage('Sorry, I encountered an error processing your request. Please try again.', 'assistant');
      }
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    })
    .catch(error => {
      console.error('Error calling acceptance criteria chat API:', error);
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if (loadingMsg) loadingMsg.remove();
      
      // Show error message
      addAcceptanceCriteriaChatMessage('Sorry, I encountered a connection error. Please check your internet connection and try again.', 'assistant');
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    });
  }
  
  function addAcceptanceCriteriaChatMessage(message, sender, isLoading = false) {
    const messagesContainer = document.getElementById('criteria-chat-messages');
    const messageDiv = document.createElement('div');
    const messageId = 'criteria-msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    messageDiv.id = messageId;
    messageDiv.className = `chat-message ${sender}`;
    
    if (isLoading) {
      messageDiv.innerHTML = `
        <div class="chat-avatar ${sender}">${sender === 'user' ? 'U' : 'AI'}</div>
        <div class="chat-bubble">
          <div class="chat-loading">
            <span class="chat-loading-dots"></span>
            Analyzing your acceptance criteria
          </div>
        </div>
      `;
    } else {
      messageDiv.innerHTML = `
        <div class="chat-avatar ${sender}">${sender === 'user' ? 'U' : 'AI'}</div>
        <div class="chat-bubble">${message}</div>
      `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
  }
  
  function applyAcceptanceCriteriaUpdate(newCriteria) {
    if (!Array.isArray(newCriteria)) return;
    
    // Update the hidden form field
    const hiddenInput = document.querySelector('input[name="acceptance_criteria"]');
    if (hiddenInput) {
      hiddenInput.value = newCriteria.join('|||');
    }
    
    // Update the visible criteria on the page
    const criteriaList = document.querySelector('.criteria-list');
    if (criteriaList) {
      criteriaList.innerHTML = '';
      newCriteria.forEach(criterion => {
        const li = document.createElement('li');
        li.textContent = criterion;
        criteriaList.appendChild(li);
      });
    }
    
    // Update the current criteria display in the modal
    const currentCriteriaDisplay = document.getElementById('current-criteria-display');
    if (currentCriteriaDisplay) {
      currentCriteriaDisplay.innerHTML = '';
      newCriteria.forEach(criterion => {
        const li = document.createElement('li');
        li.textContent = criterion;
        currentCriteriaDisplay.appendChild(li);
      });
    }
    
    // Show success message
    addAcceptanceCriteriaChatMessage('✅ Acceptance criteria updated successfully! The changes are now applied to your user story.', 'assistant');
    
    // Auto-save the changes
    saveUserStoryData();
  }

  function openRequirementsChat() {
    const modal = document.getElementById('requirements-chat-modal');
    const currentRequirementsDisplay = document.getElementById('current-requirements-display');
    
    // Get current tagged requirements
    const requirementsInput = document.querySelector('input[name="tagged_requirements"]');
    let currentRequirements = [];
    
    if (requirementsInput && requirementsInput.value) {
      currentRequirements = requirementsInput.value.split('|||').filter(r => r.trim());
    } else {
      // Fallback: extract from displayed requirements
      const requirementElements = document.querySelectorAll('.requirements-list li');
      currentRequirements = Array.from(requirementElements).map(li => li.textContent.trim());
    }
    
    // Update the current requirements display in the modal
    currentRequirementsDisplay.innerHTML = '';
    currentRequirements.forEach(requirement => {
      const li = document.createElement('li');
      li.textContent = requirement;
      currentRequirementsDisplay.appendChild(li);
    });
    
    // Show the modal
    modal.style.display = 'block';
    
    // Focus on the input
    setTimeout(() => {
      document.getElementById('requirements-chat-input').focus();
    }, 100);
    
    // Add event listener for Enter key
    const chatInput = document.getElementById('requirements-chat-input');
    chatInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendRequirementsMessage();
      }
    });
  }
  
  function closeRequirementsChat() {
    const modal = document.getElementById('requirements-chat-modal');
    modal.style.display = 'none';
  }
  
  function sendRequirementsMessage() {
    const input = document.getElementById('requirements-chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addRequirementsChatMessage(message, 'user');
    
    // Clear input
    input.value = '';
    
    // Show loading state
    const sendBtn = document.getElementById('requirements-send-btn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="chat-loading-dots"></span> Processing';
    
    // Add loading message
    const loadingMessageId = addRequirementsChatMessage('', 'assistant', true);
    
    // Get current requirements and story context
    const requirementsInput = document.querySelector('input[name="tagged_requirements"]');
    let currentRequirements = [];
    
    if (requirementsInput && requirementsInput.value) {
      currentRequirements = requirementsInput.value.split('|||').filter(r => r.trim());
    } else {
      const requirementElements = document.querySelectorAll('.requirements-list li');
      currentRequirements = Array.from(requirementElements).map(li => li.textContent.trim());
    }
    
    const storyContext = document.querySelector('input[name="user_story_name"]').value + ': ' + 
                        document.querySelector('input[name="user_story_description"]').value;
    
    // Call backend API
    fetch('/chat-requirements', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: message,
        current_requirements: currentRequirements,
        story_context: storyContext
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Requirements Chat API Response:', data);
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if (loadingMsg) loadingMsg.remove();
      
      if (data.success) {
        // Get the AI response - check both possible response properties
        const aiResponse = data.message || data.response || 'No response received';
        console.log('AI Response:', aiResponse);
        
        // Add AI response
        addRequirementsChatMessage(aiResponse, 'assistant');
        
        // If there are updated requirements, offer to apply them
        if (data.updated_requirements && Array.isArray(data.updated_requirements) && data.updated_requirements.length > 0) {
          const requirementsPreview = data.updated_requirements.map(r => `• ${r}`).join('<br>');
          const buttonId = 'apply-requirements-btn-' + Date.now();
          
          addRequirementsChatMessage(
            `Here are the updated tagged requirements. Would you like me to apply these changes?
            
            <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin: 8px 0; font-style: italic;">
              ${requirementsPreview}
            </div>
            
            <button id="${buttonId}" 
                    style="background: #d0021b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 8px;">
              ✓ Apply These Requirements
            </button>`, 
            'assistant'
          );
          
          // Add click event listener to the button
          setTimeout(() => {
            const button = document.getElementById(buttonId);
            if (button) {
              button.addEventListener('click', () => {
                applyRequirementsUpdate(data.updated_requirements);
              });
            }
          }, 100);
        }
      } else {
        addRequirementsChatMessage('Sorry, I encountered an error processing your request. Please try again.', 'assistant');
      }
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    })
    .catch(error => {
      console.error('Error calling requirements chat API:', error);
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if (loadingMsg) loadingMsg.remove();
      
      // Show error message
      addRequirementsChatMessage('Sorry, I encountered a connection error. Please check your internet connection and try again.', 'assistant');
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    });
  }
  
  function addRequirementsChatMessage(message, sender, isLoading = false) {
    const messagesContainer = document.getElementById('requirements-chat-messages');
    const messageDiv = document.createElement('div');
    const messageId = 'requirements-msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    messageDiv.id = messageId;
    messageDiv.className = `chat-message ${sender}`;
    
    if (isLoading) {
      messageDiv.innerHTML = `
        <div class="chat-avatar ${sender}">${sender === 'user' ? 'U' : 'AI'}</div>
        <div class="chat-bubble">
          <div class="chat-loading">
            <span class="chat-loading-dots"></span>
            Analyzing your requirements
          </div>
        </div>
      `;
    } else {
      messageDiv.innerHTML = `
        <div class="chat-avatar ${sender}">${sender === 'user' ? 'U' : 'AI'}</div>
        <div class="chat-bubble">${message}</div>
      `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
  }
  
  function applyRequirementsUpdate(newRequirements) {
    if (!Array.isArray(newRequirements)) return;
    
    // Update the hidden form field
    const hiddenInput = document.querySelector('input[name="tagged_requirements"]');
    if (hiddenInput) {
      hiddenInput.value = newRequirements.join('|||');
    }
    
    // Update the visible requirements on the page
    const requirementsList = document.querySelector('.requirements-list');
    if (requirementsList) {
      requirementsList.innerHTML = '';
      newRequirements.forEach(requirement => {
        const li = document.createElement('li');
        li.textContent = requirement;
        requirementsList.appendChild(li);
      });
    }
    
    // Update the current requirements display in the modal
    const currentRequirementsDisplay = document.getElementById('current-requirements-display');
    if (currentRequirementsDisplay) {
      currentRequirementsDisplay.innerHTML = '';
      newRequirements.forEach(requirement => {
        const li = document.createElement('li');
        li.textContent = requirement;
        currentRequirementsDisplay.appendChild(li);
      });
    }
    
    // Show success message
    addRequirementsChatMessage('✅ Tagged requirements updated successfully! The changes are now applied to your user story.', 'assistant');
    
    // Auto-save the changes
    saveUserStoryData();
  }
  
  // Save user story data to localStorage for persistence
  function saveUserStoryData() {
    const data = {
      epic_title: document.querySelector('input[name="epic_title"]').value,
      user_story_name: document.querySelector('input[name="user_story_name"]').value,
      user_story_description: document.querySelector('input[name="user_story_description"]').value,
      priority: document.querySelector('input[name="priority"]').value,
      responsible_systems: document.querySelector('input[name="responsible_systems"]').value,
      acceptance_criteria: document.querySelector('input[name="acceptance_criteria"]').value,
      tagged_requirements: document.querySelector('input[name="tagged_requirements"]').value,
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('current_user_story', JSON.stringify(data));
    console.log('User story data saved to localStorage');
  }
  
  // Auto-save data when form changes
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('jira-form');
    if (form) {
      // Save data every 30 seconds
      setInterval(saveUserStoryData, 30000);
      
      // Save data when user leaves the page
      window.addEventListener('beforeunload', saveUserStoryData);
    }
    
    // Log current form data for debugging
    console.log('Page loaded. Current form data:');
    const formData = new FormData(document.getElementById('jira-form'));
    for (let [key, value] of formData.entries()) {
      console.log(`${key}: ${value}`);
    }
    
    // Add debug button (remove in production)
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      addDebugButton();
    }
  });
  
  // Epic Chat Functions
  function openEpicChat() {
    const modal = document.getElementById('epic-chat-modal');
    if (!modal) {
      alert('❌ Error: Epic chat modal not found. Please reload the page and try again.');
      return;
    }
    
    const currentEpicDisplay = document.getElementById('current-epic-display');
    
    // Get current epic title
    let currentEpic = '';
    const hiddenInput = document.querySelector('input[name="epic_title"]');
    const displayElement = document.querySelector('.epic-title');
    
    if (hiddenInput && hiddenInput.value) {
      currentEpic = hiddenInput.value;
    } else if (displayElement) {
      currentEpic = displayElement.textContent.trim();
    } else {
      currentEpic = 'No epic available';
    }
    
    // Update the current epic display in the modal
    if (currentEpicDisplay) {
      currentEpicDisplay.textContent = currentEpic;
    }
    
    // Show the modal
    modal.style.display = 'block';
    
    // Focus on the input
    setTimeout(() => {
      const inputElement = document.getElementById('epic-chat-input');
      if (inputElement) {
        inputElement.focus();
      }
    }, 100);
    
    // Add event listener for Enter key
    const chatInput = document.getElementById('epic-chat-input');
    if (chatInput && !chatInput.hasAttribute('data-listener-added')) {
      chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendEpicMessage();
        }
      });
      chatInput.setAttribute('data-listener-added', 'true');
    }
  }
  
  function closeEpicChat() {
    const modal = document.getElementById('epic-chat-modal');
    modal.style.display = 'none';
  }
  
  function sendEpicMessage() {
    const input = document.getElementById('epic-chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addEpicChatMessage(message, 'user');
    
    // Clear input
    input.value = '';
    
    // Show loading state
    const sendBtn = document.getElementById('epic-send-btn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="chat-loading-dots"></span> Processing';
    
    // Add loading message
    const loadingMessageId = addEpicChatMessage('', 'assistant', true);
    
    // Get current epic and story context
    const epicInput = document.querySelector('input[name="epic_title"]');
    const currentEpic = epicInput ? epicInput.value : '';
    
    const storyContext = document.querySelector('input[name="user_story_name"]').value + ': ' + 
                        document.querySelector('input[name="user_story_description"]').value;
    
    // Call backend API
    fetch('/epic-chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: message,
        current_epic: currentEpic,
        story_context: storyContext
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Epic Chat API Response:', data);
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if (loadingMsg) loadingMsg.remove();
      
      if (data.success) {
        // Get the AI response - check both possible response properties
        const aiResponse = data.message || data.response || 'No response received';
        console.log('AI Response:', aiResponse);
        
        // Add AI response
        addEpicChatMessage(aiResponse, 'assistant');
        
        // If there's an updated epic, offer to apply it
        if (data.updated_epic && data.updated_epic.trim()) {
          const buttonId = 'apply-epic-btn-' + Date.now();
          
          addEpicChatMessage(
            `Here's the updated epic. Would you like me to apply this change?
            
            <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin: 8px 0; font-style: italic;">
              ${data.updated_epic}
            </div>
            
            <button id="${buttonId}" 
                    style="background: #d0021b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 8px;">
              ✓ Apply This Epic
            </button>`, 
            'assistant'
          );
          
          // Add click event listener to the button
          setTimeout(() => {
            const button = document.getElementById(buttonId);
            if (button) {
              button.addEventListener('click', () => {
                applyEpicUpdate(data.updated_epic);
              });
            }
          }, 100);
        }
      } else {
        addEpicChatMessage('Sorry, I encountered an error processing your request. Please try again.', 'assistant');
      }
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    })
    .catch(error => {
      console.error('Error calling epic chat API:', error);
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if (loadingMsg) loadingMsg.remove();
      
      // Show error message
      addEpicChatMessage('Sorry, I encountered a connection error. Please check your internet connection and try again.', 'assistant');
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    });
  }
  
  function addEpicChatMessage(message, sender, isLoading = false) {
    const messagesContainer = document.getElementById('epic-chat-messages');
    const messageDiv = document.createElement('div');
    const messageId = 'epic-msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    messageDiv.id = messageId;
    
    if (isLoading) {
      messageDiv.className = 'chat-message assistant';
      messageDiv.innerHTML = `
        <div class="chat-avatar assistant">AI</div>
        <div class="chat-bubble">
          <div class="chat-loading-dots"></div>
        </div>
      `;
    } else {
      messageDiv.className = `chat-message ${sender}`;
      
      if (sender === 'user') {
        messageDiv.innerHTML = `
          <div class="chat-bubble">${message}</div>
          <div class="chat-avatar user">You</div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="chat-avatar assistant">AI</div>
          <div class="chat-bubble">${message}</div>
        `;
      }
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
  }
  
  function applyEpicUpdate(newEpic) {
    // Update the hidden input
    const epicInput = document.querySelector('input[name="epic_title"]');
    if (epicInput) {
      epicInput.value = newEpic;
    }
    
    // Update the display
    const epicDisplay = document.querySelector('.epic-title');
    if (epicDisplay) {
      epicDisplay.innerHTML = newEpic;
    }
    
    // Update the modal display
    const currentEpicDisplay = document.getElementById('current-epic-display');
    if (currentEpicDisplay) {
      currentEpicDisplay.textContent = newEpic;
    }
    
    // Save to localStorage
    saveUserStoryData();
    
    // Show success message
    addEpicChatMessage('✅ Epic updated successfully! The changes are now applied to your story.', 'assistant');
  }
  
  // User Story Chat Functions
  function openUserStoryChat() {
    const modal = document.getElementById('user-story-chat-modal');
    if (!modal) {
      alert('❌ Error: User story chat modal not found. Please reload the page and try again.');
      return;
    }
    
    const currentUserStoryDisplay = document.getElementById('current-user-story-display');
    
    // Get current user story
    let currentUserStory = '';
    const hiddenInput = document.querySelector('input[name="user_story_name"]');
    const displayElement = document.querySelector('.story-header');
    
    if (hiddenInput && hiddenInput.value) {
      currentUserStory = hiddenInput.value;
    } else if (displayElement) {
      currentUserStory = displayElement.textContent.replace('User story: ', '').trim();
    } else {
      currentUserStory = 'No user story available';
    }
    
    // Update the current user story display in the modal
    if (currentUserStoryDisplay) {
      currentUserStoryDisplay.textContent = currentUserStory;
    }
    
    // Show the modal
    modal.style.display = 'block';
    
    // Focus on the input
    setTimeout(() => {
      const inputElement = document.getElementById('user-story-chat-input');
      if (inputElement) {
        inputElement.focus();
      }
    }, 100);
    
    // Add event listener for Enter key
    const chatInput = document.getElementById('user-story-chat-input');
    if (chatInput && !chatInput.hasAttribute('data-listener-added')) {
      chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendUserStoryMessage();
        }
      });
      chatInput.setAttribute('data-listener-added', 'true');
    }
  }
  
  function closeUserStoryChat() {
    const modal = document.getElementById('user-story-chat-modal');
    modal.style.display = 'none';
  }
  
  function sendUserStoryMessage() {
    const input = document.getElementById('user-story-chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addUserStoryChatMessage(message, 'user');
    
    // Clear input
    input.value = '';
    
    // Show loading state
    const sendBtn = document.getElementById('user-story-send-btn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="chat-loading-dots"></span> Processing';
    
    // Add loading message
    const loadingMessageId = addUserStoryChatMessage('', 'assistant', true);
    
    // Get current user story and context
    const userStoryInput = document.querySelector('input[name="user_story_name"]');
    const currentUserStory = userStoryInput ? userStoryInput.value : '';
    
    const epicTitle = document.querySelector('input[name="epic_title"]').value;
    const description = document.querySelector('input[name="user_story_description"]').value;
    
    // Call backend API
    fetch('/user-story-chat', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: message,
        current_user_story: currentUserStory,
        epic_title: epicTitle,
        description: description
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('User Story Chat API Response:', data);
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if (loadingMsg) loadingMsg.remove();
      
      if (data.success) {
        // Get the AI response - check both possible response properties
        const aiResponse = data.message || data.response || 'No response received';
        console.log('AI Response:', aiResponse);
        
        // Add AI response
        addUserStoryChatMessage(aiResponse, 'assistant');
        
        // If there's an updated user story, offer to apply it
        if (data.updated_user_story && data.updated_user_story.trim()) {
          const buttonId = 'apply-user-story-btn-' + Date.now();
          
          addUserStoryChatMessage(
            `Here's the updated user story. Would you like me to apply this change?
            
            <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin: 8px 0; font-style: italic;">
              ${data.updated_user_story}
            </div>
            
            <button id="${buttonId}" 
                    style="background: #d0021b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 8px;">
              ✓ Apply This User Story
            </button>`, 
            'assistant'
          );
          
          // Add click event listener to the button
          setTimeout(() => {
            const button = document.getElementById(buttonId);
            if (button) {
              button.addEventListener('click', () => {
                applyUserStoryUpdate(data.updated_user_story);
              });
            }
          }, 100);
        }
      } else {
        console.error('API returned error:', data);
        const errorMsg = data.error || 'Sorry, I encountered an error processing your request. Please try again.';
        addUserStoryChatMessage(errorMsg, 'assistant');
      }
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    })
    .catch(error => {
      console.error('Error calling user story chat API:', error);
      console.error('Error details:', {
        message: error.message,
        stack: error.stack
      });
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if (loadingMsg) loadingMsg.remove();
      
      // Show error message
      addUserStoryChatMessage('Sorry, I encountered a connection error. Please check your internet connection and try again.', 'assistant');
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    });
  }
  
  function addUserStoryChatMessage(message, sender, isLoading = false) {
    const messagesContainer = document.getElementById('user-story-chat-messages');
    const messageDiv = document.createElement('div');
    const messageId = 'user-story-msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    messageDiv.id = messageId;
    
    if (isLoading) {
      messageDiv.className = 'chat-message assistant';
      messageDiv.innerHTML = `
        <div class="chat-avatar assistant">AI</div>
        <div class="chat-bubble">
          <div class="chat-loading-dots"></div>
        </div>
      `;
    } else {
      messageDiv.className = `chat-message ${sender}`;
      
      if (sender === 'user') {
        messageDiv.innerHTML = `
          <div class="chat-bubble">${message}</div>
          <div class="chat-avatar user">You</div>
        `;
      } else {
        messageDiv.innerHTML = `
          <div class="chat-avatar assistant">AI</div>
          <div class="chat-bubble">${message}</div>
        `;
      }
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
  }
  
  function applyUserStoryUpdate(newUserStory) {
    // Update the hidden input
    const userStoryInput = document.querySelector('input[name="user_story_name"]');
    if (userStoryInput) {
      userStoryInput.value = newUserStory;
    }
    
    // Update the display
    const storyDisplay = document.querySelector('.story-header');
    if (storyDisplay) {
      storyDisplay.innerHTML = `User story: ${newUserStory}
        <button class="chat-btn" onclick="openUserStoryChat()" style="margin-left: 10px; float: right;">
          <span>💬 Chat</span>
        </button>`;
    }
    
    // Update the modal display
    const currentUserStoryDisplay = document.getElementById('current-user-story-display');
    if (currentUserStoryDisplay) {
      currentUserStoryDisplay.textContent = newUserStory;
    }
    
    // Save to localStorage
    saveUserStoryData();
    
    // Show success message
    addUserStoryChatMessage('✅ User story updated successfully! The changes are now applied.', 'assistant');
  }
  
  function addDebugButton() {
    const debugBtn = document.createElement('button');
    debugBtn.textContent = '🐛 Debug Info';
    debugBtn.style.cssText = `
      position: fixed; top: 10px; right: 10px; z-index: 9999;
      background: #007bff; color: white; border: none; padding: 8px 12px;
      border-radius: 4px; font-size: 12px; cursor: pointer;
    `;
    debugBtn.onclick = function() {
      const formData = new FormData(document.getElementById('jira-form'));
      let debugInfo = 'Form Data:\n';
      for (let [key, value] of formData.entries()) {
        debugInfo += `${key}: ${value}\n`;
      }
      debugInfo += `\nURL: ${window.location.href}`;
      debugInfo += `\nTimestamp: ${new Date().toISOString()}`;
      
      // Copy to clipboard and show alert
      navigator.clipboard.writeText(debugInfo).then(() => {
        alert('Debug info copied to clipboard!\n\n' + debugInfo);
      });
    };
    document.body.appendChild(debugBtn);
  }
</script>
</body>
</html>
