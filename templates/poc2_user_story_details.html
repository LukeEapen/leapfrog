<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Story Drafting Solution</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    /* Modern CSS Variables for Design System */
    :root {
      --primary-red: #d0021b;
      --primary-red-dark: #a0011a;
      --primary-red-light: #ff1744;
      --primary-red-lighter: #fff5f5;
      --background-dark: #1a1d23;
      --background-darker: #121419;
      --background-light: #2a2d35;
      --surface-primary: #ffffff;
      --surface-secondary: #f8fafc;
      --surface-tertiary: #f1f5f9;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-light: #ffffff;
      --text-muted: #94a3b8;
      --border-light: #e2e8f0;
      --border-medium: #cbd5e1;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --spacing-xs: 0.5rem;
      --spacing-sm: 0.75rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
    }

    /* Modern Body Styling with Gradient */
    body {
      background: linear-gradient(135deg, var(--background-darker) 0%, var(--background-dark) 100%);
      color: var(--text-light);
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 20% 80%, rgba(208, 2, 27, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    /* Enhanced Main Container */
    .main-container {
      max-width: 1000px;
      margin: var(--spacing-xl) auto;
      background: var(--surface-primary);
      border: none;
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-xl);
      overflow: hidden;
      position: relative;
      animation: pageSlideIn 0.6s ease-out;
    }

    @keyframes pageSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Enhanced Top Bar */
    .top-bar {
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      color: white;
      padding: var(--spacing-lg) var(--spacing-xl);
      font-size: 1.1rem;
      font-weight: 600;
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
      overflow: hidden;
    }

    .top-bar::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .back-button {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      backdrop-filter: blur(10px);
    }

    .back-button:hover {
      background: rgba(255, 255, 255, 0.25);
      color: white;
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .back-button:active {
      transform: translateY(0);
    }

    /* Enhanced Story Header */
    .story-header {
      background: linear-gradient(135deg, var(--background-light) 0%, #3a3d47 100%);
      color: white;
      padding: var(--spacing-lg);
      margin: 0;
      font-size: 1.375rem;
      font-weight: 700;
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 3px solid var(--primary-red);
    }

    .story-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-red), var(--primary-red-light));
    }

    /* Enhanced Content Container */
    .content-container {
      background: white;
      margin: 0;
      padding: var(--spacing-xl);
      color: var(--text-primary);
      position: relative;
    }

    /* Enhanced Epic Info Section */
    .epic-info-section {
      margin-bottom: var(--spacing-lg);
      padding: var(--spacing-lg);
      background: linear-gradient(135deg, var(--surface-secondary) 0%, var(--surface-tertiary) 100%);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-light);
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .epic-info-section:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .epic-info-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-red), var(--primary-red-light));
      border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    }

    .epic-label {
      color: var(--primary-red);
      font-weight: 700;
      font-size: 0.875rem;
      margin-bottom: var(--spacing-xs);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .epic-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      line-height: 1.4;
    }

    .info-row {
      display: flex;
      gap: var(--spacing-xl);
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
    }

    .info-item {
      display: flex;
      align-items: center;
      font-size: 0.875rem;
      background: white;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
    }

    .info-item:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .info-label {
      font-weight: 600;
      margin-right: var(--spacing-sm);
      color: var(--text-secondary);
    }

    .priority-high {
      color: #ef4444;
      font-weight: 600;
      background: #fef2f2;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      border: 1px solid #fecaca;
    }

    /* Enhanced Section Container */
    .section-container {
      margin-bottom: var(--spacing-lg);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      background: white;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .section-container:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-red);
    }

    .section-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-red), var(--primary-red-light));
      transform: scaleX(0);
      transition: transform 0.3s ease;
      transform-origin: left;
    }

    .section-container:hover::before {
      transform: scaleX(1);
    }

    .section-header {
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      color: #ffffff !important;
      padding: var(--spacing-lg) var(--spacing-xl);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 700;
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: var(--shadow-md);
      border-radius: var(--radius-md) var(--radius-md) 0 0;
    }

    .section-header span {
      color: #ffffff !important;
      font-weight: 700;
    }

    .section-content {
      padding: var(--spacing-lg);
      line-height: 1.7;
      color: var(--text-primary);
      background: white;
      font-size: 1rem;
    }

    /* Enhanced Chat Button */
    .chat-btn {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }

    .chat-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .chat-btn:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.25) 0%, rgba(255, 255, 255, 0.15) 100%);
      color: white;
      transform: translateY(-1px);
      border-color: rgba(255, 255, 255, 0.5);
      box-shadow: var(--shadow-md);
    }

    .chat-btn:hover::before {
      left: 100%;
    }

    .chat-btn:active {
      transform: translateY(0);
    }

    /* Enhanced Lists */
    .requirements-list, .criteria-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .requirements-list li, .criteria-list li {
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: 1px solid var(--border-light);
      font-size: 0.875rem;
      color: var(--text-primary);
      background: var(--surface-secondary);
      margin-bottom: 0.25rem;
      border-radius: var(--radius-md);
      transition: all 0.3s ease;
      position: relative;
    }

    .requirements-list li:hover, .criteria-list li:hover {
      background: var(--primary-red-lighter);
      transform: translateX(4px);
      box-shadow: var(--shadow-sm);
    }

    .requirements-list li:last-child, .criteria-list li:last-child {
      border-bottom: none;
    }

    .criteria-list li {
      border-left: 3px solid var(--primary-red);
      padding-left: var(--spacing-xl);
    }

    .criteria-list li:before {
      content: "✓";
      position: absolute;
      left: var(--spacing-sm);
      color: var(--primary-red);
      font-weight: bold;
      font-size: 1rem;
    }

    /* Enhanced Traceability Matrix Section */
    .traceability-matrix-section .section-content {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border: 1px solid #bae6fd;
      border-radius: var(--radius-md);
    }

    .traceability-content {
      background: var(--surface-primary) !important;
      border: 1px solid var(--border-light) !important;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .traceability-content:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--primary-red) !important;
    }

    /* Enhanced table styling within traceability content */
    .traceability-content table,
    .traceability-content .traceability-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      background: white;
      color: red;
      border-radius: var(--radius-md);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-light);
    }

    .traceability-content th {
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      color: white !important;
      font-weight: 600;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: var(--spacing-md) var(--spacing-lg);
      text-align: left;
      vertical-align: top;
      border: none;
      position: relative;
    }

    .traceability-content th::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: rgba(255, 255, 255, 0.3);
    }

    .traceability-content td {
      padding: var(--spacing-md) var(--spacing-lg);
      text-align: left;
      vertical-align: top;
      border-bottom: 1px solid var(--border-light);
      border-right: 1px solid var(--border-light);
      color: var(--text-primary);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .traceability-content td:last-child {
      border-right: none;
    }

    .traceability-content tr:nth-child(even) {
      background-color: var(--surface-secondary);
    }

    .traceability-content tr:hover {
      background-color: var(--primary-red-lighter) !important;
      transform: scale(1.001);
      transition: all 0.2s ease;
    }

    .traceability-content tr:last-child td {
      border-bottom: none;
    }

    /* Enhanced content formatting */
    .traceability-content h1,
    .traceability-content h2,
    .traceability-content h3,
    .traceability-content h4 {
      color: var(--primary-red);
      font-weight: 600;
      margin-top: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-xs);
      border-bottom: 2px solid var(--primary-red-lighter);
    }

    .traceability-content h1 { font-size: 1.5rem; }
    .traceability-content h2 { font-size: 1.25rem; }
    .traceability-content h3 { font-size: 1.1rem; }
    .traceability-content h4 { font-size: 1rem; }

    .traceability-content ul,
    .traceability-content ol {
      margin: var(--spacing-md) 0;
      padding-left: var(--spacing-xl);
    }

    .traceability-content li {
      margin-bottom: var(--spacing-xs);
      line-height: 1.6;
    }

    .traceability-content p {
      margin-bottom: var(--spacing-md);
      line-height: 1.6;
    }

    .traceability-content strong,
    .traceability-content b {
      color: var(--primary-red);
      font-weight: 600;
    }

    .traceability-content code {
      background: var(--surface-secondary);
      padding: 0.2rem 0.4rem;
      border-radius: var(--radius-sm);
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.85rem;
      border: 1px solid var(--border-light);
    }

    .traceability-content pre {
      background: var(--surface-secondary);
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      overflow-x: auto;
      border: 1px solid var(--border-light);
      margin: var(--spacing-md) 0;
    }

    .traceability-content blockquote {
      border-left: 4px solid var(--primary-red);
      padding-left: var(--spacing-md);
      margin: var(--spacing-md) 0;
      font-style: italic;
      color: var(--text-secondary);
      background: var(--surface-secondary);
      padding: var(--spacing-md);
      border-radius: 0 var(--radius-md) var(--spacing-md) 0;
    }

    /* Loading state for traceability content */
    .traceability-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-xl);
      color: var(--text-muted);
    }

    .traceability-loading::after {
      content: '';
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-light);
      border-top: 2px solid var(--primary-red);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: var(--spacing-sm);
    }

    /* Responsive design for traceability tables */
    @media (max-width: 768px) {
      .traceability-content table {
        font-size: 0.8rem;
      }
      
      .traceability-content th,
      .traceability-content td {
        padding: var(--spacing-sm);
      }
      
      .traceability-content th {
        color: white !important; /* Ensure white text in headers */
      }
      
      .traceability-content {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    }

    /* Print styles for traceability matrix */
    @media print {
      .traceability-matrix-section {
        page-break-inside: avoid;
      }
      
      .traceability-content table {
        border: 1px solid #000 !important;
      }
      
      .traceability-content th {
        background: #f0f0f0 !important;
        color: #000 !important;
      }
    }

    /* Enhanced Submit Button */
    .submit-btn {
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      color: white;
      border: none;
      padding: var(--spacing-lg) var(--spacing-xl);
      border-radius: var(--radius-lg);
      font-weight: 700;
      font-size: 1.125rem;
      cursor: pointer;
      width: 100%;
      margin-top: var(--spacing-xl);
      position: relative;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-lg);
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
    }

    .submit-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .submit-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--primary-red-light) 0%, var(--primary-red) 100%);
      color: white;
      transform: translateY(-2px);
      box-shadow: var(--shadow-xl);
    }

    .submit-btn:hover:not(:disabled)::before {
      left: 100%;
    }

    .submit-btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .submit-btn:disabled {
      background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
      cursor: not-allowed;
      transform: none;
      box-shadow: var(--shadow-md);
    }

    /* Hardcoded Content Styling */
    .hardcoded-content {
      color: #007bff !important;
      font-style: italic;
      font-weight: 500;
    }

    .story-header .hardcoded-content {
      color: #e2e8f0 !important;
    }

    .epic-title .hardcoded-content {
      color: #007bff !important;
    }

    /* Enhanced Description */
    .enhanced-description {
      background: var(--surface-secondary);
      padding: var(--spacing-lg);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--primary-red);
      font-size: 1rem;
      line-height: 1.7;
      color: var(--text-primary);
    }

    /* Validation Summary */
    #validation-summary {
      background: linear-gradient(135deg, var(--surface-secondary) 0%, var(--surface-tertiary) 100%);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-top: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }

    #validation-summary h6 {
      color: var(--primary-red);
      font-weight: 700;
      margin-bottom: var(--spacing-sm);
    }

    /* Story Name and Multiple Stories */
    .story-name-section {
      background: white;
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-sm);
    }

    .multiple-stories-summary {
      background: var(--surface-secondary);
      padding: var(--spacing-lg);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-sm);
    }

    .story-item {
      background: white !important;
      border-left: 3px solid var(--primary-red) !important;
      border-radius: var(--radius-md);
      transition: all 0.3s ease;
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-sm);
    }

    .story-item:hover {
      transform: translateX(4px);
      box-shadow: var(--shadow-md);
    }

    /* Enhanced Responsive Design */
    @media (max-width: 1200px) {
      .main-container {
        margin: var(--spacing-lg);
        max-width: none;
      }
    }

    @media (max-width: 768px) {
      :root {
        --spacing-xl: 1.5rem;
        --spacing-2xl: 2rem;
      }

      .main-container {
        margin: var(--spacing-md);
        border-radius: var(--radius-lg);
      }

      .content-container {
        padding: var(--spacing-lg);
      }

      .info-row {
        flex-direction: column;
        gap: var(--spacing-md);
      }

      .info-item {
        width: 100%;
        justify-content: space-between;
      }

      .chat-btn {
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: 0.75rem;
      }

      .section-header {
        flex-direction: column;
        gap: var(--spacing-sm);
        text-align: center;
      }

      .story-header {
        flex-direction: column;
        gap: var(--spacing-md);
        text-align: center;
        font-size: 1.25rem;
      }

      .submit-btn {
        font-size: 1rem;
        padding: var(--spacing-md) var(--spacing-lg);
      }
    }

    @media (max-width: 480px) {
      .main-container {
        margin: var(--spacing-sm);
      }

      .content-container {
        padding: var(--spacing-md);
      }

      .epic-info-section {
        padding: var(--spacing-md);
      }

      .section-header {
        padding: var(--spacing-md);
        font-size: 0.875rem;
      }

      .section-content {
        padding: var(--spacing-md);
      }

      .top-bar {
        padding: var(--spacing-md);
        font-size: 0.8rem;
      }

      .story-header {
        padding: var(--spacing-md);
        font-size: 1.1rem;
      }
    }

    /* Chat Modal Styles - Enhanced for Modern Design */
    .chat-modal {
      display: none !important;
      position: fixed !important;
      z-index: 99999 !important;
      right: 0px !important;
      top: 0px !important;
      width: 600px !important;
      height: 100vh !important;
      background-color: rgba(0, 0, 0, 0.1) !important;
      backdrop-filter: blur(2px);
    }
    
    .chat-modal[style*="display: block"] {
      display: block !important;
    }
    
    .chat-modal-content {
      background-color: white;
      margin: 0;
      padding: 0;
      border: none;
      border-radius: var(--radius-xl) 0 0 var(--radius-xl);
      width: 100%;
      height: 100%;
      box-shadow: -8px 0 32px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      border-left: 1px solid var(--border-light);
    }
    
    .chat-header {
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      color: white;
      padding: var(--spacing-lg) var(--spacing-xl);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 1rem;
    }
    
    .chat-header-actions {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }
    
    .chat-clear-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      font-size: 1rem;
      cursor: pointer;
      padding: var(--spacing-sm);
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
      font-weight: normal;
    }
    
    .chat-clear-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }
    
    .chat-clear-btn:active {
      transform: scale(0.95);
    }
    
    .chat-close {
      background: none;
      border: none;
      color: white;
      font-size: 1.75rem;
      cursor: pointer;
      padding: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s ease;
      font-weight: normal;
    }
    
    .chat-close:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    .chat-messages {
      flex: 1;
      padding: var(--spacing-xl);
      overflow-y: auto;
      background: var(--surface-secondary);
      display: flex;
      flex-direction: column;
      gap: var(--spacing-lg);
    }
    
    .chat-message {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-md);
      max-width: 80%;
    }
    
    .chat-message.user {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    
    .chat-message.assistant {
      align-self: flex-start;
    }
    
    .chat-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: bold;
      flex-shrink: 0;
    }
    
    .chat-avatar.user {
      background: var(--primary-red);
      color: white;
    }
    
    .chat-avatar.assistant {
      background: var(--surface-secondary);
      color: #8B4513;
      border: 2px solid #007bff;
    }
    
    .chat-bubble {
      background: rgb(224, 224, 235);
      border-radius: var(--radius-xl);
      padding: var(--spacing-md) var(--spacing-lg);
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border-light);
      word-wrap: break-word;
      line-height: 1.6;
      color: #8B4513;
      font-size: 0.875rem;
    }
    
    .chat-message.user .chat-bubble {
      background: var(--primary-red);
      color: white;
      border-color: var(--primary-red);
    }
    
    .chat-input-area {
      padding: var(--spacing-xl);
      background: white;
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: var(--spacing-lg);
      align-items: flex-end;
    }
    
    .chat-input {
      flex: 1;
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-md);
      padding: var(--spacing-md) var(--spacing-lg);
      font-size: 0.875rem;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      font-family: inherit;
      transition: border-color 0.2s ease;
    }
    
    .chat-input:focus {
      outline: none;
      border-color: var(--primary-red);
      box-shadow: 0 0 0 2px rgba(208, 2, 27, 0.1);
    }
    
    .chat-send-btn {
      background: var(--primary-red);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      padding: var(--spacing-md) var(--spacing-lg);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      height: 44px;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: 0.875rem;
    }
    
    .chat-send-btn:hover:not(:disabled) {
      background: var(--primary-red-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .chat-send-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .chat-loading {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      color: var(--text-secondary);
      font-style: italic;
    }
    
    .chat-loading-dots {
      display: inline-block;
    }
    
    .chat-loading-dots::after {
      content: '';
      animation: chatLoading 1.5s infinite;
    }
    
    @keyframes chatLoading {
      0%, 33% { content: '.'; }
      34%, 66% { content: '..'; }
      67%, 100% { content: '...'; }
    }
    
    .current-description {
      background: var(--primary-red-lighter);
      border: 1px solid #fed7d7;
      border-radius: var(--radius-md);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }
    
    .current-description h6 {
      color: var(--primary-red);
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .current-description-text {
      color: var(--text-primary);
      line-height: 1.6;
      margin: 0;
      font-size: 0.875rem;
    }
    
    /* Responsive Chat Modal */
    @media (max-width: 768px) {
      .chat-modal {
        right: 0px !important;
        top: 0px !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.3) !important;
      }
      
      .chat-modal-content {
        border-radius: 0;
        box-shadow: none;
        border: none;
      }
      
      .chat-message {
        max-width: 90%;
      }
      
      .chat-input-area {
        padding: var(--spacing-md);
      }
      
      .chat-input {
        font-size: 0.8rem;
        padding: var(--spacing-sm) var(--spacing-md);
      }
      
      .chat-send-btn {
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: 0.8rem;
      }
    }
    
    @media (max-width: 480px) {
      .chat-modal {
        right: 0px !important;
        top: 0px !important;
        width: 100vw !important;
        height: 100vh !important;
        background-color: rgba(0, 0, 0, 0.5) !important;
      }
      
      .chat-header {
        padding: var(--spacing-md) var(--spacing-lg);
        font-size: 0.875rem;
      }
      
      .chat-clear-btn {
        width: 32px;
        height: 32px;
        font-size: 0.875rem;
      }
      
      .chat-close {
        width: 32px;
        height: 32px;
        font-size: 1.5rem;
      }
      
      .chat-messages {
        padding: var(--spacing-md);
        gap: var(--spacing-md);
      }
      
      .chat-avatar {
        width: 30px;
        height: 30px;
        font-size: 0.875rem;
      }
      
      .chat-bubble {
        padding: var(--spacing-sm) var(--spacing-md);
        font-size: 0.8rem;
      }
    }

    /* Print Styles */
    @media print {
      body {
        background: white !important;
        color: black !important;
      }

      .chat-btn {
        display: none !important;
      }

      .submit-btn {
        display: none !important;
      }

      .top-bar {
        background: #f8f9fa !important;
        color: black !important;
      }

      .section-header {
        background: #f8f9fa !important;
        color: black !important;
      }
    }

    /* Animation for spinner in submit button */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Enhanced Focus Management */
    *:focus {
      outline: 2px solid var(--primary-red);
      outline-offset: 2px;
    }

    /* Modern Loading States */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(26, 29, 35, 0.8);
      backdrop-filter: blur(4px);
      z-index: 999999;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(208, 2, 27, 0.3);
      border-top: 4px solid var(--primary-red);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    /* Enhanced Toast Notifications */
    .toast {
      position: fixed;
      bottom: var(--spacing-xl);
      right: var(--spacing-xl);
      background: white;
      color: var(--text-primary);
      padding: var(--spacing-lg) var(--spacing-xl);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      border-left: 4px solid var(--primary-red);
      z-index: 100000;
      transform: translateX(400px);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-width: 400px;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      border-left-color: #10b981;
    }

    .toast.error {
      border-left-color: #ef4444;
    }

    .toast.warning {
      border-left-color: #f59e0b;
    }

    /* Enhanced Section Animations */
    .section-container {
      opacity: 0;
      transform: translateY(20px);
      animation: sectionSlideIn 0.6s ease-out forwards;
    }

    .section-container:nth-child(1) { animation-delay: 0.1s; }
    .section-container:nth-child(2) { animation-delay: 0.2s; }
    .section-container:nth-child(3) { animation-delay: 0.3s; }
    .section-container:nth-child(4) { animation-delay: 0.4s; }

    @keyframes sectionSlideIn {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Improved User Feedback */
    .button-pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(208, 2, 27, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(208, 2, 27, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(208, 2, 27, 0);
      }
    }

    /* Smooth Transitions for All Interactive Elements */
    button, .chat-btn, .submit-btn, .back-button, .info-item, .section-container {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Enhanced Dark Mode Support (if needed in future) */
    @media (prefers-color-scheme: dark) {
      .main-container {
        background: var(--background-light);
        color: var(--text-light);
      }
      
      .section-container {
        background: var(--background-light);
        border-color: var(--border-medium);
      }
      
      .section-content {
        background: var(--background-light);
        color: var(--text-light);
      }
    }

    /* Enhanced Accessibility */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* High Contrast Mode Support */
    @media (prefers-contrast: high) {
      .section-container {
        border-width: 2px;
      }
      
      .chat-btn, .submit-btn, .back-button {
        border-width: 2px;
      }
    }

    /* Modern Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--surface-secondary);
      border-radius: var(--radius-sm);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-medium);
      border-radius: var(--radius-sm);
      transition: background 0.2s ease;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--primary-red);
    }

    /* Modern Selection Styling */
    ::selection {
      background: rgba(208, 2, 27, 0.2);
      color: var(--text-primary);
    }

    /* Enhanced Typography */
    h1, h2, h3, h4, h5, h6 {
      font-weight: 700;
      letter-spacing: -0.025em;
      line-height: 1.2;
    }

    p {
      line-height: 1.6;
      margin-bottom: var(--spacing-md);
    }

    /* Modern Input Styling */
    input, textarea, select {
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: var(--spacing-sm) var(--spacing-md);
      font-size: 1rem;
      transition: all 0.2s ease;
      background: white;
    }

    input:focus, textarea:focus, select:focus {
      border-color: var(--primary-red);
      box-shadow: 0 0 0 3px rgba(208, 2, 27, 0.1);
      outline: none;
    }

    /* Modern Card Hover Effects */
    .epic-info-section:hover,
    .section-container:hover {
      box-shadow: var(--shadow-xl);
      border-color: var(--primary-red-light);
    }

    /* Improved Status Indicators */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status-warning {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    /* Modern Badge Styling */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      background: var(--surface-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border-light);
    }

    .badge-primary {
      background: var(--primary-red-lighter);
      color: var(--primary-red);
      border-color: rgba(208, 2, 27, 0.2);
    }

    /* Enhanced Error States */
    .form-error {
      border-color: #ef4444 !important;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
    }

    .error-message {
      color: #ef4444;
      font-size: 0.875rem;
      margin-top: 0.25rem;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .error-message::before {
      content: "⚠️";
      font-size: 1rem;
    }

    /* Modern Progress Indicators */
    .progress-bar {
      width: 100%;
      height: 4px;
      background: var(--surface-tertiary);
      border-radius: 2px;
      overflow: hidden;
      margin: var(--spacing-md) 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-red), var(--primary-red-light));
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    /* Enhanced List Styling */
    .modern-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
    }

    .modern-list-item {
      background: white;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      transition: all 0.2s ease;
      position: relative;
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }

    .modern-list-item:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      border-color: var(--primary-red);
    }

    .modern-list-item::before {
      content: "✓";
      width: 20px;
      height: 20px;
      background: var(--primary-red);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: bold;
      flex-shrink: 0;
    }

    /* Enhanced Grid Layout */
    .modern-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--spacing-lg);
    }

    @media (max-width: 768px) {
      .modern-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Enhanced Mobile Experience */
    @media (max-width: 480px) {
      .toast {
        right: var(--spacing-md);
        left: var(--spacing-md);
        max-width: none;
      }

      .loading-spinner {
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Top Navigation Bar -->
    <div class="top-bar">
      <button class="back-button" onclick="goBack()">
        &lt; Back
      </button>
      <span style="position: absolute; left: 50%; transform: translateX(-50%); font-weight: bold; font-size: 1.25rem;">
        Jira ticket creation
      </span>
      <span style="position: absolute; right: 16px; top: 12px; font-size: 1rem; font-weight: 500;">
        Use the 'Chat' interface to ask questions and edit outputs
      </span>
    </div>

    <!-- User Story Header -->
    <div class="story-header">
      {% if multiple_stories %}
        Multiple User Stories: {{ story_count }} stories selected
      {% else %}
        User story: {{ user_story_name or '<span class="hardcoded-content">Capture personal information during onboarding</span>' | safe }}
        <button class="chat-btn" onclick="openUserStoryChat()" style="margin-left: 10px; float: right;">
          <span>💬 Chat</span>
        </button>
      {% endif %}
    </div>

    <!-- Main Content -->
    <div class="content-container">
    
    <!-- Error Message Display -->
    {% if error_message %}
    <div class="status-indicator status-error" style="padding: var(--spacing-lg); margin-bottom: var(--spacing-lg); border-radius: var(--radius-lg); display: flex; align-items: center; gap: var(--spacing-md); background: #fee2e2; border: 1px solid #fecaca; color: #991b1b;">
      <span style="font-size: 1.5rem;">⚠️</span>
      <div>
        <strong>Error:</strong> {{ error_message }}
      </div>
    </div>
    {% endif %}
    
    <!-- Success Message Display -->
    {% if success_message %}
    <div class="status-indicator status-success" style="padding: var(--spacing-lg); margin-bottom: var(--spacing-lg); border-radius: var(--radius-lg); display: flex; align-items: center; gap: var(--spacing-md); background: #dcfce7; border: 1px solid #bbf7d0; color: #166534;">
      <span style="font-size: 1.5rem;">✅</span>
      <div>
        <strong>Success:</strong> {{ success_message }}
      </div>
    </div>
    {% endif %}
    
    <!-- Epic Information Section -->
    <div class="epic-info-section">
      <div class="epic-label">
        <span>🎯</span> Epic
      </div>
      <div class="epic-title">
        {{ epic_title or '<span class="hardcoded-content">******</span>' | safe }}
      </div>

      <div class="info-row">
        <div class="info-item">
          <span class="info-label">
            <span>⚡</span> Priority:
          </span>
          <span class="priority-high badge badge-primary">{{ priority or '<span class="hardcoded-content">High</span>' | safe }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">
            <span>🔧</span> Responsible systems:
          </span>
          <span class="badge">{{ responsible_systems or '<span class="hardcoded-content">CAPS, CMS</span>' | safe }}</span>
        </div>
      </div>
    </div>

  
    <!-- Description Section -->
    <div class="section-container">
      <div class="section-header">
        <span>📝 Description</span>
        <button class="chat-btn" onclick="openDescriptionChat()">
          <span>💬 Chat</span>
        </button>
      </div>
      <div class="section-content">
        {% if multiple_stories %}
          <!-- Multiple Stories Summary -->
          <div class="multiple-stories-summary">
            <h6 style="color: var(--primary-red); margin-bottom: var(--spacing-md); display: flex; align-items: center; gap: var(--spacing-xs);">
              <span>📚</span> Selected Stories ({{ story_count }}):
            </h6>
            <div class="modern-grid">
              {% for story in stories %}
                <div class="story-item modern-list-item" style="margin-bottom: var(--spacing-md); border-left: 3px solid var(--primary-red); background: var(--surface-secondary);">
                  <div>
                    <strong style="color: var(--text-primary); font-size: 1.1rem;">{{ story.name }}</strong>
                    <p style="margin: var(--spacing-xs) 0; font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">{{ story.description }}</p>
                    <div style="display: flex; gap: var(--spacing-md); margin-top: var(--spacing-sm);">
                      <span class="badge badge-primary">Priority: {{ story.priority }}</span>
                      <span class="badge">System: {{ story.system }}</span>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% else %}
          <!-- Enhanced Description from User Description Agent -->
          <div class="enhanced-description" style="position: relative;">
            <div style="display: flex; align-items: center; gap: var(--spacing-xs); margin-bottom: var(--spacing-md); color: var(--primary-red); font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px;">
              <span>📋</span> User Story Description
            </div>
            <div style="font-size: 1rem; line-height: 1.7; color: var(--text-primary);">
              {{ user_story_description or '<span class="hardcoded-content">As a new borrower, I want to input my personal information (e.g., name, SSN) so that the system can accurately create my customer profile and initiate the onboarding process. This ensures that downstream verification steps (e.g. KYC, credit checks) can proceed without manual data correction or re-entry.</span>' | safe }}
            </div>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Acceptance Criteria Section -->
    <div class="section-container">
      <div class="section-header">
        <span>✅ Acceptance Criteria</span>
        <button class="chat-btn" onclick="openAcceptanceCriteriaChat()">
          <span>💬 Chat</span>
        </button>
      </div>
      <div class="section-content">
        <div style="display: flex; align-items: center; gap: var(--spacing-xs); margin-bottom: var(--spacing-lg); color: var(--primary-red); font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px;">
          <span>📋</span> Success Criteria
        </div>
        <ul class="criteria-list modern-list">
          {% if acceptance_criteria %}
            {% for criterion in acceptance_criteria %}
            <li class="modern-list-item" style="border-left: 3px solid var(--primary-red);">{{ criterion }}</li>
            {% endfor %}
          {% else %}
          <li class="modern-list-item" style="border-left: 3px solid var(--primary-red);"><span class="hardcoded-content">System prompts for full name, date of birth, Social Security Number, email address, phone number, and residential address</span></li>
          <li class="modern-list-item" style="border-left: 3px solid var(--primary-red);"><span class="hardcoded-content">Mandatory fields must be completed before progressing</span></li>
          <li class="modern-list-item" style="border-left: 3px solid var(--primary-red);"><span class="hardcoded-content">Input formats are validated (e.g., MM/DD/YYYY for DOB, 9-digit SSN, phone with area code)</span></li>
          <li class="modern-list-item" style="border-left: 3px solid var(--primary-red);"><span class="hardcoded-content">Errors are surfaced clearly and immediately for any missing or invalid entries</span></li>
          {% endif %}
        </ul>
      </div>
    </div>

    <!-- Traceability Matrix Section -->
    <div class="section-container traceability-matrix-section">
      <div class="section-header">
        <span>🔗 Traceability Matrix</span>
        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
          <div style="font-size: 0.875rem; color: var(--text-muted); font-weight: 400;">User Story → PRD Requirements Mapping</div>
          <button class="chat-btn" onclick="openTraceabilityChat()">
            <span>� Chat</span>
          </button>
        </div>
      </div>
      <div class="section-content">
        <div style="display: flex; align-items: center; gap: var(--spacing-xs); margin-bottom: var(--spacing-lg); color: var(--primary-red); font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px;">
          <span>📊</span> Requirements Mapping
        </div>
        <div class="traceability-content" id="traceability-content" style="background: var(--surface-primary) !important; padding: var(--spacing-lg); border-radius: var(--radius-md); border: 1px solid var(--border-light) !important; line-height: 1.6; color: var(--text-primary); overflow-x: auto;">
          {% if traceability_matrix %}
            <div class="traceability-raw-content" style="display: none;">{{ traceability_matrix }}</div>
            <div class="traceability-formatted-content">
              <!-- Content will be dynamically formatted by JavaScript -->
            </div>
          {% else %}
            <div style="color: var(--text-muted); font-style: italic;">
              <span>📋</span> Traceability mapping not available. 
              <br><br>This section shows the relationship between user stories and their corresponding PRD requirements, enabling:
              <br>• Requirements tracking and compliance
              <br>• Design validation against business needs  
              <br>• Testing coverage verification
              <br>• Change impact analysis
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <button type="button" class="submit-btn button-pulse" onclick="submitToJira()" id="jira-submit-btn">
      <span>🚀</span> Submit & Export to Jira
    </button>
    
    <!-- Enhanced Data Validation Summary -->
    <div id="validation-summary" class="status-indicator status-success" style="margin-top: var(--spacing-lg); padding: var(--spacing-lg); background: var(--surface-secondary); border-radius: var(--radius-lg); border: 1px solid var(--border-light); display: none; box-shadow: var(--shadow-sm);">
      <h6 style="margin-bottom: var(--spacing-sm); color: var(--primary-red); display: flex; align-items: center; gap: var(--spacing-xs);">
        <span>📋</span> Submission Summary:
      </h6>
      <div id="validation-details" style="font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6;"></div>
    </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div style="text-align: center; color: white;">
      <div class="loading-spinner"></div>
      <p style="margin-top: var(--spacing-lg); font-size: 1.1rem; font-weight: 600;">Processing your request...</p>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toast-container" style="position: fixed; bottom: var(--spacing-xl); right: var(--spacing-xl); z-index: 100001;"></div>

  <!-- Hidden form with data for Jira submission -->
  <form id="jira-form" action="/submit-jira-ticket" method="POST" style="display: none;">
    <input type="hidden" name="epic_title" value="{{ epic_title or '' }}">
    <input type="hidden" name="user_story_name" value="{{ user_story_name or '' }}">
    <input type="hidden" name="user_story_description" value="{{ user_story_description or '' }}">
    <input type="hidden" name="priority" value="{{ priority or 'High' }}">
    <input type="hidden" name="responsible_systems" value="{{ responsible_systems or 'CAPS, CMS' }}">
    <input type="hidden" name="acceptance_criteria" value="{% if acceptance_criteria %}{{ acceptance_criteria|join('|||') }}{% else %}System prompts for full name, date of birth, Social Security Number, email address, phone number, and residential address|||Mandatory fields must be completed before progressing|||Input formats are validated (e.g., MM/DD/YYYY for DOB, 9-digit SSN, phone with area code)|||Errors are surfaced clearly and immediately for any missing or invalid entries{% endif %}">
    <input type="hidden" name="tagged_requirements" value="{% if tagged_requirements %}{{ tagged_requirements|join('|||') }}{% else %}TBD {% endif %}">
    <input type="hidden" name="traceability_matrix" value="{{ traceability_matrix or 'Traceability mapping not available.' }}">
  </form>

  <!-- Description Chat Modal -->
  <div id="description-chat-modal" class="chat-modal">
    <div class="chat-modal-content">
      <div class="chat-header">
        <span>💬 Edit Description</span>
        <div class="chat-header-actions">
          <button class="chat-clear-btn" onclick="clearDescriptionChat()" title="Clear Chat">
            🗑️
          </button>
          <button class="chat-close" onclick="closeDescriptionChat()">&times;</button>
        </div>
      </div>
      <div class="chat-container">
        <!-- Current Description Display -->
        <div class="current-description">
          <h6>Current Description:</h6>
          <p class="current-description-text" id="current-description-display"></p>
        </div>
        
        <!-- Chat Messages -->
        <div class="chat-messages" id="description-chat-messages">
          <div class="chat-message assistant">
            <div class="chat-avatar assistant">AI</div>
            <div class="chat-bubble">
              Hello! I'm here to help you refine your user story description. You can ask me to:
              <br>• Make it more detailed or concise
              <br>• Improve clarity and technical accuracy
              <br>• Add specific business context
              <br>• Adjust the tone or format
              <br><br>What would you like to change about the current description?
            </div>
          </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-area">
          <textarea id="description-chat-input" class="chat-input" placeholder="Ask me to revise the description..." rows="1"></textarea>
          <button class="chat-send-btn" onclick="sendDescriptionMessage()" id="description-send-btn">
            <span>📤</span>
            Send
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Acceptance Criteria Chat Modal -->
  <div id="acceptance-criteria-chat-modal" class="chat-modal">
    <div class="chat-modal-content">
      <div class="chat-header">
        <span>💬 Edit Acceptance Criteria</span>
        <div class="chat-header-actions">
          <button class="chat-clear-btn" onclick="clearAcceptanceCriteriaChat()" title="Clear Chat">
            🗑️
          </button>
          <button class="chat-close" onclick="closeAcceptanceCriteriaChat()">&times;</button>
        </div>
      </div>
      <div class="chat-container">
        <!-- Current Criteria Display -->
        <div class="current-description">
          <h6>Current Acceptance Criteria:</h6>
          <ul id="current-criteria-display" class="criteria-list"></ul>
        </div>
        
        <!-- Chat Messages -->
        <div class="chat-messages" id="criteria-chat-messages">
          <div class="chat-message assistant">
            <div class="chat-avatar assistant">AI</div>
            <div class="chat-bubble">
              Hello! I'm here to help you refine your acceptance criteria. You can ask me to:
              <br>• Make them more detailed and specific
              <br>• Add security, performance, or accessibility requirements
              <br>• Format them using Given/When/Then structure
              <br>• Simplify or reorganize the criteria
              <br>• Add edge cases and negative scenarios
              <br><br>What would you like to change about the current criteria?
            </div>
          </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-area">
          <textarea id="criteria-chat-input" class="chat-input" placeholder="Ask me to improve the acceptance criteria..." rows="1"></textarea>
          <button class="chat-send-btn" onclick="sendAcceptanceCriteriaMessage()" id="criteria-send-btn">
            <span>📤</span>
            Send
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Traceability Matrix Chat Modal -->
  <div id="traceability-chat-modal" class="chat-modal">
    <div class="chat-modal-content">
      <div class="chat-header">
        <span>💬 Edit Traceability Matrix</span>
        <div class="chat-header-actions">
          <button class="chat-clear-btn" onclick="clearTraceabilityChat()" title="Clear Chat">
            🗑️
          </button>
          <button class="chat-close" onclick="closeTraceabilityChat()">&times;</button>
        </div>
      </div>
      <div class="chat-container">
        <!-- Current Traceability Display -->
        <div class="current-description">
          <h6>Current Traceability Matrix:</h6>
          <div id="current-traceability-display" class="traceability-preview" style="background: var(--surface-secondary); padding: var(--spacing-md); border-radius: var(--radius-md); max-height: 200px; overflow-y: auto; font-size: 0.875rem; border: 1px solid var(--border-light);">
            <!-- Traceability content will be displayed here -->
          </div>
        </div>
        
        <!-- Chat Messages -->
        <div class="chat-messages" id="traceability-chat-messages">
          <div class="chat-message assistant">
            <div class="chat-avatar assistant">AI</div>
            <div class="chat-bubble">
              Hello! I'm here to help you enhance your traceability matrix. You can ask me to:
              <br>• Add more detailed requirement mappings
              <br>• Include compliance traceability links
              <br>• Map user stories to specific PRD sections
              <br>• Add bidirectional traceability relationships
              <br>• Include impact analysis information
              <br>• Add test case traceability links
              <br>• Include change request mappings
              <br><br>What aspects of the traceability matrix would you like to improve or expand?
            </div>
          </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-area">
          <textarea id="traceability-chat-input" class="chat-input" placeholder="Ask me to improve the traceability matrix..." rows="1"></textarea>
          <button class="chat-send-btn" onclick="sendTraceabilityMessage()" id="traceability-send-btn">
            <span>📤</span>
            Send
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Epic Chat Modal -->
  <div id="epic-chat-modal" class="chat-modal">
    <div class="chat-modal-content">
      <div class="chat-header">
        <span>💬 Edit Epic</span>
        <div class="chat-header-actions">
          <button class="chat-clear-btn" onclick="clearEpicChat()" title="Clear Chat">
            🗑️
          </button>
          <button class="chat-close" onclick="closeEpicChat()">&times;</button>
        </div>
      </div>
      <div class="chat-container">
        <!-- Current Epic Display -->
        <div class="current-description">
          <h6>Current Epic:</h6>
          <p class="current-epic-text" id="current-epic-display"></p>
        </div>
        
        <!-- Chat Messages -->
        <div class="chat-messages" id="epic-chat-messages">
          <div class="chat-message assistant">
            <div class="chat-avatar assistant">AI</div>
            <div class="chat-bubble">
              Hello! I'm here to help you refine your epic. You can ask me to:
              <br>• Make it more strategic and high-level
              <br>• Improve alignment with business objectives
              <br>• Add context about user value and benefits
              <br>• Adjust scope and structure
              <br>• Make it more actionable for the development team
              <br><br>What would you like to change about the current epic?
            </div>
          </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-area">
          <textarea id="epic-chat-input" class="chat-input" placeholder="Ask me to revise the epic..." rows="1"></textarea>
          <button class="chat-send-btn" onclick="sendEpicMessage()" id="epic-send-btn">
            <span>📤</span>
            Send
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- User Story Chat Modal -->
  <div id="user-story-chat-modal" class="chat-modal">
    <div class="chat-modal-content">
      <div class="chat-header">
        <span>💬 Edit User Story</span>
        <div class="chat-header-actions">
          <button class="chat-clear-btn" onclick="clearUserStoryChat()" title="Clear Chat">
            🗑️
          </button>
          <button class="chat-close" onclick="closeUserStoryChat()">&times;</button>
        </div>
      </div>
      <div class="chat-container">
        <!-- Current User Story Display -->
        <div class="current-description">
          <h6>Current User Story:</h6>
          <p class="current-user-story-text" id="current-user-story-display"></p>
        </div>
        
        <!-- Chat Messages -->
        <div class="chat-messages" id="user-story-chat-messages">
          <div class="chat-message assistant">
            <div class="chat-avatar assistant">AI</div>
            <div class="chat-bubble">
              Hello! I'm here to help you refine your user story. You can ask me to:
              <br>• Improve the user story format (As a... I want... So that...)
              <br>• Make it more specific and actionable
              <br>• Add clarity about user needs and goals
              <br>• Ensure it's testable and deliverable
              <br>• Add context about user personas or scenarios
              <br><br>What would you like to change about the current user story?
            </div>
          </div>
        </div>
        
        <!-- Chat Input -->
        <div class="chat-input-area">
          <textarea id="user-story-chat-input" class="chat-input" placeholder="Ask me to improve the user story..." rows="1"></textarea>
          <button class="chat-send-btn" onclick="sendUserStoryMessage()" id="user-story-send-btn">
            <span>📤</span>
            Send
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
  function goBack() {
    console.log('Back button clicked - navigating to epic results with context preservation');
    
    // Navigate to the epic results screen with preserved context
    // The backend will handle restoring the selected user stories from session
    window.location.href = '/epic-results';
  }

  function submitToJira() {
    console.log('Submitting to Jira...');
    
    // Remove pulse animation from submit button
    removeButtonPulse('jira-submit-btn');
    
    // Enhanced validation with modern UI feedback
    if (!validateForm()) {
      return;
    }
    
    // Show validation summary with modern styling
    showValidationSummary();
    
    // Show modern loading state
    const submitBtn = document.querySelector('.submit-btn');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
      <div class="loading-spinner" style="width: 20px; height: 20px; margin-right: var(--spacing-sm);"></div>
      Submitting to Jira...
    `;
    
    // Show loading overlay
    showLoading('Preparing your Jira ticket...');
    
    // Get form data
    const form = document.getElementById('jira-form');
    const formData = new FormData(form);
    
    // Log form data for debugging
    console.log('Form data being submitted:');
    for (let [key, value] of formData.entries()) {
      console.log(`${key}: ${value}`);
    }
    
    // Get values for confirmation
    const userStoryName = formData.get('user_story_name');
    const userStoryDescription = formData.get('user_story_description');
    const epicTitle = formData.get('epic_title');
    const priority = formData.get('priority');
    const systems = formData.get('responsible_systems');
    
    // Hide loading overlay temporarily for confirmation
    hideLoading();
    
    // Enhanced confirmation dialog
    const confirmMessage = `🚀 Ready to Submit to Jira

📋 Story: ${userStoryName}
🎯 Epic: ${epicTitle || 'N/A'}
⚡ Priority: ${priority || 'High'}
🔧 Systems: ${systems || 'N/A'}

Do you want to proceed?`;
    
    if (!confirm(confirmMessage)) {
      resetSubmitButton(submitBtn, originalText);
      addButtonPulse('jira-submit-btn');
      showToast('Submission cancelled', 'warning', 3000);
      return;
    }
    
    // Show loading overlay again for submission
    showLoading('Creating Jira ticket...');
    
    // Submit the form with modern UI feedback
    fetch('/submit-jira-ticket', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      hideLoading();
      
      if (response.ok) {
        console.log('Jira submission successful');
        
        // Show modern success state
        submitBtn.innerHTML = `
          <span style="margin-right: var(--spacing-sm);">✅</span>
          Success! Redirecting...
        `;
        
        // Show success toast
        showToast('Jira ticket created successfully! Redirecting...', 'success', 3000);
        
        // Redirect to the response page after a brief delay
        setTimeout(() => {
          return response.text().then(html => {
            document.open();
            document.write(html);
            document.close();
          });
        }, 1500);
      } else {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
    })
    .catch(error => {
      console.error('Error submitting to Jira:', error);
      hideLoading();
      
      // Show modern error feedback
      showToast(`Failed to submit to Jira: ${error.message}. Please try again.`, 'error', 8000);
      resetSubmitButton(submitBtn, originalText);
      addButtonPulse('jira-submit-btn');
    });
  }
  
  function showValidationSummary() {
    const form = document.getElementById('jira-form');
    const formData = new FormData(form);
    
    const summary = document.getElementById('validation-summary');
    const details = document.getElementById('validation-details');
    
    let html = '';
    html += `<strong>Story:</strong> ${formData.get('user_story_name') || 'Not provided'}<br>`;
    html += `<strong>Epic:</strong> ${formData.get('epic_title') || 'Not provided'}<br>`;
    html += `<strong>Priority:</strong> ${formData.get('priority') || 'High'}<br>`;
    html += `<strong>Systems:</strong> ${formData.get('responsible_systems') || 'Not provided'}<br>`;
    
    const acceptanceCriteria = formData.get('acceptance_criteria');
    const criteriaCount = acceptanceCriteria ? acceptanceCriteria.split('|||').filter(c => c.trim()).length : 0;
    html += `<strong>Acceptance Criteria:</strong> ${criteriaCount} items<br>`;
    
    const requirements = formData.get('tagged_requirements');
    const reqCount = requirements ? requirements.split('|||').filter(r => r.trim()).length : 0;
    html += `<strong>Tagged Requirements:</strong> ${reqCount} items`;
    
    details.innerHTML = html;
    summary.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      summary.style.display = 'none';
    }, 5000);
  }
  
  function resetSubmitButton(button, originalText) {
    button.disabled = false;
    button.innerHTML = originalText;
  }

  function openDescriptionChat() {
    console.log('openDescriptionChat called'); // Debug log
    
    // First, show an alert to confirm the function is being called
    // alert('Description chat function called!'); // Uncomment for testing
    
    const modal = document.getElementById('description-chat-modal');
    console.log('Modal element:', modal); // Debug log
    
    if (!modal) {
      console.error('Modal element not found!');
      alert('❌ Error: Chat modal not found. Please reload the page and try again.');
      return;
    }
    
    const currentDescriptionDisplay = document.getElementById('current-description-display');
    console.log('Current description display element:', currentDescriptionDisplay); // Debug log
    
    // Get current description from the form or display
    let currentDescription = '';
    const hiddenInput = document.querySelector('input[name="user_story_description"]');
    const displayElement = document.querySelector('.enhanced-description');
    
    if (hiddenInput && hiddenInput.value) {
      currentDescription = hiddenInput.value;
    } else if (displayElement) {
      currentDescription = displayElement.textContent.trim();
    } else {
      currentDescription = 'No description available';
    }
    
    console.log('Current description:', currentDescription); // Debug log
    
    // Update the current description display in the modal
    if (currentDescriptionDisplay) {
      currentDescriptionDisplay.textContent = currentDescription;
    }
    
    // Show the modal with extra styling to ensure visibility
    modal.style.display = 'block';
    modal.style.zIndex = '9999';
    modal.style.position = 'fixed';
    modal.style.top = '0';
    modal.style.left = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    
    console.log('Modal should now be visible with computed style:', window.getComputedStyle(modal).display);
    
    // Focus on the input after a short delay
    setTimeout(() => {
      const inputElement = document.getElementById('description-chat-input');
      if (inputElement) {
        inputElement.focus();
        console.log('Input focused');
      } else {
        console.error('Chat input element not found');
      }
    }, 200);
    
    // Add event listener for Enter key (only add once)
    const chatInput = document.getElementById('description-chat-input');
    if (chatInput && !chatInput.hasAttribute('data-listener-added')) {
      chatInput.setAttribute('data-listener-added', 'true');
      chatInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendDescriptionMessage();
        }
      });
    }
  }
  
  // Test function to debug modal issues
  function testDescriptionModal() {
    console.log('Test function called');
    alert('Test button clicked! Now trying to open modal...');
    
    const modal = document.getElementById('description-chat-modal');
    console.log('Modal found:', !!modal);
    
    if (modal) {
      modal.style.display = 'block';
      modal.style.zIndex = '99999';
      console.log('Modal display set to block');
      alert('Modal should be visible now. Check if you can see it behind this alert.');
    } else {
      alert('❌ Modal element not found!');
    }
  }
  
  function closeDescriptionChat() {
    const modal = document.getElementById('description-chat-modal');
    modal.style.display = 'none';
  }
  
  function sendDescriptionMessage() {
    const input = document.getElementById('description-chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addDescriptionChatMessage(message, 'user');
    
    // Clear input
    input.value = '';
    
    // Show loading state
    const sendBtn = document.getElementById('description-send-btn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="chat-loading-dots"></span> Processing';
    
    // Add loading message
    const loadingMessageId = addDescriptionChatMessage('', 'assistant', true);
    
    // Get current description
    const currentDescription = document.querySelector('input[name="user_story_description"]').value || 
                              document.querySelector('.enhanced-description').textContent.trim();
    
    // Call backend API
    fetch('/chat-description', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: message,
        current_description: currentDescription
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Description Chat API Response:', data);
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if ( loadingMsg) loadingMsg.remove();
      
      if (data.success) {
        // Get the AI response - check both possible response properties
        const aiResponse = data.message || data.response || 'No response received';
        console.log('AI Response:', aiResponse);
        
        // Add AI response
        addDescriptionChatMessage(aiResponse, 'assistant');
        
        // If there's an updated description, offer to apply it
        if (data.updated_description && data.updated_description !== currentDescription) {
          const buttonId = 'apply-btn-' + Date.now();
          addDescriptionChatMessage(
            `Here's the updated description. Would you like me to apply this change?
            
            <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin: 8px 0; font-style: italic;">
              "${data.updated_description}"
            </div>
            
            <button id="${buttonId}" 
                    style="background: #d0021b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 8px;">
              ✓ Apply This Description
            </button>`, 
            'assistant'
          );
          
          // Add click event listener to the button
          setTimeout(() => {
            const button = document.getElementById(buttonId);
            if (button) {
              button.addEventListener('click', () => {
                applyDescriptionUpdate(data.updated_description);
              });
            }
          }, 100);
        }
      } else {
        addDescriptionChatMessage('Sorry, I encountered an error processing your request. Please try again.', 'assistant');
      }
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    })
    .catch(error => {
      console.error('Error calling chat API:', error);
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if (loadingMsg) loadingMsg.remove();
      
      // Show error message
      addDescriptionChatMessage('Sorry, I encountered a connection error. Please check your internet connection and try again.', 'assistant');
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    });
  }
  
  function addDescriptionChatMessage(message, sender, isLoading = false) {
    const messagesContainer = document.getElementById('description-chat-messages');
    const messageDiv = document.createElement('div');
    const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    messageDiv.id = messageId;
    messageDiv.className = `chat-message ${sender}`;
    
    if (isLoading) {
      messageDiv.innerHTML = `
        <div class="chat-avatar ${sender}">${sender === 'user' ? 'U' : 'AI'}</div>
        <div class="chat-bubble">
          <div class="chat-loading">
            <span class="chat-loading-dots"></span>
            Thinking about your request
          </div>
        </div>
      `;
    } else {
      messageDiv.innerHTML = `
        <div class="chat-avatar ${sender}">${sender === 'user' ? 'U' : 'AI'}</div>
        <div class="chat-bubble">${message}</div>
      `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
  }
  
  
  function applyDescriptionUpdate(newDescription) {
    // Decode HTML entities first
    const textarea = document.createElement('textarea');
    textarea.innerHTML = newDescription;
    const decodedDescription = textarea.value;
    
    // Update the hidden form field
    const hiddenInput = document.querySelector('input[name="user_story_description"]');
    if (hiddenInput) {
      hiddenInput.value = decodedDescription;
    }
    
    // Update the visible description on the page
    const descriptionDisplay = document.querySelector('.enhanced-description');
    if (descriptionDisplay) {
      descriptionDisplay.textContent = decodedDescription;
    }
    
    // Update the current description display in the modal
    const currentDescriptionDisplay = document.getElementById('current-description-display');
    if (currentDescriptionDisplay) {
      currentDescriptionDisplay.textContent = decodedDescription;
    }
    
    // Show success message
    addDescriptionChatMessage('✅ Description updated successfully! The changes are now applied to your user story.', 'assistant');
    
    // Auto-save the changes
    saveUserStoryData();
  }
  
  // Close modal when clicking outside
  window.addEventListener('click', function(e) {
    const descriptionModal = document.getElementById('description-chat-modal');
    const criteriaModal = document.getElementById('acceptance-criteria-chat-modal');
    const requirementsModal = document.getElementById('requirements-chat-modal');
    const epicModal = document.getElementById('epic-chat-modal');
    const userStoryModal = document.getElementById('user-story-chat-modal');
    
    if (e.target === descriptionModal) {
      closeDescriptionChat();
    }
    if (e.target === criteriaModal) {
      closeAcceptanceCriteriaChat();
    }
    if (e.target === requirementsModal) {
      closeRequirementsChat();
    }
    if (e.target === epicModal) {
      closeEpicChat();
    }
    if (e.target === userStoryModal) {
      closeUserStoryChat();
    }
  });

  function openAcceptanceCriteriaChat() {
    const modal = document.getElementById('acceptance-criteria-chat-modal');
    const currentCriteriaDisplay = document.getElementById('current-criteria-display');
    
    // Get current acceptance criteria
    const acceptanceCriteriaInput = document.querySelector('input[name="acceptance_criteria"]');
    let currentCriteria = [];
    
    if (acceptanceCriteriaInput && acceptanceCriteriaInput.value) {
      currentCriteria = acceptanceCriteriaInput.value.split('|||').filter(c => c.trim());
    } else {
      // Fallback: extract from displayed criteria
      const criteriaElements = document.querySelectorAll('.criteria-list li');
      currentCriteria = Array.from(criteriaElements).map(li => li.textContent.trim());
    }
    
    // Update the current criteria display in the modal
    currentCriteriaDisplay.innerHTML = '';
    currentCriteria.forEach(criterion => {
      const li = document.createElement('li');
      li.textContent = criterion;
      currentCriteriaDisplay.appendChild(li);
    });
    
    // Show the modal
    modal.style.display = 'block';
    
    // Focus on the input
    setTimeout(() => {
      document.getElementById('criteria-chat-input').focus();
    }, 100);
    
    // Add event listener for Enter key
    const chatInput = document.getElementById('criteria-chat-input');
    chatInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendAcceptanceCriteriaMessage();
      }
    });
  }
  
  function closeAcceptanceCriteriaChat() {
    const modal = document.getElementById('acceptance-criteria-chat-modal');
    modal.style.display = 'none';
  }
  
  function sendAcceptanceCriteriaMessage() {
    const input = document.getElementById('criteria-chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addAcceptanceCriteriaChatMessage(message, 'user');
    
    // Clear input
    input.value = '';
    
    // Show loading state
    const sendBtn = document.getElementById('criteria-send-btn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="chat-loading-dots"></span> Processing';
    
    // Add loading message
    const loadingMessageId = addAcceptanceCriteriaChatMessage('', 'assistant', true);
    
    // Get current criteria and story context
    const acceptanceCriteriaInput = document.querySelector('input[name="acceptance_criteria"]');
    let currentCriteria = [];
    
    if (acceptanceCriteriaInput && acceptanceCriteriaInput.value) {
      currentCriteria = acceptanceCriteriaInput.value.split('|||').filter(c => c.trim());
    } else {
      const criteriaElements = document.querySelectorAll('.criteria-list li');
      currentCriteria = Array.from(criteriaElements).map(li => li.textContent.trim());
    }
    
    const storyContext = document.querySelector('input[name="user_story_name"]').value + ': ' + 
                        document.querySelector('input[name="user_story_description"]').value;
    
    // Call backend API
    fetch('/chat-acceptance-criteria', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: message,
        current_criteria: currentCriteria,
        story_context: storyContext
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Acceptance Criteria Chat API Response:', data);
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if (loadingMsg) loadingMsg.remove();
      
      if (data.success) {
        // Get the AI response - check both possible response properties
        const aiResponse = data.message || data.response || 'No response received';
        console.log('AI Response:', aiResponse);
        
        // Add AI response
        addAcceptanceCriteriaChatMessage(aiResponse, 'assistant');
        
        // If there are updated criteria, offer to apply them
        if (data.updated_criteria && Array.isArray(data.updated_criteria) && data.updated_criteria.length > 0) {
          const criteriaPreview = data.updated_criteria.map(c => `• ${c}`).join('<br>');
          const buttonId = 'apply-criteria-btn-' + Date.now();
          
          addAcceptanceCriteriaChatMessage(
            `Here are the updated acceptance criteria. Would you like me to apply these changes?
            
            <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin: 8px 0; font-style: italic;">
              ${criteriaPreview}
            </div>
            
            <button id="${buttonId}" 
                    style="background: #d0021b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 8px;">
              ✓ Apply These Criteria
            </button>`, 
            'assistant'
          );
          
          // Add click event listener to the button
          setTimeout(() => {
            const button = document.getElementById(buttonId);
            if (button) {
              button.addEventListener('click', () => {
                applyAcceptanceCriteriaUpdate(data.updated_criteria);
              });
            }
          }, 100);
        }
      } else {
        addAcceptanceCriteriaChatMessage('Sorry, I encountered an error processing your request. Please try again.', 'assistant');
      }
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    })
    .catch(error => {
      console.error('Error calling acceptance criteria chat API:', error);
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if (loadingMsg) loadingMsg.remove();
      
      // Show error message
      addAcceptanceCriteriaChatMessage('Sorry, I encountered a connection error. Please check your internet connection and try again.', 'assistant');
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    });
  }
  
  function addAcceptanceCriteriaChatMessage(message, sender, isLoading = false) {
    const messagesContainer = document.getElementById('criteria-chat-messages');
    const messageDiv = document.createElement('div');
    const messageId = 'criteria-msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    messageDiv.id = messageId;
    messageDiv.className = `chat-message ${sender}`;
    
    if (isLoading) {
      messageDiv.innerHTML = `
        <div class="chat-avatar ${sender}">${sender === 'user' ? 'U' : 'AI'}</div>
        <div class="chat-bubble">
          <div class="chat-loading">
            <span class="chat-loading-dots"></span>
            Analyzing your acceptance criteria
          </div>
        </div>
      `;
    } else {
      messageDiv.innerHTML = `
        <div class="chat-avatar ${sender}">${sender === 'user' ? 'U' : 'AI'}</div>
        <div class="chat-bubble">${message}</div>
      `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
  }
  
  function applyAcceptanceCriteriaUpdate(newCriteria) {
    if (!Array.isArray(newCriteria)) return;
    
    // Update the hidden form field
    const hiddenInput = document.querySelector('input[name="acceptance_criteria"]');
    if (hiddenInput) {
      hiddenInput.value = newCriteria.join('|||');
    }
    
    // Update the visible criteria on the page
    const criteriaList = document.querySelector('.criteria-list');
    if (criteriaList) {
      criteriaList.innerHTML = '';
      newCriteria.forEach(criterion => {
        const li = document.createElement('li');
        li.textContent = criterion;
        criteriaList.appendChild(li);
      });
    }
    
    // Update the current criteria display in the modal
    const currentCriteriaDisplay = document.getElementById('current-criteria-display');
    if (currentCriteriaDisplay) {
      currentCriteriaDisplay.innerHTML = '';
      newCriteria.forEach(criterion => {
        const li = document.createElement('li');
        li.textContent = criterion;
        currentCriteriaDisplay.appendChild(li);
      });
    }
    
    // Show success message
    addAcceptanceCriteriaChatMessage('✅ Acceptance criteria updated successfully! The changes are now applied to your user story.', 'assistant');
    
    // Auto-save the changes
    saveUserStoryData();
  }

  function openRequirementsChat() {
    const modal = document.getElementById('requirements-chat-modal');
    const currentRequirementsDisplay = document.getElementById('current-requirements-display');
    
    // Get current tagged requirements
    const requirementsInput = document.querySelector('input[name="tagged_requirements"]');
    let currentRequirements = [];
    
    if (requirementsInput && requirementsInput.value) {
      currentRequirements = requirementsInput.value.split('|||').filter(r => r.trim());
    } else {
      // Fallback: extract from displayed requirements
      const requirementElements = document.querySelectorAll('.requirements-list li');
      currentRequirements = Array.from(requirementElements).map(li => li.textContent.trim());
    }
    
    // Update the current requirements display in the modal
    currentRequirementsDisplay.innerHTML = '';
    currentRequirements.forEach(requirement => {
      const li = document.createElement('li');
      li.textContent = requirement;
      currentRequirementsDisplay.appendChild(li);
    });
    
    // Show the modal
    modal.style.display = 'block';
    
    // Focus on the input
    setTimeout(() => {
      document.getElementById('requirements-chat-input').focus();
    }, 100);
    
    // Add event listener for Enter key
    const chatInput = document.getElementById('requirements-chat-input');
    chatInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendRequirementsMessage();
      }
    });
  }
  
  function closeRequirementsChat() {
    const modal = document.getElementById('requirements-chat-modal');
    modal.style.display = 'none';
  }
  
  function sendRequirementsMessage() {
    const input = document.getElementById('requirements-chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addRequirementsChatMessage(message, 'user');
    
    // Clear input
    input.value = '';
    
    // Show loading state
    const sendBtn = document.getElementById('requirements-send-btn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="chat-loading-dots"></span> Processing';
    
    // Add loading message
    const loadingMessageId = addRequirementsChatMessage('', 'assistant', true);
    
    // Get current requirements and story context
    const requirementsInput = document.querySelector('input[name="tagged_requirements"]');
    let currentRequirements = [];
    
    if (requirementsInput && requirementsInput.value) {
      currentRequirements = requirementsInput.value.split('|||').filter(r => r.trim());
    } else {
      const requirementElements = document.querySelectorAll('.requirements-list li');
      currentRequirements = Array.from(requirementElements).map(li => li.textContent.trim());
    }
    
    const storyContext = document.querySelector('input[name="user_story_name"]').value + ': ' + 
                        document.querySelector('input[name="user_story_description"]').value;
    
    // Call backend API
    fetch('/chat-requirements', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: message,
        current_requirements: currentRequirements,
        story_context: storyContext
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('Requirements Chat API Response:', data);
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if (loadingMsg) loadingMsg.remove();
      
      if (data.success) {
        // Get the AI response - check both possible response properties
        const aiResponse = data.message || data.response || 'No response received';
        console.log('AI Response:', aiResponse);
        
        // Add AI response
        addRequirementsChatMessage(aiResponse, 'assistant');
        
        // If there are updated requirements, offer to apply them
        if (data.updated_requirements && Array.isArray(data.updated_requirements) && data.updated_requirements.length > 0) {
          const requirementsPreview = data.updated_requirements.map(r => `• ${r}`).join('<br>');
          const buttonId = 'apply-requirements-btn-' + Date.now();
          
          addRequirementsChatMessage(
            `Here are the updated tagged requirements. Would you like me to apply these changes?
            
            <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin: 8px 0; font-style: italic;">
              ${requirementsPreview}
            </div>
            
            <button id="${buttonId}" 
                    style="background: #d0021b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 8px;">
              ✓ Apply These Requirements
            </button>`, 
            'assistant'
          );
          
          // Add click event listener to the button
          setTimeout(() => {
            const button = document.getElementById(buttonId);
            if (button) {
              button.addEventListener('click', () => {
                applyRequirementsUpdate(data.updated_requirements);
              });
            }
          }, 100);
        }
      } else {
        addRequirementsChatMessage('Sorry, I encountered an error processing your request. Please try again.', 'assistant');
      }
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    })
    .catch(error => {
      console.error('Error calling requirements chat API:', error);
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if (loadingMsg) loadingMsg.remove();
      
      // Show error message
      addRequirementsChatMessage('Sorry, I encountered a connection error. Please check your internet connection and try again.', 'assistant');
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    });
  }
  
  function addRequirementsChatMessage(message, sender, isLoading = false) {
    const messagesContainer = document.getElementById('requirements-chat-messages');
    const messageDiv = document.createElement('div');
    const messageId = 'requirements-msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    messageDiv.id = messageId;
    messageDiv.className = `chat-message ${sender}`;
    
    if (isLoading) {
      messageDiv.innerHTML = `
        <div class="chat-avatar ${sender}">${sender === 'user' ? 'U' : 'AI'}</div>
        <div class="chat-bubble">
          <div class="chat-loading">
            <span class="chat-loading-dots"></span>
            Analyzing your requirements
          </div>
        </div>
      `;
    } else {
      messageDiv.innerHTML = `
        <div class="chat-avatar ${sender}">${sender === 'user' ? 'U' : 'AI'}</div>
        <div class="chat-bubble">${message}</div>
      `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
  }
  
  function applyRequirementsUpdate(newRequirements) {
    if (!Array.isArray(newRequirements)) return;
    
    // Update the hidden form field
    const hiddenInput = document.querySelector('input[name="tagged_requirements"]');
    if (hiddenInput) {
      hiddenInput.value = newRequirements.join('|||');
    }
    
    // Update the visible requirements on the page
    const requirementsList = document.querySelector('.requirements-list');
    if (requirementsList) {
      requirementsList.innerHTML = '';
      newRequirements.forEach(requirement => {
        const li = document.createElement('li');
        li.textContent = requirement;
        requirementsList.appendChild(li);
      });
    }
    
    // Update the current requirements display in the modal
    const currentRequirementsDisplay = document.getElementById('current-requirements-display');
    if (currentRequirementsDisplay) {
      currentRequirementsDisplay.innerHTML = '';
      newRequirements.forEach(requirement => {
        const li = document.createElement('li');
        li.textContent = requirement;
        currentRequirementsDisplay.appendChild(li);
      });
    }
    
    // Show success message
    addRequirementsChatMessage('✅ Tagged requirements updated successfully! The changes are now applied to your user story.', 'assistant');
    
    // Auto-save the changes
    saveUserStoryData();
  }
  
  // Modern UI Utilities
  function showLoading(message = 'Processing your request...') {
    const overlay = document.getElementById('loading-overlay');
    const messageElement = overlay.querySelector('p');
    messageElement.textContent = message;
    overlay.style.display = 'flex';
  }

  function hideLoading() {
    const overlay = document.getElementById('loading-overlay');
    overlay.style.display = 'none';
  }

  function showToast(message, type = 'success', duration = 5000) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️';
    toast.innerHTML = `
      <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
        <span style="font-size: 1.2rem;">${icon}</span>
        <span>${message}</span>
      </div>
    `;
    
    container.appendChild(toast);
    
    // Trigger the animation
    requestAnimationFrame(() => {
      toast.classList.add('show');
    });
    
    // Auto-remove after duration
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }, duration);
  }

  function animateButton(button, text, icon = '') {
    const originalText = button.innerHTML;
    button.innerHTML = `${icon} ${text}`;
    button.style.transform = 'scale(0.95)';
    
    setTimeout(() => {
      button.style.transform = 'scale(1)';
    }, 150);
    
    return originalText;
  }

  function addButtonPulse(buttonId) {
    const button = document.getElementById(buttonId);
    if (button) {
      button.classList.add('button-pulse');
    }
  }

  function removeButtonPulse(buttonId) {
    const button = document.getElementById(buttonId);
    if (button) {
      button.classList.remove('button-pulse');
    }
  }

  // Enhanced form validation with visual feedback
  function validateForm() {
    const form = document.getElementById('jira-form');
    const formData = new FormData(form);
    let isValid = true;
    const errors = [];

    // Check required fields
    const requiredFields = [
      { name: 'user_story_name', label: 'User Story Name' },
      { name: 'user_story_description', label: 'User Story Description' },
      { name: 'epic_title', label: 'Epic Title' }
    ];

    requiredFields.forEach(field => {
      const value = formData.get(field.name);
      if (!value || value.trim() === '') {
        isValid = false;
        errors.push(`${field.label} is required`);
      }
    });

    if (!isValid) {
      showToast(`Please fix the following errors:\n${errors.join('\n')}`, 'error', 8000);
    }

    return isValid;
  }

  // Initialize modern animations when page loads
  document.addEventListener('DOMContentLoaded', function() {
    // Add staggered animations to sections
    const sections = document.querySelectorAll('.section-container');
    sections.forEach((section, index) => {
      section.style.animationDelay = `${(index + 1) * 0.1}s`;
    });

    // Add pulse animation to submit button
    setTimeout(() => {
      addButtonPulse('jira-submit-btn');
    }, 2000);

    // Add hover effects to info items
    const infoItems = document.querySelectorAll('.info-item');
    infoItems.forEach(item => {
      item.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-2px) scale(1.02)';
        this.style.boxShadow = 'var(--shadow-lg)';
      });
      
      item.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0) scale(1)';
        this.style.boxShadow = 'var(--shadow-sm)';
      });
    });

    // Show welcome toast
    setTimeout(() => {
      showToast('Welcome! Review your user story details and click Submit when ready.', 'success', 4000);
    }, 1000);
  });

  // Enhanced window unload handling
  window.addEventListener('beforeunload', function(e) {
    const form = document.getElementById('jira-form');
    if (form) {
      saveUserStoryData();
    }
  });

  function saveUserStoryData() {
    // Auto-save user story data to session storage for persistence
    try {
      const userStoryData = {
        user_story_name: document.querySelector('input[name="user_story_name"]')?.value || '',
        user_story_description: document.querySelector('input[name="user_story_description"]')?.value || '',
        epic_title: document.querySelector('input[name="epic_title"]')?.value || '',
        acceptance_criteria: document.querySelector('input[name="acceptance_criteria"]')?.value || '',
        tagged_requirements: document.querySelector('input[name="tagged_requirements"]')?.value || '',
        priority: document.querySelector('input[name="priority"]')?.value || '',
        responsible_systems: document.querySelector('input[name="responsible_systems"]')?.value || '',
        timestamp: new Date().toISOString()
      };
      
      sessionStorage.setItem('userStoryData', JSON.stringify(userStoryData));
      console.log('User story data saved to session storage');
    } catch (error) {
      console.error('Error saving user story data:', error);
    }
  }

  function clearDescriptionChat() {
    if (!confirm('Are you sure you want to clear this chat? This action cannot be undone.')) {
      return;
    }
    
    const messagesContainer = document.getElementById('description-chat-messages');
    if (messagesContainer) {
      // Keep only the initial AI message if it exists
      const assistantMessage = messagesContainer.querySelector('.chat-message.assistant');
      messagesContainer.innerHTML = '';
      
      if (assistantMessage) {
        messagesContainer.appendChild(assistantMessage);
      }
      
      showToast('Description chat cleared successfully', 'success', 3000);
    }
  }

  function clearAcceptanceCriteriaChat() {
    if (!confirm('Are you sure you want to clear this chat? This action cannot be undone.')) {
      return;
    }
    
    const messagesContainer = document.getElementById('criteria-chat-messages');
    if (messagesContainer) {
      // Keep only the initial AI message if it exists
      const assistantMessage = messagesContainer.querySelector('.chat-message.assistant');
      messagesContainer.innerHTML = '';
      
      if (assistantMessage) {
        messagesContainer.appendChild(assistantMessage);
      }
      
      showToast('Acceptance Criteria chat cleared successfully', 'success', 3000);
    }
  }

  function clearRequirementsChat() {
    if (!confirm('Are you sure you want to clear this chat? This action cannot be undone.')) {
      return;
    }
    
    const messagesContainer = document.getElementById('requirements-chat-messages');
    if (messagesContainer) {
      // Keep only the initial AI message if it exists
      const assistantMessage = messagesContainer.querySelector('.chat-message.assistant');
      messagesContainer.innerHTML = '';
      
      if (assistantMessage) {
        messagesContainer.appendChild(assistantMessage);
      }
      
      showToast('Requirements chat cleared successfully', 'success', 3000);
    }
  }

  function clearEpicChat() {
    if (!confirm('Are you sure you want to clear this chat? This action cannot be undone.')) {
      return;
    }
    
    const messagesContainer = document.getElementById('epic-chat-messages');
    if (messagesContainer) {
      messagesContainer.innerHTML = '';
      showToast('Epic chat cleared successfully', 'success', 3000);
    }
  }

  function clearUserStoryChat() {
    if (!confirm('Are you sure you want to clear this chat? This action cannot be undone.')) {
      return;
    }
    
    const messagesContainer = document.getElementById('user-story-chat-messages');
    if (messagesContainer) {
      // Keep only the initial AI message if it exists
      const assistantMessage = messagesContainer.querySelector('.chat-message.assistant');
      messagesContainer.innerHTML = '';
      
      if (assistantMessage) {
        messagesContainer.appendChild(assistantMessage);
      }
      
      showToast('User Story chat cleared successfully', 'success', 3000);
    }
  }

  function openUserStoryChat() {
    console.log('openUserStoryChat called');
    
    const modal = document.getElementById('user-story-chat-modal');
    console.log('Modal element:', modal);
    
    if (!modal) {
      console.error('User Story Chat modal element not found!');
      showToast('❌ Error: Chat modal not found. Please reload the page and try again.', 'error', 5000);
      return;
    }
    
    // Get current user story context and preserve it
    const userStoryName = document.querySelector('input[name="user_story_name"]')?.value || '';
    const userStoryDescription = document.querySelector('input[name="user_story_description"]')?.value || '';
    const epicTitle = document.querySelector('input[name="epic_title"]')?.value || '';
    
    console.log('Current user story context:', { userStoryName, userStoryDescription, epicTitle });
    
    // Store context in modal data attributes for persistence
    modal.setAttribute('data-story-name', userStoryName);
    modal.setAttribute('data-story-description', userStoryDescription);
    modal.setAttribute('data-epic-title', epicTitle);
    
    // Update the current user story display in the modal if it exists
    const currentUserStoryDisplay = document.getElementById('current-user-story-display');
    if (currentUserStoryDisplay) {
      if (userStoryName) {
        currentUserStoryDisplay.innerHTML = `
          <strong>Story:</strong> ${userStoryName}<br>
          <strong>Epic:</strong> ${epicTitle || 'Not specified'}<br>
          <strong>Description:</strong> ${userStoryDescription || 'No description available'}
        `;
      } else {
        currentUserStoryDisplay.innerHTML = 'No user story context available';
      }
    }
    
    // Initialize chat with context preservation message
    const messagesContainer = document.getElementById('user-story-chat-messages');
    if (messagesContainer && messagesContainer.children.length <= 1) {
      // Only add context message if chat is mostly empty
      addUserStoryChatMessage(
        `📋 **Current Context Loaded:**
        
        **User Story:** ${userStoryName || 'Not specified'}
        **Epic:** ${epicTitle || 'Not specified'}
        
        I'm ready to help you refine this user story. I'll maintain this context throughout our conversation, so even if you ask to remove or modify specific elements, I'll understand you're working on this particular story.`, 
        'assistant'
      );
    }
    
    modal.style.display = 'block';
    
    // Focus on the input field
    const input = document.getElementById('user-story-chat-input');
    if (input) {
      setTimeout(() => input.focus(), 100);
    }
    
    // Add Enter key listener if not already added
    if (input && !input.hasAttribute('data-listener-added')) {
      input.setAttribute('data-listener-added', 'true');
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendUserStoryMessage();
        }
      });
    }
  }
  
  function closeUserStoryChat() {
    const modal = document.getElementById('user-story-chat-modal');
    modal.style.display = 'none';
  }
  
  function sendUserStoryMessage() {
    const input = document.getElementById('user-story-chat-input');
    const message = input.value.trim();
    
    if (!message) {
      showToast('Please enter a message first.', 'warning', 3000);
      return;
    }
    
    console.log('Sending user story message:', message);
    
    // Add user message to chat
    addUserStoryChatMessage(message, 'user');
    
    // Clear input
    input.value = '';
    
    // Show loading state
    const sendBtn = document.getElementById('user-story-send-btn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<span class="chat-loading-dots"></span> Processing';
    
    // Add loading message
    const loadingMessageId = addUserStoryChatMessage('', 'assistant', true);
    
    // Get current user story context - prioritize modal data attributes to preserve context
    const modal = document.getElementById('user-story-chat-modal');
    let userStoryName = modal.getAttribute('data-story-name') || document.querySelector('input[name="user_story_name"]')?.value || '';
    let userStoryDescription = modal.getAttribute('data-story-description') || document.querySelector('input[name="user_story_description"]')?.value || '';
    let epicTitle = modal.getAttribute('data-epic-title') || document.querySelector('input[name="epic_title"]')?.value || '';
    
    // If modal doesn't have data attributes, get from form and store them
    if (!modal.getAttribute('data-story-name')) {
      userStoryName = document.querySelector('input[name="user_story_name"]')?.value || '';
      userStoryDescription = document.querySelector('input[name="user_story_description"]')?.value || '';
      epicTitle = document.querySelector('input[name="epic_title"]')?.value || '';
      
      modal.setAttribute('data-story-name', userStoryName);
      modal.setAttribute('data-story-description', userStoryDescription);
      modal.setAttribute('data-epic-title', epicTitle);
    }
    
    // Get acceptance criteria and requirements for full context
    const acceptanceCriteriaInput = document.querySelector('input[name="acceptance_criteria"]');
    let acceptanceCriteria = [];
    if (acceptanceCriteriaInput && acceptanceCriteriaInput.value) {
      acceptanceCriteria = acceptanceCriteriaInput.value.split('|||').filter(c => c.trim());
    }
    
    const requirementsInput = document.querySelector('input[name="tagged_requirements"]');
    let taggedRequirements = [];
    if (requirementsInput && requirementsInput.value) {
      taggedRequirements = requirementsInput.value.split('|||').filter(r => r.trim());
    }
    
    const context = {
      user_story_name: userStoryName,
      user_story_description: userStoryDescription,
      epic_title: epicTitle,
      acceptance_criteria: acceptanceCriteria,
      tagged_requirements: taggedRequirements,
      page_context: 'user_story_details', // Important: specify that this is a single story page
      timestamp: new Date().toISOString()
    };
    
    console.log('User story context being sent:', context);
    
    // Call backend API
    fetch('/chat-user-story', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: message,
        context: context
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('User Story Chat API Response:', data);
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if (loadingMsg) loadingMsg.remove();
      
      if (data.success) {
        // Get the AI response
        const aiResponse = data.message || data.response || 'No response received';
        console.log('AI Response:', aiResponse);
        
        // Add AI response
        addUserStoryChatMessage(aiResponse, 'assistant');
        
        // If there are updates to any part of the user story, offer to apply them
        if (data.updates) {
          handleUserStoryUpdates(data.updates);
        }
      } else {
        addUserStoryChatMessage('Sorry, I encountered an error processing your request. Please try again. Error: ' + (data.error || 'Unknown error'), 'assistant');
      }
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    })
    .catch(error => {
      console.error('Error calling user story chat API:', error);
      
      // Remove loading message
      const loadingMsg = document.getElementById(loadingMessageId);
      if (loadingMsg) loadingMsg.remove();
      
      // Show error message
      addUserStoryChatMessage('Sorry, I encountered a connection error. Please check your internet connection and try again. Details: ' + error.message, 'assistant');
      
      // Reset send button
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<span>📤</span> Send';
    });
  }
  
  function addUserStoryChatMessage(message, sender, isLoading = false) {
    const messagesContainer = document.getElementById('user-story-chat-messages');
    const messageDiv = document.createElement('div');
    const messageId = 'user-story-msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    messageDiv.id = messageId;
    messageDiv.className = `chat-message ${sender}`;
    
    if (isLoading) {
      messageDiv.innerHTML = `
        <div class="chat-avatar ${sender}">${sender === 'user' ? 'U' : 'AI'}</div>
        <div class="chat-bubble">
          <div class="chat-loading">
            <span class="chat-loading-dots"></span>
            Analyzing your user story request...
          </div>
        </div>
      `;
    } else {
      messageDiv.innerHTML = `
        <div class="chat-avatar ${sender}">${sender === 'user' ? 'U' : 'AI'}</div>
        <div class="chat-bubble">${message}</div>
      `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
  }
  
  function handleUserStoryUpdates(updates) {
    // Handle updates to user story components
    if (updates.user_story_name) {
      const buttonId = 'apply-story-name-btn-' + Date.now();
      addUserStoryChatMessage(
        `I suggest updating the user story name to: <strong>"${updates.user_story_name}"</strong>
        
        <button id="${buttonId}" 
                style="background: #d0021b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 8px;">
          ✓ Apply This Update
        </button>`, 
        'assistant'
      );
      
      setTimeout(() => {
        const button = document.getElementById(buttonId);
        if (button) {
          button.addEventListener('click', () => {
            applyUserStoryNameUpdate(updates.user_story_name);
          });
        }
      }, 100);
    }
    
    if (updates.user_story_description) {
      const buttonId = 'apply-story-desc-btn-' + Date.now();
      addUserStoryChatMessage(
        `I suggest updating the user story description to:
        
        <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin: 8px 0; font-style: italic;">
          ${updates.user_story_description}
        </div>
        
        <button id="${buttonId}" 
                style="background: #d0021b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 8px;">
          ✓ Apply This Update
        </button>`, 
        'assistant'
      );
      
      setTimeout(() => {
        const button = document.getElementById(buttonId);
        if (button) {
          button.addEventListener('click', () => {
            applyUserStoryDescriptionUpdate(updates.user_story_description);
          });
        }
      }, 100);
    }
    
    if (updates.acceptance_criteria && Array.isArray(updates.acceptance_criteria)) {
      const criteriaPreview = updates.acceptance_criteria.map(c => `• ${c}`).join('<br>');
      const buttonId = 'apply-story-criteria-btn-' + Date.now();
      
      addUserStoryChatMessage(
        `I suggest updating the acceptance criteria to:
        
        <div style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin: 8px 0; font-style: italic;">
          ${criteriaPreview}
        </div>
        
        <button id="${buttonId}" 
                style="background: #d0021b; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-top: 8px;">
          ✓ Apply These Criteria
        </button>`, 
        'assistant'
      );
      
      setTimeout(() => {
        const button = document.getElementById(buttonId);
        if (button) {
          button.addEventListener('click', () => {
            applyAcceptanceCriteriaUpdate(updates.acceptance_criteria);
          });
        }
      }, 100);
    }
  }
  
  function applyUserStoryNameUpdate(newName) {
    // Update the hidden form field
    const hiddenInput = document.querySelector('input[name="user_story_name"]');
    if (hiddenInput) {
      hiddenInput.value = newName;
    }
    
    // Update the visible story header
    const storyHeader = document.querySelector('.story-header');
    if (storyHeader) {
      // Keep the chat button but update the text
      const chatButton = storyHeader.querySelector('.chat-btn');
      const chatButtonHTML = chatButton ? chatButton.outerHTML : '';
      storyHeader.innerHTML = `User story: ${newName} ${chatButtonHTML}`;
    }
    
    // Show success message
    addUserStoryChatMessage('✅ User story name updated successfully!', 'assistant');
    
    // Auto-save the changes
    saveUserStoryData();
  }
  
  function applyUserStoryDescriptionUpdate(newDescription) {
    // Update the hidden form field
    const hiddenInput = document.querySelector('input[name="user_story_description"]');
    if (hiddenInput) {
      hiddenInput.value = newDescription;
    }
    
    // Update the visible description
    const descriptionElement = document.querySelector('.enhanced-description div:last-child');
    if (descriptionElement) {
      descriptionElement.innerHTML = newDescription;
    }
    
    // Show success message
    addUserStoryChatMessage('✅ User story description updated successfully!', 'assistant');
    
    // Auto-save the changes
    saveUserStoryData();
  }

  // Function to format and beautify traceability matrix content
  function formatTraceabilityContent() {
    const traceabilityContainer = document.getElementById('traceability-content');
    if (!traceabilityContainer) return;

    const rawContentDiv = traceabilityContainer.querySelector('.traceability-raw-content');
    const formattedContentDiv = traceabilityContainer.querySelector('.traceability-formatted-content');
    
    if (!rawContentDiv || !formattedContentDiv) return;

    let rawContent = rawContentDiv.textContent || rawContentDiv.innerText || '';
    if (!rawContent.trim()) return;

    try {
      // Show loading state
      formattedContentDiv.innerHTML = '<div class="traceability-loading">Formatting traceability matrix...</div>';

      // Clean up the content
      rawContent = rawContent.trim();

      // Convert markdown-like content to HTML
      let formattedContent = rawContent;

      // Convert headers
      formattedContent = formattedContent.replace(/^#{4}\s+(.+)$/gm, '<h4>$1</h4>');
      formattedContent = formattedContent.replace(/^#{3}\s+(.+)$/gm, '<h3>$1</h3>');
      formattedContent = formattedContent.replace(/^#{2}\s+(.+)$/gm, '<h2>$1</h2>');
      formattedContent = formattedContent.replace(/^#{1}\s+(.+)$/gm, '<h1>$1</h1>');

      // Convert bold text
      formattedContent = formattedContent.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      formattedContent = formattedContent.replace(/\*(.+?)\*/g, '<em>$1</em>');

      // Convert tables (pipe-separated format) with fixed headers
      const tableRegex = /(\|.+\|[\r\n]+)+/g;
      const tables = formattedContent.match(tableRegex);
      
      // Define the required column headers
      const requiredHeaders = [
        'User Story ID',
        'User Story Title', 
        'PRD Section Name or ID',
        'Matching Requirement Summary',
        'Reason for Match'
      ];
      
      if (tables) {
        tables.forEach(tableText => {
          const lines = tableText.trim().split(/[\r\n]+/);
          let tableHtml = '<table class="traceability-table">';
          
          // Always use the required headers regardless of AI output
          tableHtml += '<thead><tr>';
          requiredHeaders.forEach(header => {
            tableHtml += `<th>${header}</th>`;
          });
          tableHtml += '</tr></thead><tbody>';
          
          lines.forEach((line, index) => {
            if (line.trim() && line.includes('|')) {
              const cells = line.split('|').map(cell => cell.trim()).filter(cell => cell);
              
              if (index === 0) {
                // Skip original header row since we're using fixed headers
                return;
              } else if (index === 1 && cells.every(cell => cell.match(/^-+$/))) {
                // Skip separator row
                return;
              } else {
                // Data row - ensure we have exactly 5 columns
                tableHtml += '<tr>';
                for (let i = 0; i < requiredHeaders.length; i++) {
                  const cellContent = cells[i] || '';
                  tableHtml += `<td>${cellContent}</td>`;
                }
                tableHtml += '</tr>';
              }
            }
          });
          
          tableHtml += '</tbody></table>';
          formattedContent = formattedContent.replace(tableText, tableHtml);
        });
      } else {
        // If no table format detected, try to create a table from the content
        // Look for patterns that might represent traceability data
        const lines = formattedContent.split(/[\r\n]+/);
        let hasTraceabilityData = false;
        let tableData = [];
        
        // Check if content contains traceability-related keywords
        const traceabilityKeywords = ['user story', 'story id', 'prd section', 'requirement', 'match'];
        const contentLower = formattedContent.toLowerCase();
        
        if (traceabilityKeywords.some(keyword => contentLower.includes(keyword))) {
          hasTraceabilityData = true;
          
          // Try to extract data from the content
          lines.forEach(line => {
            const trimmed = line.trim();
            if (trimmed && !trimmed.startsWith('#') && !trimmed.startsWith('**')) {
              // This might be data content, try to split it
              if (trimmed.includes(':') || trimmed.includes('-') || trimmed.includes('|')) {
                // Attempt to parse as data
                const parts = trimmed.split(/[:\-|]/);
                if (parts.length >= 2) {
                  tableData.push(parts.map(p => p.trim()));
                }
              }
            }
          });
          
          // Create table with proper headers if we found any data
          if (tableData.length > 0) {
            let tableHtml = '<table class="traceability-table"><thead><tr>';
            requiredHeaders.forEach(header => {
              tableHtml += `<th>${header}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';
            
            tableData.forEach(row => {
              tableHtml += '<tr>';
              for (let i = 0; i < requiredHeaders.length; i++) {
                const cellContent = row[i] || '';
                tableHtml += `<td>${cellContent}</td>`;
              }
              tableHtml += '</tr>';
            });
            
            tableHtml += '</tbody></table>';
            
            // Replace the original content with the table
            formattedContent = tableHtml + '<br><div class="original-content" style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: var(--surface-secondary); border-radius: var(--radius-md);"><strong>Original Content:</strong><br>' + formattedContent + '</div>';
          }
        }
      }

      // Convert bullet points
      formattedContent = formattedContent.replace(/^[\s]*[-•*]\s+(.+)$/gm, '<li>$1</li>');
      
      // Wrap consecutive list items in ul tags
      formattedContent = formattedContent.replace(/(<li>.*<\/li>)/gs, function(match) {
        return '<ul>' + match + '</ul>';
      });

      // Convert line breaks to paragraphs
      const paragraphs = formattedContent.split(/\n\s*\n/);
      formattedContent = paragraphs.map(para => {
        para = para.trim();
        if (!para) return '';
        if (para.includes('<h1>') || para.includes('<h2>') || para.includes('<h3>') || 
            para.includes('<h4>') || para.includes('<table') || para.includes('<ul>') || 
            para.includes('<li>')) {
          return para;
        }
        return `<p>${para.replace(/\n/g, '<br>')}</p>`;
      }).join('');

      // Clean up empty elements
      formattedContent = formattedContent.replace(/<p><\/p>/g, '');
      formattedContent = formattedContent.replace(/<ul><\/ul>/g, '');
      
      // Add special styling for specific content - highlight the required headers
      const headerPattern = /(User Story ID|User Story Title|PRD Section Name or ID|Matching Requirement Summary|Reason for Match)/gi;
      formattedContent = formattedContent.replace(headerPattern, 
        '<strong style="color: var(--primary-red);">$&</strong>');

      // Set the formatted content
      setTimeout(() => {
        formattedContentDiv.innerHTML = formattedContent || '<p style="color: var(--text-muted); font-style: italic;">No traceability data to display.</p>';
        
        // Ensure at least one table with proper headers exists
        let existingTables = formattedContentDiv.querySelectorAll('table');
        if (existingTables.length === 0) {
          // Create a table with proper headers and placeholder content
          const requiredHeaders = [
            'User Story ID',
            'User Story Title', 
            'PRD Section Name or ID',
            'Matching Requirement Summary',
            'Reason for Match'
          ];
          
          let tableHtml = '<table class="traceability-table"><thead><tr>';
          requiredHeaders.forEach(header => {
            tableHtml += `<th>${header}</th>`;
          });
          tableHtml += '</tr></thead><tbody>';
          tableHtml += '<tr><td colspan="5" style="text-align: center; color: var(--text-muted); font-style: italic; padding: var(--spacing-xl);">Traceability matrix data will be displayed here when available</td></tr>';
          tableHtml += '</tbody></table>';
          
          // Add the table to the content
          if (formattedContentDiv.innerHTML.trim()) {
            formattedContentDiv.innerHTML += '<br>' + tableHtml;
          } else {
            formattedContentDiv.innerHTML = tableHtml;
          }
        }
        
        // Add interactive features to tables and ensure correct headers
        const allTables = formattedContentDiv.querySelectorAll('table');
        allTables.forEach(table => {
          table.style.marginTop = 'var(--spacing-md)';
          table.style.marginBottom = 'var(--spacing-md)';
          
          // Ensure table has correct headers
          const thead = table.querySelector('thead');
          if (thead) {
            const headerRow = thead.querySelector('tr');
            if (headerRow) {
              const requiredHeaders = [
                'User Story ID',
                'User Story Title', 
                'PRD Section Name or ID',
                'Matching Requirement Summary',
                'Reason for Match'
              ];
              
              // Replace existing headers with required ones
              headerRow.innerHTML = '';
              requiredHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
              });
            }
          }
          
          // Add hover effects to rows
          const rows = table.querySelectorAll('tbody tr');
          rows.forEach(row => {
            row.addEventListener('mouseenter', function() {
              this.style.backgroundColor = 'var(--primary-red-lighter)';
              this.style.transform = 'scale(1.001)';
            });
            row.addEventListener('mouseleave', function() {
              this.style.backgroundColor = '';
              this.style.transform = '';
            });
          });
        });
      }, 300);

    } catch (error) {
      console.error('Error formatting traceability content:', error);
      formattedContentDiv.innerHTML = `
        <div style="color: var(--text-muted);">
          <p><strong>Raw Traceability Data:</strong></p>
          <pre style="background: var(--surface-secondary); padding: var(--spacing-md); border-radius: var(--radius-md); overflow-x: auto; white-space: pre-wrap;">${rawContent}</pre>
        </div>
      `;
    }
  }

  // Traceability Chat Functions
  function openTraceabilityChat() {
    console.log('openTraceabilityChat called');
    
    const modal = document.getElementById('traceability-chat-modal');
    console.log('Traceability modal element:', modal);
    
    if (!modal) {
      console.error('Traceability modal element not found!');
      alert('❌ Error: Traceability chat modal not found. Please reload the page and try again.');
      return;
    }
    
    const currentTraceabilityDisplay = document.getElementById('current-traceability-display');
    console.log('Current traceability display element:', currentTraceabilityDisplay);
    
    // Get current traceability matrix content
    let currentTraceability = '';
    const traceabilityContent = document.getElementById('traceability-content');
    if (traceabilityContent) {
      currentTraceability = traceabilityContent.textContent || traceabilityContent.innerText || '';
    }
    
    // Update the preview display in the modal
    if (currentTraceabilityDisplay && traceabilityContent) {
      currentTraceabilityDisplay.innerHTML = traceabilityContent.innerHTML || 'No traceability matrix available';
    }
    
    // Prepare context for chat
    const context = {
      userStory: {
        title: document.querySelector('input[name="user_story_name"]')?.value || '',
        description: document.querySelector('input[name="user_story_description"]')?.value || '',
        acceptanceCriteria: document.querySelector('input[name="acceptance_criteria"]')?.value || ''
      },
      currentTraceability: currentTraceability.trim(),
      timestamp: new Date().toISOString()
    };
    
    console.log('Traceability chat context:', context);
    
    // Show modal with animation
    modal.style.display = 'block';
    setTimeout(() => {
      modal.style.opacity = '1';
    }, 10);
    
    // Add initial context message if chat is empty
    const chatContainer = document.getElementById('traceability-chat-messages');
    if (chatContainer && chatContainer.children.length <= 1) {
      // Clear any existing messages first
      chatContainer.innerHTML = '';
      
      addTraceabilityChatMessage(
        'Hello! I can help you with the traceability matrix for this user story. You can ask me to:\n\n' +
        '• Explain how requirements map to this user story\n' +
        '• Suggest improvements to the traceability matrix\n' +
        '• Help identify missing requirement mappings\n' +
        '• Clarify requirement relationships\n\n' +
        'What would you like to know about the traceability matrix?',
        'assistant'
      );
    }
    
    // Focus on input
    const input = document.getElementById('traceability-chat-input');
    if (input) {
      setTimeout(() => input.focus(), 100);
    }
  }

  function closeTraceabilityChat() {
    const modal = document.getElementById('traceability-chat-modal');
    if (modal) {
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }
  }

  function sendTraceabilityMessage() {
    const input = document.getElementById('traceability-chat-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addTraceabilityChatMessage(message, 'user');
    
    // Clear input
    input.value = '';
    
    // Show loading state
    const sendBtn = document.getElementById('traceability-send-btn');
    if (sendBtn) {
      sendBtn.disabled = true;
      sendBtn.textContent = 'Sending...';
    }
    
    // Add loading message
    const loadingMessageId = 'loading-' + Date.now();
    addTraceabilityChatMessage('Analyzing traceability matrix...', 'assistant', true, loadingMessageId);
    
    // Get current context
    const context = {
      userStory: {
        title: document.querySelector('input[name="user_story_title"]')?.value || '',
        description: document.querySelector('input[name="user_story_description"]')?.value || '',
        acceptanceCriteria: document.querySelector('input[name="acceptance_criteria"]')?.value || ''
      },
      currentTraceability: document.getElementById('traceability-content')?.textContent || '',
      userMessage: message,
      sessionContext: sessionStorage.getItem('userStoryContext') || '{}',
      timestamp: new Date().toISOString()
    };
    
    // Send to backend
    fetch('/chat_traceability', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(context)
    })
    .then(response => response.json())
    .then(data => {
      // Remove loading message
      const loadingElement = document.getElementById(loadingMessageId);
      if (loadingElement) {
        loadingElement.remove();
      }
      
      if (data.success) {
        // Check if the response contains JSON that needs to be parsed
        let aiResponse = data.response;
        let updatedTraceability = data.updated_traceability;
        
        // Try to parse the response if it appears to be JSON
        if (typeof aiResponse === 'string' && (aiResponse.trim().startsWith('{') || aiResponse.trim().startsWith('```json'))) {
          try {
            // Clean up the response if it's wrapped in markdown code blocks
            let cleanResponse = aiResponse.trim();
            if (cleanResponse.startsWith('```json')) {
              cleanResponse = cleanResponse.replace(/```json\s*/, '').replace(/```\s*$/, '');
            }
            
            const parsedResponse = JSON.parse(cleanResponse);
            
            // Extract the actual message from the JSON
            if (parsedResponse.message || parsedResponse.response) {
              aiResponse = parsedResponse.message || parsedResponse.response;
            }
            
            // Extract updated traceability if available
            if (parsedResponse.traceability_matrix || parsedResponse.updated_traceability) {
              updatedTraceability = parsedResponse.traceability_matrix || parsedResponse.updated_traceability;
            }
            
            console.log('Parsed JSON response for traceability:', { aiResponse, updatedTraceability });
          } catch (parseError) {
            console.log('Could not parse traceability AI response as JSON, using as-is');
            // If parsing fails, use the original response
          }
        }
        
        // Add AI response
        addTraceabilityChatMessage(aiResponse, 'assistant');
        
        // Update traceability matrix if provided
        if (updatedTraceability) {
          const traceabilityContent = document.getElementById('traceability-content');
          if (traceabilityContent) {
            // Preserve the proper structure for traceability content
            let rawContentDiv = traceabilityContent.querySelector('.traceability-raw-content');
            let formattedContentDiv = traceabilityContent.querySelector('.traceability-formatted-content');
            
            // If the structure doesn't exist, create it
            if (!rawContentDiv || !formattedContentDiv) {
              traceabilityContent.innerHTML = `
                <div class="traceability-raw-content" style="display: none;">${updatedTraceability}</div>
                <div class="traceability-formatted-content">
                  <!-- Content will be dynamically formatted by JavaScript -->
                </div>
              `;
            } else {
              // Update existing structure
              rawContentDiv.textContent = updatedTraceability;
              formattedContentDiv.innerHTML = '<!-- Content will be dynamically formatted by JavaScript -->';
            }
            
            formatTraceabilityContent(); // Re-format the content
            
            // Show success message in chat
            addTraceabilityChatMessage('✅ Traceability matrix updated successfully!', 'assistant');
          }
        }
      } else {
        addTraceabilityChatMessage(
          '❌ Sorry, I encountered an error: ' + (data.error || 'Unknown error occurred'),
          'assistant'
        );
      }
    })
    .catch(error => {
      console.error('Error:', error);
      
      // Remove loading message
      const loadingElement = document.getElementById(loadingMessageId);
      if (loadingElement) {
        loadingElement.remove();
      }
      
      addTraceabilityChatMessage(
        '❌ Sorry, I encountered a network error. Please check your connection and try again.',
        'assistant'
      );
    })
    .finally(() => {
      // Reset send button
      if (sendBtn) {
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send';
      }
    });
  }

  function addTraceabilityChatMessage(message, sender, isLoading = false, messageId = null) {
    const chatContainer = document.getElementById('traceability-chat-messages');
    if (!chatContainer) return;
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender}`;
    if (messageId) messageDiv.id = messageId;
    
    const avatar = document.createElement('div');
    avatar.className = `chat-avatar ${sender}`;
    avatar.textContent = sender === 'user' ? 'U' : 'AI';
    
    const bubble = document.createElement('div');
    bubble.className = 'chat-bubble';
    
    if (isLoading) {
      bubble.innerHTML = `
        <div class="chat-loading">
          <div class="chat-loading-dots"></div>
          ${message}
        </div>
      `;
    } else {
      // Convert markdown-like formatting
      let formattedMessage = message
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>');
      
      bubble.innerHTML = formattedMessage;
    }
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(bubble);
    chatContainer.appendChild(messageDiv);
    
    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function clearTraceabilityChat() {
    const chatContainer = document.getElementById('traceability-chat-messages');
    if (chatContainer) {
      chatContainer.innerHTML = '';
      // Add welcome message back
      addTraceabilityChatMessage(
        'Hello! I can help you with the traceability matrix for this user story. What would you like to know?',
        'assistant'
      );
    }
  }

  // Add Enter key support for traceability chat
  document.addEventListener('DOMContentLoaded', function() {
    const traceabilityChatInput = document.getElementById('traceability-chat-input');
    if (traceabilityChatInput) {
      traceabilityChatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendTraceabilityMessage();
        }
      });
    }
  });

  // Initialize traceability formatting when page loads
  document.addEventListener('DOMContentLoaded', function() {
    // Add a small delay to ensure all content is loaded
    setTimeout(() => {
      formatTraceabilityContent();
    }, 500);
  });
</script>
</body>
</html>
