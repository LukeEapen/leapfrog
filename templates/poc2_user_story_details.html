<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Story Drafting Solution</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body {
      background-color: #2f323a;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .main-container {
      max-width: 900px;
      margin: 20px auto;
      background: #fff;
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    .top-bar {
      background-color: #d0021b;
      color: white;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 500;
      position: relative;
    }
    .back-button {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      font-size: 14px;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    .back-button:hover {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      transform: translateY(-1px);
    }
    .story-header {
      background-color: #444;
      color: white;
      padding: 16px 20px;
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    .content-container {
      background: white;
      margin: 0;
      padding: 28px;
      color: #000;
    }
    .epic-info-section {
      margin-bottom: 28px;
      padding: 20px;
      border-bottom: 1px solid #e2e8f0;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    .epic-label {
      color: #d0021b;
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .epic-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    .info-row {
      display: flex;
      gap: 28px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .info-item {
      display: flex;
      align-items: center;
      font-size: 14px;
      background: white;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    .info-label {
      font-weight: 600;
      margin-right: 8px;
      color: #666;
    }
    .priority-high {
      color: #d0021b;
      font-weight: 600;
      padding: 2px 8px;
      background: rgba(208, 2, 27, 0.1);
      border-radius: 4px;
    }
    .section-container {
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: white;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .section-container:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .section-header {
      background-color: #444;
      color: white;
      padding: 14px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 15px;
    }
    .section-content {
      padding: 20px;
      line-height: 1.6;
      color: #333;
      background: white;
    }
    .chat-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
      font-weight: 500;
    }
    .chat-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      transform: translateY(-1px);
    }
    .requirements-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .requirements-list li {
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 14px;
      color: #333;
      background: #f8f9fa;
      margin-bottom: 2px;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    .requirements-list li:hover {
      background: #e9ecef;
      transform: translateX(4px);
    }
    .requirements-list li:last-child {
      border-bottom: none;
    }
    .tagged-requirements-section .section-content {
      background: #fff5f5;
      border: 1px solid #fed7d7;
      border-radius: 4px;
    }
    .criteria-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .criteria-list li {
      padding: 10px 16px;
      color: #333;
      font-size: 14px;
      position: relative;
      padding-left: 28px;
      background: #f8f9fa;
      margin-bottom: 4px;
      border-radius: 4px;
      border-left: 3px solid #d0021b;
      transition: all 0.2s ease;
    }
    .criteria-list li:hover {
      background: #e9ecef;
      border-left-color: #a0011a;
    }
    .criteria-list li:before {
      content: "✓";
      position: absolute;
      left: 8px;
      color: #d0021b;
      font-weight: bold;
    }
    .hardcoded-content {
      color: #007bff !important;
      font-style: italic;
      font-weight: 500;
    }
    .story-header .hardcoded-content {
      color: #e2e8f0 !important;
    }
    .epic-title .hardcoded-content {
      color: #007bff !important;
    }
    .submit-btn {
      background-color: #d0021b;
      color: white;
      border: none;
      padding: 16px 32px;
      border-radius: 4px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 24px;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    .submit-btn:hover {
      background-color: #a0011a;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(208, 2, 27, 0.3);
    }
    .submit-btn:active {
      transform: translateY(0);
    }
    .hidden {
      display: none;
    }
    
    /* Responsive Design */
    @media (max-width: 1024px) {
      .main-container {
        margin: 15px;
        max-width: none;
      }
    }
    
    @media (max-width: 768px) {
      .main-container {
        margin: 10px;
        border-radius: 4px;
      }
      .content-container {
        padding: 20px;
      }
      .info-row {
        flex-direction: column;
        gap: 12px;
      }
      .info-item {
        width: 100%;
        justify-content: space-between;
      }
      .chat-btn {
        padding: 6px 12px;
        font-size: 11px;
      }
    }
    
    @media (max-width: 480px) {
      .main-container {
        margin: 5px;
      }
      .content-container {
        padding: 16px;
      }
      .epic-info-section {
        padding: 16px;
      }
      .section-header {
        padding: 12px 16px;
        font-size: 14px;
      }
      .section-content {
        padding: 16px;
      }
    }
    
    /* Story name section styling */
    .story-name-section {
      background: white;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    
    /* Multiple stories summary styling */
    .multiple-stories-summary {
      background: #f8f9fa;
      padding: 16px;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    
    .story-item {
      background: white !important;
      border-left: 3px solid #d0021b !important;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    
    .story-item:hover {
      transform: translateX(4px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- Top Navigation Bar -->
    <div class="top-bar">
      <button class="back-button" onclick="goBack()">
        &lt; Back
      </button>
      <span style="position: absolute; left: 50%; transform: translateX(-50%); font-weight: bold;">
        Jira ticket creation
      </span>
      <span style="position: absolute; right: 16px; top: 12px; font-size: 12px;">
        Use the 'Chat' interface to ask questions and edit outputs
      </span>
    </div>

    <!-- User Story Header -->
    <div class="story-header">
      {% if multiple_stories %}
        Multiple User Stories: {{ story_count }} stories selected
      {% else %}
        User story: {{ user_story_name or '<span class="hardcoded-content">Capture personal information during onboarding</span>' | safe }}
      {% endif %}
    </div>

    <!-- Main Content -->
    <div class="content-container">
    
    <!-- Error Message Display -->
    {% if error_message %}
    <div style="background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 16px; border-radius: 6px; margin-bottom: 20px;">
      <strong>⚠️ Error:</strong> {{ error_message }}
    </div>
    {% endif %}
    
    <!-- Success Message Display -->
    {% if success_message %}
    <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 16px; border-radius: 6px; margin-bottom: 20px;">
      <strong>✅ Success:</strong> {{ success_message }}
    </div>
    {% endif %}
    
    <!-- Epic Information Section -->
    <div class="epic-info-section">
      <div class="epic-label">Epic:</div>
      <div class="epic-title">{{ epic_title or '<span class="hardcoded-content">******</span>' | safe }}</div>

      <div class="info-row">
        <div class="info-item">
          <span class="info-label">Priority:</span>
          <span class="priority-high">{{ priority or '<span class="hardcoded-content">High</span>' | safe }}</span>
        </div>
        <div class="info-item">
          <span class="info-label">Responsible systems:</span>
          <span>{{ responsible_systems or '<span class="hardcoded-content">CAPS, CMS</span>' | safe }}</span>
        </div>
      </div>
    </div>

  
    <!-- Description Section -->
    <div class="section-container">
      <div class="section-header">
        <span>Description</span>
        <button class="chat-btn" onclick="openDescriptionChat()">
          <span>💬 Chat</span>
        </button>
      </div>
      <div class="section-content">
        {% if multiple_stories %}
          <!-- Multiple Stories Summary -->
          <div class="multiple-stories-summary">
            <h6>Selected Stories ({{ story_count }}):</h6>
            {% for story in stories %}
              <div class="story-item" style="margin-bottom: 12px; padding: 8px; border-left: 3px solid #dc3545; background: #f8f9fa;">
                <strong>{{ story.name }}</strong>
                <p style="margin: 4px 0; font-size: 14px; color: #666;">{{ story.description }}</p>
                <small style="color: #999;">Priority: {{ story.priority }} | System: {{ story.system }}</small>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <!-- Enhanced Description from User Description Agent -->
          <div class="enhanced-description">
            {{ user_story_description or '<span class="hardcoded-content">As a new borrower, I want to input my personal information (e.g., name, SSN) so that the system can accurately create my customer profile and initiate the onboarding process. This ensures that downstream verification steps (e.g. KYC, credit checks) can proceed without manual data correction or re-entry.</span>' | safe }}
          </div>
          
        {% endif %}
      </div>
    </div>

    <!-- Acceptance Criteria Section -->
    <div class="section-container">
      <div class="section-header">
        <span>Acceptance criteria</span>
        <button class="chat-btn" onclick="openAcceptanceCriteriaChat()">
          <span>💬 Chat</span>
        </button>
      </div>
      <div class="section-content">
        <ul class="criteria-list">
          {% if acceptance_criteria %}
            {% for criterion in acceptance_criteria %}
            <li>{{ criterion }}</li>
            {% endfor %}
          {% else %}
          <li><span class="hardcoded-content">System prompts for full name, date of birth, Social Security Number, email address, phone number, and residential address</span></li>
          <li><span class="hardcoded-content">Mandatory fields must be completed before progressing</span></li>
          <li><span class="hardcoded-content">Input formats are validated (e.g., MM/DD/YYYY for DOB, 9-digit SSN, phone with area code)</span></li>
          <li><span class="hardcoded-content">Errors are surfaced clearly and immediately for any missing or invalid entries</span></li>
          {% endif %}
        </ul>
      </div>
    </div>

    <!-- Tagged Requirements Section -->
    <div class="section-container tagged-requirements-section">
      <div class="section-header">
        <span>Tagged requirements</span>
        <button class="chat-btn" onclick="openRequirementsChat()">
          <span>💬 Chat</span>
        </button>
      </div>
      <div class="section-content">
        <ul class="requirements-list">
          {% if tagged_requirements %}
            {% for requirement in tagged_requirements %}
            <li>{{ requirement }}</li>
            {% endfor %}
          {% else %}
          <li><span class="hardcoded-content">TBD</span></li>

          {% endif %}
        </ul>
      </div>
    </div>

    <!-- Submit Button -->
    <button type="button" class="submit-btn" onclick="submitToJira()" id="jira-submit-btn">
      Submit & export to Jira
    </button>
    
    <!-- Data Validation Summary -->
    <div id="validation-summary" style="margin-top: 16px; padding: 12px; background: #f8f9fa; border-radius: 6px; border: 1px solid #ddd; display: none;">
      <h6 style="margin-bottom: 8px; color: #333;">📋 Submission Summary:</h6>
      <div id="validation-details" style="font-size: 14px; color: #666;"></div>
    </div>
    </div>
  </div>

  <!-- Hidden form with data for Jira submission -->
  <form id="jira-form" action="/submit-jira-ticket" method="POST" style="display: none;">
    <input type="hidden" name="epic_title" value="{{ epic_title or '' }}">
    <input type="hidden" name="user_story_name" value="{{ user_story_name or '' }}">
    <input type="hidden" name="user_story_description" value="{{ user_story_description or '' }}">
    <input type="hidden" name="priority" value="{{ priority or 'High' }}">
    <input type="hidden" name="responsible_systems" value="{{ responsible_systems or 'CAPS, CMS' }}">
    <input type="hidden" name="acceptance_criteria" value="{% if acceptance_criteria %}{{ acceptance_criteria|join('|||') }}{% else %}System prompts for full name, date of birth, Social Security Number, email address, phone number, and residential address|||Mandatory fields must be completed before progressing|||Input formats are validated (e.g., MM/DD/YYYY for DOB, 9-digit SSN, phone with area code)|||Errors are surfaced clearly and immediately for any missing or invalid entries{% endif %}">
    <input type="hidden" name="tagged_requirements" value="{% if tagged_requirements %}{{ tagged_requirements|join('|||') }}{% else %}TBD {% endif %}">
  </form>

<script>
  function goBack() {
    window.history.back();
  }

  function submitToJira() {
    console.log('Submitting to Jira...');
    
    // Show validation summary
    showValidationSummary();
    
    // Show loading state
    const submitBtn = document.querySelector('.submit-btn');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
      <span style="display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;"></span>
      Submitting to Jira...
    `;
    
    // Add CSS animation for spinner
    if (!document.getElementById('spinner-style')) {
      const style = document.createElement('style');
      style.id = 'spinner-style';
      style.textContent = `
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
      `;
      document.head.appendChild(style);
    }
    
    // Get form data and validate
    const form = document.getElementById('jira-form');
    const formData = new FormData(form);
    
    // Log form data for debugging
    console.log('Form data being submitted:');
    for (let [key, value] of formData.entries()) {
      console.log(`${key}: ${value}`);
    }
    
    // Validate required fields
    const userStoryName = formData.get('user_story_name');
    const userStoryDescription = formData.get('user_story_description');
    
    if (!userStoryName || userStoryName.trim() === '') {
      alert('Error: User story name is required');
      resetSubmitButton(submitBtn, originalText);
      return;
    }
    
    if (!userStoryDescription || userStoryDescription.trim() === '') {
      alert('Error: User story description is required');
      resetSubmitButton(submitBtn, originalText);
      return;
    }
    
    // Ask for final confirmation
    const confirmMessage = `You are about to create a Jira ticket with the following details:

📋 Story: ${userStoryName}
🎯 Epic: ${formData.get('epic_title') || 'N/A'}
⚡ Priority: ${formData.get('priority') || 'High'}
🔧 Systems: ${formData.get('responsible_systems') || 'N/A'}

Do you want to proceed?`;
    
    if (!confirm(confirmMessage)) {
      resetSubmitButton(submitBtn, originalText);
      return;
    }
    
    // Submit the form
    fetch('/submit-jira-ticket', {
      method: 'POST',
      body: formData
    })
    .then(response => {
      if (response.ok) {
        console.log('Jira submission successful');
        // Show success message briefly before redirect
        submitBtn.innerHTML = `
          <span style="margin-right: 8px;">✅</span>
          Success! Redirecting...
        `;
        
        // Redirect to the response page after a brief delay
        setTimeout(() => {
          return response.text().then(html => {
            document.open();
            document.write(html);
            document.close();
          });
        }, 1000);
      } else {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
    })
    .catch(error => {
      console.error('Error submitting to Jira:', error);
      alert(`Failed to submit to Jira: ${error.message}\n\nPlease check the console for more details and try again.`);
      resetSubmitButton(submitBtn, originalText);
    });
  }
  
  function showValidationSummary() {
    const form = document.getElementById('jira-form');
    const formData = new FormData(form);
    
    const summary = document.getElementById('validation-summary');
    const details = document.getElementById('validation-details');
    
    let html = '';
    html += `<strong>Story:</strong> ${formData.get('user_story_name') || 'Not provided'}<br>`;
    html += `<strong>Epic:</strong> ${formData.get('epic_title') || 'Not provided'}<br>`;
    html += `<strong>Priority:</strong> ${formData.get('priority') || 'High'}<br>`;
    html += `<strong>Systems:</strong> ${formData.get('responsible_systems') || 'Not provided'}<br>`;
    
    const acceptanceCriteria = formData.get('acceptance_criteria');
    const criteriaCount = acceptanceCriteria ? acceptanceCriteria.split('|||').filter(c => c.trim()).length : 0;
    html += `<strong>Acceptance Criteria:</strong> ${criteriaCount} items<br>`;
    
    const requirements = formData.get('tagged_requirements');
    const reqCount = requirements ? requirements.split('|||').filter(r => r.trim()).length : 0;
    html += `<strong>Tagged Requirements:</strong> ${reqCount} items`;
    
    details.innerHTML = html;
    summary.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
      summary.style.display = 'none';
    }, 5000);
  }
  
  function resetSubmitButton(button, originalText) {
    button.disabled = false;
    button.innerHTML = originalText;
  }

  function openDescriptionChat() {
    alert('Description chat functionality will be implemented soon');
  }

  function openAcceptanceCriteriaChat() {
    alert('Acceptance criteria chat functionality will be implemented soon');
  }

  function openRequirementsChat() {
    alert('Requirements chat functionality will be implemented soon');
  }
  
  // Save user story data to localStorage for persistence
  function saveUserStoryData() {
    const data = {
      epic_title: document.querySelector('input[name="epic_title"]').value,
      user_story_name: document.querySelector('input[name="user_story_name"]').value,
      user_story_description: document.querySelector('input[name="user_story_description"]').value,
      priority: document.querySelector('input[name="priority"]').value,
      responsible_systems: document.querySelector('input[name="responsible_systems"]').value,
      acceptance_criteria: document.querySelector('input[name="acceptance_criteria"]').value,
      tagged_requirements: document.querySelector('input[name="tagged_requirements"]').value,
      timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('current_user_story', JSON.stringify(data));
    console.log('User story data saved to localStorage');
  }
  
  // Auto-save data when form changes
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('jira-form');
    if (form) {
      // Save data every 30 seconds
      setInterval(saveUserStoryData, 30000);
      
      // Save data when user leaves the page
      window.addEventListener('beforeunload', saveUserStoryData);
    }
    
    // Log current form data for debugging
    console.log('Page loaded. Current form data:');
    const formData = new FormData(document.getElementById('jira-form'));
    for (let [key, value] of formData.entries()) {
      console.log(`${key}: ${value}`);
    }
    
    // Add debug button (remove in production)
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      addDebugButton();
    }
  });
  
  function addDebugButton() {
    const debugBtn = document.createElement('button');
    debugBtn.textContent = '🐛 Debug Info';
    debugBtn.style.cssText = `
      position: fixed; top: 10px; right: 10px; z-index: 9999;
      background: #007bff; color: white; border: none; padding: 8px 12px;
      border-radius: 4px; font-size: 12px; cursor: pointer;
    `;
    debugBtn.onclick = function() {
      const formData = new FormData(document.getElementById('jira-form'));
      let debugInfo = 'Form Data:\n';
      for (let [key, value] of formData.entries()) {
        debugInfo += `${key}: ${value}\n`;
      }
      debugInfo += `\nURL: ${window.location.href}`;
      debugInfo += `\nTimestamp: ${new Date().toISOString()}`;
      
      // Copy to clipboard and show alert
      navigator.clipboard.writeText(debugInfo).then(() => {
        alert('Debug info copied to clipboard!\n\n' + debugInfo);
      });
    };
    document.body.appendChild(debugBtn);
  }
</script>
</body>
</html>
