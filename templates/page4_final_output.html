<!--
  page4_final_output.html

  This HTML template renders the final PRD (Product Requirements Document) draft output page for a web application.
  It is designed with Bootstrap 5 and custom CSS for a modern, clean look, and supports dynamic rendering of markdown content.

  Key Features:
  - Responsive layout with a styled container and card for displaying PRD sections.
  - Header section includes navigation ("Back to Requirements"), page title, and a "Download as Word" button.
  - Each PRD section (Product Overview, Feature Overview, Requirements, etc.) is rendered dynamically if content is present.
  - Markdown content is rendered client-side using the "marked" library for rich formatting.
  - Download functionality: Users can export the PRD as a Word (.docx) document via an API call to /generate_word_doc.
  - Enhanced error handling: User-friendly alerts are shown for download errors, with auto-dismiss and console logging.
  - Custom scrollbar and typography for improved readability and aesthetics.
  - Accessibility and usability improvements, including loading indicators and disabled states for buttons.

  Template Variables:
  - outputs: A dictionary containing markdown content for each PRD section, passed from the backend.

  JavaScript:
  - Renders markdown content into each section on DOMContentLoaded.
  - Handles the download process, including API communication, error handling, and UI feedback.
  - Utility functions for error display and content collection.

  Usage:
  - Used as the final step in a PRD generation workflow, allowing users to review and export their document.

  Dependencies:
  - Bootstrap 5, Bootstrap Icons, marked.js, FileSaver.js, docx.js

  Author: [Your Name or Team]
  Date: [Date]
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>PRD Draft Output</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  <!-- Remove duplicate script references -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/6.1.0/docx.min.js"></script>
  <script src="{{ url_for('static', filename='js/global.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- ... rest of head content ... -->

  <style>
    :root {
      --primary-red: #dc3545;
      --primary-red-dark: #c82333;
      --primary-grey: #343a40;
      --secondary-grey: #6c757d;
      --light-grey: #f8f9fa;
      --gradient-red: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      --gradient-grey: linear-gradient(135deg, #343a40 0%, #495057 100%);
      --card-shadow: 0 8px 24px rgba(220, 53, 69, 0.12);
      --border-radius: 0.75rem;
      --transition-speed: 0.3s;
    }

    body {
      background: linear-gradient(135deg, #38393a 0%, #403f41 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      padding: 2rem 1rem;
    }

.container {
      max-width: 1200px;
      width: 90vw;
      margin: 2rem auto;
      padding: 0;
    }

    .card {
      background: rgba(255, 255, 255, 0.98);
      border: none;
      border-radius: var(--border-radius);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .header-box {
      background: linear-gradient(to right, #ffffff, #f8f9fa);
      border-bottom: 1px solid rgba(0,0,0,0.08);
      padding: 1.5rem 2rem;
      margin-bottom: 2rem;
    }

    .card-body {
      padding: 2rem;
    }

    .section-title {
      color: #2e5cb8;
      font-size: 1.5rem;
      font-weight: 600;
      padding-bottom: 0.75rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid rgba(46, 92, 184, 0.1);
    }

    .formatted-content {
      background: #ffffff;
      padding: 1.5rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(0, 0, 0, 0.08);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.03);
      margin-bottom: 2rem;
      font-size: 1rem;
      line-height: 1.8;
      min-height: 200px;
      max-height: 500px;
      overflow-y: auto;
    }

    .formatted-content h1,
    .formatted-content h2 {
      color: #2e5cb8;
      margin-top: 1.5rem;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .formatted-content ul {
      padding-left: 1.5rem;
      margin-bottom: 1rem;
    }

    .formatted-content li {
      margin-bottom: 0.5rem;
    }

    .btn-download {
      background: var(--danger-gradient);
      color: rgb(218, 30, 30);
      border: none;
      padding: 0.75rem 2rem;
      font-weight: 600;
      border-radius: 0.75rem;
      transition: all var(--transition-speed) ease;
    }

    .btn-download:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
    }

    .btn-back {
      position: relative;
      padding-left: 2rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn-back::before {
      content: "←";
      position: absolute;
      left: 1rem;
      transition: transform 0.2s ease;
    }

    .btn-back:hover::before {
      transform: translateX(-3px);
    }

    #loadingSpinner {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-top: 1rem;
      box-shadow: var(--card-shadow);
      font-weight: 500;
    }

    /* Improved scrollbar styling */
    .formatted-content::-webkit-scrollbar {
      width: 8px;
    }

    .formatted-content::-webkit-scrollbar-track {
      background: #f8f9fa;
      border-radius: 4px;
    }

    .formatted-content::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 4px;
    }

    .formatted-content::-webkit-scrollbar-thumb:hover {
      background: #a0aec0;
    }

    h5.text-primary {
      background-color: #f0f0f0;
      /* Light gray background */
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      margin-top: 2rem;
      border-left: 5px solid #dc3545;
      /* Changed from #0d6efd to Bootstrap's danger red */
      color: #dc3545;
      /* Added to make the text red as well */
    }

    .formatted-content {
      background: #ffffff;
      padding: 1.5rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(0, 0, 0, 0.08);
      margin-bottom: 1rem;
      font-size: 1rem;
      line-height: 1.6;
    }

    .formatted-content ul {
      list-style-type: none;
      padding-left: 0;
    }

    .formatted-content li {
      position: relative;
      padding-left: 1.5rem;
      margin-bottom: 0.75rem;
    }

    .formatted-content li::before {
      content: "•";
      color: #2e5cb8;
      position: absolute;
      left: 0;
      font-weight: bold;
    }

     .text-primary {
      color: #2e5cb8 !important;
      font-size: 1.75rem;
      letter-spacing: -0.02em;
    }

    .formatted-content {
      background: #ffffff;
      padding: 2rem;
      border-radius: 1rem;
      border: 1px solid rgba(0, 0, 0, 0.06);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
      margin-bottom: 2rem;
      font-size: 1.05rem;
      line-height: 1.8;
      color: #2c3e50;
    }

    .formatted-content h1,
    .formatted-content h2 {
      color: #2e5cb8;
      font-size: 1.5rem;
      font-weight: 600;
      margin: 2rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid rgba(46, 92, 184, 0.1);
    }

    .border-bottom {
      border-bottom: 2px solid rgba(46, 92, 184, 0.1) !important;
    }

    /* Update responsive styles */
    @media (max-width: 992px) {
      .container {
        max-width: 95%;
        /* Slightly wider on mobile */
        padding: 1rem;
      }
    }

    /* Add to your existing styles */
    .alert {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-width: 90%;
      width: 500px;
    }

    .btn-download:disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }

    #docContent {
      max-width: 100%;
      margin: 2rem auto;
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
    }

    .header-box {
      background: #ffffff;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
    }
  </style>
</head>

<body class="bg-light">
  <div class="container my-5">
    <div class="header-box d-flex justify-content-between align-items-center mb-4 px-4 py-3 rounded shadow-sm">
      <a href="/page3" class="btn btn-light btn-back border">Back to Requirements</a>
      <h3 class="m-0 text-primary fw-semibold">Final PRD Draft</h3>
      <button type="button" class="btn btn-download" onclick="downloadDoc()">
        <i class="bi bi-file-earmark-word me-2"></i>Download as Word
      </button>
    </div>

    <!-- Replace the existing card-body content with this -->
    <div class="card shadow-sm" id="docContent">
      <div class="card-body">
        {% for key, title in {
        'product_overview': 'Product Overview',
        'feature_overview': 'Feature Overview',
        'agent_4_1': 'Product Requirements / User Stories',
        'agent_4_2': 'Functional Requirements',
        'agent_4_3': 'Non-Functional Requirements',
        'agent_4_4': 'Data Requirements',
        'agent_4_5': 'Legal, Regulatory, and Compliance Requirements'
        }.items() %}
        {% if outputs[key] %}
        <section class="mb-4">
          <h4 class="text-primary border-bottom pb-2">{{ title }}</h4>
          <div class="formatted-content bg-white px-3 py-2 border rounded" id="{{ key }}_render"></div>
          <input type="hidden" id="{{ key }}_input" value="{{ outputs[key] | tojson | safe }}"
            data-raw="{{ outputs[key] }}">
        </section>
        {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
  <script>

    document.addEventListener('DOMContentLoaded', function () {
      // Set up markdown options
      marked.setOptions({
        breaks: true,
        gfm: true
      });

      // Render all sections
      document.querySelectorAll('[id$="_input"]').forEach(input => {
        const key = input.id.replace('_input', '');
        const renderDiv = document.getElementById(`${key}_render`);
        if (input && renderDiv) {
          const content = input.getAttribute('data-raw');
          if (content) {
            renderDiv.innerHTML = marked.parse(content);
          }
        }
      });
    });


    // ...existing script content...
    function showLoading() {
      const spinner = document.getElementById('loadingSpinner');
      if (spinner) spinner.style.display = 'flex';
      let seconds = 0;
      const label = document.getElementById('loadingTimer');
      window.loadingInterval = setInterval(() => {
        seconds++;
        if (label) label.textContent = `⏳ ${seconds}s`;
      }, 1000);
    }


    async function downloadDoc() {
      const downloadBtn = document.querySelector('.btn-download');
      const originalText = downloadBtn.innerHTML;
      const startTime = new Date();

      try {
        console.log('[Download] Starting document generation...');

        // Show loading state
        downloadBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            Generating document...
        `;
        downloadBtn.disabled = true;

        // Get all content and log its presence
        const sections = getAllContent();
        console.log('[Download] Sections collected:', Object.keys(sections));

        // Make the API call
        console.log('[Download] Sending request to /generate_word_doc');
        const response = await fetch('/generate_word_doc', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ sections })
        });

        // Log response status
        console.log('[Download] Response status:', response.status);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('[Download] Server error:', errorText);
          throw new Error(`Server error: ${response.status} - ${errorText}`);
        }

        // Get and validate blob
        const blob = await response.blob();
        console.log('[Download] Blob received, size:', blob.size, 'bytes');

        if (blob.size === 0) {
          throw new Error('Generated document is empty');
        }

        // Create and trigger download
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `PRD_Document_${new Date().toISOString().split('T')[0]}.docx`;
        document.body.appendChild(a);
        a.click();

        // Log success
        const endTime = new Date();
        const duration = (endTime - startTime) / 1000;
        console.log(`[Download] Document generated successfully in ${duration} seconds`);

        // Cleanup
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

      } catch (error) {
        console.error('[Download] Error details:', {
          message: error.message,
          stack: error.stack,
          timestamp: new Date().toISOString()
        });

        showError(`Failed to generate document: ${error.message}. Check browser console for details.`);
      } finally {
        // Reset button state
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
      }
    }

    // Enhanced error display
    function showError(message) {
      console.error('[Error]', message);

      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
      alertDiv.style.zIndex = '1050';
      alertDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>
                <strong>Error!</strong> ${message}<br>
                <small class="text-muted">Check browser console (F12) for detailed logs</small>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

      document.body.appendChild(alertDiv);

      // Auto-dismiss after 8 seconds
      setTimeout(() => {
        if (document.body.contains(alertDiv)) {
          alertDiv.remove();
        }
      }, 8000);
    }

    function getAllContent() {
      const sections = {};
      const sectionIds = [
        'product_overview',
        'feature_overview',
        'agent_4_1',
        'agent_4_2',
        'agent_4_3',
        'agent_4_4',
        'agent_4_5'
      ];

      sectionIds.forEach(id => {
        const input = document.getElementById(`${id}_input`);
        if (input) {
          sections[id] = input.getAttribute('data-raw') || '';
        }
      });

      return sections;
    }

    function showError(message) {
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-danger alert-dismissible fade show';
      alertDiv.innerHTML = `
        <strong>Error!</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

      document.querySelector('.container').insertBefore(
        alertDiv,
        document.querySelector('.card')
      );

      // Auto-dismiss after 5 seconds
      setTimeout(() => {
        alertDiv.remove();
      }, 5000);
    }

  </script>
</body>

</html>