<!--
  page4_final_output.html

  This HTML template renders the final PRD (Product Requirements Document) draft output page for a web application.
  It is designed with Bootstrap 5 and custom CSS for a modern, clean look, and supports dynamic rendering of markdown content.

  Key Features:
  - Responsive layout with a styled container and card for displaying PRD sections.
  - Header section includes navigation ("Back to Requirements"), page title, and a "Download as Word" button.
  - Each PRD section (Product Overview, Feature Overview, Requirements, etc.) is rendered dynamically if content is present.
  - Markdown content is rendered client-side using the "marked" library for rich formatting.
  - Download functionality: Users can export the PRD as a Word (.docx) document via an API call to /generate_word_doc.
  - Enhanced error handling: User-friendly alerts are shown for download errors, with auto-dismiss and console logging.
  - Custom scrollbar and typography for improved readability and aesthetics.
  - Accessibility and usability improvements, including loading indicators and disabled states for buttons.

  Template Variables:
  - outputs: A dictionary containing markdown content for each PRD section, passed from the backend.

  JavaScript:
  - Renders markdown content into each section on DOMContentLoaded.
  - Handles the download process, including API communication, error handling, and UI feedback.
  - Utility functions for error display and content collection.

  Usage:
  - Used as the final step in a PRD generation workflow, allowing users to review and export their document.

  Dependencies:
  - Bootstrap 5, Bootstrap Icons, marked.js, FileSaver.js, docx.js

  Author: [Your Name or Team]
  Date: [Date]
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>PRD Draft Output</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  <!-- Remove duplicate script references -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/6.1.0/docx.min.js"></script>
  <script src="{{ url_for('static', filename='js/global.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- ... rest of head content ... -->

  <style>
    :root {
      --primary-red: #dc3545;
      --primary-red-dark: #c82333;
      --primary-grey: #343a40;
      --secondary-grey: #6c757d;
      --light-grey: #f8f9fa;
      --gradient-red: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      --gradient-grey: linear-gradient(135deg, #343a40 0%, #495057 100%);
      --card-shadow: 0 8px 24px rgba(220, 53, 69, 0.12);
      --border-radius: 0.75rem;
      --transition-speed: 0.3s;
    }

    .section-title {
      background: linear-gradient(to right, #f8f9fa, #ffffff);
      padding: 0.75rem 1rem;
      border-left: 6px solid #dc3545;
      border-radius: 0.5rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      font-size: 1.25rem;
      color: #2c3e50;
    }

    body {
      background-color: #343a40 !important;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      padding: 2rem 1rem;
    }

    .container {
      max-width: 1800px;
      width: 98vw;
      margin: 2rem auto;
      padding: 0;
    }

    .card {
      background: rgba(255, 255, 255, 0.98);
      border: none;
      border-radius: var(--border-radius);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .header-box {
      background: linear-gradient(to right, #ffffff, #f8f9fa);
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      padding: 1.5rem 2rem;
      margin-bottom: 2rem;
    }

    .card-body {
      padding: 2rem;
    }

    .section-title {
      color: #2e5cb8;
      font-size: 1.5rem;
      font-weight: 600;
      padding-bottom: 0.75rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid rgba(46, 92, 184, 0.1);
    }

    .formatted-content {
      background: #ffffff;
      padding: 1.5rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(0, 0, 0, 0.08);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.03);
      margin-bottom: 2rem;
      font-size: 1rem;
      line-height: 1.8;
      min-height: 200px;
      max-height: 500px;
      overflow-y: auto;
    }

    .formatted-content h1,
    .formatted-content h2 {
      color: #2e5cb8;
      margin-top: 1.5rem;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .formatted-content ul {
      padding-left: 1.5rem;
      margin-bottom: 1rem;
    }

    .formatted-content li {
      margin-bottom: 0.5rem;
    }

    .btn-download {
      background: var(--danger-gradient);
      color: rgb(218, 30, 30);
      border: none;
      padding: 0.75rem 2rem;
      font-weight: 600;
      border-radius: 0.75rem;
      transition: all var(--transition-speed) ease;
    }

    .btn-download:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
    }

    .btn-back {
      position: relative;
      padding-left: 2rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn-back::before {
      content: "←";
      position: absolute;
      left: 1rem;
      transition: transform 0.2s ease;
    }

    .btn-back:hover::before {
      transform: translateX(-3px);
    }

    #loadingSpinner {
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-top: 1rem;
      box-shadow: var(--card-shadow);
      font-weight: 500;
    }

    /* Improved scrollbar styling */
    .formatted-content::-webkit-scrollbar {
      width: 8px;
    }

    .formatted-content::-webkit-scrollbar-track {
      background: #f8f9fa;
      border-radius: 4px;
    }

    .formatted-content::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 4px;
    }

    .formatted-content::-webkit-scrollbar-thumb:hover {
      background: #a0aec0;
    }

    h5.text-primary {
      background-color: #f0f0f0;
      /* Light gray background */
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      margin-top: 2rem;
      border-left: 5px solid #dc3545;
      /* Changed from #0d6efd to Bootstrap's danger red */
      color: #dc3545;
      /* Added to make the text red as well */
    }

    .formatted-content {
      background: #ffffff;
      padding: 1.5rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(0, 0, 0, 0.08);
      margin-bottom: 1rem;
      font-size: 1rem;
      line-height: 1.6;
    }

    .formatted-content ul {
      list-style-type: none;
      padding-left: 0;
    }

    .formatted-content li {
      position: relative;
      padding-left: 1.5rem;
      margin-bottom: 0.75rem;
    }

    .formatted-content li::before {
      content: "•";
      color: #2e5cb8;
      position: absolute;
      left: 0;
      font-weight: bold;
    }

    .text-primary {
      color: #2e5cb8 !important;
      font-size: 1.75rem;
      letter-spacing: -0.02em;
    }

    .formatted-content {
      background: #ffffff;
      padding: 2rem;
      border-radius: 1rem;
      border: 1px solid rgba(0, 0, 0, 0.06);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03);
      margin-bottom: 2rem;
      font-size: 1.05rem;
      line-height: 1.8;
      color: #2c3e50;
    }

    .formatted-content h1,
    .formatted-content h2 {
      color: #2e5cb8;
      font-size: 1.5rem;
      font-weight: 600;
      margin: 2rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid rgba(46, 92, 184, 0.1);
    }

    .border-bottom {
      border-bottom: 2px solid rgba(46, 92, 184, 0.1) !important;
    }

    /* Update responsive styles */
    @media (max-width: 992px) {
      .container {
        max-width: 95%;
        /* Slightly wider on mobile */
        padding: 1rem;
      }
    }

    /* Add to your existing styles */
    .alert {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      max-width: 90%;
      width: 500px;
    }

    .btn-download:disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }

    #docContent {
      max-width: 100%;
      margin: 2rem auto;
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
    }

    .header-box {
      background: #ffffff;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
    }

    .nav-tabs .nav-link.active {
      background-color: #e9ecef;
      font-weight: 600;
    }

    .tab-pane {
      background-color: #fff;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-top: 0.5rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    .input-group {
      margin-top: 0.75rem;
    }

    .input-group .form-control {
      border-top-left-radius: 0.5rem;
      border-bottom-left-radius: 0.5rem;
    }

    .input-group .btn {
      border-top-right-radius: 0.5rem;
      border-bottom-right-radius: 0.5rem;
    }

    .btn-danger:hover {
      background-color: #bb2d3b;
      color: #fff;
    }

    .chatbox-message {
      margin-bottom: 0.5rem;
    }

    .chatbox-message strong {
      display: block;
      font-weight: 600;
      color: #2e5cb8;
    }

    .chatbox-message.user {
      background: #f1f3f5;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
    }

    .chatbox-message.agent {
      background: #e8f0fe;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
    }

    .tab-pane .chatbox-message {
      margin-bottom: 0.75rem;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .tab-pane .chatbox-message.user {
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
    }

    .tab-pane .chatbox-message.agent {
      background-color: #d1e7dd;
      border-left: 4px solid #198754;
    }

    #mainContent {
      transition: margin-left 0.3s ease-in-out;
    }

    .chat-panel {
      position: fixed;
      top: 80px;
      left: 20px;
      width: 280px;
      max-height: 90vh;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      z-index: 1050;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid #e2e8f0;
      font-family: 'Segoe UI', sans-serif;
    }

    .chat-header {
      background: #1e293b;
      color: #f8fafc;
      padding: 12px 16px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-header .close-btn {
      background: none;
      border: none;
      color: #cbd5e1;
      font-size: 16px;
      cursor: pointer;
    }

    .chat-body {
      padding: 12px;
      overflow-y: auto;
      flex-grow: 1;
      font-size: 14px;
      color: #334155;
    }

    .chat-footer {
      padding: 10px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 6px;
    }

    .chat-footer input {
      flex-grow: 1;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      padding: 6px 10px;
    }

    .chat-footer button {
      background-color: #ef4444;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease-in-out;
    }

    .chat-footer button:hover {
      background-color: #dc2626;
    }

    /* Legacy citation highlighting */
    .legacy-cited-line {
      position: relative;
    }
    .legacy-citation-text {
      font-style: italic;
      color: #6c757d;
    }
    .legacy-citation-badge {
      margin-left: 0.5rem;
      font-size: 0.75rem;
      vertical-align: middle;
    }
  </style>
</head>

<body style="background-color: #343a40;">
  <div id="reviewLoadingOverlay"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background-color: rgba(255,255,255,0.8); z-index: 2000; display: none; align-items: center; justify-content: center;">
    <div class="text-center">
      <div class="spinner-border text-danger" role="status"></div>
      <p class="mt-2 fw-semibold text-danger">Reviewing PRD... please wait</p>
    </div>
  </div>
  <!-- Final PRD Draft Header -->
  
  <div id="mainContent" style="margin-top: 0;">
  <script>
  // Returns ?vectorDbLink=... if available, else empty string
  function getVectorDbQuery() {
    var link = '';
    var el = document.getElementById('vectorDbPrdLink');
    if (el && el.href && el.href.startsWith('http')) {
      return '?vectorDbLink=' + encodeURIComponent(el.href);
    }
    return '';
  }

  // Attach click handler to Backlog management button to pass vector DB link
  document.addEventListener('DOMContentLoaded', function () {
    var backlogBtn = document.getElementById('backlogMgmtBtn');
    if (backlogBtn) {
      backlogBtn.onclick = function () {
        var url = 'http://127.0.0.1:5002/tabbed-layout' + getVectorDbQuery();
        window.open(url, '_blank');
      };
    }
  });
  </script>
    <div class="container my-5">
      <!-- Page 4 Chat Panel -->
      <div id="chatPanel"
        style="display: none; position: fixed; top: 0; left: 0; width: 340px; height: 100vh; background: #ffffff; border-right: 1px solid #dee2e6; box-shadow: 4px 0 12px rgba(0,0,0,0.1); padding: 1rem 1rem 0.5rem; overflow-y: auto; z-index: 1050;">
        <div class="d-flex align-items-center justify-content-between bg-dark text-white px-3 py-2 rounded mb-3">
          <h6 class="mb-0 fw-semibold">
            <i class="bi bi-person-workspace me-2"></i>
            Chat Context: <span id="chatContextName">—</span>
          </h6>
          <button class="btn btn-sm btn-outline-light"
            onclick="document.getElementById('chatPanel').style.display='none'; document.getElementById('mainContent').style.marginLeft='0';">
            ✖ Close
          </button>
        </div>
        <!-- CHAT TAB HEADERS -->
        {% set agent_titles = {
        'agent_4_2': 'Functional Requirements',
        'agent_4_3': 'Non-Functional Requirements',
        'agent_4_4': 'Data Requirements',
        'agent_4_5': 'Legal, Regulatory, and Compliance Requirements'
        } %}

        <ul class="nav nav-tabs mb-3" id="chatTab" role="tablist">
          {% for agent_id, title in agent_titles.items() %}
          <li class="nav-item" role="presentation">
            <button class="nav-link {% if loop.first %}active{% endif %}" id="{{ agent_id }}-tab" data-bs-toggle="tab"
              data-bs-target="#{{ agent_id }}-chat" type="button" role="tab" aria-controls="{{ agent_id }}-chat"
              aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
              {{ title }}
            </button>
          </li>
          {% endfor %}
        </ul>

        <!-- CHAT TAB CONTENT -->
        <div class="tab-content">
          {% for agent_id, title in agent_titles.items() %}
          <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="{{ agent_id }}-chat" role="tabpanel"
            aria-labelledby="{{ agent_id }}-tab">
            <div id="{{ agent_id }}_chatbox" class="mb-2" style="height: 250px; overflow-y: auto; font-size: 0.9rem;">
            </div>
            <div class="input-group">
              <input type="text" id="{{ agent_id }}_message" class="form-control" placeholder="Ask about {{ title }}">
              <button class="btn btn-danger send-btn" data-agent-id="{{ agent_id }}">Send</button>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      <div class="header-box d-flex justify-content-between align-items-center mb-4 px-4 py-3 rounded shadow-sm">
        <a href="/page3" class="btn btn-light btn-back border">Back to Requirements</a>
        <h3 class="m-0 text-primary fw-semibold">Final PRD Draft</h3>
        <button id="downloadButton" class="btn btn-primary">📥 Download as Word</button>
        <button id="reviewButton" class="btn btn-warning ms-3">🧪 Review PRD</button>

      </div>
      <!-- Legend for legacy code citations -->
      <div class="d-flex justify-content-end mb-3">
        <span class="badge rounded-pill text-bg-secondary" title="Indicates lines informed directly by uploaded legacy artifacts">
          <i class="bi bi-info-circle me-1"></i> “Source: Legacy Code” = derived from legacy artifacts
        </span>
      </div>
      <div class="d-flex justify-content-end mb-3">

        <button  onclick="window.open('http://127.0.0.1:5001/page1','_blank')" title="Reverse engineer legacy code and mine internal docs and research to identify high-level requirements"
          class="btn btn-primary">
          <i class="fas fa-file-alt" style="margin-right: 0.5rem;"></i>
          Requirements insights
        </button>
        <div style="width: 0.5rem;"></div>
        <button id="backlogMgmtBtn" title="Convert business objectives and detailed requirements into user stories with clear acceptance criteria"
          class="btn btn-warning ms-3">
          <i class="fas fa-cogs" style="margin-right: 0.5rem;"></i>
          Backlog management
        </button>

        <div style="width: 2rem;"></div>
        <div class="btn-group" role="group" aria-label="Expand/Collapse All">
          <button class="btn btn-sm btn-outline-primary me-2" onclick="expandAll()">Expand - All</button>
          <div style="width: 0.5rem;"></div>
          <button class="btn btn-sm btn-outline-secondary" onclick="collapseAll()">Collapse All</button>
        </div>
      </div>
      <!-- Replace the existing card-body content with this -->
      <div class="card shadow-sm" id="docContent">
        <div class="card-body">
          {% for key, title in {
          'product_overview': 'Product Overview',
          'feature_overview': 'Feature Overview',
          'agent_4_2': 'Functional Requirements',
          'agent_4_3': 'Non-Functional Requirements',
          'agent_4_4': 'Data Requirements',
          'agent_4_5': 'Legal, Regulatory, and Compliance Requirements'
          }.items() %}
          {% if outputs[key] %}

          <section class="mb-3">
            <div class="d-flex justify-content-between align-items-center bg-dark text-white px-3 py-2 rounded-top">
              <div class="card-header bg-dark text-white flex-grow-1" role="button" data-bs-toggle="collapse"
                data-bs-target="#collapse_{{ key }}" aria-expanded="false" aria-controls="collapse_{{ key }}">
                <strong><i class="bi bi-chevron-down me-2"></i> {{ title }}</strong>
              </div>
              {% if key.startswith('agent_4_') %}
              <button type="button" class="btn btn-warning btn-sm ms-2" onclick="toggleChatPanel('{{ key }}')">💬
                Chat</button>
              {% endif %}
            </div>
            <div id="collapse_{{ key }}" class="collapse prd-section-collapse">
              <div class="formatted-content bg-white px-3 py-2 border rounded" id="{{ key }}_render"></div>
              <input type="hidden" id="{{ key }}_input" value="{{ outputs[key] | tojson | safe }}"
                data-raw="{{ outputs[key] }}">
            </div>
          </section>
          {% endif %}
          {% endfor %}
        </div>
      </div>
    <!-- Vector DB Upload Section -->
    <div class="card mt-4">
      <div class="card-body">
        <h5 class="card-title">Upload PRD to Vector DB</h5>
        <button class="btn btn-success" id="uploadToVectorDbBtn">Upload PRD to Vector DB</button>
        <div id="vectorDbLinkContainer" class="mt-3" style="display:none;">
          <span class="fw-bold">Vector DB Link:</span>
          <a id="vectorDbPrdLink" href="#" target="_blank"></a>
        </div>
      </div>
    </div>
    </div>
  </div>
  <script>
    // Upload PRD to Vector DB and show link
    document.addEventListener('DOMContentLoaded', function () {
      const uploadBtn = document.getElementById('uploadToVectorDbBtn');
      if (uploadBtn) {
        uploadBtn.addEventListener('click', function () {
          uploadBtn.disabled = true;
          uploadBtn.textContent = 'Uploading...';
          fetch('/api/upload-prd-to-vector-db', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
              if (data.success && data.link) {
                document.getElementById('vectorDbLinkContainer').style.display = 'block';
                const linkEl = document.getElementById('vectorDbPrdLink');
                linkEl.href = data.link;
                linkEl.textContent = data.link;
                uploadBtn.textContent = 'Uploaded!';
              } else {
                uploadBtn.textContent = 'Upload Failed';
              }
            })
            .catch(() => {
              uploadBtn.textContent = 'Upload Failed';
            });
        });
      }
    });
    function toggleReviewOverlay(show) {
      const overlay = document.getElementById("reviewLoadingOverlay");
      if (overlay) {
        overlay.style.display = show ? "flex" : "none";
      }
    }
    document.addEventListener('DOMContentLoaded', function () {
      // Attach download and review button listeners
      document.querySelector('#downloadButton')?.addEventListener('click', downloadDoc);
      document.querySelector('#reviewButton')?.addEventListener('click', triggerPRDReview);

      // Set up markdown options
      marked.setOptions({
        breaks: true,
        gfm: true
      });
      // Render markdown for all PRD sections
      document.querySelectorAll('[id$="_input"]').forEach(input => {
        const key = input.id.replace('_input', '');
        const renderDiv = document.getElementById(`${key}_render`);
        if (input && renderDiv) {
          const content = input.getAttribute('data-raw');
          if (content) {
            renderDiv.innerHTML = marked.parse(content);
            highlightLegacyCitations(renderDiv);
          }
        }
      });

      // Collapse/expand icon toggle logic
      document.querySelectorAll('.card-header[data-bs-toggle="collapse"]').forEach(header => {
        const icon = header.querySelector('i.bi');
        const targetId = header.getAttribute('data-bs-target');
        const target = document.querySelector(targetId);

        target.addEventListener('shown.bs.collapse', () => {
          icon.classList.remove('bi-chevron-down');
          icon.classList.add('bi-chevron-up');
        });

        target.addEventListener('hidden.bs.collapse', () => {
          icon.classList.remove('bi-chevron-up');
          icon.classList.add('bi-chevron-down');
        });
      });




      // ...existing script content...
      function showLoading() {
        const spinner = document.getElementById('loadingSpinner');
        if (spinner) spinner.style.display = 'flex';
        let seconds = 0;
        const label = document.getElementById('loadingTimer');
        window.loadingInterval = setInterval(() => {
          seconds++;
          if (label) label.textContent = `⏳ ${seconds}s`;
        }, 1000);
      }


      async function downloadDoc() {
        const downloadBtn = document.getElementById('downloadButton');
        const originalText = downloadBtn.innerHTML;
        const startTime = new Date();

        try {
          console.log('[Download] Starting document generation...');

          // Show loading state
          downloadBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            Generating document...
        `;
          downloadBtn.disabled = true;

          // Get all content and log its presence
          const sections = getAllContent();
          console.log('[Download] Sections collected:', Object.keys(sections));

          // Make the API call
          console.log('[Download] Sending request to /generate_word_doc');
          const response = await fetch('/generate_word_doc', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ sections })
          });

          // Log response status
          console.log('[Download] Response status:', response.status);

          if (!response.ok) {
            const errorText = await response.text();
            console.error('[Download] Server error:', errorText);
            throw new Error(`Server error: ${response.status} - ${errorText}`);
          }

          // Get and validate blob
          const blob = await response.blob();
          console.log('[Download] Blob received, size:', blob.size, 'bytes');

          if (blob.size === 0) {
            throw new Error('Generated document is empty');
          }

          // Create and trigger download
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `PRD_Document_${new Date().toISOString().split('T')[0]}.docx`;
          document.body.appendChild(a);
          a.click();

          // Log success
          const endTime = new Date();
          const duration = (endTime - startTime) / 1000;
          console.log(`[Download] Document generated successfully in ${duration} seconds`);

          // Cleanup
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

        } catch (error) {
          console.error('[Download] Error details:', {
            message: error.message,
            stack: error.stack,
            timestamp: new Date().toISOString()
          });

          showError(`Failed to generate document: ${error.message}. Check browser console for details.`);
        } finally {
          // Reset button state
          downloadBtn.innerHTML = originalText;
          downloadBtn.disabled = false;
        }
      }


      function getAllContent() {
        const sections = {};
        const sectionIds = [
          'product_overview',
          'feature_overview',
          'agent_4_2',
          'agent_4_3',
          'agent_4_4',
          'agent_4_5'
        ];

        sectionIds.forEach(id => {
          const input = document.getElementById(`${id}_input`);
          if (input) {
            sections[id] = input.getAttribute('data-raw') || '';
          }
        });

        return sections;
      }

      function showError(message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
        <strong>Error!</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        document.querySelector('.container').insertBefore(
          alertDiv,
          document.querySelector('.card')
        );

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
          alertDiv.remove();
        }, 5000);
      }




      async function triggerPRDReview() {
        const sections = getAllContent();
        const btn = document.querySelector(".btn-warning");
        const originalLabel = btn.innerHTML;

        btn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Reviewing...`;
        btn.disabled = true;
        toggleReviewOverlay(true); // ✅ Show overlay on click

        try {
          const res = await fetch("/review_prd", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ sections })
          });

          const data = await res.json();
          const html = data.issues.map(i => `
      <div class="mb-3">
        <strong>${i.section}</strong><br/>
        🔺 <span class="text-danger">${i.issue}</span><br/>
        💡 <em>${i.suggestion}</em>
      </div>
    `).join("");

          document.getElementById("reviewFeedback").innerHTML = html;
          new bootstrap.Modal(document.getElementById("reviewModal")).show();
        } catch (err) {
          showError("Review failed. See console.");
          console.error(err);
        } finally {
          btn.innerHTML = originalLabel;
          btn.disabled = false;
          toggleReviewOverlay(false); // ✅ Hide overlay after completion
        }
      }



    }); // <-- Add this closing brace and parenthesis for DOMContentLoaded

    // Highlight lines with explicit legacy source references and add a subtle badge
    function highlightLegacyCitations(container) {
      if (!container) return;
      const targets = container.querySelectorAll('p, li');
      const phrases = [
        'Source: Legacy Code',
        'Reference: Legacy Code'
      ];
      targets.forEach(el => {
        const text = el.textContent || '';
        if (!phrases.some(ph => text.includes(ph))) return;
        // Wrap phrase(s) with styled span without removing original text
        let html = el.innerHTML;
        phrases.forEach(ph => {
          const safePh = ph.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          const re = new RegExp(safePh, 'g');
          html = html.replace(re, `<span class="legacy-citation-text">${ph}</span>`);
        });
        el.innerHTML = html;
        el.classList.add('legacy-cited-line');
        const badge = document.createElement('span');
        badge.className = 'badge text-bg-light border legacy-citation-badge';
        badge.innerHTML = '<i class="bi bi-file-earmark-code me-1"></i>Legacy Code';
        el.appendChild(badge);
      });
    }
    let visibleTabId = null;

    function toggleChatPanel(agentKey) {
      const panel = document.getElementById('chatPanel');
      const content = document.getElementById('mainContent');
      const tabId = `${agentKey}-tab`;
      const tabElement = document.getElementById(tabId);
      const label = document.getElementById('chatContextName');

      const agentTitles = {
        'agent_4_2': 'Functional Requirements',
        'agent_4_3': 'Non-Functional Requirements',
        'agent_4_4': 'Data Requirements',
        'agent_4_5': 'Legal, Regulatory, and Compliance Requirements'
      };

      if (!tabElement) return;

      if (panel.style.display === 'none') {
        panel.style.display = 'block';
        content.style.marginLeft = '360px';
        bootstrap.Tab.getOrCreateInstance(tabElement).show();
        visibleTabId = agentKey;
      } else if (visibleTabId === agentKey) {
        panel.style.display = 'none';
        content.style.marginLeft = '0';
        visibleTabId = null;
      } else {
        bootstrap.Tab.getOrCreateInstance(tabElement).show();
        visibleTabId = agentKey;
      }

      label.textContent = agentTitles[agentKey] || 'Unknown';
    }
    function expandAll() {
      document.querySelectorAll('.prd-section-collapse').forEach(el => bootstrap.Collapse.getOrCreateInstance(el).show());
    }
    function collapseAll() {
      document.querySelectorAll('.prd-section-collapse.show').forEach(el => bootstrap.Collapse.getOrCreateInstance(el).hide());
    }



    async function sendAgentMessage(agentId) {
      console.log("Triggered sendAgentMessage for", agentId);
      console.log("Input element:", document.getElementById(`${agentId}_message`));

      const input = document.getElementById(`${agentId}_message`);
      const button = input.nextElementSibling;
      const message = input.value.trim();
      if (!message) return;

      const chatbox = document.getElementById(`${agentId}_chatbox`);
      chatbox.innerHTML += `<div class="chatbox-message user"><strong>You:</strong> ${message}</div>`;
      chatbox.innerHTML += `<div class="chatbox-message text-muted" id="sendingIndicator">Sending...</div>`;
      // Disable and show spinner
      input.disabled = true;
      button.disabled = true;
      button.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;

      try {
        const response = await fetch('/update_content', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: agentId, content: message })
        });

        const result = await response.json();
        const reply = result.response;
        document.getElementById("sendingIndicator")?.remove();
        chatbox.innerHTML += `<div class="chatbox-message agent"><strong>Agent:</strong> ${reply}</div>`;

        // Update hidden input and rendered div
        const renderDiv = document.getElementById(`${agentId}_render`);
        const hiddenInput = document.getElementById(`${agentId}_input`);

        hiddenInput.setAttribute('data-raw', reply);
        hiddenInput.value = JSON.stringify(reply);
        renderDiv.innerHTML = marked.parse(reply);

        const confirmation = document.createElement('div');
        confirmation.className = 'text-success small mt-2 fade';
        confirmation.innerText = 'Message sent...';
        chatbox.appendChild(confirmation);
        setTimeout(() => confirmation.remove(), 2000);

      } catch (err) {
        chatbox.innerHTML += `<div class="text-danger">Error: ${err.message}</div>`;
      } finally {
        input.disabled = false;
        button.disabled = false;
        button.innerHTML = "Send";
        input.value = '';
        chatbox.scrollTop = chatbox.scrollHeight;
      }
    }

    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".send-btn").forEach(button => {
        button.addEventListener("click", () => {
          const agentId = button.getAttribute("data-agent-id");
          if (typeof sendAgentMessage === "function") {
            sendAgentMessage(agentId);
          } else {
            console.error("sendAgentMessage function not found");
          }
        });
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- How To: Floating Help and Offcanvas Guide -->
  <style>
    .howto-fab { position: fixed; right: 24px; bottom: 24px; z-index: 1055; border-radius: 999px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
  </style>
  <button type="button" class="btn btn-danger howto-fab" data-bs-toggle="offcanvas" data-bs-target="#howToPanel" aria-controls="howToPanel" title="How To (Shift + ?)">
    <i class="bi bi-question-circle-fill"></i>
  </button>
  <div class="offcanvas offcanvas-end" tabindex="-1" id="howToPanel" aria-labelledby="howToLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="howToLabel">How To: Final Output</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ol class="mb-3">
        <li>Review each section rendered from markdown.</li>
        <li>Use the chat controls to ask follow-up questions per section.</li>
        <li>Click “Download as Word” to export the PRD document.</li>
        <li>(Optional) Upload to Vector DB to enable downstream linking.</li>
      </ol>
      <div class="mb-2"><strong>Tips</strong></div>
      <ul>
        <li>Ensure legacy-derived lines include the “Source: Legacy Code” citation.</li>
        <li>Use Expand/Collapse to skim quickly before deep review.</li>
      </ul>
      <div class="text-muted small mt-3">Shortcut: Press Shift + ? to open this guide.</div>
    </div>
  </div>
  <script>
    // Keyboard shortcut: Shift + ?
    document.addEventListener('keydown', function(e){
      if (e.shiftKey && (e.key === '?' || e.key === '/')) {
        const panel = document.getElementById('howToPanel');
        if (!panel || !window.bootstrap) return;
        const off = bootstrap.Offcanvas.getOrCreateInstance(panel);
        off.toggle();
      }
    });
  </script>
  <div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">AI Review – PRD Quality Check</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="reviewFeedback"></div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</body>

</html>