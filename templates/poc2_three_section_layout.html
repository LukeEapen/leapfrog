<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Epic & User Story Management - Three Section Layout</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    /* Modern CSS Variables for Design System */
    :root {
      --primary-red: #d0021b;
      --primary-red-dark: #a0011a;
      --primary-red-light: #ff1744;
      --primary-red-lighter: #fff5f5;
      --background-dark: #1a1d23;
      --background-darker: #121419;
      --background-light: #2a2d35;
      --surface-primary: #ffffff;
      --surface-secondary: #f8fafc;
      --surface-tertiary: #f1f5f9;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-light: #ffffff;
      --text-muted: #94a3b8;
      --border-light: #e2e8f0;
      --border-medium: #cbd5e1;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --spacing-xs: 0.5rem;
      --spacing-sm: 0.75rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
    }

    /* Modern Body Styling with Dark Gradient */
    body {
      background: linear-gradient(135deg, var(--background-darker) 0%, var(--background-dark) 100%);
      color: var(--text-light);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 20% 80%, rgba(208, 2, 27, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    /* Enhanced Main Container - Full Width */
    .main-container {
      width: 100%;
      margin: 0;
      background: var(--surface-primary);
      border: none;
      border-radius: 0;
      box-shadow: none;
      overflow: hidden;
      position: relative;
      z-index: 2;
      animation: pageSlideIn 0.6s ease-out;
      min-height: 100vh;
    }

    @keyframes pageSlideIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Enhanced Top Bar */
    .header-bar {
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      color: white;
      padding: var(--spacing-xl) var(--spacing-2xl);
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      min-height: 80px;
    }

    .header-bar::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .header-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: white;
      margin: 0;
    }

    .back-button {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      backdrop-filter: blur(10px);
      text-decoration: none;
    }

    .back-button:hover {
      background: rgba(255, 255, 255, 0.25);
      color: white;
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      text-decoration: none;
    }

    .back-button:active {
      transform: translateY(0);
    }

    /* Enhanced Three Section Layout - Full Width */
    .three-section-container {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: var(--spacing-xl);
      min-height: calc(100vh - 140px);
      padding: var(--spacing-xl);
      color: var(--text-primary);
      width: 100%;
      max-width: 100%;
      align-items: start;
    }

    /* Enhanced Section Styling */
    .section {
      background: linear-gradient(135deg, var(--surface-secondary) 0%, var(--surface-tertiary) 100%);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-lg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      height: fit-content;
      min-height: 600px;
    }

    .section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-red), var(--primary-red-light));
    }

    .section:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-xl);
    }

    .section-header {
      background: linear-gradient(135deg, var(--background-light) 0%, #3a3d47 100%);
      color: white;
      padding: var(--spacing-lg) var(--spacing-xl);
      font-size: 1.25rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-light);
      position: relative;
      min-height: 70px;
    }

    .section-header span {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: 1.125rem;
    }

    .section-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--spacing-xl);
      background: white;
      min-height: 500px;
    }

    /* Enhanced Epic Section */
    .epic-item {
      background: var(--surface-primary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .epic-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-red), var(--primary-red-light));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .epic-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-red);
    }

    .epic-item:hover::before {
      opacity: 1;
    }

    .epic-item.selected {
      background: linear-gradient(135deg, var(--primary-red-lighter) 0%, rgba(208, 2, 27, 0.05) 100%);
      border-color: var(--primary-red);
      box-shadow: var(--shadow-md);
    }

    .epic-item.selected::before {
      opacity: 1;
    }

    .epic-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .epic-description {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    .epic-meta {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-sm);
      font-size: 0.8rem;
    }

    .epic-priority {
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      font-weight: 600;
    }

    .priority-high {
      background: #fee2e2;
      color: #991b1b;
    }

    .priority-medium {
      background: #fef3c7;
      color: #92400e;
    }

    .priority-low {
      background: #dcfce7;
      color: #166534;
    }

    /* Enhanced User Story Section */
    .user-story-item {
      background: var(--surface-primary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-sm);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .user-story-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6, #06b6d4);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .user-story-item:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      border-color: #3b82f6;
    }

    .user-story-item:hover::before {
      opacity: 1;
    }

    .user-story-item.selected {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
      border-color: #3b82f6;
      box-shadow: var(--shadow-sm);
    }

    .user-story-item.selected::before {
      opacity: 1;
    }

    .user-story-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-xs);
    }

    .user-story-summary {
      color: var(--text-secondary);
      font-size: 0.85rem;
      line-height: 1.4;
    }

    /* Enhanced Selection Card Styles for User Stories */
    .selection-card {
      background: var(--surface-primary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-md);
    }

    .selection-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6, #06b6d4);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .selection-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: #3b82f6;
    }

    .selection-card:hover::before {
      opacity: 1;
    }

    .selection-card.selected,
    .selection-card:has(input[type="radio"]:checked) {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
      border-color: #3b82f6;
      box-shadow: var(--shadow-md);
    }

    .selection-card.selected::before,
    .selection-card:has(input[type="radio"]:checked)::before {
      opacity: 1;
    }

    .card-radio {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      position: relative;
      flex-shrink: 0;
      margin-top: var(--spacing-xs);
    }

    .card-radio input[type="radio"] {
      width: 20px;
      height: 20px;
      margin: 0;
      opacity: 0;
      cursor: pointer;
      position: relative;
      z-index: 2;
    }

    .card-radio label {
      position: absolute;
      top: 0;
      left: 0;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-medium);
      border-radius: 50%;
      background: var(--surface-primary);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-radio input[type="radio"]:checked + label {
      border-color: #3b82f6;
      background: #3b82f6;
    }

    .card-radio input[type="radio"]:checked + label::after {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: white;
    }

    .card-radio input[type="radio"]:hover + label {
      border-color: #3b82f6;
      transform: scale(1.1);
    }

    .card-content {
      flex: 1;
      cursor: pointer;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--spacing-sm);
      gap: var(--spacing-md);
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
      line-height: 1.4;
      flex: 1;
    }

    .card-meta {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      align-items: flex-end;
      flex-shrink: 0;
    }

    .card-description {
      color: var(--text-secondary);
      font-size: 0.85rem;
      line-height: 1.4;
      margin: 0;
    }

    /* Priority and Systems Badges */
    .priority-badge {
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    .systems-badge {
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 500;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
      color: #1e40af;
      border: 1px solid rgba(59, 130, 246, 0.2);
      white-space: nowrap;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Enhanced Story Details Section */
    .story-details-content {
      padding: 0;
      background: white;
    }

    .detail-section {
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--border-light);
      background: linear-gradient(135deg, var(--surface-secondary) 0%, var(--surface-tertiary) 100%);
      margin-bottom: var(--spacing-md);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }

    .detail-section:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .detail-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .detail-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: var(--spacing-sm);
      border-bottom: 2px solid var(--primary-red);
    }

    .detail-content {
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .criteria-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .criteria-list li {
      background: var(--surface-primary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: var(--spacing-sm) var(--spacing-md);
      margin-bottom: var(--spacing-sm);
      position: relative;
      padding-left: 2.5rem;
      transition: all 0.3s ease;
    }

    .criteria-list li:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
      border-color: var(--primary-red);
    }

    .criteria-list li::before {
      content: 'âœ“';
      position: absolute;
      left: var(--spacing-md);
      top: var(--spacing-sm);
      color: var(--primary-red);
      font-weight: bold;
    }

    /* Enhanced Chat Button */
    .chat-btn {
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      color: white;
      border: none;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .chat-btn:hover {
      transform: scale(1.05) translateY(-1px);
      box-shadow: var(--shadow-md);
      color: white;
      background: linear-gradient(135deg, var(--primary-red-dark) 0%, var(--primary-red) 100%);
    }

    /* Epic Submit Button */
    .epic-submit-container {
      border-top: 1px solid var(--border-light);
      background: linear-gradient(135deg, var(--surface-secondary) 0%, var(--surface-tertiary) 100%);
      margin-top: var(--spacing-md);
    }

    #epic-submit-btn {
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      border: none;
      color: white;
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--radius-md);
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }

    #epic-submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      background: linear-gradient(135deg, var(--primary-red-dark) 0%, var(--primary-red) 100%);
    }

    /* User Story Submit Button */
    .user-story-submit-container {
      border-top: 1px solid var(--border-light);
      background: linear-gradient(135deg, var(--surface-secondary) 0%, var(--surface-tertiary) 100%);
      margin-top: var(--spacing-md);
    }

    #user-story-submit-btn {
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      border: none;
      color: white;
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--radius-md);
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-sm);
    }

    #user-story-submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      background: linear-gradient(135deg, var(--primary-red-dark) 0%, var(--primary-red) 100%);
    }

    /* Enhanced Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      padding: var(--spacing-2xl);
      color: var(--text-muted);
      text-align: center;
      background: linear-gradient(135deg, var(--surface-secondary) 0%, var(--surface-tertiary) 100%);
      border-radius: var(--radius-lg);
      border: 2px dashed var(--border-medium);
      margin: var(--spacing-lg);
      position: relative;
    }

    .empty-state-icon {
      font-size: 3.5rem;
      margin-bottom: var(--spacing-lg);
      opacity: 0.7;
      color: var(--primary-red);
    }

    .empty-state-text {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .empty-state-subtext {
      font-size: 1rem;
      margin-bottom: var(--spacing-lg);
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .empty-state .btn {
      margin-top: var(--spacing-md);
      white-space: nowrap;
      max-width: 100%;
      font-size: 1rem;
      padding: var(--spacing-md) var(--spacing-xl);
      font-weight: 600;
      border-radius: var(--radius-md);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .empty-state .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    /* Enhanced Loading State */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      padding: var(--spacing-xl);
      color: var(--text-secondary);
      background: var(--surface-secondary);
      border-radius: var(--radius-lg);
      margin: var(--spacing-lg);
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--border-light);
      border-top: 4px solid var(--primary-red);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: var(--spacing-md);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Enhanced Action Buttons */
    .action-btn {
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      color: white;
      border: none;
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--radius-lg);
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-top: var(--spacing-lg);
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
    }

    .action-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .action-btn:hover::before {
      left: 100%;
    }

    .action-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Header Action Button - for buttons in section headers */
    .header-action-btn {
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      color: white;
      border: none;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      position: relative;
      overflow: hidden;
    }

    .header-action-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .header-action-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .header-action-btn:hover::before {
      left: 100%;
    }

    .header-action-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Chat Apply Button Styles */
    .chat-apply-btn {
      background: linear-gradient(135deg, #28a745 0%, #20963b 100%);
      color: white;
      border: none;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 0.9rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
      margin-left: var(--spacing-sm);
      flex-shrink: 0;
      box-sizing: border-box;
      white-space: nowrap;
      max-width: 140px;
    }

    .chat-apply-btn:hover {
      background: linear-gradient(135deg, #20963b 0%, #1e7e34 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
    }

    .chat-apply-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      background: linear-gradient(135deg, #6c757d 0%, #5a6169 100%);
      box-shadow: none;
    }

    .chat-apply-btn:disabled:hover {
      transform: none;
      box-shadow: none;
      background: linear-gradient(135deg, #6c757d 0%, #5a6169 100%);
    }

    .chat-apply-container {
      border-top: 1px solid var(--border-light);
      padding: var(--spacing-md);
      background: var(--surface-secondary);
      display: none;
      align-items: center;
      justify-content: space-between;
      position: relative;
      z-index: 1;
      width: 100%;
      box-sizing: border-box;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      overflow: hidden;
    }

    .chat-apply-container.show {
      display: flex;
    }

    .chat-apply-info {
      color: var(--text-secondary);
      font-size: 0.9rem;
      flex: 1;
      min-width: 0;
      margin-right: var(--spacing-sm);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Enhanced File Upload Styles */
    .form-control[type="file"] {
      border: 2px dashed var(--border-medium);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      background: linear-gradient(135deg, var(--surface-secondary) 0%, var(--surface-tertiary) 100%);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--text-primary);
      width: 100%;
      min-height: 60px;
      display: block;
      box-sizing: border-box;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .form-control[type="file"]::-webkit-file-upload-button {
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: var(--radius-md);
      margin-right: 12px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .form-control[type="file"]::-webkit-file-upload-button:hover {
      background: linear-gradient(135deg, var(--primary-red-dark) 0%, var(--primary-red) 100%);
      transform: scale(1.05);
      box-shadow: var(--shadow-sm);
    }

    .form-control[type="file"]:hover {
      border-color: var(--primary-red);
      background: var(--surface-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .form-control[type="file"]:focus {
      outline: none;
      border-color: var(--primary-red);
      box-shadow: 0 0 0 3px rgba(208, 2, 27, 0.1);
    }

    .form-label {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
      display: block;
    }

    /* Enhanced Upload Section Styling */
    .upload-section {
      background: linear-gradient(135deg, var(--surface-secondary) 0%, var(--surface-tertiary) 100%);
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-sm);
    }

    /* Enhanced Button Improvements */
    .btn {
      border-radius: var(--radius-md);
      font-weight: 600;
      padding: var(--spacing-sm) var(--spacing-lg);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: none;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      color: white;
      box-shadow: var(--shadow-md);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      color: white;
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--text-muted) 0%, var(--text-secondary) 100%);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, var(--text-secondary) 0%, var(--text-primary) 100%);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      color: white;
    }

    /* Badge Styling */
    .badge {
      border-radius: var(--radius-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      font-weight: 500;
    }

    .badge-secondary {
      background: var(--text-light);
      color: white;
    }

    /* Enhanced Responsive Design */
    @media (max-width: 1200px) {
      .three-section-container {
        grid-template-columns: 1fr 1fr;
        grid-template-rows: auto auto;
        gap: var(--spacing-lg);
      }
      
      .section:nth-child(3) {
        grid-column: 1 / -1;
      }
    }

    @media (max-width: 768px) {
      .main-container {
        margin: 0;
        border-radius: 0;
        width: 100%;
      }
      
      .three-section-container {
        grid-template-columns: 1fr;
        height: auto;
        gap: var(--spacing-lg);
        padding: var(--spacing-lg);
        width: 100%;
      }
      
      .section {
        min-height: 500px;
        width: 100%;
      }
      
      .section-content {
        padding: var(--spacing-lg);
      }
      
      .empty-state {
        margin: var(--spacing-md);
        padding: var(--spacing-lg);
      }
      
      .header-bar {
        padding: var(--spacing-lg);
        flex-direction: column;
        gap: var(--spacing-md);
        text-align: center;
      }

      .header-title {
        font-size: 1.5rem;
      }
    }

    /* Modern Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--surface-tertiary);
      border-radius: var(--radius-sm);
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      border-radius: var(--radius-sm);
      transition: background 0.3s ease;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, var(--primary-red-dark) 0%, var(--primary-red) 100%);
    }

    /* Modern Selection Styling */
    ::selection {
      background: rgba(208, 2, 27, 0.2);
      color: var(--text-primary);
    }

    /* Enhanced Focus Management */
    *:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(208, 2, 27, 0.1);
      border-radius: var(--radius-sm);
    }

    /* Enhanced Chat Modal Styles */
    .chat-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      right: 0;
      top: 0;
      width: 400px;
      height: 100vh;
      background: var(--surface-primary);
      backdrop-filter: blur(20px);
      border-left: 1px solid var(--border-light);
      box-shadow: var(--shadow-xl);
      border-radius: var(--radius-lg) 0 0 var(--radius-lg);
      overflow: hidden;
      box-sizing: border-box;
    }

    .chat-modal[style*="display: block"] {
      display: flex !important;
      flex-direction: column;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .chat-modal-content {
      height: 100%;
      display: flex;
      flex-direction: column;
      color: #8B4513;
      width: 100%;
      box-sizing: border-box;
      overflow: hidden;
    }

    .chat-header {
      background: linear-gradient(135deg, var(--background-light) 0%, #3a3d47 100%);
      color: #8B4513;
      padding: var(--spacing-lg);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border-light);
      position: relative;
    }

    .chat-header::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-red), var(--primary-red-light));
    }

    .chat-close {
      background: rgba(139, 69, 19, 0.1);
      border: 1px solid rgba(139, 69, 19, 0.2);
      color: #8B4513;
      font-size: 1.2rem;
      cursor: pointer;
      padding: var(--spacing-xs);
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .chat-close:hover {
      background: rgba(139, 69, 19, 0.2);
      transform: scale(1.1);
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      color: #8B4513;
      position: relative;
      height: 100%;
      width: 100%;
      box-sizing: border-box;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: var(--spacing-lg);
      color: #8B4513;
    }

    .chat-message {
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-sm);
    }

    .chat-message.user {
      flex-direction: row-reverse;
    }

    .chat-bubble {
      background: var(--surface-secondary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      max-width: 80%;
      word-wrap: break-word;
    }

    .chat-message.user .chat-bubble {
      background: var(--primary-gradient);
      color: #8B4513;
      border-color: transparent;
    }

    .chat-input-area {
      padding: var(--spacing-lg);
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: var(--spacing-sm);
      width: 100%;
      box-sizing: border-box;
      flex-wrap: wrap;
      align-items: center;
    }

    .chat-input {
      flex: 1;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      outline: none;
      transition: border-color 0.3s ease;
      min-width: 0;
      box-sizing: border-box;
    }

    .chat-input:focus {
      border-color: #667eea;
    }

    .chat-send-btn {
      background: var(--primary-gradient);
      color: #8B4513;
      border: none;
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      cursor: pointer;
      transition: all 0.3s ease;
      flex-shrink: 0;
      box-sizing: border-box;
      white-space: nowrap;
    }

    .chat-send-btn:hover {
      transform: scale(1.05);
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--surface-tertiary);
      border-radius: var(--radius-sm);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-medium);
      border-radius: var(--radius-sm);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-light);
    }

    /* Enhanced Selection Card Styles for User Stories */
    .selection-card {
      background: var(--surface-primary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-md);
    }

    .selection-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6, #06b6d4);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .selection-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: #3b82f6;
    }

    .selection-card:hover::before {
      opacity: 1;
    }

    .selection-card.selected,
    .selection-card:has(input[type="radio"]:checked) {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
      border-color: #3b82f6;
      box-shadow: var(--shadow-md);
    }

    .selection-card.selected::before,
    .selection-card:has(input[type="radio"]:checked)::before {
      opacity: 1;
    }

    .card-radio {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      position: relative;
      flex-shrink: 0;
      margin-top: var(--spacing-xs);
    }

    .card-radio input[type="radio"] {
      width: 20px;
      height: 20px;
      margin: 0;
      opacity: 0;
      cursor: pointer;
      position: relative;
      z-index: 2;
    }

    .card-radio label {
      position: absolute;
      top: 0;
      left: 0;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-medium);
      border-radius: 50%;
      background: var(--surface-primary);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-radio input[type="radio"]:checked + label {
      border-color: #3b82f6;
      background: #3b82f6;
    }

    .card-radio input[type="radio"]:checked + label::after {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: white;
    }

    .card-radio input[type="radio"]:hover + label {
      border-color: #3b82f6;
      transform: scale(1.1);
    }

    .card-content {
      flex: 1;
      cursor: pointer;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--spacing-sm);
      gap: var(--spacing-md);
    }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
      line-height: 1.4;
      flex: 1;
    }

    .card-meta {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      align-items: flex-end;
      flex-shrink: 0;
    }

    .card-description {
      color: var(--text-secondary);
      font-size: 0.85rem;
      line-height: 1.4;
      margin: 0;
    }

    /* Priority and Systems Badges */
    .priority-badge {
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    .priority-high {
      background: #fee2e2;
      color: #991b1b;
    }

    .priority-medium {
      background: #fef3c7;
      color: #92400e;
    }

    .priority-low {
      background: #dcfce7;
      color: #166534;
    }

    .systems-badge {
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-weight: 500;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
      color: #1e40af;
      border: 1px solid rgba(59, 130, 246, 0.2);
      white-space: nowrap;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Modern User Story Card Styles */
    .modern-story-card {
      background: linear-gradient(135deg, var(--surface-primary) 0%, var(--surface-secondary) 100%);
      border: 1px solid var(--border-light);
      border-radius: 16px;
      margin-bottom: 20px;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      cursor: pointer;
    }

    .modern-story-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modern-story-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      border-color: #667eea;
    }

    .modern-story-card:hover::before {
      opacity: 1;
    }

    .story-card-header {
      padding: 24px;
      display: flex;
      align-items: flex-start;
      gap: 16px;
    }

    .story-radio {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      position: relative;
      flex-shrink: 0;
      margin-top: 4px;
    }

    .story-radio input[type="radio"] {
      width: 20px;
      height: 20px;
      margin: 0;
      opacity: 0;
      cursor: pointer;
      position: relative;
      z-index: 2;
    }

    .story-radio label {
      position: absolute;
      top: 0;
      left: 0;
      width: 20px;
      height: 20px;
      border: 2px solid #cbd5e1;
      border-radius: 50%;
      background: var(--surface-primary);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .story-radio input[type="radio"]:checked + label {
      border-color: #667eea;
      background: #667eea;
      transform: scale(1.1);
    }

    .story-radio input[type="radio"]:checked + label::after {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: white;
    }

    .story-main-content {
      flex: 1;
      min-width: 0;
    }

    .story-title-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 12px;
    }

    .story-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
      line-height: 1.4;
      flex: 1;
      min-width: 0;
      word-wrap: break-word;
    }

    .story-badges {
      display: flex;
      flex-shrink: 0;
    }

    .modern-priority-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
      border: 1px solid transparent;
    }

    .modern-priority-badge.priority-high {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #dc2626;
      border-color: #fca5a5;
    }

    .modern-priority-badge.priority-medium {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #d97706;
      border-color: #fbbf24;
    }

    .modern-priority-badge.priority-low {
      background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
      color: #16a34a;
      border-color: #86efac;
    }

    .story-meta-row {
      margin-bottom: 16px;
    }

    .story-description {
      color: var(--text-secondary);
      font-size: 0.875rem;
      line-height: 1.6;
      margin: 0;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .story-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-light);
    }

    .responsible-systems {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .system-icon {
      font-size: 1rem;
      opacity: 0.7;
    }

    .systems-text {
      background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
      color: #0277bd;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
      border: 1px solid #81d4fa;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }

    .story-id {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-weight: 500;
      opacity: 0.8;
    }

    .story-radio input[type="radio"]:focus + label {
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .modern-story-card:has(input[type="radio"]:checked) {
      background: linear-gradient(135deg, rgba(102, 126, 234, 0.04) 0%, rgba(118, 75, 162, 0.04) 100%);
      border-color: #667eea;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.15);
    }

    .modern-story-card:has(input[type="radio"]:checked)::before {
      opacity: 1;
    }

    /* Step Indicators */
    .step-indicators {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 2rem;
      gap: 1rem;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--border-medium);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .step.active .step-number {
      background: var(--primary-red);
      color: white;
    }

    .step-label {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-muted);
      transition: all 0.3s ease;
    }

    .step.active .step-label {
      color: var(--text-primary);
    }

    .step-connector {
      width: 60px;
      height: 2px;
      background: var(--border-medium);
    }

    /* Enhanced PRD Upload Modal with Full Features */

  /* Loading dots animation for chat */
  .loading-dots {
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .loading-dots span {
    width: 6px;
    height: 6px;
    background-color: #8B4513;
    border-radius: 50%;
    animation: loading-bounce 1.4s infinite ease-in-out;
  }

  .loading-dots span:nth-child(1) {
    animation-delay: -0.32s;
  }

  .loading-dots span:nth-child(2) {
    animation-delay: -0.16s;
  }

  @keyframes loading-bounce {
    0%, 80%, 100% {
      transform: scale(0);
      opacity: 0.5;
    }
    40% {
      transform: scale(1);
      opacity: 1;
    }
  }

  /* Loading dots animation for chat */
  .loading-dots {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .loading-dots span {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--text-secondary);
    animation: loadingPulse 1.4s infinite ease-in-out both;
  }

  .loading-dots span:nth-child(1) {
    animation-delay: -0.32s;
  }

  .loading-dots span:nth-child(2) {
    animation-delay: -0.16s;
  }

  @keyframes loadingPulse {
    0%, 80%, 100% {
      transform: scale(0.8);
      opacity: 0.5;
    }
    40% {
      transform: scale(1);
      opacity: 1;
    }
  }

  /* Scrollbar Styling */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: var(--surface-tertiary);
    border-radius: var(--radius-sm);
  }

  ::-webkit-scrollbar-thumb {
    background: var(--border-medium);
    border-radius: var(--radius-sm);
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--text-light);
  }

  /* Enhanced Selection Card Styles for User Stories */
  .selection-card {
    background: var(--surface-primary);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    margin-bottom: var(--spacing-md);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-md);
  }

  .selection-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #3b82f6, #06b6d4);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .selection-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: #3b82f6;
  }

  .selection-card:hover::before {
    opacity: 1;
  }

  .selection-card.selected,
  .selection-card:has(input[type="radio"]:checked) {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
    border-color: #3b82f6;
    box-shadow: var(--shadow-md);
  }

  .selection-card.selected::before,
  .selection-card:has(input[type="radio"]:checked)::before {
    opacity: 1;
  }

  .card-radio {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    position: relative;
    flex-shrink: 0;
    margin-top: var(--spacing-xs);
  }

  .card-radio input[type="radio"] {
    width: 20px;
    height: 20px;
    margin: 0;
    opacity: 0;
    cursor: pointer;
    position: relative;
    z-index: 2;
  }

  .card-radio label {
    position: absolute;
    top: 0;
    left: 0;
    width: 20px;
    height: 20px;
    border: 2px solid var(--border-medium);
    border-radius: 50%;
    background: var(--surface-primary);
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .card-radio input[type="radio"]:checked + label {
    border-color: #3b82f6;
    background: #3b82f6;
  }

  .card-radio input[type="radio"]:checked + label::after {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: white;
  }

  .card-radio input[type="radio"]:hover + label {
    border-color: #3b82f6;
    transform: scale(1.1);
  }

  .card-content {
    flex: 1;
    cursor: pointer;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--spacing-sm);
    gap: var(--spacing-md);
  }

  .card-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
    line-height: 1.4;
    flex: 1;
  }

    .summary-box::-webkit-scrollbar {
      width: 8px;
    }

    .summary-box::-webkit-scrollbar-track {
      background: #f8f9fa;
      border-radius: 4px;
    }

    .summary-box::-webkit-scrollbar-thumb {
      background: #ced4da;
      border-radius: 4px;
      transition: background 0.2s ease;
    }

    .summary-box::-webkit-scrollbar-thumb:hover {
      background: #d0021b;
    }

    /* Traceability Matrix Markdown Styling */
    .traceability-matrix h4,
    .traceability-matrix h5,
    .traceability-matrix h6 {
      margin: 0.5rem 0 0.3rem 0;
      color: var(--text-primary);
      font-weight: 600;
    }

    .traceability-matrix h4 {
      font-size: 1.1rem;
      color: #667eea;
      border-bottom: 2px solid rgba(102, 126, 234, 0.2);
      padding-bottom: 0.2rem;
    }

    .traceability-matrix h5 {
      font-size: 1rem;
      color: #764ba2;
    }

    .traceability-matrix h6 {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .traceability-matrix p {
      margin: 0.4rem 0;
      line-height: 1.5;
    }

    .traceability-matrix ul {
      margin: 0.5rem 0;
      padding-left: 1.2rem;
    }

    .traceability-matrix li {
      margin: 0.2rem 0;
      line-height: 1.4;
    }

    .traceability-matrix strong {
      color: var(--text-primary);
      font-weight: 600;
    }

    .traceability-matrix em {
      color: var(--text-secondary);
      font-style: italic;
    }

    .traceability-matrix code {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      padding: 0.1rem 0.3rem;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
      font-size: 0.85em;
    }

    .traceability-matrix pre {
      background: rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border-light);
      border-radius: 4px;
      padding: 0.8rem;
      margin: 0.5rem 0;
      overflow-x: auto;
    }

    .traceability-matrix pre code {
      background: transparent;
      color: var(--text-primary);
      padding: 0;
    }

    .traceability-matrix table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }

    .traceability-matrix table td {
      border: 1px solid var(--border-light);
      padding: 0.4rem 0.6rem;
      text-align: left;
    }

    .traceability-matrix table tr:nth-child(even) {
      background: rgba(102, 126, 234, 0.03);
    }

    .traceability-matrix table tr:first-child {
      background: rgba(102, 126, 234, 0.08);
      font-weight: 600;
    }
  </style>
</head>
<body>
  <!-- Hidden form for Jira submission -->
  <form id="jira-form" action="/three-section-submit-jira" method="POST" style="display: none;">
    <input type="hidden" name="epic_title" id="jira-epic-title">
    <input type="hidden" name="user_story_name" id="jira-user-story-name">
    <input type="hidden" name="user_story_description" id="jira-user-story-description">
    <input type="hidden" name="priority" id="jira-priority">
    <input type="hidden" name="responsible_systems" id="jira-responsible-systems">
    <input type="hidden" name="acceptance_criteria" id="jira-acceptance-criteria">
    <input type="hidden" name="tagged_requirements" id="jira-tagged-requirements">
    <input type="hidden" name="traceability_matrix" id="jira-traceability-matrix">
  </form>

  <div class="main-container">
    <!-- Header Bar -->
    <div class="header-bar">
      <h1 class="header-title">Epic & User Story Management</h1>
    </div>

    <!-- Three Section Layout -->
    <div class="three-section-container">
      <!-- Section 1: Epics List -->
      <div class="section" id="epics-section">
        <div class="section-header">
          <span>ðŸ“‹ Epics</span>
          <button class="chat-btn" onclick="openEpicChat()" style="display: none;" id="epic-chat-btn">
            ðŸ’¬ Chat
          </button>
        </div>
        <div class="section-content" id="epics-content">
          <div class="loading-state" id="epics-loading">
            <div class="loading-spinner"></div>
            <span>Loading epics...</span>
          </div>
          <div class="empty-state" id="epics-empty" style="display: none;">
            <div class="empty-state-icon">ðŸ“‹</div>
            <div class="empty-state-text">No epics available</div>
            <div class="empty-state-subtext">Upload a PRD to generate epics</div>
            <button class="btn btn-primary mt-3" onclick="showPRDUpload()">
              <i class="fas fa-upload mr-2"></i>Upload PRD, and Additional Document
            </button>
          </div>
          <div id="epics-list"></div>
          <div class="epic-submit-container" style="display: none; padding: var(--spacing-lg); text-align: center;">
            <button class="btn btn-primary" id="epic-submit-btn" onclick="submitSelectedEpic()">
              <i class="fas fa-arrow-right mr-2"></i>Continue with Selected Epic
            </button>
          </div>
        </div>
      </div>

      <!-- Section 2: User Stories List -->
      <div class="section" id="user-stories-section">
        <div class="section-header">
          <span>ðŸ“ User Stories</span>
          <button class="chat-btn" onclick="openUserStoryChat()" style="display: none;" id="user-story-chat-btn">
            ðŸ’¬ Chat
          </button>
        </div>
        <div class="section-content" id="user-stories-content">
          <div class="empty-state" id="user-stories-empty">
            <div class="empty-state-icon">ðŸ“</div>
            <div class="empty-state-text">Select an epic</div>
            <div class="empty-state-subtext">Choose an epic to view its user stories</div>
          </div>
          <div class="loading-state" id="user-stories-loading" style="display: none;">
            <div class="loading-spinner"></div>
            <span>Generating user stories...</span>
          </div>
          <div id="user-stories-list"></div>
          <div class="user-story-submit-container" style="display: none; padding: var(--spacing-lg); text-align: center;">
            <button class="btn btn-primary" id="user-story-submit-btn" onclick="submitSelectedUserStory()">
              <i class="fas fa-arrow-right mr-2"></i>Continue with Selected User Story
            </button>
          </div>
        </div>
      </div>

      <!-- Section 3: Story Details -->
      <div class="section" id="story-details-section">
        <div class="section-header">
          <span>ðŸ” Story Details</span>
          <button class="header-action-btn" id="submit-jira-btn" onclick="submitToJira()" style="display: none;">
            ðŸš€ Submit to Jira
          </button>
        </div>
        <div class="section-content story-details-content" id="story-details-content">
          <div class="empty-state" id="story-details-empty">
            <div class="empty-state-icon">ðŸ”</div>
            <div class="empty-state-text">Select a user story</div>
            <div class="empty-state-subtext">Choose a user story to view its details</div>
          </div>
          <div id="story-details"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Epic Chat Modal -->
  <div id="epic-chat-modal" class="chat-modal">
    <div class="chat-modal-content">
      <div class="chat-header">
        <h4 style="margin: 0; color: white !important;">Epic Chat</h4>
        <button class="chat-close" onclick="closeEpicChat()">&times;</button>
      </div>
      <div class="chat-container">
        <div class="chat-messages" id="epic-chat-messages">
          <div class="chat-message">
            <div class="chat-bubble">
              Hello! I can help you refine your epics. Ask me to make changes, add details, or reorganize them.
            </div>
          </div>
        </div>
        <div class="chat-apply-container" id="epic-chat-apply-container">
          <div class="chat-apply-info">
            <span id="epic-apply-info">Ask me to modify your epics and I'll suggest changes for you to apply</span>
          </div>
          <button class="chat-apply-btn" id="epic-apply-btn" onclick="applyEpicChanges()" disabled style="opacity: 0.6;">
            âœ… Apply Changes
          </button>
        </div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" id="epic-chat-input" placeholder="Ask about epics... (Enter to send, Shift+Enter for new line, Esc to close)" onkeypress="handleEpicChatEnter(event)">
          <button class="chat-send-btn" onclick="sendEpicMessage()">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- User Story Chat Modal -->
  <div id="user-story-chat-modal" class="chat-modal">
    <div class="chat-modal-content">
      <div class="chat-header">
        <h4 style="margin: 0; color: white !important;">User Story Chat</h4>
        <button class="chat-close" onclick="closeUserStoryChat()">&times;</button>
      </div>
      <div class="chat-container">
        <div class="chat-messages" id="user-story-chat-messages">
          <div class="chat-message">
            <div class="chat-bubble">
              Hello! I can help you refine your user stories. Ask me to make changes, add details, or reorganize them.
            </div>
          </div>
        </div>
        <div class="chat-apply-container" id="user-story-chat-apply-container">
          <div class="chat-apply-info">
            <span id="user-story-apply-info">Ask me to modify user stories and I'll suggest changes for you to apply</span>
          </div>
          <button class="chat-apply-btn" id="user-story-apply-btn" onclick="applyUserStoryChanges()" disabled style="opacity: 0.6;">
            âœ… Apply Changes
          </button>
        </div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" id="user-story-chat-input" placeholder="Ask about user stories... (Enter to send, Shift+Enter for new line, Esc to close)" onkeypress="handleUserStoryChatEnter(event)">
          <button class="chat-send-btn" onclick="sendUserStoryMessage()">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Story Details Chat Modal -->
  <div id="story-details-chat-modal" class="chat-modal">
    <div class="chat-modal-content">
      <div class="chat-header">
        <h4 style="margin: 0;">Story Details Chat</h4>
        <button class="chat-close" onclick="closeStoryDetailsChat()">&times;</button>
      </div>
      <div class="chat-container">
        <div class="chat-messages" id="story-details-chat-messages">
          <div class="chat-message">
            <div class="chat-bubble">
              Hello! I can help you refine story details, acceptance criteria, and traceability.
            </div>
          </div>
        </div>
        <div class="chat-apply-container" id="story-details-chat-apply-container">
          <div class="chat-apply-info">
            <span id="story-details-apply-info">Ask me to modify story details and I'll suggest changes for you to apply</span>
          </div>
          <button class="chat-apply-btn" id="story-details-apply-btn" onclick="applyStoryDetailsChanges()" disabled style="opacity: 0.6;">
            âœ… Apply Changes
          </button>
        </div>
        <div class="chat-input-area">
          <input type="text" class="chat-input" id="story-details-chat-input" placeholder="Ask about story details... (Enter to send, Shift+Enter for new line, Esc to close)" onkeypress="handleStoryDetailsChatEnter(event)">
          <button class="chat-send-btn" onclick="sendStoryDetailsMessage()">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced PRD Upload Modal with Full Features -->
  <div id="prd-upload-modal" class="chat-modal">
    <div class="chat-modal-content" style="max-width: 1000px; height: 90vh; overflow-y: auto;">
      <div class="chat-header">
        <h4 style="margin: 0; color: white !important;">ðŸ“„ Upload PRD & Additional Documents</h4>
        <button class="chat-close" onclick="closePRDUpload()">&times;</button>
      </div>
      <div class="chat-body" style="padding: 2rem;">
        <div class="step-indicators" style="display: flex; justify-content: center; align-items: center; margin-bottom: 2rem; gap: 1rem;">
          <div class="step active" id="step-1">
            <div class="step-number">1</div>
            <div class="step-label">Upload & Preview</div>
          </div>
          <div class="step-connector"></div>
          <div class="step" id="step-2">
            <div class="step-number">2</div>
            <div class="step-label">Generate Epics</div>
          </div>
        </div>

        <!-- Step 1: Upload and Preview -->
        <div class="upload-step" id="upload-step-1">
          <form id="prd-upload-form" enctype="multipart/form-data">
            <div class="form-group mb-4">
              <label for="prd-file" class="form-label">
                <strong>ðŸ“„ Primary Requirements Document (PRD)</strong>
              </label>
              <input type="file" class="form-control" id="prd-file" name="prd_file" accept=".txt,.docx,.pdf,.md" required>
              <div class="form-text" style="color: #6c757d; font-size: 0.875rem;">
                Supported formats: TXT, DOCX, PDF, MD. This will be the main source for epic generation.
              </div>
            </div>

            <div class="form-group mb-4">
              <label for="additional-file" class="form-label">
                <strong>ðŸ“‹ Additional Documentation (Optional)</strong>
              </label>
              <input type="file" class="form-control" id="additional-file" name="additional_file" accept=".txt,.docx,.pdf,.md,.csv">
              <div class="form-text" style="color: #6c757d; font-size: 0.875rem;">
                Optional: Additional context, technical specs, or system mapping (CSV format supported).
              </div>
            </div>

            <div class="form-group mb-4">
              <label for="context-notes" class="form-label">
                <strong>ðŸ’¡ Context & Special Instructions (Optional)</strong>
              </label>
              <textarea class="form-control" id="context-notes" name="context_notes" rows="4" placeholder="Example:
â€¢ Business constraints or timeline requirements
â€¢ Technical architecture preferences  
â€¢ Integration requirements with existing systems
â€¢ Specific user personas or use cases
â€¢ Compliance or security considerations"></textarea>
              <div class="form-text" style="color: #6c757d; font-size: 0.875rem;">
                Provide any additional context to guide epic generation.
              </div>
            </div>

            <!-- Upload & Preview Button -->
            <button type="submit" class="btn btn-primary btn-lg w-100 mb-4" id="prd-upload-btn">
              <span class="btn-text">ðŸ“„ Upload & Preview Documents</span>
              <span class="timer-display" id="upload-timer" style="display: none; margin-left: 10px; font-size: 0.9em;">(0:00)</span>
            </button>
          </form>
        </div>

        <!-- Loading Spinner for Upload - SPINNER REMOVED -->
        <div class="loading-spinner" id="prd-loading-spinner" style="display: none;">
          <div style="text-align: center; padding: 2rem;">
            <p style="margin: 0; color: #6c757d; font-weight: 500;"></p>
          </div>
        </div>

        <!-- Step 2: Preview and Generate Epics -->
        <div class="upload-step" id="upload-step-2" style="display: none;">
          <div class="document-preview" id="document-preview">
            <!-- Alert Container -->
            <div id="prd-alert-container"></div>
            
            <!-- PRD Summary Section -->
            <div id="prd-summary-section" style="display: none; color: #8B4513;">
              <h5><strong>ðŸ“„ PRD Summary</strong></h5>
              <div id="prd-filename-display" class="mb-2"></div>
              <div class="summary-box" style="background: #f8f9fa; padding: 1rem; border-radius: 0.375rem; border: 1px solid #dee2e6; max-height: 200px; overflow-y: auto;">
                <div id="prd-summary-content"></div>
              </div>
            </div>
            
            <!-- Additional Documents Section -->
            <div id="additional-docs-section" style="display: none; margin-top: 1.5rem; color: #8B4513;">
              <h5><strong>ðŸ“‹ Additional Documentation</strong></h5>
              <div id="additional-docs-filename" class="mb-2"></div>
              <div class="summary-box" style="background: #f8f9fa; padding: 1rem; border-radius: 0.375rem; border: 1px solid #dee2e6; max-height: 200px; overflow-y: auto;">
                <div id="additional-docs-summary"></div>
              </div>
            </div>
            
            <!-- User Context Section -->
            <div id="user-context-section" style="display: none; margin-top: 1.5rem;">
              <h5><strong>ðŸ’¡ Your Additional Context</strong></h5>
              <div class="summary-box" style="background: #f0f7ff; padding: 1rem; border-radius: 0.375rem; border: 1px solid #bee5eb;">
                <div id="user-context-display"></div>
              </div>
            </div>
            
            <!-- Reset Button -->
            <button type="button" class="btn btn-outline-secondary mt-3" id="reset-prd-btn" onclick="resetPRDUpload()" style="display: none;">
              ðŸ”„ Start Over
            </button>
          </div>
          
          <button type="button" class="btn btn-primary btn-lg w-100 mt-4" id="generate-epics-btn" onclick="generateEpicsFromPRDData()">
            <span class="btn-text">âš¡ Generate Epics & User Stories</span>
          </button>
          
          <!-- Loading state for epic generation - SPINNER REMOVED -->
          <div class="loading-spinner" id="prd-epic-spinner" style="display: none;">
            <div style="text-align: center; padding: 2rem;">
              <p style="margin-top: 1rem; color: #6c757d; font-weight: 500;"></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // Global state
  let currentEpics = [];
  let currentUserStories = [];
  let selectedEpic = null;
  let selectedUserStory = null;
  let currentStoryDetails = null;
  
  // Pending changes from chat interactions
  let pendingEpicChanges = null;
  let pendingUserStoryChanges = null;
  let pendingStoryDetailsChanges = null;
  
  // Track if we're in selection mode (showing radio buttons)
  let isEpicSelectionMode = false;
  let selectedEpicId = null;

  // Initialize the application
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Three Section Layout initialized');
    
    // Safety check for required elements
    const requiredElements = [
      'epics-loading', 'epics-empty', 'epics-list',
      'user-stories-empty', 'user-stories-loading', 'user-stories-list',
      'story-details-empty', 'story-details'
    ];
    
    let missingElements = [];
    for (const elementId of requiredElements) {
      if (!document.getElementById(elementId)) {
        missingElements.push(elementId);
      }
    }
    
    if (missingElements.length > 0) {
      console.error('Missing required elements:', missingElements);
      return;
    }
    
    // Initialize with a small delay to ensure DOM is fully ready
    setTimeout(() => {
      loadEpics();
    }, 100);
  });

  // Load epics from session or backend
  async function loadEpics() {
    try {
      console.log('Loading epics from backend...');
      const response = await fetch('/three-section-get-epics');
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      console.log('Epic loading response:', data);
      
      if (data.success && data.epics && data.epics.length > 0) {
        currentEpics = data.epics;
        displayEpics(currentEpics);
      } else {
        console.log('No epics available, showing empty state');
        showEpicsEmpty();
      }
    } catch (error) {
      console.error('Error loading epics:', error);
      showEpicsEmpty();
    }
  }

  // Display epics in the first section
  function displayEpics(epics) {
    const epicsLoading = document.getElementById('epics-loading');
    const epicsEmpty = document.getElementById('epics-empty');
    const epicsList = document.getElementById('epics-list');
    const epicChatBtn = document.getElementById('epic-chat-btn');

    epicsLoading.style.display = 'none';
    epicsEmpty.style.display = 'none';
    
    // Reset selection mode flag (this is for simple display without radio buttons)
    isEpicSelectionMode = false;
    
    if (epicChatBtn) {
      epicChatBtn.style.display = 'inline-block';
    }

    if (!epics || epics.length === 0) {
      showEpicsEmpty();
      return;
    }

    let html = '';
    epics.forEach((epic, index) => {
      const priority = epic.priority || 'High';
      const priorityClass = priority.toLowerCase().replace(' ', '-');
      
      html += `
        <div class="epic-item" data-epic-id="${epic.id || index}" onclick="selectEpic(${index})">
          <div class="epic-title">${epic.title || `Epic ${index + 1}`}</div>
          <div class="epic-description">${epic.description || epic.summary || 'No description available'}</div>
          <div class="epic-meta">
            <span class="epic-priority priority-${priorityClass}">${priority}</span>
            <span>ID: ${epic.id || `epic-${index + 1}`}</span>
          </div>
        </div>
      `;
    });

    epicsList.innerHTML = html;
    
    // Update chat placeholders with new context
    updateChatPlaceholders();
  }
  
  // Convert epics to radio button HTML format
  function convertEpicsToRadioFormat(epics) {
    console.log('ðŸ”§ convertEpicsToRadioFormat called with:', epics);
    
    if (!epics || epics.length === 0) {
      return '';
    }
    
    let html = '';
    epics.forEach((epic, index) => {
      const priority = epic.priority || 'High';
      const priorityClass = priority.toLowerCase().replace(' ', '-');
      const epicId = epic.id || `epic-${index + 1}`;
      const isSelected = selectedEpicId === epicId;
      
      // Ensure we have full content for display
      const epicTitle = epic.title || `Epic ${index + 1}`;
      const epicDescription = epic.description || epic.summary || 'No description available';
      
      console.log(`ðŸ”§ Processing epic ${index + 1}: ${epicTitle} (ID: ${epicId})`);
      
      html += `
        <div class="selection-card">
          <div class="card-radio">
            <input type="radio" id="epic_${epicId}" name="epic_selection" value="${epicId}" ${isSelected ? 'checked' : ''}>
            <label for="epic_${epicId}"></label>
          </div>
          <div class="card-content">
            <div class="card-header">
              <h5 class="card-title">${epicTitle}</h5>
              <div class="card-meta">
                <span class="priority-badge priority-${priorityClass}">${priority}</span>
              </div>
            </div>
            <p class="card-description">${epicDescription}</p>
          </div>
        </div>
      `;
    });
    
    console.log('ðŸ”§ Generated radio HTML:', html.length, 'characters');
    return html;
  }

  // Display epics using HTML from backend (with radio buttons)
  function displayEpicsHTML(epicsHTML) {
    const epicsLoading = document.getElementById('epics-loading');
    const epicsEmpty = document.getElementById('epics-empty');
    const epicsList = document.getElementById('epics-list');
    const epicChatBtn = document.getElementById('epic-chat-btn');

    epicsLoading.style.display = 'none';
    epicsEmpty.style.display = 'none';
    
    // Set selection mode flag
    isEpicSelectionMode = true;
    
    if (epicChatBtn) {
      epicChatBtn.style.display = 'inline-block';
    }

    if (!epicsHTML || epicsHTML.trim() === '') {
      showEpicsEmpty();
      return;
    }

    epicsList.innerHTML = epicsHTML;
    
    // Add event listeners to radio buttons for epic selection
    const radioButtons = epicsList.querySelectorAll('input[name="epic_selection"]');
    radioButtons.forEach((radio, index) => {
      radio.addEventListener('change', function() {
        if (this.checked) {
          selectEpicByRadio(this.value, index);
          showEpicSubmitButton();
        }
      });
    });
    
    // Add click handlers to card content for easier selection
    const selectionCards = epicsList.querySelectorAll('.selection-card');
    selectionCards.forEach((card, index) => {
      const cardContent = card.querySelector('.card-content');
      if (cardContent) {
        cardContent.addEventListener('click', function() {
          const radio = card.querySelector('input[type="radio"]');
          if (radio) {
            radio.checked = true;
            radio.dispatchEvent(new Event('change'));
          }
        });
      }
    });
    
    // Maintain current selection if available, otherwise auto-select the first epic
    let hasSelection = false;
    if (selectedEpicId && radioButtons.length > 0) {
      const currentSelectedRadio = Array.from(radioButtons).find(r => r.value === selectedEpicId);
      if (currentSelectedRadio) {
        currentSelectedRadio.checked = true;
        hasSelection = true;
        showEpicSubmitButton();
      }
    }
    
    // Auto-select the first epic if no current selection
    if (!hasSelection && radioButtons.length > 0 && !Array.from(radioButtons).some(r => r.checked)) {
      radioButtons[0].checked = true;
      selectEpicByRadio(radioButtons[0].value, 0);
      showEpicSubmitButton();
    }
  }

  // Select epic by radio button value
  function selectEpicByRadio(epicId, epicIndex) {
    // Find the epic by ID
    const epic = currentEpics.find(e => e.id === epicId) || currentEpics[epicIndex];
    if (!epic) {
      console.error('Epic not found:', epicId);
      return;
    }
    
    selectedEpic = epic;
    selectedEpicId = epicId; // Track the selected epic ID
    
    // Clear user stories and story details when a new epic is selected
    showUserStoriesEmpty();
    clearStoryDetails();
  }

  // Show empty state for epics
  function showEpicsEmpty() {
    document.getElementById('epics-loading').style.display = 'none';
    document.getElementById('epics-empty').style.display = 'flex';
    document.getElementById('epics-list').innerHTML = '';
    
    const epicChatBtn = document.getElementById('epic-chat-btn');
    if (epicChatBtn) {
      epicChatBtn.style.display = 'none';
    }
    
    hideEpicSubmitButton();
  }

  // Show epic submit button
  function showEpicSubmitButton() {
    const submitContainer = document.querySelector('.epic-submit-container');
    if (submitContainer) {
      submitContainer.style.display = 'block';
    }
  }

  // Hide epic submit button
  function hideEpicSubmitButton() {
    const submitContainer = document.querySelector('.epic-submit-container');
    if (submitContainer) {
      submitContainer.style.display = 'none';
    }
  }

  // Show user story submit button
  function showUserStorySubmitButton() {
    const submitContainer = document.querySelector('.user-story-submit-container');
    if (submitContainer) {
      submitContainer.style.display = 'block';
    }
  }

  // Hide user story submit button
  function hideUserStorySubmitButton() {
    const submitContainer = document.querySelector('.user-story-submit-container');
    if (submitContainer) {
      submitContainer.style.display = 'none';
    }
  }

  // Handle epic submit button click
  async function submitSelectedEpic() {
    if (!selectedEpic) {
      alert('Please select an epic first.');
      return;
    }
    
    // Show loading state for user stories
    showUserStoriesLoading();
    
    // Clear story details
    clearStoryDetails();

    try {
      // Get the selected epic index for form data
      const epicIndex = currentEpics.findIndex(epic => epic.id === selectedEpic.id);
      
      // Prepare form data for user story creation
      const formData = new FormData();
      formData.append('epic_ids', selectedEpic.id || `epic-${epicIndex + 1}`);
      formData.append('selected_epic_contents', JSON.stringify({[selectedEpic.id || `epic-${epicIndex + 1}`]: selectedEpic}));

      // Call the backend to generate user stories
      const response = await fetch('/three-section-approve-epics', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      
      if (data.success && data.user_stories) {
        currentUserStories = data.user_stories;
        displayUserStories(currentUserStories);
        console.log('User stories generated for epic:', selectedEpic.title);
      } else {
        throw new Error(data.error || 'Failed to generate user stories');
      }
      
    } catch (error) {
      console.error('Error generating user stories:', error);
      showUserStoriesError(`Error generating user stories: ${error.message}`);
    }
  }

  // Select an epic and load its user stories
  async function selectEpic(epicIndex) {
    // Remove previous selection
    document.querySelectorAll('.epic-item').forEach(item => {
      item.classList.remove('selected');
    });

    // Add selection to clicked epic
    const epicItems = document.querySelectorAll('.epic-item');
    if (epicItems[epicIndex]) {
      epicItems[epicIndex].classList.add('selected');
    }

    selectedEpic = currentEpics[epicIndex];
    
    // Show loading state for user stories
    showUserStoriesLoading();
    
    // Clear story details
    clearStoryDetails();

    try {
      const formData = new FormData();
      formData.append('epic_ids', selectedEpic.id || `epic-${epicIndex + 1}`);
      formData.append('selected_epic_contents', JSON.stringify({[selectedEpic.id || `epic-${epicIndex + 1}`]: selectedEpic}));

      const response = await fetch('/three-section-approve-epics', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();
      
      if (data.success && data.user_stories) {
        currentUserStories = data.user_stories;
        displayUserStories(currentUserStories);
      } else {
        showUserStoriesEmpty();
      }
    } catch (error) {
      console.error('Error loading user stories:', error);
      showUserStoriesEmpty();
    }
  }

  // Show loading state for user stories
  function showUserStoriesLoading() {
    document.getElementById('user-stories-empty').style.display = 'none';
    document.getElementById('user-stories-loading').style.display = 'flex';
    document.getElementById('user-stories-list').innerHTML = '';
    document.getElementById('user-story-chat-btn').style.display = 'none';
    hideUserStorySubmitButton();
  }

  // Show empty state for user stories
  function showUserStoriesEmpty() {
    document.getElementById('user-stories-loading').style.display = 'none';
    document.getElementById('user-stories-empty').style.display = 'flex';
    document.getElementById('user-stories-list').innerHTML = '';
    document.getElementById('user-story-chat-btn').style.display = 'none';
    hideUserStorySubmitButton();
  }

  // Show error state for user stories
  function showUserStoriesError(errorMessage) {
    const userStoriesLoading = document.getElementById('user-stories-loading');
    const userStoriesEmpty = document.getElementById('user-stories-empty');
    const userStoriesList = document.getElementById('user-stories-list');
    const userStoryChatBtn = document.getElementById('user-story-chat-btn');

    userStoriesLoading.style.display = 'none';
    userStoriesEmpty.style.display = 'none';
    userStoryChatBtn.style.display = 'none';
    hideUserStorySubmitButton();

    userStoriesList.innerHTML = `
      <div class="error-container text-center py-4">
        <div class="text-danger mb-2">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <p class="text-danger">${errorMessage}</p>
        <button class="btn btn-outline-primary btn-sm" onclick="showUserStoriesEmpty()">
          <i class="fas fa-redo"></i> Try Again
        </button>
      </div>
    `;
  }

  // Display user stories in the second section
  function displayUserStories(userStories) {
    const userStoriesLoading = document.getElementById('user-stories-loading');
    const userStoriesEmpty = document.getElementById('user-stories-empty');
    const userStoriesList = document.getElementById('user-stories-list');
    const userStoryChatBtn = document.getElementById('user-story-chat-btn');

    userStoriesLoading.style.display = 'none';
    userStoriesEmpty.style.display = 'none';
    userStoryChatBtn.style.display = 'inline-block';
    hideUserStorySubmitButton(); // Reset submit button when displaying new user stories

    if (!userStories || userStories.length === 0) {
      showUserStoriesEmpty();
      return;
    }

    let html = '';
    userStories.forEach((story, index) => {
      const storyTitle = story.title || story.name || `User Story ${index + 1}`;
      const storySummary = story.description || story.summary || 'No description available';
      const priority = story.priority || 'Medium';
      const systems = story.systems || story.responsible_systems || ['Unknown System'];
      const systemsText = Array.isArray(systems) ? systems.join(', ') : systems;
      
      html += `
        <div class="modern-story-card" data-story-id="${story.id || index}">
          <div class="story-card-header">
            <div class="story-radio">
              <input type="radio" name="user-story-selection" value="${index}" id="story-${index}" onchange="selectUserStory(${index})">
              <label for="story-${index}"></label>
            </div>
            <div class="story-main-content">
              <div class="story-title-row">
                <h3 class="story-title">${storyTitle}</h3>
                <div class="story-badges">
                  <span class="modern-priority-badge priority-${priority.toLowerCase()}">${priority}</span>
                </div>
              </div>
              <div class="story-meta-row">
                <div class="story-description">${storySummary}</div>
              </div>
              <div class="story-footer">
                <div class="responsible-systems">
                  <i class="system-icon">ðŸ—ï¸</i>
                  <span class="systems-text">${systemsText}</span>
                </div>
                <div class="story-id">ID: ${story.id || `US-${index + 1}`}</div>
              </div>
            </div>
          </div>
        </div>
      `;
    });

    userStoriesList.innerHTML = html;
    
    // Update chat placeholders with new context
    updateChatPlaceholders();
  }

  // Handle user story submit button click
  async function submitSelectedUserStory() {
    if (!selectedUserStory) {
      alert('Please select a user story first.');
      return;
    }
    
    // Show loading state in the third section
    showStoryDetailsLoading();
    
    try {
      // Store the epic title in session for context
      if (selectedEpic) {
        sessionStorage.setItem('current_epic_title', selectedEpic.title || 'Unknown Epic');
      }
      
      // Get the selected user story index for form data
      const storyIndex = currentUserStories.findIndex(story => story.id === selectedUserStory.id);
      
      // Prepare form data for the API call
      const formData = new FormData();
      formData.append('selected_story_id', selectedUserStory.id || `US-${storyIndex + 1}`);
      formData.append('selected_story_name', selectedUserStory.title || selectedUserStory.name || `User Story ${storyIndex + 1}`);
      formData.append('selected_story_description', selectedUserStory.description || selectedUserStory.summary || '');
      
      // Call the API to get story details
      const response = await fetch('/three-section-user-story-details', {
        method: 'POST',
        body: formData
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      
      if (data.success && data.story_details) {
        // Store story details globally so submitToJira works
        currentStoryDetails = data.story_details;
        // Display the story details in the third section
        displayStoryDetails(data.story_details);
        
        // Show the Jira submit button
        const submitBtn = document.getElementById('submit-jira-btn');
        if (submitBtn) {
          submitBtn.style.display = 'block';
        }
        
        console.log('Story details loaded successfully');
      } else {
        throw new Error(data.error || 'Failed to load story details');
      }
      
    } catch (error) {
      console.error('Error loading story details:', error);
      showStoryDetailsError(`Error loading story details: ${error.message}`);
    }
  }

  // Select a user story and show submit button
  function selectUserStory(storyIndex) {
    selectedUserStory = currentUserStories[storyIndex];
    
    // Clear story details when a new user story is selected
    clearStoryDetails();
    
    // Show the user story submit button
    showUserStorySubmitButton();
    
    // Update chat placeholders with new context
    updateChatPlaceholders();
  }

  // Story Details Loading and Error Functions
  function showStoryDetailsLoading() {
    const storyDetailsEmpty = document.getElementById('story-details-empty');
    const storyDetailsDiv = document.getElementById('story-details');
    const submitBtn = document.getElementById('submit-jira-btn');
    
    storyDetailsEmpty.style.display = 'none';
    if (submitBtn) {
      submitBtn.style.display = 'none';
    }
    
    storyDetailsDiv.innerHTML = `
      <div class="loading-container text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="sr-only">Loading...</span>
        </div>
        <p class="mt-2">Loading story details...</p>
      </div>
    `;
  }

  function showStoryDetailsError(errorMessage) {
    const storyDetailsEmpty = document.getElementById('story-details-empty');
    const storyDetailsDiv = document.getElementById('story-details');
    const submitBtn = document.getElementById('submit-jira-btn');
    
    storyDetailsEmpty.style.display = 'none';
    if (submitBtn) {
      submitBtn.style.display = 'none';
    }
    
    storyDetailsDiv.innerHTML = `
      <div class="error-container text-center py-4">
        <div class="text-danger mb-2">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <p class="text-danger">${errorMessage}</p>
        <button class="btn btn-outline-primary btn-sm" onclick="clearStoryDetails()">
          <i class="fas fa-redo"></i> Clear
        </button>
      </div>
    `;
  }

  // Clear story details
  function clearStoryDetails() {
    document.getElementById('story-details-empty').style.display = 'flex';
    document.getElementById('story-details').innerHTML = '';
    document.getElementById('submit-jira-btn').style.display = 'none';
  }

  // Simple markdown to HTML converter for traceability matrix
  function markdownToHtml(markdown) {
    if (!markdown || markdown === 'Not available') {
      return '<p class="text-muted">Not available</p>';
    }
    
    let html = markdown
      // Convert headers (must be at start of line)
      .replace(/^### (.+)$/gm, '<h6>$1</h6>')
      .replace(/^## (.+)$/gm, '<h5>$1</h5>')
      .replace(/^# (.+)$/gm, '<h4>$1</h4>')
      // Convert bold text
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/__(.*?)__/g, '<strong>$1</strong>')
      // Convert italic text
      .replace(/\*(.*?)\*/g, '<em>$1</em>')
      .replace(/_(.*?)_/g, '<em>$1</em>')
      // Convert code blocks first (to avoid conflicts)
      .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
      .replace(/`([^`]+)`/g, '<code>$1</code>')
      // Convert tables (improved handling)
      .replace(/^\|(.+)\|$/gm, function(match, content) {
        const cells = content.split('|').map(cell => cell.trim()).filter(cell => cell);
        return '<tr>' + cells.map(cell => `<td>${cell}</td>`).join('') + '</tr>';
      })
      // Convert bullet points (must be at start of line)
      .replace(/^[\*\-] (.+)$/gm, '<li>$1</li>')
      // Convert numbered lists (must be at start of line)
      .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
      // Convert horizontal rules
      .replace(/^---+$/gm, '<hr>')
      // Convert line breaks (double newlines become paragraph breaks)
      .replace(/\n\s*\n/g, '</p><p>')
      .replace(/\n/g, '<br>');
    
    // Post-process to wrap consecutive list items in ul tags
    html = html.replace(/(<li>.*?<\/li>)(?:\s*<br>\s*<li>.*?<\/li>)*/g, function(match) {
      const items = match.replace(/<br>\s*/g, '').match(/<li>.*?<\/li>/g);
      return '<ul>' + items.join('') + '</ul>';
    });
    
    // Post-process to wrap consecutive table rows in table tags
    if (html.includes('<tr>')) {
      html = html.replace(/(<tr>.*?<\/tr>)(?:\s*<br>\s*<tr>.*?<\/tr>)*/g, function(match) {
        const rows = match.replace(/<br>\s*/g, '').match(/<tr>.*?<\/tr>/g);
        return '<table class="table table-sm table-bordered">' + rows.join('') + '</table>';
      });
    }
    
    // Wrap content in paragraphs if it doesn't start with a block element
    if (!html.match(/^<(h[1-6]|ul|table|pre|hr)/)) {
      html = '<p>' + html + '</p>';
    }
    
    // Clean up empty paragraphs and extra breaks
    html = html.replace(/<p><\/p>/g, '').replace(/<p><br><\/p>/g, '');
    
    return html;
  }

  // Display story details in the third section
  function displayStoryDetails(storyDetails) {
    const storyDetailsEmpty = document.getElementById('story-details-empty');
    const storyDetailsDiv = document.getElementById('story-details');

    storyDetailsEmpty.style.display = 'none';

    const acceptanceCriteria = storyDetails.acceptance_criteria || [];
    const taggedRequirements = storyDetails.tagged_requirements || [];
    const traceabilityMatrix = storyDetails.traceability_matrix || 'Not available';

    let html = `
      <div class="detail-section">
        <div class="detail-title">
          Story Overview
          <button class="chat-btn" onclick="openStoryDetailsChat('description')">ðŸ’¬ Chat</button>
        </div>
        <div class="detail-content">
          <strong>Epic:</strong> ${selectedEpic?.title || 'Unknown Epic'}<br>
          <strong>Story:</strong> ${selectedUserStory?.title || selectedUserStory?.name || 'Unknown Story'}<br>
          <strong>Description:</strong> ${selectedUserStory?.description || selectedUserStory?.summary || 'No description available'}
        </div>
      </div>

      <div class="detail-section">
        <div class="detail-title">
          Acceptance Criteria
          <button class="chat-btn" onclick="openStoryDetailsChat('criteria')">ðŸ’¬ Chat</button>
        </div>
        <div class="detail-content">
          ${acceptanceCriteria.length > 0 ? 
            `<ul class="criteria-list">${acceptanceCriteria.map(criteria => `<li>${criteria}</li>`).join('')}</ul>` :
            '<p>No acceptance criteria defined yet.</p>'
          }
        </div>
      </div>

      <div class="detail-section">
        <div class="detail-title">
          Tagged Requirements
          <button class="chat-btn" onclick="openStoryDetailsChat('requirements')">ðŸ’¬ Chat</button>
        </div>
        <div class="detail-content">
          ${taggedRequirements.length > 0 ? 
            `<ul class="criteria-list">${taggedRequirements.map(req => `<li>${req}</li>`).join('')}</ul>` :
            '<p>No tagged requirements defined yet.</p>'
          }
        </div>
      </div>

      <div class="detail-section">
        <div class="detail-title">
          Traceability Matrix
          <button class="chat-btn" onclick="openStoryDetailsChat('traceability')">ðŸ’¬ Chat</button>
        </div>
        <div class="detail-content">
          <div class="traceability-matrix" style="background: var(--surface-tertiary); padding: var(--spacing-md); border-radius: var(--radius-sm); border: 1px solid var(--border-light);">
            ${markdownToHtml(traceabilityMatrix)}
          </div>
        </div>
      </div>
    `;

    storyDetailsDiv.innerHTML = html;
    
    // Update chat placeholders with new context
    updateChatPlaceholders();
  }

  // Epic Chat Functions
  function openEpicChat() {
    // Clear previous chat history when opening
    clearEpicChatHistory();
    
    // Initialize Apply button state
    hideEpicApplyButton();
    
    // Update chat button states
    updateChatButtonStates();
    
    document.getElementById('epic-chat-modal').style.display = 'block';
    setTimeout(() => {
      document.getElementById('epic-chat-input').focus();
    }, 100);
  }

  function closeEpicChat() {
    document.getElementById('epic-chat-modal').style.display = 'none';
  }

  // Temporary test function for debugging - REMOVE AFTER TESTING
  function debugEnableApply() {
    console.log('ðŸ”§ DEBUG: Manually enabling Apply button for testing');
    console.log('ðŸ”§ Current epics:', currentEpics);
    console.log('ðŸ”§ isEpicSelectionMode:', isEpicSelectionMode);
    
    if (currentEpics && currentEpics.length > 0) {
      // Create test data with modified priorities
      const testChanges = currentEpics.map((epic, index) => ({
        ...epic,
        priority: index % 2 === 0 ? 'Low' : 'Medium',
        description: epic.description + ' [MODIFIED BY TEST]'
      }));
      
      pendingEpicChanges = testChanges;
      console.log('ðŸ”§ Test changes created:', testChanges);
      
      showEpicApplyButton('ðŸ”§ DEBUG: Apply button enabled for testing');
      addEpicChatMessage('ðŸ”§ DEBUG: Apply button enabled manually. Test data will change priorities and add [MODIFIED BY TEST] to descriptions.', 'assistant');
    } else {
      addEpicChatMessage('âš ï¸ No epics available for testing.', 'assistant');
    }
  }

  function clearEpicChatHistory() {
    const messagesContainer = document.getElementById('epic-chat-messages');
    // Keep only the initial welcome message
    messagesContainer.innerHTML = `
      <div class="chat-message">
        <div class="chat-bubble">
          Hello! I can help you refine your epics. Ask me to make changes, add details, or reorganize them.
        </div>
      </div>
    `;
    // Hide apply button and clear pending changes
    hideEpicApplyButton();
    pendingEpicChanges = null;
  }

  function handleEpicChatEnter(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      sendEpicMessage();
    } else if (event.key === 'Escape') {
      closeEpicChat();
    }
  }

  async function sendEpicMessage() {
    const input = document.getElementById('epic-chat-input');
    const message = input.value.trim();
    
    if (!message) return;

    // Validate that we have epics to chat about
    if (!currentEpics || currentEpics.length === 0) {
      addEpicChatMessage('Please generate some epics first before using the chat feature.', 'assistant');
      return;
    }

    console.log('ðŸ”§ Sending epic message:', message);
    console.log('ðŸ”§ Current epics being sent:', currentEpics);

    // Add user message to chat
    addEpicChatMessage(message, 'user');
    input.value = '';

    // Add loading message
    const loadingId = addEpicChatMessage('...', 'assistant', true);

    try {
      const response = await fetch('/three-section-epic-chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: message,
          epics: currentEpics
        })
      });

      // Remove loading message
      removeEpicChatMessage(loadingId);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      
      console.log('ðŸ”§ Epic chat response received:');
      console.log('ðŸ”§ Full response data:', data);
      console.log('ðŸ”§ Response text:', data.response);
      console.log('ðŸ”§ Updated epics:', data.updated_epics);
      console.log('ðŸ”§ Has updated_epics?', !!data.updated_epics);
      console.log('ðŸ”§ Is array?', Array.isArray(data.updated_epics));
      console.log('ðŸ”§ Array length:', data.updated_epics ? data.updated_epics.length : 'N/A');
      
      if (data.success) {
        // Add the AI response - it should already be in natural language from backend
        let aiResponse = data.response;
        
        // Remove any JSON formatting detection - backend should handle this
        console.log('ðŸ”§ Epic chat response received:', aiResponse);
        
        addEpicChatMessage(aiResponse, 'assistant');
        
        // Always check for updated_epics in the response, regardless of the format
        if (data.updated_epics && Array.isArray(data.updated_epics) && data.updated_epics.length > 0) {
          pendingEpicChanges = data.updated_epics;
          console.log('ðŸ”§ Pending epic changes set:', pendingEpicChanges);
          showEpicApplyButton('AI has suggested changes to your epics. Click Apply to update them.');
          addEpicChatMessage('ðŸ’¡ AI has suggested changes to your epics. Review them and click "Apply Changes" when ready.', 'assistant');
        } else {
          console.log('ðŸ”§ No updated_epics in response, Apply button will not be enabled');
          console.log('ðŸ”§ Response data structure:', data);
        }
      } else {
        addEpicChatMessage(`Sorry, there was an error: ${data.error || 'Unknown error'}`, 'assistant');
      }
    } catch (error) {
      console.error('Error in epic chat:', error);
      
      // Remove loading message if it still exists
      removeEpicChatMessage(loadingId);
      
      addEpicChatMessage('Sorry, there was a connection error. Please check your network and try again.', 'assistant');
    }
  }

  function addEpicChatMessage(message, sender, isLoading = false) {
    const messagesContainer = document.getElementById('epic-chat-messages');
    const messageDiv = document.createElement('div');
    const messageId = 'msg-' + Date.now();
    messageDiv.id = messageId;
    messageDiv.className = `chat-message ${sender}`;
    
    if (isLoading) {
      messageDiv.innerHTML = `
        <div class="chat-bubble">
          <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      `;
    } else {
      // Escape HTML to prevent XSS, but allow line breaks
      const escapedMessage = message
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/\n/g, '<br>');
      
      messageDiv.innerHTML = `
        <div class="chat-bubble">${escapedMessage}</div>
      `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
  }

  function removeEpicChatMessage(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (messageDiv) {
      messageDiv.remove();
    }
  }

  // User Story Chat Functions
  function openUserStoryChat() {
    // Clear previous chat history when opening
    clearUserStoryChatHistory();
    
    // Initialize Apply button state
    hideUserStoryApplyButton();
    
    document.getElementById('user-story-chat-modal').style.display = 'block';
    setTimeout(() => {
      document.getElementById('user-story-chat-input').focus();
    }, 100);
  }

  function closeUserStoryChat() {
    document.getElementById('user-story-chat-modal').style.display = 'none';
  }

  function clearUserStoryChatHistory() {
    const messagesContainer = document.getElementById('user-story-chat-messages');
    // Keep only the initial welcome message
    messagesContainer.innerHTML = `
      <div class="chat-message">
        <div class="chat-bubble">
          Hello! I can help you refine your user stories. Ask me to make changes, add details, or reorganize them.
        </div>
      </div>
    `;
    // Hide apply button and clear pending changes
    hideUserStoryApplyButton();
    pendingUserStoryChanges = null;
  }

  function handleUserStoryChatEnter(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      sendUserStoryMessage();
    } else if (event.key === 'Escape') {
      closeUserStoryChat();
    }
  }

  async function sendUserStoryMessage() {
    const input = document.getElementById('user-story-chat-input');
    const message = input.value.trim();
    
    if (!message) return;

    // Validate that we have user stories and a selected epic to chat about
    if (!currentUserStories || currentUserStories.length === 0) {
      addUserStoryChatMessage('Please select an epic and generate user stories first before using the chat feature.', 'assistant');
      return;
    }

    if (!selectedEpic) {
      addUserStoryChatMessage('Please select an epic first before chatting about user stories.', 'assistant');
      return;
    }

    // Add user message to chat
    addUserStoryChatMessage(message, 'user');
    input.value = '';

    // Add loading message
    const loadingId = addUserStoryChatMessage('...', 'assistant', true);

    try {
      const response = await fetch('/three-section-user-story-chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: message,
          user_stories: currentUserStories,
          epic: selectedEpic
        })
      });

      // Remove loading message
      removeUserStoryChatMessage(loadingId);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      
      console.log('ðŸ”§ User Story chat response received:');
      console.log('ðŸ”§ Full response data:', data);
      console.log('ðŸ”§ Response text:', data.response);
      console.log('ðŸ”§ Updated user stories:', data.updated_user_stories);
      console.log('ðŸ”§ Has updated_user_stories?', !!data.updated_user_stories);
      console.log('ðŸ”§ Is array?', Array.isArray(data.updated_user_stories));
      console.log('ðŸ”§ Array length:', data.updated_user_stories ? data.updated_user_stories.length : 'N/A');
      
      if (data.success) {
        // Add the AI response - it should already be in natural language from backend
        let aiResponse = data.response;
        
        // Remove any JSON formatting detection - backend should handle this
        console.log('ðŸ”§ User Story chat response received:', aiResponse);
        
        addUserStoryChatMessage(aiResponse, 'assistant');
        
        // Always check for updated_user_stories in the response, regardless of the format
        if (data.updated_user_stories && Array.isArray(data.updated_user_stories) && data.updated_user_stories.length > 0) {
          pendingUserStoryChanges = data.updated_user_stories;
          console.log('ðŸ”§ Pending user story changes set:', pendingUserStoryChanges);
          showUserStoryApplyButton('AI has suggested changes to your user stories. Click Apply to update them.');
          addUserStoryChatMessage('ðŸ’¡ AI has suggested changes to your user stories. Review them and click "Apply Changes" when ready.', 'assistant');
        } else {
          console.log('ðŸ”§ No updated_user_stories in response, Apply button will not be enabled');
          console.log('ðŸ”§ Response data structure:', data);
        }
      } else {
        addUserStoryChatMessage(`Sorry, there was an error: ${data.error || 'Unknown error'}`, 'assistant');
      }
    } catch (error) {
      console.error('Error in user story chat:', error);
      
      // Remove loading message if it still exists
      removeUserStoryChatMessage(loadingId);
      
      addUserStoryChatMessage('Sorry, there was a connection error. Please check your network and try again.', 'assistant');
    }
  }

  function addUserStoryChatMessage(message, sender, isLoading = false) {
    const messagesContainer = document.getElementById('user-story-chat-messages');
    const messageDiv = document.createElement('div');
    const messageId = 'msg-' + Date.now();
    messageDiv.id = messageId;
    messageDiv.className = `chat-message ${sender}`;
    
    if (isLoading) {
      messageDiv.innerHTML = `
        <div class="chat-bubble">
          <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      `;
    } else {
      // Escape HTML to prevent XSS, but allow line breaks
      const escapedMessage = message
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/\n/g, '<br>');
      
      messageDiv.innerHTML = `
        <div class="chat-bubble">${escapedMessage}</div>
      `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
  }

  function removeUserStoryChatMessage(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (messageDiv) {
      messageDiv.remove();
    }
  }

  // Story Details Chat Functions
  function openStoryDetailsChat(section) {
    // Clear previous chat history when opening
    clearStoryDetailsChatHistory();
    
    // Initialize Apply button state
    hideStoryDetailsApplyButton();
    
    document.getElementById('story-details-chat-modal').style.display = 'block';
    // Store which section we're chatting about
    document.getElementById('story-details-chat-modal').setAttribute('data-section', section);
    
    // Update the chat header to show which section we're chatting about
    updateStoryDetailsModalHeader(section);
    
    setTimeout(() => {
      document.getElementById('story-details-chat-input').focus();
    }, 100);
  }

  function closeStoryDetailsChat() {
    document.getElementById('story-details-chat-modal').style.display = 'none';
  }

  function clearStoryDetailsChatHistory() {
    const messagesContainer = document.getElementById('story-details-chat-messages');
    // Keep only the initial welcome message
    messagesContainer.innerHTML = `
      <div class="chat-message">
        <div class="chat-bubble">
          Hello! I can help you refine story details, acceptance criteria, and traceability.
        </div>
      </div>
    `;
    // Hide apply button and clear pending changes
    hideStoryDetailsApplyButton();
    pendingStoryDetailsChanges = null;
  }

  function updateStoryDetailsModalHeader(section) {
    const modal = document.getElementById('story-details-chat-modal');
    const header = modal.querySelector('.chat-header h4');
    
    const sectionNames = {
      'description': 'Story Description',
      'criteria': 'Acceptance Criteria',
      'requirements': 'Tagged Requirements',
      'traceability': 'Traceability Matrix'
    };
    
    const sectionName = sectionNames[section] || 'Story Details';
    header.textContent = `${sectionName} Chat`;
  }

  function handleStoryDetailsChatEnter(event) {
    if (event.key === 'Enter' && !event.shiftKey) {
      event.preventDefault();
      sendStoryDetailsMessage();
    } else if (event.key === 'Escape') {
      closeStoryDetailsChat();
    }
  }

  async function sendStoryDetailsMessage() {
    const input = document.getElementById('story-details-chat-input');
    const message = input.value.trim();
    const section = document.getElementById('story-details-chat-modal').getAttribute('data-section');
    
    if (!message) return;

    // Validate that we have the required context
    if (!selectedUserStory) {
      addStoryDetailsChatMessage('Please select a user story first before using the chat feature.', 'assistant');
      return;
    }

    if (!currentStoryDetails) {
      addStoryDetailsChatMessage('Please load story details first before using the chat feature.', 'assistant');
      return;
    }

    // Add user message to chat
    addStoryDetailsChatMessage(message, 'user');
    input.value = '';

    // Add loading message
    const loadingId = addStoryDetailsChatMessage('...', 'assistant', true);

    try {
      const response = await fetch('/three-section-story-details-chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: message,
          section: section || 'general',
          story_details: currentStoryDetails,
          user_story: selectedUserStory,
          epic: selectedEpic
        })
      });

      // Remove loading message
      removeStoryDetailsChatMessage(loadingId);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      
      console.log('Story Details chat response data:', data);
      console.log('Updated story details in response:', data.updated_story_details);
      
      if (data.success) {
        // Add the AI response - ensure it's properly formatted
        let aiResponse = data.response;
        
        // Check if the response looks like JSON and try to format it better
        if (aiResponse && (aiResponse.startsWith('{') || aiResponse.startsWith('['))) {
          console.warn('Response appears to be JSON, attempting to format it better');
          try {
            const jsonData = JSON.parse(aiResponse);
            // Convert JSON to a more readable format
            aiResponse = `Here are the suggested changes:\n${JSON.stringify(jsonData, null, 2)}`;
          } catch (e) {
            console.warn('Could not parse response as JSON, using as-is');
          }
        }
        
        addStoryDetailsChatMessage(aiResponse, 'assistant');
        
        if (data.updated_story_details) {
          pendingStoryDetailsChanges = data.updated_story_details;
          console.log('Pending story details changes set:', pendingStoryDetailsChanges);
          showStoryDetailsApplyButton('AI has suggested changes to your story details. Click Apply to update them.');
          addStoryDetailsChatMessage('ðŸ’¡ AI has suggested changes to your story details. Review them and click "Apply Changes" when ready.', 'assistant');
        } else {
          console.log('No updated_story_details in response, Apply button will not be enabled');
        }
      } else {
        addStoryDetailsChatMessage(`Sorry, there was an error: ${data.error || 'Unknown error'}`, 'assistant');
      }
    } catch (error) {
      console.error('Error in story details chat:', error);
      
      // Remove loading message if it still exists
      removeStoryDetailsChatMessage(loadingId);
      
      addStoryDetailsChatMessage('Sorry, there was a connection error. Please check your network and try again.', 'assistant');
    }
  }

  function addStoryDetailsChatMessage(message, sender, isLoading = false) {
    const messagesContainer = document.getElementById('story-details-chat-messages');
    const messageDiv = document.createElement('div');
    const messageId = 'msg-' + Date.now();
    messageDiv.id = messageId;
    messageDiv.className = `chat-message ${sender}`;
    
    if (isLoading) {
      messageDiv.innerHTML = `
        <div class="chat-bubble">
          <div class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      `;
    } else {
      // Escape HTML to prevent XSS, but allow line breaks
      const escapedMessage = message
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/\n/g, '<br>');
      
      messageDiv.innerHTML = `
        <div class="chat-bubble">${escapedMessage}</div>
      `;
    }
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    return messageId;
  }

  function removeStoryDetailsChatMessage(messageId) {
    const messageDiv = document.getElementById(messageId);
    if (messageDiv) {
      messageDiv.remove();
    }
  }

  // Apply Changes Functions
  function applyEpicChanges() {
    console.log('ðŸ”§ applyEpicChanges called');
    console.log('ðŸ”§ pendingEpicChanges:', pendingEpicChanges);
    console.log('ðŸ”§ isEpicSelectionMode:', isEpicSelectionMode);
    
    if (pendingEpicChanges) {
      currentEpics = pendingEpicChanges;
      
      // If we were in selection mode, maintain it by converting to radio format
      if (isEpicSelectionMode) {
        console.log('ðŸ”§ Was in selection mode, converting to radio format');
        const radioHTML = convertEpicsToRadioFormat(currentEpics);
        console.log('ðŸ”§ Generated radio HTML length:', radioHTML.length);
        displayEpicsHTML(radioHTML);
      } else {
        // Regular display mode
        console.log('ðŸ”§ Using regular display mode');
        displayEpics(currentEpics);
      }
      
      pendingEpicChanges = null;
      hideEpicApplyButton();
      addEpicChatMessage('âœ… Epic changes have been applied successfully!', 'assistant');
    } else {
      addEpicChatMessage('No pending changes to apply. Please ask me to modify your epics first.', 'assistant');
    }
  }

  function applyUserStoryChanges() {
    console.log('ðŸ”§ applyUserStoryChanges called');
    console.log('ðŸ”§ pendingUserStoryChanges:', pendingUserStoryChanges);
    
    if (pendingUserStoryChanges) {
      currentUserStories = pendingUserStoryChanges;
      displayUserStories(currentUserStories);
      pendingUserStoryChanges = null;
      hideUserStoryApplyButton();
      addUserStoryChatMessage('âœ… User story changes have been applied successfully!', 'assistant');
      console.log('ðŸ”§ User story changes applied successfully');
    } else {
      addUserStoryChatMessage('No pending changes to apply. Please ask me to modify your user stories first.', 'assistant');
      console.log('ðŸ”§ No pending user story changes to apply');
    }
  }

  function applyStoryDetailsChanges() {
    if (pendingStoryDetailsChanges) {
      currentStoryDetails = pendingStoryDetailsChanges;
      displayStoryDetails(currentStoryDetails);
      pendingStoryDetailsChanges = null;
      hideStoryDetailsApplyButton();
      addStoryDetailsChatMessage('âœ… Story detail changes have been applied successfully!', 'assistant');
    }
  }

  // Show/Hide Apply Button Functions
  function showEpicApplyButton(info = 'Changes suggested by AI are ready to apply') {
    console.log('ðŸ”§ showEpicApplyButton called with info:', info);
    const container = document.getElementById('epic-chat-apply-container');
    const infoSpan = document.getElementById('epic-apply-info');
    const button = document.getElementById('epic-apply-btn');
    
    console.log('ðŸ”§ Elements found:', { container: !!container, infoSpan: !!infoSpan, button: !!button });
    
    if (container && infoSpan && button) {
      infoSpan.textContent = info;
      container.classList.add('show');
      button.disabled = false;
      button.style.opacity = '1';
      button.style.backgroundColor = '#28a745'; // Green color for enabled state
      
      // Ensure the container is visible and properly positioned
      container.style.display = 'flex';
      container.style.position = 'relative';
      container.style.zIndex = '1';
      
      console.log('ðŸ”§ Apply button enabled successfully');
      console.log('ðŸ”§ Button state - disabled:', button.disabled, 'opacity:', button.style.opacity);
    } else {
      console.error('ðŸ”§ Failed to find required elements for Apply button');
    }
  }

  function hideEpicApplyButton() {
    console.log('ðŸ”§ hideEpicApplyButton called');
    const container = document.getElementById('epic-chat-apply-container');
    const button = document.getElementById('epic-apply-btn');
    const infoSpan = document.getElementById('epic-apply-info');
    if (container && button && infoSpan) {
      button.disabled = true;
      button.style.opacity = '0.6';
      button.style.backgroundColor = ''; // Reset to default color
      infoSpan.textContent = 'Ask me to modify your epics and I\'ll suggest changes for you to apply';
      console.log('ðŸ”§ Apply button disabled successfully');
    }
  }

  function showUserStoryApplyButton(info = 'Changes suggested by AI are ready to apply') {
    console.log('ðŸ”§ showUserStoryApplyButton called with info:', info);
    const container = document.getElementById('user-story-chat-apply-container');
    const infoSpan = document.getElementById('user-story-apply-info');
    const button = document.getElementById('user-story-apply-btn');
    
    console.log('ðŸ”§ User Story Apply Elements found:', { container: !!container, infoSpan: !!infoSpan, button: !!button });
    
    if (container && infoSpan && button) {
      infoSpan.textContent = info;
      container.classList.add('show');
      button.disabled = false;
      button.style.opacity = '1';
      button.style.backgroundColor = '#28a745'; // Green color for enabled state
      
      // Ensure the container is visible and properly positioned
      container.style.display = 'flex';
      container.style.position = 'relative';
      container.style.zIndex = '1';
      
      console.log('ðŸ”§ User Story Apply button enabled successfully');
      console.log('ðŸ”§ Button state - disabled:', button.disabled, 'opacity:', button.style.opacity);
    } else {
      console.error('ðŸ”§ Failed to find required elements for User Story Apply button');
    }
  }

  function hideUserStoryApplyButton() {
    console.log('ðŸ”§ hideUserStoryApplyButton called');
    const container = document.getElementById('user-story-chat-apply-container');
    const button = document.getElementById('user-story-apply-btn');
    const infoSpan = document.getElementById('user-story-apply-info');
    if (container && button && infoSpan) {
      button.disabled = true;
      button.style.opacity = '0.6';
      button.style.backgroundColor = ''; // Reset to default color
      infoSpan.textContent = 'Ask me to modify user stories and I\'ll suggest changes for you to apply';
      container.classList.remove('show');
      console.log('ðŸ”§ User Story Apply button disabled successfully');
    }
  }

  function showStoryDetailsApplyButton(info = 'Changes suggested by AI are ready to apply') {
    console.log('showStoryDetailsApplyButton called with info:', info);
    const container = document.getElementById('story-details-chat-apply-container');
    const infoSpan = document.getElementById('story-details-apply-info');
    const button = document.getElementById('story-details-apply-btn');
    
    console.log('Story Details Apply Elements found:', { container: !!container, infoSpan: !!infoSpan, button: !!button });
    
    if (container && infoSpan && button) {
      infoSpan.textContent = info;
      container.classList.add('show');
      button.disabled = false;
      button.style.opacity = '1';
      console.log('Story Details Apply button enabled successfully');
    } else {
      console.error('Failed to find required elements for Story Details Apply button');
    }
  }

  function hideStoryDetailsApplyButton() {
    const container = document.getElementById('story-details-chat-apply-container');
    const button = document.getElementById('story-details-apply-btn');
    const infoSpan = document.getElementById('story-details-apply-info');
    if (container && button && infoSpan) {
      button.disabled = true;
      button.style.opacity = '0.6';
      infoSpan.textContent = 'Ask me to modify story details and I\'ll suggest changes for you to apply';
      container.classList.remove('show');
    }
  }

  // Enhanced PRD Upload Functions with Full Features
  let prdPreviewData = null;

  // Timer utility functions for PRD upload - ADDED TIMER FUNCTIONALITY
  let uploadTimer = null;
  let uploadStartTime = null;

  // Show PRD button loading with timer
  function showPRDButtonLoading(button, spinner, loadingText) {
    button.disabled = true;
    if (spinner) {
      spinner.style.display = 'inline-block';
    }
    const btnText = button.querySelector('.btn-text');
    if (btnText) {
      btnText.textContent = loadingText;
    }
    
    // Start timer for upload button
    if (button.id === 'prd-upload-btn') {
      startUploadTimer();
    }
  }

  function hidePRDButtonLoading(button, spinner, originalText) {
    button.disabled = false;
    if (spinner) {
      spinner.style.display = 'none';
    }
    const btnText = button.querySelector('.btn-text');
    if (btnText) {
      btnText.textContent = originalText;
    }
    
    // Stop timer for upload button
    if (button.id === 'prd-upload-btn') {
      stopUploadTimer();
    }
  }

  function startUploadTimer() {
    const timerDisplay = document.getElementById('upload-timer');
    if (timerDisplay) {
      timerDisplay.style.display = 'inline';
      uploadStartTime = Date.now();
      
      uploadTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - uploadStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        timerDisplay.textContent = `(${minutes}:${seconds.toString().padStart(2, '0')})`;
      }, 1000);
    }
  }

  function stopUploadTimer() {
    if (uploadTimer) {
      clearInterval(uploadTimer);
      uploadTimer = null;
    }
    const timerDisplay = document.getElementById('upload-timer');
    if (timerDisplay) {
      timerDisplay.style.display = 'none';
      timerDisplay.textContent = '(0:00)';
    }
  }

  // Show PRD alert messages
  function showPRDAlert(message, type = 'info') {
    const alertContainer = document.getElementById('prd-alert-container');
    const alertId = 'prd-alert-' + Date.now();
    
    const alertHTML = `
      <div class="alert alert-${type}" id="${alertId}" role="alert">
        <div>
          <strong>${type === 'success' ? 'âœ…' : type === 'danger' ? 'âŒ' : 'â„¹ï¸'}</strong>
          ${message}
        </div>
        <button type="button" class="btn-close" onclick="document.getElementById('${alertId}').remove()">Ã—</button>
      </div>
    `;
    
    alertContainer.innerHTML = alertHTML;
    
    // Auto-remove success alerts after 5 seconds
    if (type === 'success') {
      setTimeout(() => {
        const alert = document.getElementById(alertId);
        if (alert) alert.remove();
      }, 5000);
    }
  }

  // Handle file selection and validation
  function handlePRDFileSelect() {
    const fileInput = document.getElementById('prd-file');
    const file = fileInput.files[0];
    
    if (file) {
      // Check file size
      const maxSize = 50 * 1024 * 1024; // 50MB
      if (file.size > maxSize) {
        showPRDAlert('File size exceeds 50MB limit. Please choose a smaller file.', 'danger');
        fileInput.value = '';
        return;
      }
      
      // Show file info
      const fileSize = (file.size / 1024).toFixed(1);
      showPRDAlert(`PRD file selected: ${file.name} (${fileSize} KB)`, 'success');
      
      // Enable form submission if this is the first file
      const submitBtn = document.getElementById('prd-upload-btn');
      submitBtn.disabled = false;
    }
  }

  function handleAdditionalFilesSelect() {
    const fileInput = document.getElementById('additional-file');
    const files = fileInput.files;
    
    if (files.length > 0) {
      let totalSize = 0;
      let fileNames = [];
      
      for (let i = 0; i < files.length; i++) {
        totalSize += files[i].size;
        fileNames.push(files[i].name);
      }
      
      // Check total size
      const maxSize = 100 * 1024 * 1024; // 100MB total
      if (totalSize > maxSize) {
        showPRDAlert('Total file size exceeds 100MB limit. Please choose smaller files.', 'danger');
        fileInput.value = '';
        return;
      }
      
      const totalSizeKB = (totalSize / 1024).toFixed(1);
      showPRDAlert(`${files.length} additional file(s) selected (${totalSizeKB} KB total)`, 'success');
    }
  }

  // Update step indicators
  function updatePRDStepIndicator(activeStep) {
    const step1 = document.getElementById('step-1');
    const step2 = document.getElementById('step-2');
    
    // Reset classes
    step1.className = 'step';
    step2.className = 'step';
    
    if (activeStep === 1) {
      step1.className = 'step active';
    } else if (activeStep === 2) {
      step1.className = 'step completed';
      step2.className = 'step active';
    }
  }

  // Show PRD upload modal
  function showPRDUpload() {
    document.getElementById('prd-upload-modal').style.display = 'block';
    
    // Reset modal state
    resetPRDUpload();
    
    // Set initial step
    updatePRDStepIndicator(1);
  }

  // Close PRD upload modal
  function closePRDUpload() {
    document.getElementById('prd-upload-modal').style.display = 'none';
  }

  // Reset PRD upload modal to initial state
  function resetPRDUpload() {
    // Clear form
    document.getElementById('prd-document-form').reset();
    
    // Clear alerts
    document.getElementById('prd-alert-container').innerHTML = '';
    
    // Hide preview sections
    document.getElementById('prd-summary-section').style.display = 'none';
    document.getElementById('additional-docs-section').style.display = 'none';
    document.getElementById('user-context-section').style.display = 'none';
    document.getElementById('prd-loading-spinner').style.display = 'none';
    document.getElementById('prd-epic-spinner').style.display = 'none';
    
    // Show upload section
    document.getElementById('upload-step-1').style.display = 'block';
    
    // Reset step indicator
    updatePRDStepIndicator(1);
    
    // Reset buttons
    const uploadBtn = document.getElementById('prd-upload-btn');
    const generateBtn = document.getElementById('generate-epics-btn');
    
    hidePRDButtonLoading(uploadBtn, null, 'ðŸš€ Upload & Preview Documents');
    hidePRDButtonLoading(generateBtn, null, 'âš¡ Generate Epics & User Stories');
    
    // Reset preview data
    prdPreviewData = null;
    
    // Show reset button
    document.getElementById('reset-prd-btn').style.display = 'none';
  }

  // Handle document upload and preview
  async function handlePRDDocumentUpload(event) {
    console.log('handlePRDDocumentUpload called');
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const uploadBtn = document.getElementById('prd-upload-btn');
    const loadingSpinner = document.getElementById('prd-loading-spinner');
    
    console.log('Form elements found:', {
      uploadBtn: !!uploadBtn,
      loadingSpinner: !!loadingSpinner
    });
    
    // Validate input
    const prdFile = document.getElementById('prd-file').files[0];
    const context = document.getElementById('context-notes').value.trim();
    
    console.log('Form data:', {
      prdFile: !!prdFile,
      context: context.length > 0
    });
    
    if (!prdFile && !context) {
      console.log('Validation failed - no file or context');
      showPRDAlert('Please upload a PRD file or provide additional context.', 'danger');
      return;
    }
    
    // Check for large files and warn user
    let totalSize = 0;
    const allFiles = [
      ...document.getElementById('prd-file').files,
      ...document.getElementById('additional-file').files
    ];
    
    for (const file of allFiles) {
      totalSize += file.size;
    }
    
    const largeFileThreshold = 20 * 1024; // 20KB
    if (totalSize > largeFileThreshold) {
      const proceed = confirm(
        `Large files detected (${(totalSize / 1024).toFixed(1)} KB). ` +
        'Processing may take 1-3 minutes. Do you want to continue?'
      );
      if (!proceed) {
        return;
      }
    }
    
    try {
      console.log('Starting upload process...');
      // Show loading state
      showPRDButtonLoading(uploadBtn, null, 'Processing...');
      loadingSpinner.style.display = 'block';
      
      // Update loading message for large files
      if (totalSize > largeFileThreshold) {
        const loadingMessage = loadingSpinner.querySelector('p');
        if (loadingMessage) {
          loadingMessage.textContent = '';
        }
      }
      
      console.log('About to make fetch request to /three-section-document-upload');
      // Make request with timeout
      const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('Request timeout - file processing took too long')), 300000);
      });
      
      const fetchPromise = fetch('/three-section-document-upload', {
        method: 'POST',
        body: formData
      });
      
      console.log('Waiting for response...');
      const response = await Promise.race([fetchPromise, timeoutPromise]);
      console.log('Response received:', response.status, response.statusText);
      
      const data = await response.json();
      console.log('Response data:', data);
      
      if (data.success) {
        console.log('Upload successful, showing preview');
        // Store preview data
        prdPreviewData = data;
        
        // Show preview section
        displayPRDPreview(data);
        
        // Update step indicator
        updatePRDStepIndicator(2);
        
        // Hide upload section and show preview
        document.getElementById('upload-step-1').style.display = 'none';
        document.getElementById('upload-step-2').style.display = 'block';
        
        showPRDAlert('Documents processed successfully! Review the summary and generate epics.', 'success');
      } else {
        console.log('Upload failed:', data.error);
        throw new Error(data.error || 'Failed to process documents');
      }
      
    } catch (error) {
      console.error('Error uploading documents:', error);
      showPRDAlert(`Error processing documents: ${error.message}`, 'danger');
    } finally {
      // Hide loading
      loadingSpinner.style.display = 'none';
      hidePRDButtonLoading(uploadBtn, null, 'ï¿½ Upload & Preview Documents');
    }
  }

  // Display PRD preview data
  function displayPRDPreview(data) {
    // PRD Summary
    if (data.prd_summary) {
      const prdFilename = document.getElementById('prd-filename-display');
      const prdSummary = document.getElementById('prd-summary-content');
      
      if (data.prd_filename) {
        prdFilename.innerHTML = `<span class="filename-tag">${data.prd_filename}</span>`;
      }
      
      prdSummary.textContent = data.prd_summary;
      document.getElementById('prd-summary-section').style.display = 'block';
    }
    
    // Additional Documents Summary
    if (data.additional_summary) {
      const docsFilename = document.getElementById('additional-docs-filename');
      const docsSummary = document.getElementById('additional-docs-summary');
      
      if (data.additional_filenames && data.additional_filenames.length > 0) {
        docsFilename.innerHTML = data.additional_filenames.map(filename => 
          `<span class="filename-tag">${filename}</span>`
        ).join('');
      }
      
      docsSummary.textContent = data.additional_summary;
      document.getElementById('additional-docs-section').style.display = 'block';
    }
    
    // User Context
    if (data.context) {
      const userContext = document.getElementById('user-context-display');
      userContext.textContent = data.context;
      document.getElementById('user-context-section').style.display = 'block';
    }
    
    // Show reset button
    document.getElementById('reset-prd-btn').style.display = 'inline-block';
  }

  // Generate epics from PRD data
  async function generateEpicsFromPRDData() {
    if (!prdPreviewData) {
      showPRDAlert('No preview data available. Please upload documents first.', 'danger');
      return;
    }
    
    const generateBtn = document.getElementById('generate-epics-btn');
    const epicSpinner = document.getElementById('prd-epic-spinner');
    const epicLoadingSpinner = document.getElementById('prd-epic-spinner');
    
    try {
      // Show loading state
      showPRDButtonLoading(generateBtn, epicSpinner, 'Generating...');
      epicLoadingSpinner.style.display = 'block';
      
      // Prepare data for epic generation
      const epicData = {
        prd_summary: prdPreviewData.prd_summary,
        additional_summary: prdPreviewData.additional_summary,
        context: prdPreviewData.context,
        prd_filename: prdPreviewData.prd_filename,
        additional_filenames: prdPreviewData.additional_filenames
      };
      
      const response = await fetch('/three-section-generate-epics', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(epicData)
      });
      
      const data = await response.json();
      
      if (data.success && data.epics) {
        // Store epics globally
        currentEpics = data.epics;
        
        // Use the formatted HTML from backend if available, otherwise fall back to displayEpics
        if (data.epics_html) {
          displayEpicsHTML(data.epics_html);
        } else {
          displayEpics(currentEpics);
        }
        
        // Close modal
        closePRDUpload();
        
        // Show success message in main UI
        console.log('Epics generated successfully:', data.epics);
        
      } else {
        throw new Error(data.error || 'Failed to generate epics');
      }
      
    } catch (error) {
      console.error('Error generating epics:', error);
      showPRDAlert(`Error generating epics: ${error.message}`, 'danger');
    } finally {
      // Hide loading
      epicLoadingSpinner.style.display = 'none';
      hidePRDButtonLoading(generateBtn, null, 'âš¡ Generate Epics & User Stories');
    }
  }

  // Event listeners for PRD upload modal
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded - Setting up event listeners');
    
    // Form submission for document upload
    const prdForm = document.getElementById('prd-upload-form');
    console.log('PRD form found:', !!prdForm);
    if (prdForm) {
      prdForm.addEventListener('submit', handlePRDDocumentUpload);
      console.log('Submit event listener added to PRD form');
    }
    
    // Generate epics button
    const generateBtn = document.getElementById('generate-epics-btn');
    console.log('Generate button found:', !!generateBtn);
    if (generateBtn) {
      generateBtn.addEventListener('click', generateEpicsFromPRDData);
      console.log('Click event listener added to generate button');
    }
  });

  // Legacy function for compatibility (will be removed)
  function handleFileSelect(type) {
    // This function is kept for backwards compatibility but should not be used
    console.warn('handleFileSelect is deprecated. Use handlePRDFileSelect or handleAdditionalFilesSelect instead.');
  }

  // Legacy function for compatibility (updated to use new system)
  async function generateEpicsFromPRD() {
    // For backwards compatibility, redirect to new function if preview data exists
    if (prdPreviewData) {
      return generateEpicsFromPRDData();
    }
    
    // Otherwise, show modal for user to upload documents
    showPRDUpload();
  }

  // Jira Submission
  async function submitToJira() {
    if (!selectedUserStory || !currentStoryDetails) {
      alert('Please select a user story first.');
      return;
    }

    // Show confirmation
    const confirmMessage = `Submit to Jira?

Epic: ${selectedEpic?.title || 'Unknown'}
Story: ${selectedUserStory?.title || selectedUserStory?.name || 'Unknown'}
Priority: ${selectedEpic?.priority || 'High'}

Do you want to proceed?`;

    if (!confirm(confirmMessage)) {
      return;
    }

    try {
      // Show loading state on submit button
      const submitBtn = document.getElementById('submit-jira-btn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
      submitBtn.disabled = true;

      // Prepare form data
      const formData = new FormData();
      formData.append('epic_title', selectedEpic?.title || '');
      formData.append('user_story_name', selectedUserStory?.title || selectedUserStory?.name || '');
      formData.append('user_story_description', selectedUserStory?.description || selectedUserStory?.summary || '');
      formData.append('priority', selectedEpic?.priority || 'High');
      formData.append('responsible_systems', selectedUserStory?.responsible_systems || (selectedUserStory?.systems ? selectedUserStory.systems.join(', ') : 'CAPS, CMS'));
      formData.append('acceptance_criteria', (currentStoryDetails?.acceptance_criteria || []).join('|||'));
      formData.append('tagged_requirements', (currentStoryDetails?.tagged_requirements || []).join('|||'));
      formData.append('traceability_matrix', currentStoryDetails?.traceability_matrix || '');

      // Submit to Jira via AJAX
      const response = await fetch('/three-section-submit-jira', {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      // Parse JSON response (since we're sending X-Requested-With header)
      const data = await response.json();
      
      if (data.success) {
        // Success - show success message in the story details section
        const storyDetailsDiv = document.getElementById('story-details');
        const jiraLinkHtml = data.jira_url ? 
          `<p class="mb-3"><a href="${data.jira_url}" target="_blank" class="btn btn-outline-primary">
            <i class="fas fa-external-link-alt"></i> View in Jira
          </a></p>` : '';
        
        // Show warning if there was one (e.g., priority field not available)
        const warningHtml = data.warning ? 
          `<div class="alert alert-warning mt-3" style="font-size: 0.9em;">
            <i class="fas fa-exclamation-triangle"></i> ${data.warning}
          </div>` : '';
        
        storyDetailsDiv.innerHTML = `
          <div class="success-container text-center py-5">
            <div class="text-success mb-3">
              <i class="fas fa-check-circle fa-3x"></i>
            </div>
            <h4 class="text-success">Successfully Submitted to Jira!</h4>
            <p class="mb-3">
              <strong>Epic:</strong> ${data.epic_title || selectedEpic?.title || 'Unknown'}<br>
              <strong>Story:</strong> ${data.user_story_name || selectedUserStory?.title || selectedUserStory?.name || 'Unknown'}<br>
              <strong>Ticket ID:</strong> ${data.ticket_id || 'TST-' + Math.floor(Date.now() / 1000)}
            </p>
            ${jiraLinkHtml}
            ${warningHtml}
            <button class="btn btn-primary" onclick="location.reload()">
              <i class="fas fa-plus"></i> Create Another Story
            </button>
          </div>
        `;
        
        // Hide submit button
        submitBtn.style.display = 'none';
        
        console.log('Successfully submitted to Jira:', data);
      } else {
        // Show error message
        const storyDetailsDiv = document.getElementById('story-details');
        storyDetailsDiv.innerHTML = `
          <div class="error-container text-center py-5">
            <div class="text-danger mb-3">
              <i class="fas fa-exclamation-triangle fa-3x"></i>
            </div>
            <h4 class="text-danger">Failed to Submit to Jira</h4>
            <p class="mb-3 text-danger">${data.error || data.message || 'Unknown error occurred'}</p>
            <p class="text-muted">Please check your JIRA configuration and try again.</p>
            <button class="btn btn-secondary" onclick="location.reload()">
              <i class="fas fa-refresh"></i> Try Again
            </button>
          </div>
        `;
        
        // Reset submit button
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit to Jira';
        submitBtn.disabled = false;
        
        throw new Error(data.error || 'Failed to submit to Jira');
      }
      
    } catch (error) {
      console.error('Error submitting to Jira:', error);
      alert(`Error submitting to Jira: ${error.message}`);
      
      // Reset submit button
      const submitBtn = document.getElementById('submit-jira-btn');
      submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit to Jira';
      submitBtn.disabled = false;
    }
  }

  // Close modals when clicking outside
  window.addEventListener('click', function(e) {
    const modals = document.querySelectorAll('.chat-modal');
    modals.forEach(modal => {
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });
  });

  // Global keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // Close any open modal with Escape key
    if (e.key === 'Escape') {
      const openModals = document.querySelectorAll('.chat-modal[style*="display: block"]');
      openModals.forEach(modal => {
        modal.style.display = 'none';
      });
    }
  });

  // Initialize chat input placeholders with context
  function updateChatPlaceholders() {
    const epicInput = document.getElementById('epic-chat-input');
    const userStoryInput = document.getElementById('user-story-chat-input');
    const storyDetailsInput = document.getElementById('story-details-chat-input');
    
    if (epicInput) {
      const epicCount = currentEpics ? currentEpics.length : 0;
      epicInput.placeholder = epicCount > 0 ? 
        `Ask about ${epicCount} epic${epicCount !== 1 ? 's' : ''}... (Enter to send, Esc to close)` : 
        'Ask about epics... (Enter to send, Esc to close)';
    }
    
    if (userStoryInput) {
      const storyCount = currentUserStories ? currentUserStories.length : 0;
      const epicTitle = selectedEpic ? (selectedEpic.title || '').substring(0, 20) + '...' : '';
      userStoryInput.placeholder = storyCount > 0 ? 
        `Ask about ${storyCount} story${storyCount !== 1 ? 'ies' : 'y'} in ${epicTitle} (Enter to send, Esc to close)` : 
        'Ask about user stories... (Enter to send, Esc to close)';
    }
    
    if (storyDetailsInput) {
      const storyTitle = selectedUserStory ? (selectedUserStory.title || selectedUserStory.name || '').substring(0, 20) + '...' : '';
      storyDetailsInput.placeholder = storyTitle ? 
        `Ask about "${storyTitle}" (Enter to send, Esc to close)` : 
        'Ask about story details... (Enter to send, Esc to close)';
    }
  }

  // Update chat button states based on input content
  function updateChatButtonStates() {
    const inputs = ['epic-chat-input', 'user-story-chat-input', 'story-details-chat-input'];
    const buttons = ['epic-send-btn', 'user-story-send-btn', 'story-details-send-btn'];
    
    inputs.forEach((inputId, index) => {
      const input = document.getElementById(inputId);
      const button = document.querySelector(`[onclick*="${buttons[index].replace('-send-btn', 'Message')}"]`);
      
      if (input && button) {
        input.addEventListener('input', function() {
          button.disabled = this.value.trim().length === 0;
        });
        
        // Set initial state
        button.disabled = input.value.trim().length === 0;
      }
    });
  }
</script>
</body>
</html>
