<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Review PRD Outputs</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <style>
    #loadingSpinner {
      display: none;
      justify-content: center;
      align-items: center;
      margin-top: 1rem;
      font-weight: 500;
      font-size: 1.1rem;
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--border-radius);
      padding: 1rem;
      box-shadow: var(--card-shadow);
    }

    .table th {
      background-color: #0d6efd;
      color: white;
      text-align: center;
    }

    .table td {
      vertical-align: top;
    }

    :root {
      --primary-red: #dc3545;
      --primary-red-dark: #c82333;
      --primary-grey: #343a40;
      --secondary-grey: #6c757d;
      --light-grey: #f8f9fa;
      --gradient-red: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      --gradient-grey: linear-gradient(135deg, #343a40 0%, #495057 100%);
      --card-shadow: 0 8px 24px rgba(220, 53, 69, 0.12);
      --border-radius: 0.75rem;
      --transition-speed: 0.3s;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    .card {
      border: none;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .card-header {
      background: var(--primary-gradient);
      border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
      padding: 1rem 1.5rem;
    }

    .formatted-content {
      min-height: 200px;
      max-height: 500px;
      padding: 1.5rem;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 0.5rem;
      background: #ffffff;
      font-size: 1rem;
      line-height: 1.6;
      overflow-y: auto;
    }

    /* Add textarea editor styles */
    #productOverviewEditor,
    #featureOverviewEditor {
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.9rem;
      line-height: 1.6;
      padding: 1rem;
      border-radius: 0.5rem;
      border: 1px solid #dee2e6;
      background: #f8f9fa;
      resize: vertical;
      min-height: 200px;
    }

    /* Add loading animation styles */
    @keyframes slideIn {
      from {
        transform: translateY(10px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .alert {
      animation: slideIn 0.3s ease-out;
    }

    /* Add markdown content styles */
    .formatted-content h1 {
      color: #2e5cb8;
      font-size: 1.75rem;
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid rgba(46, 92, 184, 0.1);
    }

    .formatted-content h2 {
      color: #3a4f7a;
      font-size: 1.5rem;
      margin-top: 2rem;
      margin-bottom: 1rem;
    }

    .formatted-content ul {
      list-style-type: none;
      padding-left: 0;
    }

    .formatted-content ul li {
      position: relative;
      padding-left: 1.5rem;
      margin-bottom: 0.75rem;
    }

    .formatted-content ul li::before {
      content: "•";
      color: #2e5cb8;
      position: absolute;
      left: 0;
      font-weight: bold;
    }

    /* Improve edit button styles */
    .btn-edit {
      position: relative;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      border-radius: 0.5rem;
      transition: all var(--transition-speed) ease;
    }

    .btn-back {
      position: relative;
      padding-left: 2rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn-back::before {
      content: "←";
      position: absolute;
      left: 1rem;
      transition: transform 0.2s ease;
    }

    .btn-back:hover::before {
      transform: translateX(-3px);
    }

    .btn-edit:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-1px);
    }

    .btn-light {
      background: rgba(255, 255, 255, 0.9);
      border: none;
      font-weight: 500;
      padding: 0.5rem 1rem;
      transition: all 0.2s ease;
    }

    .btn-light:hover {
      background: #ffffff;
      transform: translateY(-1px);
    }

    /* Update these styles in your existing <style> section */

    #submitBtn {
      background: var(--gradient-red);
      border: none;
      height: 3.5rem;
      font-size: 1.1rem;
      font-weight: 500;
      border-radius: var(--border-radius);
      transition: all var(--transition-speed) ease;
      color: white;
    }

    #submitBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
      background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);
    }

    #submitBtn:disabled {
      background: var(--secondary-grey);
      cursor: not-allowed;
      transform: none;
      opacity: 0.65;
    }



    /* Submit Button */
    .btn-danger {
      background: var(--gradient-red);
      border: none;
      height: 3.5rem;
      font-size: 1.1rem;
      font-weight: 500;
      border-radius: var(--border-radius);
      transition: all var(--transition-speed) ease;
    }

    .btn-danger:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
      background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);
    }

    .btn-danger:disabled {
      background: var(--secondary-grey);
      cursor: not-allowed;
      transform: none;
    }

    /* Loading States */
    #loadingSpinner {
      background: rgba(255, 255, 255, 0.98);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      margin-top: 1rem;
      box-shadow: var(--card-shadow);
      display: none;
    }

    .loading-animation {
      animation: pulse 1.5s infinite;
    }

    .content-wrapper {
      background: #ffffff;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      max-width: 960px;
      margin: 3rem auto;
      padding: 2rem;
    }
  </style>
  <script>
    function showLoading() {
      const spinner = document.getElementById('loadingSpinner');
      if (spinner) spinner.style.display = 'flex';
      let seconds = 0;
      const label = document.getElementById('loadingTimer');
      window.loadingInterval = setInterval(() => {
        seconds++;
        if (label) label.textContent = `⏳ ${seconds}s`;
      }, 1000);
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', showLoading);
      });
    });
  </script>
  <script src="{{ url_for('static', filename='js/global.js') }}"></script>
</head>

<body style="background-color: #343a40;">
  <div class="content-wrapper p-4 rounded shadow-sm">
    <div class="container">

      <!-- existing content from here down -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="/page1" class="btn btn-light btn-back border">Back to Inputs</a>
        <h3 class="m-0 fw-semibold text-primary">Review Product & Feature Overview</h3>
        <div style="width: 100px;"></div>
      </div>

      {% if agent11_output == "" or agent2_output == "" %}
      <div class="alert alert-info text-center">⏳ Please wait while the PRD assistant processes your input...</div>
      {% endif %}



      <form method="post">
        <div class="mb-4">

          <div class="card mb-4 shadow-sm">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
              <span>Product Overview</span>
              <button type="button" class="btn btn-edit" onclick="toggleEdit('product')">
                <i class="bi bi-pencil-square me-1"></i>
                <span class="edit-text">Edit</span>
                <span class="save-text d-none">Save Changes</span>
              </button>
            </div>
            <div class="card-body">
              <div id="productOverviewRender" class="formatted-content"></div>
              <textarea id="productOverviewEditor" class="form-control d-none" rows="10"></textarea>
              <input type="hidden" name="product_overview" id="productOverviewInput"
                value="{{ agent11_output | tojson | safe }}" data-raw="{{ agent11_output | e }}">
            </div>
          </div>

          <div class="card mb-4 shadow-sm">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
              <span>Feature Overview</span>
              <button type="button" class="btn btn-edit" onclick="toggleEdit('feature')">
                <i class="bi bi-pencil-square me-1"></i>
                <span class="edit-text">Edit</span>
                <span class="save-text d-none">Save Changes</span>
              </button>
            </div>
            <div class="card-body">
              <div id="featureOverviewRender" class="formatted-content"></div>
              <textarea id="featureOverviewEditor" class="form-control d-none" rows="10"></textarea>
              <input type="hidden" name="feature_overview" id="featureOverviewInput"
                value="{{ agent2_output | tojson | safe }}" data-raw="{{ agent2_output }}">
            </div>
          </div>

          <div class="d-grid mt-4">
            <button type="submit" id="submitBtn" class="btn btn-danger btn-lg w-100" onclick="handleSubmit(event)">
              <span class="default-text">Approve & Submit</span>
              <span class="loading-text d-none">Processing...</span>
            </button>

          </div>
      </form>

      <div id="loadingSpinner" class="d-flex text-muted justify-content-center align-items-center">
        <div class="spinner-border text-primary me-2" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <span id="loadingTimer" class="fs-5">⏳ 0s</span>
      </div>
    </div>
  </div> <!-- end content-wrapper -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Helper function to render markdown content
      function renderMarkdownContent(inputId, renderId) {
        try {
          const input = document.getElementById(inputId);
          const renderDiv = document.getElementById(renderId);

          if (!input || !renderDiv) {
            console.error(`Required elements not found for ${inputId}`);
            return;
          }

          let content = input.getAttribute('data-raw');
          console.log(`Raw data for ${inputId}:`, content);

          if (content) {
            const renderedContent = marked.parse(content);
            console.log(`Rendered content for ${inputId}:`, renderedContent);
            renderDiv.innerHTML = renderedContent;
          } else {
            renderDiv.innerHTML = '<p class="text-muted">No content available</p>';
            console.error(`No data found in data-raw attribute for ${inputId}`);
          }
        } catch (error) {
          console.error(`Error rendering ${inputId}:`, error);
          document.getElementById(renderId).innerHTML =
            '<div class="alert alert-danger">' +
            '<h6>Error Details:</h6>' +
            '<pre>' + error.toString() + '</pre>' +
            '</div>';
        }
      }

      // Render both overviews
      renderMarkdownContent('productOverviewInput', 'productOverviewRender');
      renderMarkdownContent('featureOverviewInput', 'featureOverviewRender');
    });

    function handleSubmit(event) {
      event.preventDefault(); // Prevent default form submission

      const form = event.target.closest('form');

      // Check form validity
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const submitBtn = document.getElementById('submitBtn');
      const defaultText = submitBtn.querySelector('.default-text');
      const loadingText = submitBtn.querySelector('.loading-text');

      // Disable the button
      submitBtn.disabled = true;
      submitBtn.classList.remove('btn-danger');
      submitBtn.classList.add('btn-secondary');

      // Show loading text
      defaultText.classList.add('d-none');
      loadingText.classList.remove('d-none');

      // Start the spinner
      startSpinner();

      // Submit the form programmatically
      form.submit();
    }

    function toggleEdit(type) {
      const renderDiv = document.getElementById(`${type}OverviewRender`);
      const editor = document.getElementById(`${type}OverviewEditor`);
      const input = document.getElementById(`${type}OverviewInput`);
      const btn = event.currentTarget;
      const editText = btn.querySelector('.edit-text');
      const saveText = btn.querySelector('.save-text');

      if (editor.classList.contains('d-none')) {
        // Switch to edit mode
        editor.value = input.getAttribute('data-raw');
        renderDiv.classList.add('d-none');
        editor.classList.remove('d-none');
        editText.classList.add('d-none');
        saveText.classList.remove('d-none');
      } else {
        // Save changes and update via API
        const newContent = editor.value;
        const payload = {
          type: type,
          content: newContent
        };

        fetch('/update_content', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        })
          .then(response => response.json())
          .then(data => {
            if (data.error) throw new Error(data.error);

            // Update the content
            input.value = JSON.stringify(newContent);
            input.setAttribute('data-raw', newContent);
            renderDiv.innerHTML = marked.parse(newContent);

            // Switch back to view mode
            renderDiv.classList.remove('d-none');
            editor.classList.add('d-none');
            editText.classList.remove('d-none');
            saveText.classList.add('d-none');
          })
          .catch(error => {
            alert('Error saving changes: ' + error.message);
          });
      }
    }
  </script>
</body>

</html>