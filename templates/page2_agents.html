<!--
  page2_agents.html

  This template renders the "Review PRD Outputs" page for a PRD (Product Requirements Document) assistant web application.
  It displays the outputs of two agents: Product Overview and Feature Overview, allowing users to review, edit, and approve the generated content.

  Key Features:
  - Uses Bootstrap 5 for layout and styling, with custom CSS for enhanced UI.
  - Renders markdown content for both Product Overview and Feature Overview using the Marked.js library.
  - Provides "Edit" functionality for both sections, enabling inline editing with a textarea and saving changes via AJAX to the /update_content endpoint.
  - Displays a loading spinner and timer when submitting or processing content.
  - Handles form submission with a custom handler to show loading states and prevent duplicate submissions.
  - Includes user feedback via alerts and disables the submit button during processing.
  - Responsive and visually enhanced with gradients, shadows, and animation for a modern UX.

  Context:
  - Expects Flask/Jinja2 variables: agent11_output (Product Overview) and agent2_output (Feature Overview).
  - Used as part of a multi-step PRD assistant workflow, with navigation back to the input page.

  Dependencies:
  - Bootstrap 5, Bootstrap Icons, Marked.js, Highlight.js
  - Custom CSS (static/custom.css) and optional global JS (static/js/global.js)
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Review PRD Outputs</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <style>
    #loadingSpinner {
      display: none;
      justify-content: center;
      align-items: center;
      margin-top: 1rem;
      font-weight: 500;
      font-size: 1.1rem;
      background: rgba(255, 255, 255, 0.95);
      border-radius: var(--border-radius);
      padding: 1rem;
      box-shadow: var(--card-shadow);
    }

    .table th {
      background-color: #0d6efd;
      color: white;
      text-align: center;
    }

    .table td {
      vertical-align: top;
    }

    :root {
      --primary-red: #dc3545;
      --primary-red-dark: #c82333;
      --primary-grey: #343a40;
      --secondary-grey: #6c757d;
      --light-grey: #f8f9fa;
      --gradient-red: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      --gradient-grey: linear-gradient(135deg, #343a40 0%, #495057 100%);
      --card-shadow: 0 8px 24px rgba(220, 53, 69, 0.12);
      --border-radius: 0.75rem;
      --transition-speed: 0.3s;
    }

    body {
      background-color: #343a40 !important;
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    .card {
      border: none;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      transition: all var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .card-header {
      background: var(--primary-gradient);
      border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
      padding: 1rem 1.5rem;
    }

    .formatted-content {
      min-height: 200px;
      max-height: 500px;
      padding: 1.5rem;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 0.5rem;
      background: #ffffff;
      font-size: 1rem;
      line-height: 1.6;
      overflow-y: auto;
    }

    /* Add textarea editor styles */
    #productOverviewEditor,
    #featureOverviewEditor {
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.9rem;
      line-height: 1.6;
      padding: 1rem;
      border-radius: 0.5rem;
      border: 1px solid #dee2e6;
      background: #f8f9fa;
      resize: vertical;
      min-height: 200px;
    }

    /* Add loading animation styles */
    @keyframes slideIn {
      from {
        transform: translateY(10px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .alert {
      animation: slideIn 0.3s ease-out;
    }

    /* Add markdown content styles */
    .formatted-content h1 {
      color: #2e5cb8;
      font-size: 1.75rem;
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid rgba(46, 92, 184, 0.1);
    }

    .formatted-content h2 {
      color: #3a4f7a;
      font-size: 1.5rem;
      margin-top: 2rem;
      margin-bottom: 1rem;
    }

    .formatted-content ul {
      list-style-type: none;
      padding-left: 0;
    }

    .formatted-content ul li {
      position: relative;
      padding-left: 1.5rem;
      margin-bottom: 0.75rem;
    }

    .formatted-content ul li::before {
      content: "•";
      color: #2e5cb8;
      position: absolute;
      left: 0;
      font-weight: bold;
    }

    /* Improve edit button styles */
    .btn-edit {
      position: relative;
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      border-radius: 0.5rem;
      transition: all var(--transition-speed) ease;
    }

    .btn-back {
      position: relative;
      padding-left: 2rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn-back::before {
      content: "←";
      position: absolute;
      left: 1rem;
      transition: transform 0.2s ease;
    }

    .btn-back:hover::before {
      transform: translateX(-3px);
    }

    .btn-edit:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-1px);
    }

    .btn-light {
      background: rgba(255, 255, 255, 0.9);
      border: none;
      font-weight: 500;
      padding: 0.5rem 1rem;
      transition: all 0.2s ease;
    }

    .btn-light:hover {
      background: #ffffff;
      transform: translateY(-1px);
    }

    /* Update these styles in your existing <style> section */

    #submitBtn {
      background: var(--gradient-red);
      border: none;
      height: 3.5rem;
      font-size: 1.1rem;
      font-weight: 500;
      border-radius: var(--border-radius);
      transition: all var(--transition-speed) ease;
      color: white;
    }

    #submitBtn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
      background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);
    }

    #submitBtn:disabled {
      background: var(--secondary-grey);
      cursor: not-allowed;
      transform: none;
      opacity: 0.65;
    }



    /* Submit Button */
    .btn-danger {
      background: var(--gradient-red);
      border: none;
      height: 3.5rem;
      font-size: 1.1rem;
      font-weight: 500;
      border-radius: var(--border-radius);
      transition: all var(--transition-speed) ease;
    }

    .btn-danger:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
      background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);
    }

    .btn-danger:disabled {
      background: var(--secondary-grey);
      cursor: not-allowed;
      transform: none;
    }

    /* Loading States */
    #loadingSpinner {
      background: rgba(255, 255, 255, 0.98);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      margin-top: 1rem;
      box-shadow: var(--card-shadow);
      display: none;
    }

    .loading-animation {
      animation: pulse 1.5s infinite;
    }

    .content-wrapper {
      background: #ffffff;
      border-radius: var(--border-radius);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      max-width: 1200px;
      margin: 3rem auto;
      padding: 2rem;
    }

    #chatPanel {
      display: none;
    }

    .chat-panel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 400px;
      z-index: 1050;
      border-radius: 0.75rem;
      overflow: hidden;
    }

    .chat-body {
      background-color: #f8f9fa;
      font-size: 0.95rem;
    }

    .chat-message {
      margin-bottom: 0.75rem;
      border-radius: 0.5rem;
      padding: 0.5rem 0.75rem;
    }

    .chat-message.user {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
    }

    .chat-message.agent {
      background: #d1e7dd;
      border-left: 4px solid #198754;
    }

    .fade {
      transition: opacity 0.5s ease-in-out;
      opacity: 1;
    }

    #mainContent {
      transition: margin-left 0.3s ease-in-out;
    }
  </style>
  <script>
    function showLoading() {
      const spinner = document.getElementById('loadingSpinner');
      if (spinner) spinner.style.display = 'flex';
      let seconds = 0;
      const label = document.getElementById('loadingTimer');
      window.loadingInterval = setInterval(() => {
        seconds++;
        if (label) label.textContent = `⏳ ${seconds}s`;
      }, 1000);
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', showLoading);
      });
    });


  </script>
  <script src="{{ url_for('static', filename='js/global.js') }}"></script>
</head>

<body style="background-color: #343a40;">
  <div id="mainContent">
    <div class="content-wrapper p-4 rounded shadow-sm">
      <div class="container">
        <!-- Chat Panel -->
        <!-- Improved Chat Panel -->
        <div class="chat-panel card shadow-lg border-0" id="chatPanel" style="display: none;">
          <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
            <strong><i class="bi bi-chat-dots-fill me-2"></i><span id="chatSectionTitle">Chat Assistant</span></strong>
            <button type="button" class="btn-close btn-close-white" onclick="toggleChatPanel()"
              aria-label="Close"></button>
          </div>
          <div class="card-body chat-body px-3 py-2" id="chatMessages" style="max-height: 500px; overflow-y: auto;">
          </div>
          <div class="card-footer bg-light">
            <div class="input-group">
              <input type="text" class="form-control" id="chatInput" placeholder="Ask a question..."
                onkeydown="if(event.key === 'Enter') sendUnifiedChat();">
              <button class="btn btn-warning" type="button" onclick="sendUnifiedChat()">Send</button>
            </div>
          </div>
        </div>
        <!-- existing content from here down -->
        <div class="d-flex justify-content-between align-items-center mb-4">
          <a href="/page1" class="btn btn-light btn-back border">Back to Inputs</a>
          <h3 class="m-0 fw-semibold text-primary">Review Product & Feature Overview</h3>
          <div style="width: 100px;"></div>
        </div>

        {% if agent11_output == "" or agent2_output == "" %}
        <div class="alert alert-info text-center">⏳ Please wait while the PRD assistant processes your input...</div>
        {% endif %}



        <form method="post">
          <div class="mb-4">
            <!-- New: Legacy Business Description section -->
            <div class="card mb-4 shadow-sm">
              <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <span>Legacy Business Description</span>
              </div>
              <div class="card-body">
                <div id="legacyBusinessRender" class="formatted-content"></div>
                {% if legacy_business_description %}
                <input type="hidden" id="legacyBusinessInput" value="{{ legacy_business_description | tojson | safe }}" data-raw="{{ legacy_business_description | e }}">
                {% endif %}
              </div>
            </div>
            <div class="card mb-4 shadow-sm">
              <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <span>Product Overview</span>
                <button type="button" class="btn btn-sm btn-warning" onclick="toggleChatPanel('product')">
                  💬 Chat
                </button>
              </div>
              <div class="card-body">
                <div id="productOverviewRender" class="formatted-content"></div>
                <textarea id="productOverviewEditor" class="form-control d-none" rows="10"></textarea>
                <input type="hidden" name="product_overview" id="productOverviewInput"
                  value="{{ agent11_output | tojson | safe }}" data-raw="{{ agent11_output | e }}">
              </div>
            </div>

            <div class="card mb-4 shadow-sm">
              <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <span>Feature Overview</span>
                <button type="button" class="btn btn-sm btn-warning" onclick="toggleChatPanel('feature')">
                  💬 Chat
                </button>
              </div>
              <div class="card-body">
                <div id="featureOverviewRender" class="formatted-content"></div>
                <textarea id="featureOverviewEditor" class="form-control d-none" rows="10"></textarea>
                <input type="hidden" name="feature_overview" id="featureOverviewInput"
                  value="{{ agent2_output | tojson | safe }}" data-raw="{{ agent2_output }}">
              </div>
            </div>

            <div class="d-grid mt-4">
              <button type="submit" id="submitBtn" class="btn btn-danger btn-lg w-100" onclick="handleSubmit(event)">
                <span class="default-text">Approve & Submit</span>
                <span class="loading-text d-none">Processing...</span>
              </button>
            </div>
          </div>
        </form>

        <div id="loadingSpinner" class="d-flex text-muted justify-content-center align-items-center">
          <div class="spinner-border text-primary me-2" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <span id="loadingTimer" class="fs-5">⏳ 0s</span>
        </div>
      </div>
    </div> <!-- end content-wrapper -->
  </div>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Helper function to render markdown content
      function renderMarkdownContent(inputId, renderId) {
        try {
          const input = document.getElementById(inputId);
          const renderDiv = document.getElementById(renderId);

          if (!input || !renderDiv) {
            console.error(`Required elements not found for ${inputId}`);
            return;
          }

          let content = input.getAttribute('data-raw');
          console.log(`Raw data for ${inputId}:`, content);

          if (content) {
            const renderedContent = marked.parse(content);
            console.log(`Rendered content for ${inputId}:`, renderedContent);
            renderDiv.innerHTML = renderedContent;
          } else {
            renderDiv.innerHTML = '<p class="text-muted">No content available</p>';
            console.error(`No data found in data-raw attribute for ${inputId}`);
          }
        } catch (error) {
          console.error(`Error rendering ${inputId}:`, error);
          document.getElementById(renderId).innerHTML =
            '<div class="alert alert-danger">' +
            '<h6>Error Details:</h6>' +
            '<pre>' + error.toString() + '</pre>' +
            '</div>';
        }
      }

      // Render both overviews
      renderMarkdownContent('productOverviewInput', 'productOverviewRender');
      renderMarkdownContent('featureOverviewInput', 'featureOverviewRender');

      // Fallback for legacy section if not provided by backend: pull from localStorage
      const legacyRender = document.getElementById('legacyBusinessRender');
      if (legacyRender) {
        const legacyInput = document.getElementById('legacyBusinessInput');
        if (legacyInput) {
          renderMarkdownContent('legacyBusinessInput', 'legacyBusinessRender');
        } else {
          const ls = localStorage.getItem('legacyBusinessDescription') || '';
          legacyRender.innerHTML = ls ? marked.parse(ls) : '<p class="text-muted">No legacy description available</p>';
        }
      }
    });

    function handleSubmit(event) {
      event.preventDefault(); // Prevent default form submission

      const form = event.target.closest('form');

      // Check form validity
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      const submitBtn = document.getElementById('submitBtn');
      const defaultText = submitBtn.querySelector('.default-text');
      const loadingText = submitBtn.querySelector('.loading-text');

      // Disable the button
      submitBtn.disabled = true;
      submitBtn.classList.remove('btn-danger');
      submitBtn.classList.add('btn-secondary');

      // Show loading text
      defaultText.classList.add('d-none');
      loadingText.classList.remove('d-none');

      // Start the spinner
      startSpinner();

      // Submit the form programmatically
      form.submit();
    }
    function openChatbot() {
      const modal = new bootstrap.Modal(document.getElementById('chatbotModal'));
      modal.show();
    }

    async function sendChatMessage() {
      const input = document.getElementById('userMessage');
      const message = input.value.trim();
      if (!message) return;

      const chatbox = document.getElementById('chatbox');
      chatbox.innerHTML += `<div><strong>You:</strong> ${message}</div>`;
      input.value = '...';

      try {
        const response = await fetch('/chat_with_agent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        const result = await response.json();
        chatbox.innerHTML += `<div><strong>Assistant:</strong> ${result.reply}</div>`;
      } catch (error) {
        chatbox.innerHTML += `<div class="text-danger">Error: ${error.message}</div>`;
      } finally {
        input.value = '';
      }
    }
    function toggleEdit(type) {
      const renderDiv = document.getElementById(`${type}OverviewRender`);
      const editor = document.getElementById(`${type}OverviewEditor`);
      const input = document.getElementById(`${type}OverviewInput`);
      const btn = event.currentTarget;
      const editText = btn.querySelector('.edit-text');
      const saveText = btn.querySelector('.save-text');

      if (editor.classList.contains('d-none')) {
        // Switch to edit mode
        editor.value = input.getAttribute('data-raw');
        renderDiv.classList.add('d-none');
        editor.classList.remove('d-none');
        editText.classList.add('d-none');
        saveText.classList.remove('d-none');
      } else {
        // Save changes and update via API
        const newContent = editor.value;
        const payload = {
          type: type,
          content: newContent
        };

        fetch('/update_content', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload)
        })
          .then(response => response.json())
          .then(data => {
            if (data.error) throw new Error(data.error);

            // Update the content
            input.value = JSON.stringify(newContent);
            input.setAttribute('data-raw', newContent);
            renderDiv.innerHTML = marked.parse(newContent);

            // Switch back to view mode
            renderDiv.classList.remove('d-none');
            editor.classList.add('d-none');
            editText.classList.remove('d-none');
            saveText.classList.add('d-none');
          })
          .catch(error => {
            alert('Error saving changes: ' + error.message);
          });
      }
    }


    async function sendChatMessage() {
      const input = document.getElementById('userMessage');
      const message = input.value.trim();
      if (!message) return;

      const chatbox = document.getElementById('chatbox');
      chatbox.innerHTML += `<div><strong>You:</strong> ${message}</div>`;
      input.value = '...';

      try {
        const response = await fetch('/chat_with_agent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });

        const result = await response.json();
        const reply = result.reply;
        chatbox.innerHTML += `<div><strong>Assistant:</strong> ${reply}</div>`;

        // ✅ Update productOverviewInput and re-render content
        const productInput = document.getElementById('productOverviewInput');
        const productRender = document.getElementById('productOverviewRender');

        productInput.setAttribute('data-raw', reply);
        productInput.value = JSON.stringify(reply);  // for form post
        productRender.innerHTML = marked.parse(reply);

      } catch (error) {
        chatbox.innerHTML += `<div class="text-danger">Error: ${error.message}</div>`;
      } finally {
        input.value = '';
      }
    }
    function toggleChatPanel(section = null) {
      const panel = document.getElementById('chatPanel');
      const input = document.getElementById('chatInput');
      const title = document.getElementById('chatSectionTitle');
      const mainContent = document.getElementById('mainContent');

      const isOpening = panel.style.display === 'none';

      panel.style.display = isOpening ? 'block' : 'none';
      mainContent.style.marginLeft = isOpening ? '340px' : '0';

      if (section && isOpening) {
        input.dataset.section = section;
        title.textContent = section === 'product' ? 'Product Overview Chat' : 'Feature Overview Chat';
      }
    }



    function sendUnifiedChat() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      const chatbox = document.getElementById('chatMessages');
      const section = input.dataset.section || 'product';
      const sendButton = input.nextElementSibling;
      sendButton.disabled = true;
      sendButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;

      if (!message) return;

      chatbox.innerHTML += `<div class="chat-message user"><strong>You:</strong> ${message}</div>`;
      chatbox.innerHTML += `<div class="chat-message text-muted" id="sendingIndicator">Sending...</div>`;

      fetch('/update_content', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type: section, content: message })
      })
        .then(res => res.json())
        .then(data => {
          document.getElementById("sendingIndicator")?.remove();
          // Use data.reply if present, else fallback to data.response
          const reply = data.reply !== undefined ? data.reply : data.response;
          chatbox.innerHTML += `<div class="chat-message agent"><strong>Assistant:</strong> ${reply}</div>`;

          // ✅ Add success confirmation
          const confirmation = document.createElement('div');
          confirmation.className = 'text-success small mt-2 fade';
          confirmation.innerText = 'Message sent successfully';
          chatbox.appendChild(confirmation);
          setTimeout(() => confirmation.remove(), 2000);

          // Update corresponding section
          const renderId = section === 'product' ? 'productOverviewRender' : 'featureOverviewRender';
          const inputId = section === 'product' ? 'productOverviewInput' : 'featureOverviewInput';
          const renderDiv = document.getElementById(renderId);
          const hiddenInput = document.getElementById(inputId);

          hiddenInput.setAttribute('data-raw', reply);
          hiddenInput.value = JSON.stringify(reply);
          renderDiv.innerHTML = marked.parse(reply);
        })
        .finally(() => {
          input.value = '';
          input.disabled = false;
          sendButton.disabled = false;
          sendButton.innerHTML = "Send";
          chatbox.scrollTop = chatbox.scrollHeight;
        });

      input.value = '';
      chatbox.scrollTop = chatbox.scrollHeight;
    }


    async function sendChat(type) {
      const input = document.getElementById(type + 'Message');
      const button = input.nextElementSibling;
      const chatbox = document.getElementById(type + 'Chatbox');
      const message = input.value.trim();
      if (!message) return;

      chatbox.innerHTML += `<div><strong>You:</strong> ${message}</div>`;

      // Show spinner and disable UI
      input.disabled = true;
      button.disabled = true;
      button.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
      input.value = '';

      try {
        const response = await fetch('/update_content', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type, content: message })
        });

        const result = await response.json();
        const reply = result.response;
        chatbox.innerHTML += `<div><strong>Assistant:</strong> ${reply}</div>`;

        // Render updated content
        const renderId = type === 'product' ? 'productOverviewRender' : 'featureOverviewRender';
        const inputId = type === 'product' ? 'productOverviewInput' : 'featureOverviewInput';

        const renderDiv = document.getElementById(renderId);
        const hiddenInput = document.getElementById(inputId);

        hiddenInput.setAttribute('data-raw', reply);
        hiddenInput.value = JSON.stringify(reply);
        renderDiv.innerHTML = marked.parse(reply);

      } catch (err) {
        chatbox.innerHTML += `<div class="text-danger">Error: ${err.message}</div>`;
      } finally {
        input.disabled = false;
        button.disabled = false;
        button.innerHTML = "Send";
        chatbox.scrollTop = chatbox.scrollHeight;
      }
    }
  </script>



  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>