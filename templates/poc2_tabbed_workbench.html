<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Management - Tabbed Workbench</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* Modern CSS Variables for Design System */
    :root {
      --primary-red: #dc3545;
      --primary-red-dark: #b71c1c;
      --primary-grey: #343a40;
      --secondary-grey: #6c757d;
      --light-grey: #f8f9fa;
      --surface-primary: #ffffff;
      --surface-secondary: #f8f9fa;
      --surface-tertiary: #e9ecef;
      --text-primary: #343a40;
      --text-secondary: #6c757d;
      --text-light: #ffffff;
      --text-muted: #94a3b8;
      --border-light: #e9ecef;
      --border-medium: #dee2e6;
      --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      --border-radius: 1rem;
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --spacing-xs: 0.5rem;
      --spacing-sm: 0.75rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
    }

    /* Reset and Base Styling */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Modern Body Styling */
    body {
      font-family: 'Inter', sans-serif;
      background: #f8f9fa;
      color: #343a40;
      line-height: 1.6;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    /* Enhanced Main Container */
    .main-container {
      width: 100%;
      margin: 0;
      background: white;
      min-height: 100vh;
    }

    /* Enhanced Top Bar */
    .header-bar {
      background: #dc3545;
      color: white;
      padding: 20px 40px;
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 85px;
    }

    .header-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: white;
      margin: 0;
    }

    .back-button {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 6px;
      transition: all 0.3s ease;
      text-decoration: none;
    }

    .back-button:hover {
      background: rgba(255, 255, 255, 0.3);
      color: white;
      text-decoration: none;
    }

    /* Tab Navigation */
    .nav-tabs {
      border-bottom: 1px solid #dee2e6;
      background: #f8f9fa;
      padding: 0 20px;
      margin: 0;
    }

    .nav-tabs .nav-link {
      border: none;
      border-radius: 0;
      color: #6c757d;
      font-weight: 500;
      padding: 15px 20px;
      background: transparent;
      transition: all 0.3s ease;
    }

    .nav-tabs .nav-link.disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .nav-tabs .nav-link:hover:not(.disabled) {
      color: #dc3545;
      background: rgba(220, 53, 69, 0.05);
    }

    .nav-tabs .nav-link.active {
      color: #dc3545;
      background: white;
      border-bottom: 2px solid #dc3545;
    }

    /* Tab Content */
    .tab-content {
      padding: 0;
      min-height: calc(100vh - 200px);
    }

    .tab-pane {
      animation: fadeInUp 0.4s ease-out;
      min-height: calc(100vh - 200px);
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Tab Content Container */
    .tab-content-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 200px);
      background: var(--surface-primary);
    }

    /* Tab Header */
    .tab-header {
      background: #6c757d;
      color: white;
      padding: 15px 20px;
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #dee2e6;
    }

    .tab-header span {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Tab Body */
    .tab-body {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Content Area */
    .content-area {
      flex: 1;
      padding: var(--spacing-xl);
      overflow-y: auto;
      background: var(--surface-primary);
    }

    /* Chat Area */
    .chat-area {
      width: 350px;
      background: var(--surface-secondary);
      border-left: 1px solid var(--border-light);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .chat-header {
      background: var(--primary-red);
      color: white;
      padding: var(--spacing-md) var(--spacing-lg);
      font-weight: 600;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .chat-messages {
      flex: 1;
      padding: var(--spacing-md);
      overflow-y: auto;
      max-height: calc(100vh - 400px);
    }

    .chat-message {
      margin-bottom: var(--spacing-md);
      animation: messageSlideIn 0.3s ease-out;
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chat-message.user {
      text-align: right;
    }

    .chat-message.ai {
      text-align: left;
    }

    .message-bubble {
      display: inline-block;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-lg);
      max-width: 80%;
      word-wrap: break-word;
    }

    .chat-message.user .message-bubble {
      background: var(--primary-red);
      color: white;
    }

    .chat-message.ai .message-bubble {
      background: var(--surface-primary);
      color: var(--text-primary);
      border: 1px solid var(--border-light);
    }

    .chat-input-area {
      padding: var(--spacing-md);
      border-top: 1px solid var(--border-light);
      background: var(--surface-primary);
    }

    .chat-input-container {
      display: flex;
      gap: var(--spacing-sm);
    }

    .chat-input {
      flex: 1;
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-md);
      padding: var(--spacing-sm) var(--spacing-md);
      font-size: 0.875rem;
      transition: border-color 0.3s ease;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--primary-red);
      box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2);
    }

    .chat-send-btn {
      background: var(--primary-red);
      border: none;
      color: white;
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .chat-send-btn:hover {
      background: var(--primary-red-dark);
      transform: translateY(-1px);
    }

    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Epic Items */
    .epic-item {
      background: var(--surface-primary);
      border: 2px solid var(--border-light);
      border-radius: var(--border-radius);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .epic-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .epic-item:hover {
      border-color: var(--primary-red);
      box-shadow: 0 8px 25px rgba(220, 53, 69, 0.15);
      transform: translateY(-2px);
    }

    .epic-item:hover::before {
      opacity: 1;
    }

    .epic-item.selected {
      border-color: var(--primary-red);
      background: linear-gradient(135deg, rgba(220, 53, 69, 0.05) 0%, rgba(220, 53, 69, 0.02) 100%);
      box-shadow: 0 8px 25px rgba(220, 53, 69, 0.2);
    }

    .epic-item.selected::before {
      opacity: 1;
    }

    .epic-title {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary-red) !important;
      margin-bottom: var(--spacing-sm);
      line-height: 1.3;
    }

    .epic-description {
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: var(--spacing-sm);
    }

    .epic-metadata {
      display: flex;
      gap: var(--spacing-md);
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    /* Story Selection Styles */
    .stories-selection-container {
      padding: var(--spacing-lg);
    }

    .story-radio-item {
      margin-bottom: var(--spacing-md);
    }

    .story-check {
      margin: 0;
    }

    .story-check .form-check-input {
      margin-right: var(--spacing-md);
      margin-top: 0.5rem;
    }

    .story-label {
      display: block;
      padding: var(--spacing-lg);
      background: var(--surface-secondary);
      border: 2px solid var(--border-light);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s ease;
      margin-left: 0;
      width: 100%;
    }

    .story-label:hover {
      border-color: var(--primary-red);
      background: var(--surface-primary);
    }

    .story-check .form-check-input:checked + .story-label {
      border-color: var(--primary-red);
      background: rgba(220, 53, 69, 0.1);
    }

    /* User Story Items */
    .user-story-item {
      background: var(--surface-primary);
      border: 2px solid var(--border-light);
      border-radius: var(--border-radius);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .user-story-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .user-story-item:hover {
      border-color: #3b82f6;
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
      transform: translateY(-2px);
    }

    .user-story-item:hover::before {
      opacity: 1;
    }

    .user-story-item.selected {
      border-color: #3b82f6;
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(59, 130, 246, 0.02) 100%);
      box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
    }

    .user-story-item.selected::before {
      opacity: 1;
    }

    .user-story-item.created {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      border-color: #22c55e;
      cursor: not-allowed;
      opacity: 0.8;
    }

    .user-story-item.created .user-story-title,
    .user-story-item.created .user-story-description {
      color: #22c55e;
    }

    .user-story-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
      line-height: 1.3;
    }

    .user-story-description {
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: var(--spacing-sm);
    }

    .user-story-metadata {
      display: flex;
      gap: var(--spacing-md);
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    /* Story Details */
    .story-details-section {
      background: var(--surface-primary);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-light);
      margin-bottom: var(--spacing-lg);
    }

    .story-details-header {
      background: linear-gradient(135deg, #dc3545 0%, #dc3545 100%);
      color: white;
      padding: var(--spacing-md) var(--spacing-lg);
      font-weight: 600;
      border-radius: var(--border-radius) var(--border-radius) 0 0;
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .story-details-content {
      padding: var(--spacing-lg);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--spacing-2xl);
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: var(--spacing-lg);
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: var(--spacing-sm);
    }

    .empty-state-subtext {
      font-size: 1rem;
      margin-bottom: var(--spacing-lg);
    }

    /* Loading State */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-2xl);
      color: var(--text-muted);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--border-light);
      border-top: 4px solid var(--primary-red);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: var(--spacing-lg);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Enhanced Loading States with Timer */
    .modern-loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-2xl);
      color: var(--text-primary);
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: var(--border-radius);
      margin: var(--spacing-lg);
      min-height: 300px;
      position: relative;
      overflow: hidden;
    }

    .modern-loading-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      animation: progressPulse 2s ease-in-out infinite;
    }

    @keyframes progressPulse {
      0%, 100% { opacity: 0.6; transform: scaleX(0.8); }
      50% { opacity: 1; transform: scaleX(1); }
    }

    .modern-spinner {
      width: 60px;
      height: 60px;
      margin-bottom: var(--spacing-xl);
      position: relative;
    }

    .modern-spinner::before,
    .modern-spinner::after {
      content: '';
      position: absolute;
      border-radius: 50%;
    }

    .modern-spinner::before {
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      animation: modernSpin 1.5s linear infinite;
      opacity: 0.8;
    }

    .modern-spinner::after {
      width: 40px;
      height: 40px;
      background: white;
      top: 10px;
      left: 10px;
      box-shadow: inset 0 0 0 3px var(--primary-red);
      animation: modernSpinReverse 1s linear infinite;
    }

    @keyframes modernSpin {
      0% { transform: rotate(0deg) scale(1); }
      50% { transform: rotate(180deg) scale(1.1); }
      100% { transform: rotate(360deg) scale(1); }
    }

    @keyframes modernSpinReverse {
      0% { transform: rotate(360deg) scale(1); }
      50% { transform: rotate(180deg) scale(0.9); }
      100% { transform: rotate(0deg) scale(1); }
    }

    .loading-timer {
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid var(--primary-red);
      border-radius: 25px;
      padding: var(--spacing-sm) var(--spacing-lg);
      margin: var(--spacing-lg) 0;
      font-family: 'Inter', monospace;
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--primary-red);
      min-width: 120px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2);
      animation: timerPulse 1s ease-in-out infinite alternate;
    }

    @keyframes timerPulse {
      0% { box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2); }
      100% { box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4); }
    }

    .loading-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
      text-align: center;
    }

    .loading-subtitle {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-lg);
      text-align: center;
      max-width: 400px;
      line-height: 1.5;
    }

    .loading-progress-bar {
      width: 100%;
      max-width: 400px;
      height: 8px;
      background: var(--border-light);
      border-radius: 4px;
      margin: var(--spacing-lg) 0;
      overflow: hidden;
      position: relative;
    }

    .loading-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      border-radius: 4px;
      animation: progressFill 3s ease-in-out infinite;
      position: relative;
    }

    .loading-progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
      animation: progressShine 2s ease-in-out infinite;
    }

    @keyframes progressFill {
      0% { width: 10%; }
      25% { width: 30%; }
      50% { width: 60%; }
      75% { width: 85%; }
      100% { width: 95%; }
    }

    @keyframes progressShine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(400%); }
    }

    .loading-dots {
      display: flex;
      gap: 6px;
      margin-top: var(--spacing-lg);
    }

    .loading-dot {
      width: 8px;
      height: 8px;
      background: var(--primary-red);
      border-radius: 50%;
      animation: dotBounce 1.4s ease-in-out infinite;
    }

    .loading-dot:nth-child(1) { animation-delay: 0s; }
    .loading-dot:nth-child(2) { animation-delay: 0.2s; }
    .loading-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes dotBounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-15px); }
    }

    /* Chat Loading Spinner */
    .chat-loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-light);
      border-top: 2px solid var(--primary-red);
      border-radius: 50%;
      animation: chatSpin 0.8s linear infinite;
      display: inline-block;
      margin-right: var(--spacing-xs);
    }

    @keyframes chatSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Buttons */
    .btn-primary {
      background: #dc3545;
      border: none;
      color: white;
      font-weight: 600;
      padding: 8px 16px;
      border-radius: 6px;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: #b71c1c;
      color: white;
    }

    /* Priority Badges */
    .priority-high {
      background: #dc3545;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .priority-medium {
      background: #fd7e14;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .priority-low {
      background: #198754;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    /* File Upload Styles */
    .upload-area {
      background: var(--surface-secondary);
      border: 2px dashed var(--border-medium);
      border-radius: var(--border-radius);
      padding: var(--spacing-2xl);
      text-align: center;
      margin-bottom: var(--spacing-lg);
      transition: all 0.3s ease;
    }

    .upload-area:hover {
      border-color: var(--primary-red);
      background: rgba(220, 53, 69, 0.05);
    }

    .upload-area.dragover {
      border-color: var(--primary-red);
      background: rgba(220, 53, 69, 0.1);
    }

    .upload-form-container {
      background: var(--surface-primary);
      border-radius: var(--border-radius);
      padding: var(--spacing-2xl);
      box-shadow: var(--card-shadow);
      margin-bottom: var(--spacing-lg);
    }

    .form-label {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
    }

    .form-text {
      font-size: 0.875rem;
      color: var(--text-muted);
      margin-top: var(--spacing-xs);
    }

    /* Epic Selection Styles */
    .epics-selection-container {
      padding: var(--spacing-lg);
    }

    .epic-radio-item {
      margin-bottom: var(--spacing-md);
    }

    .epic-check {
      margin: 0;
    }

    .epic-check .form-check-input {
      margin-right: var(--spacing-md);
      margin-top: 0.5rem;
    }

    .epic-label {
      display: block;
      padding: var(--spacing-lg);
      background: var(--surface-secondary);
      border: 2px solid var(--border-light);
      border-radius: var(--border-radius);
      cursor: pointer;
      transition: all 0.3s ease;
      margin-left: 0;
      width: 100%;
    }

    .epic-label:hover {
      border-color: var(--primary-red);
      background: var(--surface-primary);
    }

    .epic-check .form-check-input:checked + .epic-label {
      border-color: var(--primary-red);
      background: rgba(220, 53, 69, 0.1);
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--surface-tertiary);
      border-radius: var(--radius-sm);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-medium);
      border-radius: var(--radius-sm);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--secondary-grey);
    }

    /* Success and Error Containers for Jira Submission - Refined Theme */
    .success-container {
      background: linear-gradient(135deg, rgba(143, 174, 154, 0.15) 0%, rgba(45, 84, 54, 0.1) 100%);
      border: 1px solid var(--development-color);
      border-radius: var(--border-radius);
      padding: var(--spacing-xl);
      margin: var(--spacing-lg);
    }

    .error-container {
      background: linear-gradient(135deg, rgba(220, 53, 69, 0.15) 0%, rgba(183, 28, 28, 0.1) 100%);
      border: 1px solid var(--primary-red);
      border-radius: var(--border-radius);
      padding: var(--spacing-xl);
      margin: var(--spacing-lg);
    }

    .success-container h4 {
      color: var(--discovery-color);
      margin-bottom: var(--spacing-md);
    }

    .error-container h4 {
      color: var(--primary-red-dark);
      margin-bottom: var(--spacing-md);
    }

    .success-container .fas {
      color: var(--development-color);
    }

    .error-container .fas {
      color: var(--primary-red);
    }

    /* Traceability Matrix Markdown Styling */
    .traceability-matrix h4,
    .traceability-matrix h5,
    .traceability-matrix h6 {
      color: var(--text-primary);
      margin-bottom: var(--spacing-sm);
      margin-top: var(--spacing-md);
    }

    .traceability-matrix h4 {
      font-size: 1.25rem;
      font-weight: 700;
      border-bottom: 2px solid var(--border-light);
      padding-bottom: var(--spacing-xs);
    }

    .traceability-matrix h5 {
      font-size: 1.1rem;
      font-weight: 600;
    }

    .traceability-matrix h6 {
      font-size: 1rem;
      font-weight: 600;
    }

    .traceability-matrix p {
      margin-bottom: var(--spacing-sm);
      line-height: 1.6;
    }

    .traceability-matrix ul {
      margin-bottom: var(--spacing-sm);
      padding-left: var(--spacing-lg);
    }

    .traceability-matrix li {
      margin-bottom: var(--spacing-xs);
      line-height: 1.5;
    }

    .traceability-matrix strong {
      font-weight: 700;
      color: var(--text-primary);
    }

    .traceability-matrix em {
      font-style: italic;
      color: var(--text-secondary);
    }

    .traceability-matrix code {
      background: var(--surface-tertiary);
      color: var(--primary-red);
      padding: 0.125rem 0.25rem;
      border-radius: var(--radius-xs);
      font-size: 0.875rem;
      font-family: 'Courier New', monospace;
    }

    .traceability-matrix pre {
      background: var(--surface-tertiary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      padding: var(--spacing-md);
      margin: var(--spacing-sm) 0;
      overflow-x: auto;
      font-size: 0.875rem;
    }

    .traceability-matrix pre code {
      background: none;
      color: var(--text-primary);
      padding: 0;
    }

    .traceability-matrix table {
      width: 100%;
      border-collapse: collapse;
      margin: var(--spacing-md) 0;
      font-size: 0.9rem;
    }

    .traceability-matrix table td {
      padding: var(--spacing-sm);
      border: 1px solid var(--border-light);
      vertical-align: top;
    }

    .traceability-matrix table tr:nth-child(even) {
      background-color: var(--surface-tertiary);
    }

    .traceability-matrix table tr:first-child {
      background-color: var(--surface-secondary);
      font-weight: 600;
    }

    /* Modern Requirements List Styling */
    .modern-requirements-list {
      background: linear-gradient(135deg, rgba(248, 249, 250, 0.8) 0%, rgba(233, 236, 239, 0.5) 100%);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin: var(--spacing-sm) 0;
    }

    .requirement-item {
      display: flex;
      align-items: flex-start;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
      padding: var(--spacing-xs) var(--spacing-sm);
      background: rgba(255, 255, 255, 0.7);
      border-radius: var(--radius-sm);
      border-left: 3px solid var(--primary-red);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .requirement-item:hover {
      background: rgba(255, 255, 255, 0.9);
      border-left-color: var(--primary-red-dark);
      transform: translateX(2px);
      box-shadow: 0 2px 8px rgba(220, 53, 69, 0.1);
    }

    .requirement-item:last-child {
      margin-bottom: 0;
    }

    .requirement-bullet {
      color: var(--primary-red);
      font-size: 0.875rem;
      margin-top: 2px;
      min-width: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .requirement-text {
      color: var(--text-primary);
      font-weight: 500;
      line-height: 1.4;
      flex: 1;
      font-size: 0.9rem;
    }

    .requirement-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(180deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .requirement-item:hover::before {
      opacity: 1;
    }

    /* Enhanced tagged requirements section header */
    .modern-requirements-list + .mb-3 p strong {
      color: var(--text-primary);
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      margin-bottom: var(--spacing-sm);
    }

    .modern-requirements-list + .mb-3 p strong i {
      color: var(--primary-red);
    }

    /* Responsive design for requirements */
    @media (max-width: 768px) {
      .requirement-item {
        padding: var(--spacing-sm);
        margin-bottom: var(--spacing-xs);
      }
      
      .requirement-text {
        font-size: 0.85rem;
      }
    }

    /* Animation for requirements loading */
    .requirement-item {
      animation: requirementSlideIn 0.3s ease-out forwards;
      opacity: 0;
      transform: translateX(-10px);
    }

    .requirement-item:nth-child(1) { animation-delay: 0.1s; }
    .requirement-item:nth-child(2) { animation-delay: 0.2s; }
    .requirement-item:nth-child(3) { animation-delay: 0.3s; }
    .requirement-item:nth-child(4) { animation-delay: 0.4s; }
    .requirement-item:nth-child(5) { animation-delay: 0.5s; }

    @keyframes requirementSlideIn {
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Enhanced focus styles for accessibility */
    .form-control:focus {
      border-color: var(--primary-red);
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
      outline: none;
    }

    .btn-primary:focus {
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
      outline: none;
    }

    /* Custom styles for file input */
    .form-control-file {
      padding: var(--spacing-sm);
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-md);
      transition: border-color 0.3s ease;
    }

    .form-control-file:focus {
      border-color: var(--primary-red);
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
      outline: none;
    }

    /* Custom styles for radio and checkbox inputs */
    .form-check-input {
      width: 1.25rem;
      height: 1.25rem;
      margin-top: 0.3rem;
      cursor: pointer;
      transition: border-color 0.3s ease;
    }

    .form-check-input:focus {
      border-color: var(--primary-red);
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
      outline: none;
    }

    /* Custom styles for select inputs */
    .form-select {
      padding: var(--spacing-sm);
      border: 1px solid var(--border-medium);
      border-radius: var(--radius-md);
      transition: border-color 0.3s ease;
    }

    .form-select:focus {
      border-color: var(--primary-red);
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
      outline: none;
    }

    /* Custom scrollbar styles for WebKit browsers */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--surface-tertiary);
      border-radius: var(--radius-sm);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border-medium);
      border-radius: var(--radius-sm);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--secondary-grey);
    }

    /* Custom styles for buttons with icons */
    .btn-icon {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
      transition: all 0.3s ease;
    }

    .btn-icon:hover {
      background: rgba(220, 53, 69, 0.1);
    }

    /* Custom styles for badge notifications */
    .badge-notification {
      position: relative;
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: var(--radius-sm);
      background: var(--primary-red);
      color: white;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-notification::after {
      content: '';
      position: absolute;
      top: 50%;
      right: 50%;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 1;
      }
      50% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0.6;
      }
      100% {
        transform: translate(-50%, -50%) scale(0);
        opacity: 1;
      }
    }

    /* Custom styles for tooltips */
    .tooltip-inner {
      background: var(--primary-red);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-sm);
      font-size: 0.875rem;
      font-weight: 500;
    }

    .tooltip-arrow {
      border-top-color: var(--primary-red) !important;
    }

    /* Custom styles for modals */
    .modal-content {
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    .modal-header {
      background: var(--primary-red);
      color: white;
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: 1px solid var(--border-light);
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0;
    }

    .modal-body {
      padding: var(--spacing-lg);
    }

    .modal-footer {
      background: var(--surface-secondary);
      padding: var(--spacing-md) var(--spacing-lg);
      border-top: 1px solid var(--border-light);
    }

    /* Custom styles for alerts */
    .alert {
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }

    .alert-success {
      background: rgba(143, 174, 154, 0.15);
      border-color: var(--development-color);
    }

    .alert-danger {
      background: rgba(220, 53, 69, 0.15);
      border-color: var(--primary-red);
    }

    .alert-warning {
      background: rgba(253, 124, 20, 0.15);
      border-color: var(--warning-color);
    }

    /* Custom styles for badges */
    .badge {
      border-radius: var(--radius-sm);
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
    }

    .badge-success {
      background: var(--development-color);
      color: white;
    }

    .badge-danger {
      background: var(--primary-red);
      color: white;
    }

    .badge-warning {
      background: var(--warning-color);
      color: white;
    }

    /* Custom styles for links */
    a {
      color: var(--primary-red);
      text-decoration: none;
      transition: color 0.3s ease;
    }

    a:hover {
      color: var(--primary-red-dark);
      text-decoration: none;
    }

    /* Custom styles for images */
    img {
      max-width: 100%;
      height: auto;
      border-radius: var(--radius-md);
    }

    /* Custom styles for iframes */
    iframe {
      max-width: 100%;
      height: auto;
      border: none;
      border-radius: var(--radius-md);
    }

    /* Custom print styles */
    @media print {
      body {
  -webkit-print-color-adjust: exact;
  print-color-adjust: exact;
      }

      .main-container {
        background: white;
        color: black;
        padding: 0;
        margin: 0;
        border: none;
        border-radius: 0;
        box-shadow: none;
        width: 100%;
        height: auto;
        overflow: visible;
      }

      .header-bar {
        display: none;
      }

      .nav-tabs {
        display: none;
      }

      .tab-content {
        padding: 0;
      }

      .tab-pane {
        page-break-inside: avoid;
      }

      .btn,
      .badge,
      .alert {
        display: none !important;
      }

      @page {
        margin: 0;
        size: A4;
      }
    }
  </style>
</head>
<body>
  <!-- Vector DB Link Display Section -->
  <div id="vectorDbLinkDisplay" style="display:none; background: #e9f7ef; color: #155724; border: 1px solid #b7ebc6; border-radius: 8px; padding: 1rem 2rem; margin: 1.5rem 2rem 0.5rem 2rem; font-size: 1.1rem; font-weight: 500;">
    <span class="fw-bold">Vector DB Link:</span>
    <a id="vectorDbLinkValue" href="#" target="_blank" style="color: #007bff; word-break: break-all;"></a>
  </div>
  <script>
    // If a vectorDbLink is present, fetch the file and set it as the file input value
    document.addEventListener('DOMContentLoaded', async function() {
      const params = new URLSearchParams(window.location.search);
      const link = params.get('vectorDbLink');
      if (link) {
        try {
          const response = await fetch(link);
          if (!response.ok) throw new Error('Failed to fetch file from Vector DB Link');
          const blob = await response.blob();
          // Create a File object from the blob
          const filename = link.split('/').pop() || 'vector_db_file';
          const file = new File([blob], filename, { type: blob.type });
          // Set the file input value using DataTransfer
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          const fileInput = document.getElementById('prd-file');
          if (fileInput) {
            fileInput.files = dataTransfer.files;
            // Optionally, trigger change event if needed
            fileInput.dispatchEvent(new Event('change', { bubbles: true }));
          }
        } catch (err) {
          console.error('Error auto-filling PRD file from Vector DB Link:', err);
        }
      }
    });
    // On page load, check for vectorDbLink in query params and display if present
    document.addEventListener('DOMContentLoaded', function() {
      const params = new URLSearchParams(window.location.search);
      const link = params.get('vectorDbLink');
      if (link) {
        const displayDiv = document.getElementById('vectorDbLinkDisplay');
        const linkEl = document.getElementById('vectorDbLinkValue');
        linkEl.href = link;
        linkEl.textContent = link;
        displayDiv.style.display = 'block';
      }
    });
  </script>
  <div class="main-container">
    <!-- Enhanced Header -->
    <div class="header-bar">
      <div class="header-title">📋 Product Management Workbench</div>
      <a href="/" class="back-button">
        <i class="fas fa-arrow-left"></i>
        Back to Home
      </a>
    </div>
<!-- Navigation Row for POC Integration -->
    <div class="navigation-row" style="background: linear-gradient(135deg, #b71c1c 0%, #8e0000 100%); border-bottom: 3px solid #6d0000; padding: 2rem 2.5rem; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 15px rgba(183, 28, 28, 0.4);">
      <div class="navigation-info">
        <span style="color: #ffffff; font-size: 1.1rem; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">
          <i class="fas fa-puzzle-piece" style="color: #ffffff; margin-right: 0.75rem; font-size: 1.2rem;"></i>
          This workbench integrates with other POCs for a complete workflow
        </span>
      </div>
      <div class="navigation-actions" style="display: flex; gap: 0.75rem;">
        <button class="btn btn-light" onclick="window.open('http://127.0.0.1:5051','_blank')" title="Reverse engineer legacy code and mine internal docs and research to identify high-level requirements
" style="background: #ffffff; color: #dc3545; border: 2px solid #ffffff; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 8px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onmouseover="this.style.background='#f8f9fa'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.background='#ffffff'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
          <i class="fas fa-file-alt" style="margin-right: 0.5rem;"></i>
          Requirements insights
        </button>
   
        <button class="btn btn-light" onclick="window.open('http://127.0.0.1:5001/page1','_blank')" title="Translate research & human input into structured requirements (data, functional, non-functional, legal, etc.) " style="background: #ffffff; color: #dc3545; border: 2px solid #ffffff; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 8px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onmouseover="this.style.background='#f8f9fa'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.background='#ffffff'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
          <i class="fas fa-download" style="margin-right: 0.5rem;"></i>
          Requirements definition
        </button>
        <button class="btn btn-light" onclick="window.open('http://127.0.0.1:5002/tabbed-layout','_blank')" title="Convert business objectives and detailed requirements into user stories with clear acceptance criteria
" style="background: #ffffff; color: #dc3545; border: 2px solid #ffffff; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 8px; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onmouseover="this.style.background='#f8f9fa'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.background='#ffffff'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
          <i class="fas fa-cogs" style="margin-right: 0.5rem;"></i>
          Backlog management
        </button>
        
   
      </div>
    </div>
    <!-- Enhanced Tab Navigation -->
    <ul class="nav nav-tabs" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="epics-tab" data-bs-toggle="tab" data-bs-target="#epics-pane" type="button" role="tab">
          <i class="fas fa-flag"></i>
          Epics
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link disabled" id="stories-tab" data-bs-toggle="tab" data-bs-target="#stories-pane" type="button" role="tab">
          <i class="fas fa-tasks"></i>
          User Stories
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link disabled" id="details-tab" data-bs-toggle="tab" data-bs-target="#details-pane" type="button" role="tab">
          <i class="fas fa-info-circle"></i>
          Story Details
        </button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="mainTabContent">
      <!-- Epics Tab -->
      <div class="tab-pane fade show active" id="epics-pane" role="tabpanel">
        <div class="tab-content-container">
          <div class="tab-header">
            <span><i class="fas fa-flag"></i> Product Epics</span>
          </div>
          <div class="tab-body">
            <div class="content-area">
              <!-- Upload Section -->
              <div id="upload-section">
                <div class="upload-form-container">
                  <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 2rem; margin-bottom: 1rem; color: var(--text-muted);">
                      <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h4>Upload Documents to Generate Epics</h4>
                    <p class="text-muted">Upload your Product Requirements Document and System Mapping file</p>
                  </div>
                  
                  <div class="row">
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="prd-file" class="form-label">
                          <strong><i class="fas fa-file-alt"></i> Product Requirements Document (Required)</strong>
                        </label>
                        <input type="file" class="form-control" id="prd-file" accept=".txt,.docx,.pdf,.md">
                        <div class="form-text">Upload your PRD file (.txt, .docx, .pdf, .md)</div>
                        <!-- Vector DB PRD Selection Button and Modal (single instance) -->

<script>
// Show Vector DB PRD Modal and fetch files
async function showVectorDbPrdModal() {
  const modalElem = document.getElementById('vectorDbPrdModal');
  if (!modalElem) {
    alert('Vector DB Modal element not found in DOM.');
    return;
  }
  // Ensure Bootstrap Modal is available
  if (typeof bootstrap === 'undefined' || !bootstrap.Modal) {
    alert('Bootstrap Modal JS is not loaded.');
    return;
  }
  const modal = bootstrap.Modal.getOrCreateInstance(modalElem);
  document.getElementById('vector-db-files-list').innerHTML = '<div class="text-center text-muted">Loading files...</div>';
  modal.show();
  try {
    const response = await fetch('/vector-db/files/', { method: 'GET' });
    if (!response.ok) throw new Error('Failed to fetch files');
    const data = await response.json();
    if (Array.isArray(data.files) && data.files.length > 0) {
      let html = '<ul class="list-group">';
      data.files.forEach(function(filename) {
        var encodedFilename = encodeURIComponent(filename);
        html += '<li class="list-group-item d-flex justify-content-between align-items-center">';
        html += '<span>' + filename + '</span>';
        html += '<div>';
        html += '<button type="button" class="btn btn-sm btn-primary me-2 vector-db-select-btn" data-filename="' + filename.replace(/"/g, '&quot;') + '">Select</button>';
        html += '<a href="http://localhost:5001/vector-db/files/' + encodedFilename + '" target="_blank" class="btn btn-sm btn-outline-secondary">View</a>';
        html += '</div>';
        html += '</li>';
      });
      html += '</ul>';
      document.getElementById('vector-db-files-list').innerHTML = html;
      // Add event listeners for select buttons
      document.querySelectorAll('.vector-db-select-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          selectVectorDbPrd(this.getAttribute('data-filename'));
        });
      });
    } else {
      document.getElementById('vector-db-files-list').innerHTML = '<div class="text-center text-muted">No files found in Vector DB.</div>';
    }
  } catch (err) {
    document.getElementById('vector-db-files-list').innerHTML = '<div class="text-danger">Error loading files: ' + err.message + '</div>';
  }
}
// Select a file from Vector DB
function selectVectorDbPrd(filename) {
  document.getElementById('selected-vector-db-prd').value = filename;
  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('vectorDbPrdModal'));
  if (modal) modal.hide();
}
</script>
                        <input type="hidden" id="selected-vector-db-prd" name="selected_vector_db_prd">
                        {% include 'vector_db_prd_modal.html' %}
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="mb-3">
                        <label for="system-mapping-file" class="form-label">
                          <strong><i class="fas fa-sitemap"></i> System Mapping Document (Optional)</strong>
                        </label>
                        <input type="file" class="form-control" id="system-mapping-file" accept=".txt,.docx,.pdf,.md,.csv">
                        <div class="form-text">Upload your system mapping file (.txt, .docx, .pdf, .md, .csv)</div>
                        <div class="mt-2">
                          <button type="button" class="btn btn-danger btn-sm" onclick="window.open('/system-mapping','_blank')" title="Plan and validate target system architecture with drag-and-drop and AI assistance">
                            <i class="fas fa-sitemap me-1"></i>
                            Generate System Mapping
                          </button>
                          <small class="text-muted ms-2">Open the mapping tool, export CSV, then upload it here.</small>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="context-notes" class="form-label">
                      <i class="fas fa-sticky-note"></i> Context & Instructions (Optional)
                    </label>
                    <textarea class="form-control" id="context-notes" rows="3" placeholder="Provide any additional context or specific instructions for epic generation..."></textarea>
                  </div>
                  
                  <div class="text-center">
                    <button class="btn btn-primary btn-lg" id="submit-files-btn" type="button">
                      <i class="fas fa-magic"></i> Submit Files & Generate Epics
                    </button>
                    <br><br>
                    
                  </div>
                </div>
              </div>

              <!-- Modern Loading State with Timer -->
              <div id="epics-loading" class="modern-loading-container" style="display: none;">
                <div class="modern-spinner"></div>
                <div class="loading-title">🚀 Generating Epics</div>
                <div class="loading-subtitle">Analyzing your PRD content and creating comprehensive epics that break down requirements into manageable chunks...</div>
                <div class="loading-timer" id="epics-timer">00:00</div>
                <div class="loading-progress-bar">
                  <div class="loading-progress-fill"></div>
                </div>
                <div class="loading-dots">
                  <div class="loading-dot"></div>
                  <div class="loading-dot"></div>
                  <div class="loading-dot"></div>
                </div>
              </div>

              <!-- Epics List -->
              <div id="epics-list" style="display: none;">
                <!-- Epics will be populated here -->
              </div>

              <!-- Empty State -->
              <div id="epics-empty" class="empty-state" style="display: none;">
                <div class="empty-state-icon"><i class="fas fa-flag"></i></div>
                <div class="empty-state-text">No epics generated yet</div>
                <div class="empty-state-subtext">Upload both PRD and System Mapping files to get started</div>
              </div>
            </div>

            <!-- Epic Chat Area (initially hidden, shown after epics are displayed) -->
            <div class="chat-area" id="epic-chat-area" style="display: none;">
              <div class="chat-header">
                <i class="fas fa-comments"></i>
                Refine Epics
              </div>
              <div class="chat-messages" id="epic-chat-messages">
                <div class="chat-message ai">
                  <div class="message-bubble">
                    👋 Hi! I'm here to help you refine your epics. Once you generate some epics, you can ask me questions or request improvements.
                  </div>
                </div>
              </div>
              <div class="chat-input-area">
                <div class="chat-input-container">
                  <input type="text" class="chat-input" id="epic-chat-input" placeholder="Ask about epics or suggest improvements..." onkeypress="handleEpicChatEnter(event)">
                  <button class="chat-send-btn" id="epic-chat-send" onclick="sendEpicMessage()" disabled>
                    <i class="fas fa-paper-plane"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- User Stories Tab -->
      <div class="tab-pane fade" id="stories-pane" role="tabpanel">
        <div class="tab-content-container">
          <div class="tab-header">
            <span><i class="fas fa-tasks"></i> User Stories</span>
          </div>
          <div class="tab-body">
            <div class="content-area">
              <!-- Selected Epic Info -->
              <div id="selected-epic-info" style="display: none;" class="alert alert-info">
                <h5><i class="fas fa-flag"></i> Selected Epic:</h5>
                <div id="selected-epic-display"></div>
              </div>

              <!-- Modern Loading State with Timer -->
              <div id="stories-loading" class="modern-loading-container" style="display: none;">
                <div class="modern-spinner"></div>
                <div class="loading-title">📝 Generating User Stories</div>
                <div class="loading-subtitle">Creating detailed user stories for your selected epic with acceptance criteria and system mappings...</div>
                <div class="loading-timer" id="stories-timer">00:00</div>
                <div class="loading-progress-bar">
                  <div class="loading-progress-fill"></div>
                </div>
                <div class="loading-dots">
                  <div class="loading-dot"></div>
                  <div class="loading-dot"></div>
                  <div class="loading-dot"></div>
                </div>
              </div>

              <!-- User Stories List -->
              <div id="stories-list">
                <!-- User stories will be populated here -->
              </div>

              <!-- Empty State -->
              <div id="stories-empty" class="empty-state">
                <div class="empty-state-icon"><i class="fas fa-tasks"></i></div>
                <div class="empty-state-text">Select an epic first</div>
                <div class="empty-state-subtext">Choose an epic from the previous tab to generate user stories</div>
              </div>
            </div>

            <!-- Story Chat Area (initially hidden, shown after user stories are displayed) -->
            <div class="chat-area" id="story-chat-area" style="display: none;">
              <div class="chat-header">
                <i class="fas fa-comments"></i>
                Refine Stories
              </div>
              <div class="chat-messages" id="story-chat-messages">
                <div class="chat-message ai">
                  <div class="message-bubble">
                    💡 I'll help you refine user stories once they're generated. You can ask me to improve clarity, add details, or adjust priorities.
                  </div>
                </div>
              </div>
              <div class="chat-input-area">
                <div class="chat-input-container">
                  <input type="text" class="chat-input" id="story-chat-input" placeholder="Ask about user stories or suggest improvements..." onkeypress="handleStoryChatEnter(event)">
                  <button class="chat-send-btn" id="story-chat-send" onclick="sendStoryMessage()" disabled>
                    <i class="fas fa-paper-plane"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Story Details Tab -->
      <div class="tab-pane fade" id="details-pane" role="tabpanel">
        <div class="tab-content-container">
          <div class="tab-header">
            <span><i class="fas fa-info-circle"></i> Story Details</span>
            <button class="btn btn-success" id="submit-jira-btn" onclick="submitToJira()" style="display: none;">
              <i class="fas fa-rocket"></i>
              Submit to Jira
            </button>
          </div>
          <div class="tab-body">
            <div class="content-area">
              <!-- Story Details Content -->
              <div id="story-details-content">
                <!-- Empty State -->
                <div id="details-empty" class="empty-state">
                  <div class="empty-state-icon"><i class="fas fa-info-circle"></i></div>
                  <div class="empty-state-text">Select a user story</div>
                  <div class="empty-state-subtext">Choose a user story to view detailed information</div>
                </div>

                <!-- Modern Loading State with Timer -->
                <div id="details-loading" class="modern-loading-container" style="display: none;">
                  <div class="modern-spinner"></div>
                  <div class="loading-title">📋 Generating Story Details</div>
                  <div class="loading-subtitle">Creating detailed acceptance criteria, tagged requirements, and traceability matrix for your user story...</div>
                  <div class="loading-timer" id="details-timer">00:00</div>
                  <div class="loading-progress-bar">
                    <div class="loading-progress-fill"></div>
                  </div>
                  <div class="loading-dots">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                  </div>
                </div>

                <!-- Details Sections -->
                <div id="details-sections" style="display: none;">
                  <!-- Story Info Section -->
                  <div class="story-details-section">
                    <div class="story-details-header">
                      <i class="fas fa-user"></i>
                      User Story
                    </div>
                    <div class="story-details-content" id="story-info">
                      <!-- Story information will be populated here -->
                    </div>
                  </div>

                  <!-- Acceptance Criteria Section -->
                  <div class="story-details-section">
                    <div class="story-details-header">
                      <i class="fas fa-check-square"></i>
                      Acceptance Criteria
                    </div>
                    <div class="story-details-content" id="acceptance-criteria">
                      <!-- Acceptance criteria will be populated here -->
                    </div>
                  </div>

                  <!-- Additional Details Section -->
                  <div class="story-details-section">
                    <div class="story-details-header">
                      <i class="fas fa-info"></i>
                      Additional Details
                    </div>
                    <div class="story-details-content" id="additional-details">
                      <!-- Additional details will be populated here -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Details Chat Area -->
            <div class="chat-area">
              <div class="chat-header">
                <i class="fas fa-comments"></i>
                Refine Details
              </div>
              <div class="chat-messages" id="details-chat-messages">
                <div class="chat-message ai">
                  <div class="message-bubble">
                    📝 I'm here to help you polish the story details. You can ask me to refine acceptance criteria, add more context, or prepare for Jira submission.
                  </div>
                </div>
              </div>
              <div class="chat-input-area">
                <div class="chat-input-container">
                  <input type="text" class="chat-input" id="details-chat-input" placeholder="Ask about story details or request improvements..." onkeypress="handleDetailsChatEnter(event)">
                  <button class="chat-send-btn" id="details-chat-send" onclick="sendDetailsMessage()" disabled>
                    <i class="fas fa-paper-plane"></i>
                  </button>
                  <button class="btn btn-primary ms-2" id="details-chat-apply" onclick="applyStoryDetailsChatChangesFromPanel()" style="display:none;">
                    <i class="fas fa-check"></i> Apply
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Floating How To helper for all tabs -->
  <style>
  .howto-fab { position: fixed; right: 24px; bottom: var(--fab-bottom-offset, 24px); z-index: 1060; border-radius: 999px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
  /* Distinct Help pill (match POC4) */
  .btn-help { display:inline-flex; align-items:center; gap:.4rem; border-radius:999px; border:1px solid #d32f2f; background:linear-gradient(90deg,#d32f2f 60%,#b71c1c); color:#fff !important; font-weight:700; padding:.45rem .9rem; box-shadow:0 4px 12px rgba(211,47,47,.18); }
  .btn-help:hover { filter:brightness(1.05); box-shadow:0 6px 16px rgba(211,47,47,.24); }
  .btn-help:focus { outline:3px solid rgba(211,47,47,.14); outline-offset:2px; }
    .howto-nav .nav-link.active { background: #dc3545; color: #fff; }

    /* When Story Details tab is active, lift the FAB above the chat input to avoid overlap */
    body.details-tab-active .howto-fab { bottom: 96px; }

    /* Slightly more room on smaller screens */
    @media (max-width: 768px) {
      body.details-tab-active .howto-fab { bottom: 112px; right: 16px; }
    }
  </style>
  <button type="button" class="btn btn-help howto-fab" data-bs-toggle="offcanvas" data-bs-target="#howtoOffcanvas" aria-controls="howtoOffcanvas" title="Help (Shift + ?)">
    <i class="fas fa-life-ring"></i>
    <span>Help</span>
  </button>
  <div class="offcanvas offcanvas-end" tabindex="-1" id="howtoOffcanvas" aria-labelledby="howtoLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="howtoLabel">How To · Backlog Workbench</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="nav nav-pills howto-nav mb-3" id="howtoTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="howto-epics-tab" data-bs-toggle="tab" data-bs-target="#howto-epics" type="button" role="tab">
            <i class="fas fa-flag me-1"></i> Epics
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="howto-stories-tab" data-bs-toggle="tab" data-bs-target="#howto-stories" type="button" role="tab">
            <i class="fas fa-tasks me-1"></i> User Stories
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="howto-details-tab" data-bs-toggle="tab" data-bs-target="#howto-details" type="button" role="tab">
            <i class="fas fa-info-circle me-1"></i> Story Details
          </button>
        </li>
      </ul>

      <div class="tab-content" id="howtoTabContent">
        <!-- Epics How To -->
        <div class="tab-pane fade show active" id="howto-epics" role="tabpanel" aria-labelledby="howto-epics-tab">
          <ol class="mb-3">
            <li>Upload PRD (required) and optionally System Mapping, or pick a PRD from Vector DB.</li>
            <li>Add Context & Instructions to steer generation (priorities, constraints, scope).</li>
            <li>Click “Submit Files & Generate Epics” and watch the timer/progress.</li>
            <li>Review generated epics. Select one to highlight; use the chat to refine titles/descriptions.</li>
            <li>When ready, proceed to the User Stories tab to generate stories for the selected epic.</li>
          </ol>
          <div class="small text-muted">
            Tips: Clear, outcome-focused epic titles improve story quality. Capture dependencies or risks in Context.
          </div>
        </div>

        <!-- Stories How To -->
        <div class="tab-pane fade" id="howto-stories" role="tabpanel" aria-labelledby="howto-stories-tab">
          <ol class="mb-3">
            <li>Select an epic, then click the stories generator to create user stories.</li>
            <li>Review each story’s title and description. Use the chat to adjust scope and clarity.</li>
            <li>Choose a story to view details and acceptance criteria in the next tab.</li>
          </ol>
          <div class="small text-muted">
            Tips: Keep stories user‑centric; write measurable, unambiguous acceptance criteria; mark cross-team dependencies.
          </div>
        </div>

        <!-- Story Details How To -->
        <div class="tab-pane fade" id="howto-details" role="tabpanel" aria-labelledby="howto-details-tab">
          <ol class="mb-3">
            <li>Select a user story, then generate details (AC, tagged requirements, traceability).</li>
            <li>Use the chat to refine AC and descriptions; click Apply to update panels where available.</li>
            <li>When satisfied, click “Submit to Jira” to create the ticket and get a link.</li>
          </ol>
          <div class="small text-muted">
            Tips: Reference PRD sections for traceability; ensure AC are testable; confirm non‑functional constraints if relevant.
          </div>
        </div>
      </div>

      <hr>
      <div class="small text-muted">
        Shortcut: Shift + ? toggles this guide. The section auto-syncs to the active tab.
      </div>
    </div>
  </div>

  <script>
    // Keyboard shortcut: Shift + ?
    document.addEventListener('keydown', function(e){
      if (e.shiftKey && (e.key === '?' || e.key === '/')) {
        const panel = document.getElementById('howtoOffcanvas');
        if (!panel || !window.bootstrap) return;
        syncHowToToActiveMainTab();
        bootstrap.Offcanvas.getOrCreateInstance(panel).toggle();
      }
    });

    // Sync How To inner tab with main active tab
    function syncHowToToActiveMainTab() {
      const mainActive = document.querySelector('#mainTabs .nav-link.active');
      if (!mainActive) return;
      const id = mainActive.id || '';
      const map = { 'epics-tab': 'howto-epics-tab', 'stories-tab': 'howto-stories-tab', 'details-tab': 'howto-details-tab' };
      const target = map[id];
      if (!target) return;
      const btn = document.getElementById(target);
      if (btn) bootstrap.Tab.getOrCreateInstance(btn).show();
    }

    // Toggle FAB offset class based on active main tab (prevents overlap with chat send button)
    function updateFabOffsetBasedOnTab() {
      const detailsPane = document.getElementById('details-pane');
      const isActive = !!detailsPane && detailsPane.classList.contains('active');
      document.body.classList.toggle('details-tab-active', isActive);
    }

    // When main tab changes, update How To
    document.getElementById('mainTabs')?.addEventListener('shown.bs.tab', function () {
      syncHowToToActiveMainTab();
      updateFabOffsetBasedOnTab();
    });

    document.addEventListener('DOMContentLoaded', function() {
      syncHowToToActiveMainTab();
      updateFabOffsetBasedOnTab();
    });
  </script>
  <script>
    // Global state
    let currentEpics = [];
    let currentUserStories = [];
    let selectedEpic = null;
    let selectedUserStory = null;
    let currentStoryDetails = null;
    
    // Timer variables
    let loadingTimers = {};

    // Timer functions
    function startLoadingTimer(timerId) {
      if (loadingTimers[timerId]) {
        clearInterval(loadingTimers[timerId].interval);
      }
      
      const startTime = Date.now();
      const timerElement = document.getElementById(timerId);
      
      if (!timerElement) return;
      
      loadingTimers[timerId] = {
        startTime: startTime,
        interval: setInterval(() => {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          
          const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
          timerElement.textContent = timeString;
          
          // Add visual feedback for longer processes
          if (elapsed > 10) {
            timerElement.style.background = 'rgba(255, 193, 7, 0.9)';
            timerElement.style.borderColor = '#ffc107';
            timerElement.style.color = '#212529';
          }
          if (elapsed > 30) {
            timerElement.style.background = 'rgba(220, 53, 69, 0.9)';
            timerElement.style.borderColor = '#dc3545';
            timerElement.style.color = 'white';
          }
        }, 1000)
      };
    }

    function stopLoadingTimer(timerId) {
      if (loadingTimers[timerId]) {
        clearInterval(loadingTimers[timerId].interval);
        delete loadingTimers[timerId];
        
        const timerElement = document.getElementById(timerId);
        if (timerElement) {
          // Reset timer appearance
          timerElement.style.background = 'rgba(255, 255, 255, 0.9)';
          timerElement.style.borderColor = 'var(--primary-red)';
          timerElement.style.color = 'var(--primary-red)';
        }
      }
    }

    function resetLoadingTimer(timerId) {
      stopLoadingTimer(timerId);
      const timerElement = document.getElementById(timerId);
      if (timerElement) {
        timerElement.textContent = '00:00';
      }
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Tabbed Layout initialized');
      
      // Reset all timers on page load
      resetLoadingTimer('epics-timer');
      resetLoadingTimer('stories-timer');
      resetLoadingTimer('details-timer');
      
      // Setup submit button event listener
      const submitBtn = document.getElementById('submit-files-btn');
      if (submitBtn) {
        console.log('Submit button found, adding event listener');
        submitBtn.addEventListener('click', function(event) {
          event.preventDefault();
          console.log('Submit button clicked!');
          submitFilesAndGenerateEpics();
        });
      } else {
        console.error('Submit button not found!');
      }
      
      // Enable/disable chat send buttons based on input
      setupChatInputs();
      
      // Setup file upload drag and drop
      setupDragAndDrop();
    });

    // Setup chat inputs
    function setupChatInputs() {
      const epicChatInput = document.getElementById('epic-chat-input');
      const epicChatSend = document.getElementById('epic-chat-send');
      
      const storyChatInput = document.getElementById('story-chat-input');
      const storyChatSend = document.getElementById('story-chat-send');
      
      const detailsChatInput = document.getElementById('details-chat-input');
      const detailsChatSend = document.getElementById('details-chat-send');

      epicChatInput.addEventListener('input', function() {
        epicChatSend.disabled = !this.value.trim();
      });

      storyChatInput.addEventListener('input', function() {
        storyChatSend.disabled = !this.value.trim();
      });

      detailsChatInput.addEventListener('input', function() {
        detailsChatSend.disabled = !this.value.trim();
      });
    }

    // Setup drag and drop (optional enhancement)
    function setupDragAndDrop() {
      // For future enhancement - currently using form-based upload
    }

    // Update submit button state (button is always enabled)
    function updateSubmitButton() {
      console.log('updateSubmitButton called');
      const prdFile = document.getElementById('prd-file').files[0];
      const systemMappingFile = document.getElementById('system-mapping-file').files[0];
      const submitBtn = document.getElementById('submit-files-btn');
      
      console.log('PRD file:', prdFile ? prdFile.name : 'none');
      console.log('System mapping file:', systemMappingFile ? systemMappingFile.name : 'none');
      console.log('Submit button found:', !!submitBtn);
      
      if (!submitBtn) {
        console.error('Submit button not found!');
        return;
      }
      
      // Keep button always enabled
      submitBtn.disabled = false;
      
      // Update button text based on files selected
      if (prdFile && systemMappingFile) {
        submitBtn.innerHTML = '<i class="fas fa-magic"></i> Submit Files & Generate Epics';
      } else if (prdFile) {
        submitBtn.innerHTML = '<i class="fas fa-magic"></i> Submit PRD & Generate Epics';
      } else {
        submitBtn.innerHTML = '<i class="fas fa-magic"></i> Submit Files & Generate Epics';
      }
    }

    // Submit files and generate epics
    async function submitFilesAndGenerateEpics() {
      console.log('=== submitFilesAndGenerateEpics START ===');
      
      try {
        console.log('Step 1: Getting file inputs...');
        const prdFile = document.getElementById('prd-file');
        const systemMappingFile = document.getElementById('system-mapping-file');
        const contextNotes = document.getElementById('context-notes');
        
        console.log('File elements found:', {
          prdFile: !!prdFile,
          systemMappingFile: !!systemMappingFile,
          contextNotes: !!contextNotes
        });
        
        if (!prdFile || !systemMappingFile || !contextNotes) {
          console.error('Missing form elements!');
          alert('Error: Form elements not found. Please refresh the page.');
          return;
        }
        
        const prdFileSelected = prdFile.files[0];
        const systemMappingFileSelected = systemMappingFile.files[0];
        const contextNotesValue = contextNotes.value;

        console.log('Step 2: Files selected:', {
          prd: prdFileSelected ? prdFileSelected.name : 'none',
          system: systemMappingFileSelected ? systemMappingFileSelected.name : 'none',
          context: contextNotesValue ? 'provided' : 'empty'
        });

        console.log('Step 3: Validating files...');
        if (!prdFileSelected && !systemMappingFileSelected) {
          alert('Please select at least a PRD file or System Mapping file to generate epics');
          return;
        }

        if (!prdFileSelected) {
          alert('PRD file is required. Please select a PRD file.');
          return;
        }

        console.log('Step 4: Showing loading state...');
        // Show loading state with timer
        const uploadSection = document.getElementById('upload-section');
        const epicsLoading = document.getElementById('epics-loading');
        const epicsEmpty = document.getElementById('epics-empty');
        
        if (uploadSection) uploadSection.style.display = 'none';
        if (epicsLoading) {
          epicsLoading.style.display = 'flex';
          startLoadingTimer('epics-timer');
        }
        if (epicsEmpty) epicsEmpty.style.display = 'none';

        console.log('Step 5: Preparing form data...');
        const formData = new FormData();
        formData.append('prd_file', prdFileSelected);
        
        // Only append system mapping if it exists
        if (systemMappingFileSelected) {
          formData.append('system_mapping_file', systemMappingFileSelected);
          console.log('Including system mapping file:', systemMappingFileSelected.name);
        } else {
          console.log('No system mapping file selected');
        }
        
        if (contextNotesValue) {
          formData.append('context_notes', contextNotesValue);
        }

        // Use different endpoint based on files uploaded
        const endpoint = systemMappingFileSelected ? '/tabbed-upload-files' : '/tabbed-upload-prd';
        console.log('Step 6: Using endpoint:', endpoint);

        console.log('Step 7: Making API call...');
        const response = await fetch(endpoint, {
          method: 'POST',
          body: formData
        });

        console.log('Step 8: Response received, status:', response.status);
        const data = await response.json();
        console.log('Step 9: Response data:', data);

        if (data.success) {
          console.log('Step 10: Success! Processing epics...');
          console.log('Raw epics data:', data.epics);
          console.log('Number of epics:', data.epics ? data.epics.length : 0);
          
          // Stop loading timer
          stopLoadingTimer('epics-timer');
          
          // Store epics globally
          currentEpics = data.epics || [];
          window.currentEpics = data.epics || [];
          console.log('Epics stored globally:', currentEpics);
          
          if (data.epics && data.epics.length > 0) {
            console.log('Calling displayEpics with', data.epics.length, 'epics');
            displayEpics(data.epics);
          } else {
            console.error('No epics in response data!');
            stopLoadingTimer('epics-timer');
            alert('No epics were generated. Please try again.');
            return;
          }
          
          // Enable epic chat
          const epicChatSend = document.getElementById('epic-chat-send');
          if (epicChatSend) epicChatSend.disabled = false;
          
          // Add success message to epic chat
          const fileText = systemMappingFileSelected ? 'PRD and System Mapping' : 'PRD';
          if (typeof addChatMessage === 'function') {
            addChatMessage('epic-chat-messages', `✅ Generated ${data.epics.length} epics successfully from your ${fileText}! You can now ask me questions or request refinements.`, 'ai');
          }
          console.log('=== submitFilesAndGenerateEpics SUCCESS ===');
        } else {
          throw new Error(data.error || 'Failed to generate epics');
        }
      } catch (error) {
        console.error('=== submitFilesAndGenerateEpics ERROR ===');
        console.error('Error generating epics:', error);
        alert('Error generating epics: ' + error.message);
        
        // Reset to upload state
        const epicsLoading = document.getElementById('epics-loading');
        const uploadSection = document.getElementById('upload-section');
        
        if (epicsLoading) epicsLoading.style.display = 'none';
        if (uploadSection) uploadSection.style.display = 'block';
      }
    }

    // Display epics
    function displayEpics(epics) {
      console.log('displayEpics called with:', epics);
      const epicsLoading = document.getElementById('epics-loading');
      const epicsList = document.getElementById('epics-list');

      epicsLoading.style.display = 'none';
      epicsList.style.display = 'block';
      // Show Epic Chat Area when epics are displayed
      const epicChatArea = document.getElementById('epic-chat-area');
      if (epicChatArea) epicChatArea.style.display = 'block';

      // Store epics globally for access in other functions
      currentEpics = epics;
      console.log('currentEpics updated:', currentEpics);

      let html = '<div class="epics-selection-container">';
      html += '<h5 class="mb-3"><i class="fas fa-flag"></i> Select an Epic to Generate User Stories</h5>';
      
      epics.forEach((epic, index) => {
        console.log(`Epic ${index}:`, epic);
        const priorityClass = epic.priority.toLowerCase() === 'high' ? 'priority-high' : 
                             epic.priority.toLowerCase() === 'low' ? 'priority-low' : 'priority-medium';
        // Add onchange to set selectedEpic
        html += `
          <div class="epic-radio-item">
            <div class="form-check epic-check">
              <input class="form-check-input" type="radio" name="selectedEpic" id="epic_${index}" value="${index}" onchange="updateGenerateButton(); setSelectedEpic(${index});">
              <label class="form-check-label epic-label" for="epic_${index}">
                <div class="epic-title">${epic.title}</div>
                <div class="epic-description">${epic.description}</div>
                <div class="epic-metadata">
                  <span><i class="fas fa-flag"></i> <span class="${priorityClass}">${epic.priority}</span></span>
                  <span><i class="fas fa-tasks"></i> ${epic.estimated_stories || 'TBD'} stories</span>
                  <span><i class="fas fa-clock"></i> ${epic.estimated_effort || 'TBD'} estimate</span>
                </div>
              </label>
            </div>
          </div>
        `;
      });
      
      html += `
        <div class="text-center mt-4">
          <button class="btn btn-primary btn-lg" id="generate-stories-btn" onclick="generateUserStories()" disabled>
            <i class="fas fa-magic"></i> Generate User Stories
          </button>
        </div>
      </div>`;

      epicsList.innerHTML = html;
      console.log('Epic list HTML generated and inserted');
    }

    // Update generate button state
    function updateGenerateButton() {
      const selectedRadio = document.querySelector('input[name="selectedEpic"]:checked');
      const generateBtn = document.getElementById('generate-stories-btn');
      generateBtn.disabled = !selectedRadio;
    }

    // Set selectedEpic when an epic is selected
    function setSelectedEpic(index) {
      if (currentEpics && currentEpics[index]) {
        selectedEpic = currentEpics[index];
      }
    }

    // Generate user stories for selected epic
    async function generateUserStories() {
      const selectedRadio = document.querySelector('input[name="selectedEpic"]:checked');
      
      if (!selectedRadio) {
        alert('Please select an epic first');
        return;
      }

      const epicIndex = parseInt(selectedRadio.value);
      console.log('Selected epic index:', epicIndex);
      console.log('Available epics:', currentEpics);
      
      if (epicIndex >= currentEpics.length) {
        alert('Invalid epic selection');
        return;
      }
      
      const epic = currentEpics[epicIndex];
      console.log('Selected epic:', epic);
      selectedEpic = epic;

      // Enable stories tab
      const storiesTab = document.getElementById('stories-tab');
      storiesTab.classList.remove('disabled');

      // Show loading in stories tab
      document.getElementById('stories-loading').style.display = 'flex';
      document.getElementById('stories-empty').style.display = 'none';
      
      // Start stories timer
      startLoadingTimer('stories-timer');

      // Switch to stories tab
      const tab = new bootstrap.Tab(storiesTab);
      tab.show();

      try {
        // Use the updated epic object from global state
        console.log('Sending updated epic to backend:', epic);
        const response = await fetch('/tabbed-select-epic', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            epic_id: epic.id,
            epic: epic // send both for compatibility
          })
        });

        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);

        if (data.success) {
          currentUserStories = data.user_stories;
          displaySelectedEpic(data.epic);
          displayUserStories(data.user_stories);
          
          // Enable story chat
          document.getElementById('story-chat-send').disabled = false;
          
          // Add success message to story chat
          addChatMessage('story-chat-messages', `🎯 Generated ${data.user_stories.length} user stories for "${data.epic.title}". Ask me anything about these stories!`, 'ai');
        } else {
          throw new Error(data.error || 'Failed to generate user stories');
        }
      } catch (error) {
        console.error('Error selecting epic:', error);
        alert('Error generating user stories: ' + error.message);
        
        // Stop loading timer and reset stories tab
        stopLoadingTimer('stories-timer');
        document.getElementById('stories-loading').style.display = 'none';
        document.getElementById('stories-empty').style.display = 'block';
      }
    }

    // Display selected epic info
    function displaySelectedEpic(epic) {
      const selectedEpicInfo = document.getElementById('selected-epic-info');
      const selectedEpicDisplay = document.getElementById('selected-epic-display');
      
      selectedEpicDisplay.innerHTML = `
        <h6>${epic.title}</h6>
        <p>${epic.description}</p>
      `;
      
      selectedEpicInfo.style.display = 'block';
    }

    // Display user stories
    function displayUserStories(userStories) {
      const storiesLoading = document.getElementById('stories-loading');
      const storiesList = document.getElementById('stories-list');

      // Stop stories timer
      stopLoadingTimer('stories-timer');

      storiesLoading.style.display = 'none';
      storiesList.style.display = 'block';
      // Show Story Chat Area when user stories are displayed
      const storyChatArea = document.getElementById('story-chat-area');
      if (storyChatArea) storyChatArea.style.display = 'block';

      let html = '<div class="stories-selection-container">';
      html += '<h5 class="mb-3"><i class="fas fa-tasks"></i> Select a User Story to Generate Details</h5>';
      
      userStories.forEach((story, index) => {
        const priorityClass = story.priority.toLowerCase() === 'high' ? 'priority-high' : 
                             story.priority.toLowerCase() === 'low' ? 'priority-low' : 'priority-medium';
        
        html += `
          <div class="story-radio-item">
            <div class="form-check story-check">
              <input class="form-check-input" type="radio" name="selectedStory" id="story_${index}" value="${index}" onchange="updateGenerateDetailsButton()">
              <label class="form-check-label story-label" for="story_${index}">
                <div class="user-story-title">${story.title}</div>
                <div class="user-story-description">${story.description}</div>
                <div class="user-story-metadata">
                  <span><i class="fas fa-flag"></i> <span class="${priorityClass}">${story.priority}</span></span>
                  <span><i class="fas fa-weight-hanging"></i> ${story.estimated_effort || 'TBD'}</span>
                  <span><i class="fas fa-cogs"></i> ${story.responsible_systems || 'TBD'}</span>
                </div>
              </label>
            </div>
          </div>
        `;
      });
      
      html += `
        <div class="text-center mt-4">
          <button class="btn btn-primary btn-lg" id="generate-details-btn" onclick="generateStoryDetails()" disabled>
            <i class="fas fa-file-alt"></i> Generate Story Details
          </button>
        </div>
      </div>`;

      storiesList.innerHTML = html;
    }

    // Update generate details button state
    function updateGenerateDetailsButton() {
      const selectedRadio = document.querySelector('input[name="selectedStory"]:checked');
      const generateBtn = document.getElementById('generate-details-btn');
      if (generateBtn) {
        generateBtn.disabled = !selectedRadio;
      }
    }

    // Generate story details for selected user story
    async function generateStoryDetails() {
      const selectedRadio = document.querySelector('input[name="selectedStory"]:checked');
      
      if (!selectedRadio) {
        alert('Please select a user story first');
        return;
      }

      const storyIndex = parseInt(selectedRadio.value);
      console.log('Selected story index:', storyIndex);
      console.log('Available user stories:', currentUserStories);
      
      if (storyIndex >= currentUserStories.length) {
        alert('Invalid story selection');
        return;
      }
      
      const story = currentUserStories[storyIndex];
      console.log('Selected story:', story);
      selectedUserStory = story;

      // Enable details tab
      const detailsTab = document.getElementById('details-tab');
      detailsTab.classList.remove('disabled');

      // Show loading in details tab
      document.getElementById('details-loading').style.display = 'flex';
      document.getElementById('details-empty').style.display = 'none';
      
      // Start details timer
      startLoadingTimer('details-timer');

      // Switch to details tab
      const tab = new bootstrap.Tab(detailsTab);
      tab.show();

      try {
        // Use the updated user story object from global state
        console.log('Sending updated user story to backend:', story);
        const response = await fetch('/tabbed-select-story', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            story: story // send the full updated user story object
          })
        });

        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);

        if (data.success) {
          displayStoryDetails(data.story_details);
          
          // Enable details chat
          document.getElementById('details-chat-send').disabled = false;
          
          // Add success message to details chat
          addChatMessage('details-chat-messages', `📋 Generated detailed acceptance criteria and technical specifications for "${story.title}". Ask me anything about these details!`, 'ai');
        } else {
          throw new Error(data.error || 'Failed to generate story details');
        }
      } catch (error) {
        console.error('Error generating story details:', error);
        alert('Error generating story details: ' + error.message);
        
        // Stop details timer and reset details tab
        stopLoadingTimer('details-timer');
        document.getElementById('details-loading').style.display = 'none';
        document.getElementById('details-empty').style.display = 'block';
      }
    }

    // Simple markdown to HTML converter for traceability matrix
    function markdownToHtml(markdown) {
      if (!markdown || markdown === 'Not available') {
        return '<p class="text-muted">Not available</p>';
      }
      
      let html = markdown
        // Convert headers (must be at start of line)
        .replace(/^### (.+)$/gm, '<h6>$1</h6>')
        .replace(/^## (.+)$/gm, '<h5>$1</h5>')
        .replace(/^# (.+)$/gm, '<h4>$1</h4>')
        // Convert bold text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/__(.*?)__/g, '<strong>$1</strong>')
        // Convert italic text
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/_(.*?)_/g, '<em>$1</em>')
        // Convert code blocks first (to avoid conflicts)
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        // Convert tables (improved handling)
        .replace(/^\|(.+)\|$/gm, function(match, content) {
          const cells = content.split('|').map(cell => cell.trim()).filter(cell => cell);
          return '<tr>' + cells.map(cell => `<td>${cell}</td>`).join('') + '</tr>';
        })
        // Convert bullet points (must be at start of line)
        .replace(/^[\*\-] (.+)$/gm, '<li>$1</li>')
        // Convert numbered lists (must be at start of line)
        .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
        // Convert horizontal rules
        .replace(/^---+$/gm, '<hr>')
        // Convert line breaks (double newlines become paragraph breaks)
        .replace(/\n\s*\n/g, '</p><p>')
        .replace(/\n/g, '<br>');
      
      // Post-process to wrap consecutive list items in ul tags
      html = html.replace(/(<li>.*?<\/li>)(?:\s*<br>\s*<li>.*?<\/li>)*/g, function(match) {
        const items = match.replace(/<br>\s*/g, '').match(/<li>.*?<\/li>/g);
        return '<ul>' + items.join('') + '</ul>';
      });
      
      // Post-process to wrap consecutive table rows in table tags
      if (html.includes('<tr>')) {
        html = html.replace(/(<tr>.*?<\/tr>)(?:\s*<br>\s*<tr>.*?<\/tr>)*/g, function(match) {
          const rows = match.replace(/<br>\s*/g, '').match(/<tr>.*?<\/tr>/g);
          return '<table class="table table-sm table-bordered">' + rows.join('') + '</table>';
        });
      }
      
      // Wrap content in paragraphs if it doesn't start with a block element
      if (!html.match(/^<(h[1-6]|ul|table|pre|hr)/)) {
        html = '<p>' + html + '</p>';
      }
      
      // Clean up empty paragraphs and extra breaks
      html = html.replace(/<p><\/p>/g, '').replace(/<p><br><\/p>/g, '');
      
      return html;
    }

    // Display story details
    function displayStoryDetails(details) {
      const detailsLoading = document.getElementById('details-loading');
      const detailsSections = document.getElementById('details-sections');
      
      // Stop details timer
      stopLoadingTimer('details-timer');
      
      detailsLoading.style.display = 'none';
      detailsSections.style.display = 'block';

      // Show Refine Details chat area only after Story Details are displayed
      const detailsChatArea = document.getElementById('details-chat-area');
      if (detailsChatArea) detailsChatArea.style.display = 'block';

      // Store the current story details for Jira submission
      currentStoryDetails = details;

      // Show Submit to Jira button
      const submitBtn = document.getElementById('submit-jira-btn');
      submitBtn.style.display = 'inline-block';

      // Story Info
      document.getElementById('story-info').innerHTML = `
        <h5>${details.title}</h5>
        <p><strong>Description:</strong> ${details.description}</p>
        <p><strong>Epic:</strong> ${details.epic_title}</p>
      `;

      // Acceptance Criteria
      document.getElementById('acceptance-criteria').innerHTML = `
        <div style="white-space: pre-line;">${details.acceptance_criteria}</div>
      `;

      // Process tagged requirements into modern bulleted format
      const processTaggedRequirements = (taggedReqs) => {
        if (!taggedReqs || taggedReqs === 'Not available' || taggedReqs === 'TBD') {
          return '<p class="text-muted"><i class="fas fa-info-circle"></i> Tagged requirements not available</p>';
        }
        
        let requirements = [];
        
        // Handle different data types
        if (typeof taggedReqs === 'string') {
          // Split by comma if it's a string
          requirements = taggedReqs.split(',').map(req => req.trim()).filter(req => req);
        } else if (Array.isArray(taggedReqs)) {
          // Use directly if it's already an array
          requirements = taggedReqs.map(req => String(req).trim()).filter(req => req);
        } else if (typeof taggedReqs === 'object') {
          // Convert object to array of values
          requirements = Object.values(taggedReqs).map(req => String(req).trim()).filter(req => req);
        } else {
          // Convert any other type to string and try to split
          requirements = String(taggedReqs).split(',').map(req => req.trim()).filter(req => req);
        }
        
        if (requirements.length === 0) {
          return '<p class="text-muted"><i class="fas fa-info-circle"></i> No tagged requirements found</p>';
        }
        
        return `
          <div class="modern-requirements-list">
            ${requirements.map(req => `
              <div class="requirement-item">
                <div class="requirement-bullet">
                  <i class="fas fa-tag"></i>
                </div>
                <div class="requirement-text">${req}</div>
              </div>
            `).join('')}
          </div>
        `;
      };

      // Additional Details - split into two sections for better organization
      document.getElementById('additional-details').innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <p><strong>Priority:</strong> <span class="priority-${details.priority.toLowerCase()}">${details.priority}</span></p>
            <p><strong>Estimated Effort:</strong> ${details.estimated_effort}</p>
            <p><strong>Responsible Systems:</strong> ${details.responsible_systems}</p>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <p><strong><i class="fas fa-tags"></i> Tagged Requirements:</strong></p>
              ${processTaggedRequirements(details.tagged_requirements)}
            </div>
          </div>
        </div>
        
        <!-- Requirements Traceability Matrix Section -->
        <div class="mt-4">
          <h6><i class="fas fa-table"></i> Requirements Traceability Matrix</h6>
          <div class="traceability-matrix" style="background: var(--surface-tertiary); padding: var(--spacing-md); border-radius: var(--radius-sm); border: 1px solid var(--border-light);">
            ${markdownToHtml(details.traceability_matrix || details.tagged_requirements || 'Traceability matrix not available')}
          </div>
        </div>
      `;
    }

    // Chat functions
    function handleEpicChatEnter(event) {
      if (event.key === 'Enter') {
        sendEpicMessage();
      }
    }

    function handleStoryChatEnter(event) {
      if (event.key === 'Enter') {
        sendStoryMessage();
      }
    }

    function handleDetailsChatEnter(event) {
      if (event.key === 'Enter') {
        sendDetailsMessage();
      }
    }

    async function sendEpicMessage() {
      const input = document.getElementById('epic-chat-input');
      const message = input.value.trim();
      
      if (!message) return;

      // Add user message
      addChatMessage('epic-chat-messages', message, 'user');
      input.value = '';

      // Add loading message
      const loadingId = addChatMessage('epic-chat-messages', 'Thinking...', 'ai', true);

      try {
        const response = await fetch('/tabbed-epic-chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: message
          })
        });

        const data = await response.json();

        // Remove loading message
        removeChatMessage(loadingId);

        if (data.success) {
          // Add AI message with Apply Changes button
          addChatMessage('epic-chat-messages', data.response, 'ai', false, true);
        } else {
          addChatMessage('epic-chat-messages', 'Sorry, I encountered an error. Please try again.', 'ai');
        }
      } catch (error) {
        console.error('Error in epic chat:', error);
        removeChatMessage(loadingId);
        addChatMessage('epic-chat-messages', 'Sorry, I encountered an error. Please try again.', 'ai');
      }
    }

    async function sendStoryMessage() {
      const input = document.getElementById('story-chat-input');
      const message = input.value.trim();
      
      if (!message) return;

      // Add user message
      addChatMessage('story-chat-messages', message, 'user');
      input.value = '';

      // Add loading message
      const loadingId = addChatMessage('story-chat-messages', 'Thinking...', 'ai', true);

      try {
        const response = await fetch('/tabbed-story-chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: message
          })
        });

        const data = await response.json();

        // Remove loading message
        removeChatMessage(loadingId);

        if (data.success) {
          // Add AI message with Apply Changes button (like Epic Chat)
          addChatMessage('story-chat-messages', data.response, 'ai', false, true);
        } else {
          addChatMessage('story-chat-messages', 'Sorry, I encountered an error. Please try again.', 'ai');
        }
      } catch (error) {
        console.error('Error in story chat:', error);
        removeChatMessage(loadingId);
        addChatMessage('story-chat-messages', 'Sorry, I encountered an error. Please try again.', 'ai');
      }
    }

    async function sendDetailsMessage() {
      const input = document.getElementById('details-chat-input');
      const message = input.value.trim();
      
      if (!message) return;

      // Add user message
      addChatMessage('details-chat-messages', message, 'user');
      input.value = '';

      // Add loading message
      const loadingId = addChatMessage('details-chat-messages', 'Thinking...', 'ai', true);

      try {
        const response = await fetch('/tabbed-details-chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: message
          })
        });

        const data = await response.json();

        // Remove loading message
        removeChatMessage(loadingId);

        if (data.success) {
          addChatMessage('details-chat-messages', data.response, 'ai');
        } else {
          addChatMessage('details-chat-messages', 'Sorry, I encountered an error. Please try again.', 'ai');
        }
      } catch (error) {
        console.error('Error in details chat:', error);
        removeChatMessage(loadingId);
        addChatMessage('details-chat-messages', 'Sorry, I encountered an error. Please try again.', 'ai');
      }
    }

    // Add chat message
function addChatMessage(containerId, message, sender, isLoading = false, showApply = false) {
  const container = document.getElementById(containerId);
  const messageId = 'msg-' + Date.now() + '-' + Math.random();

  const messageDiv = document.createElement('div');
  messageDiv.className = `chat-message ${sender}`;
  messageDiv.id = messageId;

  if (isLoading) {
    messageDiv.innerHTML = `
      <div class="message-bubble">
        <div class="loading-spinner" style="width: 20px; height: 20px; margin: 0;"></div>
        ${message}
      </div>
    `;
  } else {
    messageDiv.innerHTML = `
      <div class="message-bubble">${message}</div>
    `;
    // If showApply is true, add Apply Changes button for epic, story, or details chat
    if (showApply && (containerId === 'epic-chat-messages' || containerId === 'story-chat-messages' || containerId === 'details-chat-messages')) {
      const applyBtn = document.createElement('button');
      applyBtn.className = 'btn btn-success btn-sm mt-2';
      applyBtn.innerHTML = '<i class="fas fa-check"></i> Apply Changes';
      // Store only the AI response (strip prompt if present)
      let responseOnly = message;
      // If message contains a separator (e.g., "\nAI:" or "\nResponse:"), try to split
      const splitters = ['\nAI:', '\nResponse:', '\n---', '\n>'];
      for (const splitter of splitters) {
        if (responseOnly.includes(splitter)) {
          responseOnly = responseOnly.split(splitter).pop().trim();
        }
      }
      applyBtn.dataset.response = responseOnly;
      applyBtn.onclick = function() {
        const response = applyBtn.dataset.response;
        if (containerId === 'epic-chat-messages') {
          applyEpicChatChanges(response);
        } else if (containerId === 'story-chat-messages') {
          applyStoryChatChanges(response);
        } else if (containerId === 'details-chat-messages') {
          applyStoryDetailsChatChanges(response);
        }
        applyBtn.disabled = true;
        applyBtn.innerHTML = '<i class="fas fa-check"></i> Applied';
      };
      messageDiv.appendChild(applyBtn);
    }
  }
// Apply Story Details Chat changes to the Story Details panel
function applyStoryDetailsChatChanges(newContent) {
  // Only update the story details description in the details section with the AI response
  if (!selectedUserStory) {
    alert('No user story selected to apply changes.');
    return;
  }
  const storyInfo = document.getElementById('story-info');
  if (storyInfo) {
    // Update only the description field
    const descP = Array.from(storyInfo.querySelectorAll('p')).find(p => p.textContent.includes('Description:'));
    if (descP) {
      descP.innerHTML = `<strong>Description:</strong> ${newContent}`;
    }
    // Also update the global story details object
    if (currentStoryDetails) {
      currentStoryDetails.description = newContent;
    }
    if (selectedUserStory) {
      selectedUserStory.description = newContent;
    }
  }
}
// Apply Story Chat changes to the User Stories Tab
function applyStoryChatChanges(newContent) {
  // Always set selectedUserStory from the selected radio button
  const storiesList = document.getElementById('stories-list');
  if (storiesList) {
    const selectedRadio = storiesList.querySelector('input[name="selectedStory"]:checked');
    if (!selectedRadio) {
      alert('No user story selected to apply changes.');
      return;
    }
    const idx = parseInt(selectedRadio.value);
    if (!currentUserStories[idx]) {
      alert('No user story selected to apply changes.');
      return;
    }
    selectedUserStory = currentUserStories[idx];
    // Update the description in the label
    const label = storiesList.querySelector(`label[for="story_${idx}"] .user-story-description`);
    if (label) {
      label.innerHTML = newContent;
    }
    // Also update the global user story object
    currentUserStories[idx].description = newContent;
  }
}

  container.appendChild(messageDiv);
  container.scrollTop = container.scrollHeight;

  return messageId;
}

// Apply Epic Chat changes to the Epics Tab
function applyEpicChatChanges(newContent) {
  // Find the currently selected epic and update its content
  if (!selectedEpic) {
    alert('No epic selected to apply changes.');
    return;
  }
  // Update the epic description in the epics list
  const epicsList = document.getElementById('epics-list');
  if (epicsList) {
    // Find the epic label for the selected epic
    const epicRadios = epicsList.querySelectorAll('input[name="selectedEpic"]');
    epicRadios.forEach((radio, idx) => {
      if (selectedEpic && selectedEpic.id && currentEpics[idx] && currentEpics[idx].id === selectedEpic.id) {
        // Update the description in the label
        const label = epicsList.querySelector(`label[for="epic_${idx}"] .epic-description`);
        if (label) {
          label.innerHTML = newContent;
        }
        // Also update the global epic object
        currentEpics[idx].description = newContent;
      }
    });
  }
}

    // Remove chat message
    function removeChatMessage(messageId) {
      const message = document.getElementById(messageId);
      if (message) {
        message.remove();
      }
    }

    // Submit to Jira
    async function submitToJira() {
      if (!selectedUserStory || !currentStoryDetails) {
        console.log('Submit to Jira: No user story selected or story details missing');
        addChatMessage('details-chat-messages', '⚠️ Please select a user story and generate its details first before submitting to Jira.', 'ai');
        return;
      }

      // Log submission details for debugging
      console.log('Submitting to Jira:', {
        epic: selectedEpic?.title || 'Unknown',
        story: selectedUserStory?.title || selectedUserStory?.name || 'Unknown',
        priority: selectedEpic?.priority || 'High'
      });

      // Get submit button reference outside try block
      const submitBtn = document.getElementById('submit-jira-btn');
      if (!submitBtn) {
        console.error('submit-jira-btn not found in DOM!');
        addChatMessage('details-chat-messages', '❌ Error: Submit to Jira button not found in DOM.', 'ai');
        return;
      }
      const originalText = submitBtn.innerHTML;

      try {
        // Show loading state on submit button
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        submitBtn.disabled = true;
        console.log('Submit button set to loading state.');

        // Submit to Jira via AJAX
        console.log('Attempting Jira connection via /tabbed-submit-jira endpoint...');
        const response = await fetch('/tabbed-submit-jira', {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        });

        console.log('Jira response status:', response.status);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        // Parse JSON response
        const data = await response.json();
        console.log('Jira response data:', data);

        // Defensive DOM lookups and logging
        const storyDetailsDiv = document.getElementById('story-details-content');
        if (!storyDetailsDiv) {
          console.error('story-details-content not found in DOM during Jira response handling.');
        }
        const detailsSections = document.getElementById('details-sections');
        if (!detailsSections) {
          console.error('details-sections not found in DOM during Jira response handling.');
        }

        if (data.success) {
          // Success - prepend success message above the details sections
          if (storyDetailsDiv) {
            const jiraLinkHtml = data.jira_url ? 
              `<p class="mb-3"><a href="${data.jira_url}" target="_blank" class="btn btn-outline-primary">
                <i class="fas fa-external-link-alt"></i> View in Jira
              </a></p>` : '';
            const warningHtml = data.warning ? 
              `<div class="alert alert-warning mt-3" style="font-size: 0.9em;">
                <i class="fas fa-exclamation-triangle"></i> ${data.warning}
              </div>` : '';
            // Save the current details HTML
            const detailsSections = document.getElementById('details-sections');
            let detailsHtml = '';
            if (detailsSections) {
              detailsHtml = detailsSections.outerHTML;
            }
            storyDetailsDiv.innerHTML = `
              <div class="success-container text-center py-5">
                <div class="text-success mb-3">
                  <i class="fas fa-check-circle fa-3x"></i>
                </div>
                <h4 class="text-success">Successfully Submitted to Jira!</h4>
                <p class="mb-3">
                  <strong>Epic:</strong> ${data.epic_title || selectedEpic?.title || 'Unknown'}<br>
                  <strong>Story:</strong> ${data.user_story_name || selectedUserStory?.title || selectedUserStory?.name || 'Unknown'}<br>
                  <strong>Ticket ID:</strong> ${data.ticket_id || 'TST-' + Math.floor(Date.now() / 1000)}
                </p>
                ${jiraLinkHtml}
                ${warningHtml}
                <button class="btn btn-primary" onclick="location.reload()">
                  <i class="fas fa-plus"></i> Create Another Story
                </button>
              </div>
              ${detailsHtml}
            `;
          }
          // Hide submit button and reset its state for next use
          if (submitBtn) {
            console.log('Hiding submit-jira-btn after successful Jira submission.');
            submitBtn.style.display = 'none';
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
          } else {
            console.warn('submit-jira-btn not found in DOM when trying to hide/reset after Jira submission.');
          }
          // Also show message in chat
          addChatMessage('details-chat-messages', `🚀 Successfully submitted "${selectedUserStory.title || selectedUserStory.name}" to Jira! Ticket: ${data.ticket_id}`, 'ai');
          // Mark the story as created
          if (selectedUserStory && selectedUserStory.id) {
            const storyElem = document.querySelector(`.user-story-item[data-story-id='${selectedUserStory.id}']`);
            if (storyElem) {
              storyElem.classList.add('created');
              storyElem.setAttribute('data-editable', 'false');
            }
          }
          // Keep Story Details visible
          if (detailsSections) {
            detailsSections.style.display = '';
          } else {
            console.warn('details-sections not found in DOM when trying to keep Story Details visible.');
          }
          // Show Jira info to the right of content
          const jiraInfoDiv = document.createElement('div');
          jiraInfoDiv.className = 'jira-info-panel';
          jiraInfoDiv.innerHTML = `
            <div class="card border-success mb-3">
              <div class="card-header bg-success text-white"><i class="fab fa-jira"></i> Jira Ticket</div>
              <div class="card-body">
                <h5 class="card-title">${data.ticket_id || 'TST-' + Math.floor(Date.now() / 1000)}</h5>
                <p class="card-text">${data.jira_url ? `<a href='${data.jira_url}' target='_blank'>View in Jira</a>` : 'No link available'}</p>
              </div>
            </div>
          `;
          const contentArea = document.querySelector('.content-area');
          if (contentArea && !document.querySelector('.jira-info-panel')) {
            contentArea.appendChild(jiraInfoDiv);
          }
        } else {
          // Show error message
          if (storyDetailsDiv) {
            storyDetailsDiv.innerHTML = `
              <div class="error-container text-center py-5">
                <div class="text-danger mb-3">
                  <i class="fas fa-exclamation-triangle fa-3x"></i>
                </div>
                <h4 class="text-danger">Failed to Submit to Jira</h4>
                <p class="mb-3 text-danger">${data.error || data.message || 'Unknown error occurred'}</p>
                <p class="text-muted">Please check your JIRA configuration and try again.</p>
                <button class="btn btn-secondary" onclick="location.reload()">
                  <i class="fas fa-refresh"></i> Try Again
                </button>
              </div>
            `;
          } else {
            console.error('story-details-content not found in DOM when trying to show Jira error.');
          }
          // Reset submit button
          if (submitBtn) {
            console.log('Resetting submit-jira-btn after Jira error.');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
          }
          // Also show error in chat
          addChatMessage('details-chat-messages', `❌ Failed to submit to Jira: ${data.error || 'Unknown error'}`, 'ai');
          throw new Error(data.error || 'Failed to submit to Jira');
        }
      } catch (error) {
        console.error('Error submitting to Jira:', error);
        // Defensive DOM lookup and logging
        const storyDetailsDiv = document.getElementById('story-details-content');
        const detailsSections = document.getElementById('details-sections');
        if (storyDetailsDiv) {
          storyDetailsDiv.innerHTML = `
            <div class="error-container text-center py-5">
              <div class="text-danger mb-3">
                <i class="fas fa-exclamation-triangle fa-3x"></i>
              </div>
              <h4 class="text-danger">Error Submitting to Jira</h4>
              <p class="mb-3 text-danger">${error.message}</p>
              <p class="text-muted">Please check your JIRA configuration and try again.</p>
              <button class="btn btn-secondary" onclick="location.reload()">
                <i class="fas fa-refresh"></i> Try Again
              </button>
            </div>
          `;
        } else {
          console.error('story-details-content not found in DOM when trying to show Jira error.');
        }
        // Reset submit button
        if (submitBtn) {
          console.log('Resetting submit-jira-btn after Jira exception.');
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
        // Also show error in chat
        addChatMessage('details-chat-messages', `❌ Error submitting to Jira: ${error.message}`, 'ai');
      }
    }

    // Debug function to check session state
    async function debugSession() {
      try {
        console.log('=== DEBUG SESSION START ===');
        const response = await fetch('/debug-session');
        const data = await response.json();
        console.log('Session debug data:', data);
        
        alert(`Session Debug Info:
Session ID: ${data.session_id}
Has Epics: ${data.has_epics}
Epics Count: ${data.epics_count}
Current Epic: ${data.current_epic}
Session Keys: ${data.session_keys.join(', ')}
Epic IDs: ${data.epic_ids ? data.epic_ids.join(', ') : 'None'}`);
        
        console.log('=== DEBUG SESSION END ===');
      } catch (error) {
        console.error('Debug session error:', error);
        alert('Error fetching session debug info: ' + error.message);
      }
    }

    // Apply Story Details Chat changes to the Story Details panel
function applyStoryDetailsChatChanges(newContent) {
  // Only update the story details description in the details section with the AI response
  if (!selectedUserStory) {
    alert('No user story selected to apply changes.');
    return;
  }
  const storyInfo = document.getElementById('story-info');
  if (storyInfo) {
    // Update only the description field
    const descP = Array.from(storyInfo.querySelectorAll('p')).find(p => p.textContent.includes('Description:'));
    if (descP) {
      descP.innerHTML = `<strong>Description:</strong> ${newContent}`;
    }
    // Also update the global story details object
    if (currentStoryDetails) {
      currentStoryDetails.description = newContent;
    }
    if (selectedUserStory) {
      selectedUserStory.description = newContent;
    }
  }
}
// Apply Story Details Chat changes to the Story Details panel
function applyStoryDetailsChatChangesFromPanel() {
  if (!selectedUserStory || !currentStoryDetails) {
    alert('No user story selected to apply changes.');
    return;
  }
  // Collect updated details from UI (example: description, acceptance criteria, etc.)
  const storyInfo = document.getElementById('story-info');
  let updatedDescription = currentStoryDetails.description;
  if (storyInfo) {
    const descP = Array.from(storyInfo.querySelectorAll('p')).find(p => p.textContent.includes('Description:'));
    if (descP) {
      updatedDescription = descP.textContent.replace('Description:', '').trim();
    }
  }
  // Build updated details object
  const updatedDetails = Object.assign({}, currentStoryDetails, { description: updatedDescription });
  // Persist to backend
  fetch('/tabbed-apply-story-details', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ story_id: selectedUserStory.id, story_details: updatedDetails })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      // Optionally show a success message
      alert('Story details applied and saved.');
    } else {
      alert('Failed to save story details: ' + (data.error || 'Unknown error'));
    }
  })
  .catch(err => {
    alert('Error saving story details: ' + err);
  });
}

  </script>
</body>
</html>
