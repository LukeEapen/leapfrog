<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Step 3: Function Synthesizer Agent</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #23272b 0%, #343a40 100%);
      font-family: 'Segoe UI', Arial, sans-serif;
      min-height: 100vh;
    }
    .main-app-container {
      max-width: 100vw;
      margin: 40px auto;
      padding: 32px 2vw;
      background: #fff;
      border-radius: 2rem;
      box-shadow: 0 8px 32px rgba(44,44,44,0.18);
      min-height: 98vh;
      width: 100vw;
    }
    .agent-card {
      background: #f8f9fa;
      color: #23272b;
      border-radius: 1.5rem;
      box-shadow: 0 2px 12px rgba(44,44,44,0.10);
      padding: 2.5rem 2vw;
      margin: 2rem auto;
      max-width: 2400px;
      min-width: 1200px;
      min-height: 700px;
      width: 100vw;
    }
    .agent-title {
      font-size: 2.2rem;
      font-weight: bold;
      color: #fff;
      background: #d32f2f;
      border-radius: 1.25rem 1.25rem 0 0;
      padding: 1.2rem 2rem;
      margin-bottom: 0;
      box-shadow: 0 2px 12px rgba(44,44,44,0.10);
    }
    .chat-panel {
      background: rgba(255,255,255,0.25);
      border-radius: 1.5rem;
      padding: 2.5rem 3.5rem 2.2rem 3.5rem;
      margin-top: 1rem;
      box-shadow: 0 8px 32px rgba(44,44,44,0.18);
      backdrop-filter: blur(12px);
      border: 1.5px solid rgba(255,255,255,0.18);
      position: relative;
      overflow: hidden;
      max-width: 620px;
      min-width: 480px;
      width: 620px;
      margin-left: auto;
      margin-right: 0;
    }
    .agent-desc {
      font-size: 1.15rem;
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      background: linear-gradient(90deg, #d32f2f 0%, #f8f9fa 100%);
      border-radius: 1rem;
      padding: 0.7rem 1.2rem;
      box-shadow: 0 2px 8px rgba(44,44,44,0.10);
      color: #fff;
    }
      text-align: left;
      width: 100%;
      margin: 0 auto 2rem auto;
      box-shadow: 0 2px 12px rgba(44,44,44,0.06);
    }
    .btn, .btn-next, .btn-outline-danger, .btn-primary, .btn-success, .btn-sm {
      min-height: 44px;
      padding-top: 0.6rem;
      padding-bottom: 0.6rem;
      font-size: 1.08rem;
      border-radius: 1rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    .btn-next {
    .chat-history {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 1.2rem;
      padding-right: 1rem;
      background: rgba(255,255,255,0.18);
      border-radius: 1rem;
      box-shadow: 0 2px 8px rgba(44,44,44,0.08);
      padding: 1rem 1rem 1rem 1rem;
    }
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(211,47,47,0.08);
      margin-top: 1rem;
      transition: background 0.2s;
    }
    .btn-next:hover {
      background: #d32f2f;
      color: #fff;
      box-shadow: 0 2px 8px rgba(211,47,47,0.12);
      border-radius: 1rem;
      border: none;
    }
    .btn:hover, .btn:focus {
      box-shadow: 0 2px 8px rgba(44,44,44,0.14);
      border-radius: 1rem;
      outline: none;
    }
    .chat-msg {
      margin-bottom: 0.7rem;
      padding: 0.7rem 1rem;
      border-radius: 0.9rem;
      position: relative;
      max-width: 80%;
      font-size: 0.98rem;
      box-shadow: 0 2px 8px rgba(44,44,44,0.08);
      word-break: break-word;
      border: 1.5px solid #e0e0e0;
      transition: background 0.2s;
      display: flex;
      align-items: flex-end;
      gap: 0.5rem;
    }
    .chat-user {
      background: linear-gradient(90deg, #e3f2fd 0%, #d1e7dd 100%);
      margin-left: auto;
      text-align: right;
      border-top-right-radius: 1.5rem;
      border-bottom-right-radius: 1.5rem;
      border-top-left-radius: 0.9rem;
      border-bottom-left-radius: 0.9rem;
      border-left: 2px solid #d32f2f;
      flex-direction: row-reverse;
    }
    .chat-assistant {
      background: linear-gradient(90deg, #f8d7da 0%, #fff3e0 100%);
      margin-right: auto;
      text-align: left;
      border-top-left-radius: 1.5rem;
      border-bottom-left-radius: 1.5rem;
      border-top-right-radius: 0.9rem;
      border-bottom-right-radius: 0.9rem;
      border-right: 2px solid #d32f2f;
      flex-direction: row;
    }
      /* removed stray lines */
    .chat-input-row {
      display: flex;
      gap: 0.7rem;
      margin-top: 0.5rem;
      background: rgba(255,255,255,0.18);
      border-radius: 1rem;
      padding: 0.7rem 1rem;
      box-shadow: 0 2px 8px rgba(44,44,44,0.08);
    }
    @media (max-width: 991px) {
      .main-app-container { padding: 16px 4px; }
      .agent-card { padding: 1.5rem 0.5rem; }
    }
    @media (max-width: 767px) {
      .main-app-container { border-radius: 0.5rem; }
      .agent-title { font-size: 1.3rem; }
      .agent-desc { font-size: 1rem; }
    }
    .chat-panel {
      background: #f1f3f4;
      border-radius: 1rem;
      padding: 1.5rem;
      margin-top: 1rem;
      box-shadow: 0 2px 8px rgba(44,44,44,0.06);
    }
    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .chat-history {
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 1rem;
      padding-right: 1rem;
    }
    .chat-msg {
      margin-bottom: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      position: relative;
      max-width: 80%;
    }
    .chat-user {
      background: #d1e7dd;
      margin-left: auto;
      text-align: right;
    }
    .chat-assistant {
      background: #f8d7da;
      margin-right: auto;
      text-align: left;
    }
    .chat-input-row {
      display: flex;
      gap: 0.5rem;
    }
  /* Marked section styles (shared across POC 3b pages) */
  .marked-section{position:relative;border:2px dashed #d32f2f;border-radius:12px;padding:.4rem .7rem;background:rgba(211,47,47,.05);margin:0 0 .85rem 0}
  .marked-section .marked-label{position:absolute;top:-12px;left:14px;background:#d32f2f;color:#fff;border-radius:8px;padding:2px 10px;font-weight:800;font-size:.78rem;letter-spacing:.02em;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  </style>
    /* Story list expandable styling */
    .story-item {
      background:#f8d7da; /* light red */
      border:1px solid #e0b4b4;
      border-radius:.6rem;
      padding:.55rem .75rem .55rem .75rem;
      margin:.35rem 0;
      cursor:pointer;
      position:relative;
      transition:background .2s, box-shadow .2s;
    }
    .story-item:hover { background:#f5c2c7; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
    .story-item.active { outline:2px solid #d32f2f; }
    .story-item .story-header { display:flex; justify-content:space-between; align-items:flex-start; gap:.6rem; }
    .story-item .story-key { font-weight:700; color:#b71c1c; font-size:.82rem; letter-spacing:.5px; }
    .story-item .story-summary { flex:1; font-size:.75rem; color:#23272b; line-height:1.15; }
    .story-item .toggle-icon { font-size:.9rem; color:#b71c1c; font-weight:600; }
    .story-item-details { margin-top:.45rem; background:#f1f3f4; border:1px solid #ddd; border-radius:.45rem; padding:.55rem .6rem; font-size:.72rem; color:#23272b; line-height:1.25; display:none; white-space:pre-wrap; max-height:180px; overflow-y:auto; }
    .story-item.expanded .story-item-details { display:block; }
    .story-item.expanded .toggle-icon { transform:rotate(90deg); }
    .stories-empty { font-size:.7rem; color:#6c757d; padding:.4rem .2rem; }
</head>
<body>
  {% include 'partials/banner.html' %}
  <header style="background: linear-gradient(120deg, #d32f2f 60%, #23272b 100%); color: #fff; padding: 1.2rem 0 1rem 0; border-radius: 0 0 1.2rem 1.2rem; box-shadow: 0 4px 32px rgba(44,44,44,0.22); margin-bottom: 2.5rem; position:relative; overflow:hidden; border: 4px solid #fff; min-height:unset;">
    <div style="position:absolute; top:-40px; right:-60px; opacity:0.12; pointer-events:none;">
      <i class="bi bi-diagram-3" style="font-size:7rem;"></i>
    </div>
    <div class="container d-flex flex-column align-items-center position-relative" style="z-index:2;">
      <div class="d-flex align-items-center justify-content-center flex-wrap" style="gap:1.1rem; margin-bottom:0.2rem;">
        <i class="bi bi-cpu" style="font-size:1.7rem;"></i>
        <i class="bi bi-diagram-3" style="font-size:1.7rem;"></i>
        <i class="bi bi-lightbulb" style="font-size:1.7rem;"></i>
        <i class="bi bi-arrow-repeat" style="font-size:1.7rem;"></i>
        <i class="bi bi-gear" style="font-size:1.7rem;"></i>
        <span style="font-size:2.3rem; font-weight:900; letter-spacing:0.01em; margin-left:1.1rem; text-shadow:0 2px 8px rgba(44,44,44,0.10); vertical-align:middle; line-height:1;">Function Synthesizer Agent</span>
      </div>
      <div style="font-size:1.13rem; font-weight:500; color:#fff; opacity:0.93; max-width:900px; text-align:center; margin-bottom:0.2rem;">
        <span class="badge bg-warning text-dark me-2" style="font-size:1rem; border-radius:0.7rem; padding:0.5em 1em; vertical-align:middle;"><i class="bi bi-gear me-2"></i>Step 3</span>
        Analyze user stories and legacy code to synthesize the <b>5-10 most important technical functions</b> for your microservice.<br>
      </div>
      <noscript><div class="alert alert-danger mt-2">Bootstrap Icons require JavaScript enabled.</div></noscript>
      <div id="icon-fallback" style="display:none; color:yellow; font-weight:bold;">[Icons failed to load]</div>
    </div>
  </header>
  <div class="main-app-container d-flex flex-column align-items-stretch justify-content-start" style="gap:2.5rem; width:100%;">
    <div class="agent-card" style="width:100%; max-width:100%; margin:0; padding:2.5rem 3rem;">
      <div class="marked-section"><span class="marked-label">Marked</span></div>
      <!-- Bootstrap Icons CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Bootstrap Icons fallback check -->
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      var testIcon = document.createElement('i');
      testIcon.className = 'bi bi-cpu';
      document.body.appendChild(testIcon);
      var style = window.getComputedStyle(testIcon, '::before');
      var content = style.getPropertyValue('content');
      if (!content || content === 'none' || content === '""') {
        var fallback = document.getElementById('icon-fallback');
        if (fallback) fallback.style.display = 'block';
      }
      document.body.removeChild(testIcon);
    });
  </script>
      <div class="d-flex justify-content-between w-100" style="width:100%; margin-bottom:0; margin-top:-1.5rem;">
        <a href="/user-story-decomposer" class="btn px-4 d-flex align-items-center gap-2" style="font-weight:600; border-radius:1rem; box-shadow:0 2px 8px rgba(44,44,44,0.10); background:#6c757d; border:none; color:#fff; min-width:180px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#fff" class="bi bi-arrow-left-circle" viewBox="0 0 16 16">
            <path d="M8 15A7 7 0 1 0 8 1a7 7 0 0 0 0 14zm0 1A8 8 0 1 1 8 0a8 8 0 0 1 0 16z"/>
            <path d="M8.354 11.354a.5.5 0 0 1-.708 0l-3-3a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L6.707 8H11.5a.5.5 0 0 1 0 1H6.707l1.647 1.646a.5.5 0 0 1 0 .708z"/>
          </svg>
          <span style="color:#fff;">Step 2</span>
        </a>
  <!-- Removed Synthesize Functions button per requirement -->
      </div>
  <div class="row w-100 align-items-start mt-4" style="margin-top:0; flex-wrap:wrap; --bs-gutter-x: .25rem;">
  <div class="col-lg-8 col-md-12 d-flex flex-column align-items-stretch justify-content-start order-lg-1 order-1" style="max-width:100%; padding-right:.5rem; overflow:hidden;">
          <div class="d-flex justify-content-between align-items-center flex-wrap mb-3" style="gap:.75rem;">
            <div class="btn-group" role="group" aria-label="Actions" style="flex-wrap:wrap; gap:.5rem;">
              <button id="regenerateBtn" class="btn btn-sm" style="background:#d32f2f; color:#fff; min-width:180px;">Regenerate (Practical)</button>
              <button id="toggleScoresBtn" class="btn btn-sm btn-outline-secondary" style="min-width:140px;">Show Scores</button>
              <button id="exportJsonBtn" class="btn btn-sm btn-outline-dark" style="min-width:140px;">Export JSON</button>
            </div>
            <div class="d-flex align-items-center gap-2" style="flex-wrap:wrap;">
              <label for="overlapThresholdInput" class="form-label m-0" style="font-size:.9rem; color:#6c757d;">Overlap threshold</label>
              <input id="overlapThresholdInput" type="number" class="form-control form-control-sm" min="0" max="100" step="1" style="width:90px;" />
              <span class="text-secondary" style="font-size:.85rem;">%</span>
            </div>
            <div id="regenStatus" class="small text-secondary"></div>
          </div>
          <div id="coverageSummary" class="mb-3"></div>
          <div id="result" class="w-100" style="margin-top:0;"></div>
        </div>
  <div class="col-lg-4 col-md-12 d-flex flex-column order-lg-2 order-2" style="margin-left:0; margin-right:0; padding-left:.25rem;">
          <div id="selected-user-story-panel" class="p-3" style="background:#f1f3f4; border-radius:1rem; border:2px solid #e0e0e0; box-shadow:0 2px 8px rgba(44,44,44,0.08); min-height:360px; max-width:100%;">
            <div class="d-flex justify-content-between align-items-center flex-wrap mb-2" style="gap:.5rem .75rem;">
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <h5 class="m-0" style="color:#d32f2f; font-weight:700;">User Stories</h5>
                <span id="selectedCount" class="text-secondary small">Selected: 0</span>
              </div>
              <div class="d-flex gap-2 flex-wrap align-items-center">
                <button id="selectAllStoriesBtn" class="btn btn-sm btn-outline-secondary">Select All</button>
                <button id="clearSelectedStoriesBtn" class="btn btn-sm btn-outline-secondary">Clear</button>
                <button id="updateJiraBtn" class="btn btn-sm" style="background:#d32f2f; color:#fff;">Update Selected</button>
                <button id="updateAllJiraBtn" class="btn btn-sm" style="background:#23272b; color:#fff;">Update All</button>
              </div>
            </div>
            <div id="updateStatus" class="mt-2" role="status" aria-live="polite"></div>
            <div class="row g-2">
              <div class="col-12 mb-2">
                <select id="storiesDropdown" class="form-select" multiple size="8" style="max-height:160px; overflow-y:auto; border:1px solid #e0e0e0; border-radius:.5rem; background:#fff; max-width:100%;"></select>
              </div>
              <div class="col-12">
                <div id="selectedStoryMeta" class="text-secondary small mb-2">(Select a story)</div>
                <div id="selectedStoryContent" style="white-space:pre-wrap; font-size:0.95rem; line-height:1.4; max-height:180px; overflow-y:auto;"></div>
              </div>
            </div>
            <hr/>
            <div>
              <h6 style="font-weight:600; color:#d32f2f;">Delta (Legacy Code Only Functions)</h6>
              <div id="deltaLegacyFunctions" class="small text-secondary">(Will populate from synthesized result)</div>
            </div>
          </div>
        </div>
        <!-- Business Logic below the main row -->
      </div>
      <div class="row w-100 align-items-start mt-4" style="margin-top:0;">
        <div class="col-12">
          <div id="business-logic-col"></div>
        </div>
        </div>
          <div id="statusMsg" class="mt-3"></div>
        </div>
      <textarea class="form-control" id="editArea" style="width:100%; min-height:120px; border-radius:1rem; border:1.5px solid #d32f2f; padding:1rem; font-size:1.08rem; margin-bottom:1rem; display:none;" placeholder="Edit the functional breakdown response here..."></textarea>
    </div>
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      const resultDiv = document.getElementById('result');
      const scoresToggleBtn = document.getElementById('toggleScoresBtn');
      const regenerateBtn = document.getElementById('regenerateBtn');
      const exportJsonBtn = document.getElementById('exportJsonBtn');
      const regenStatus = document.getElementById('regenStatus');
      const overlapInput = document.getElementById('overlapThresholdInput');
      let showScores = false;
      // Overlap threshold (percentage) for classifying Common vs Delta; default 10%
      let overlapThresholdPct = parseFloat(localStorage.getItem('overlapThresholdPct') || '10');
      if (isNaN(overlapThresholdPct)) overlapThresholdPct = 10;
      if (overlapInput) {
        overlapInput.value = String(Math.max(0, Math.min(100, Math.round(overlapThresholdPct))));
        overlapInput.addEventListener('change', ()=>{
          let v = parseFloat(overlapInput.value);
          if (isNaN(v)) v = 10;
          v = Math.max(0, Math.min(100, Math.round(v)));
          overlapThresholdPct = v;
          localStorage.setItem('overlapThresholdPct', String(v));
          renderResponse(responseData);
          renderLegacyDelta();
        });
      }

      // Load cached synthesis result (may be array, object with functions, or raw string)
      let cachedRaw = localStorage.getItem('latestSynthesisResult');
  let responseData = [];
  let coverageData = null;
      try {
        if (cachedRaw) {
          const parsed = JSON.parse(cachedRaw);
    if (Array.isArray(parsed)) { responseData = parsed; }
    else if (parsed && Array.isArray(parsed.functions)) { responseData = parsed.functions; coverageData = parsed.coverage || null; }
    else if (parsed && Array.isArray(parsed.result)) { responseData = parsed.result; }
        }
      } catch(e) {
        // attempt to extract array from raw text using regex
        try {
          const match = cachedRaw && cachedRaw.match(/\[(.|\n|\r)*\]/);
          if (match) responseData = JSON.parse(match[0]);
        } catch(_) {}
      }

      // Collect reference corpora for similarity scoring
      const legacyMarkdown = localStorage.getItem('latestLegacyEnglish') || '';
      const userStoriesRaw = (function(){
        let raw = localStorage.getItem('selectedUserStories');
        if (!raw) return '';
        try { const arr = JSON.parse(raw); return arr.map(o => [o.summary||'', o.description||''].join('\n')).join('\n'); } catch(e){ return ''; }
      })();

      function stripMarkdown(md){
        return (md||'')
          .replace(/```[\s\S]*?```/g,' ') // code blocks
          .replace(/`[^`]*`/g,' ')
          .replace(/\!\[[^\]]*\]\([^)]*\)/g,' ')
          .replace(/\[[^\]]*\]\([^)]*\)/g,' ')
          .replace(/[#>*_~`\-]+/g,' ')
          .replace(/\|/g,' ')
          .replace(/\s+/g,' ') ;
      }
      const legacyPlain = stripMarkdown(legacyMarkdown).toLowerCase();
      const storyPlain = stripMarkdown(userStoriesRaw).toLowerCase();

      // Basic tokenizer / stopword filtering
      const STOP = new Set(['the','a','an','and','or','for','to','of','in','on','by','is','with','be','at','as','from','that','this','it','are','was','were','will','can','if','then','else','when','do','does','did']);
      function tokens(text){
        return Array.from(new Set((text||'').toLowerCase().match(/[a-z0-9]{3,}/g) || []).values())
          .filter(t => !STOP.has(t));
      }
      const legacyTokens = new Set(tokens(legacyPlain));
      const storyTokens = new Set(tokens(storyPlain));

      function jaccard(aSet, bSet){
        if (!aSet.size || !bSet.size) return 0;
        let inter = 0;
        for (const t of aSet) if (bSet.has(t)) inter++;
        return inter / (aSet.size + bSet.size - inter);
      }

      function computeScoresForFunction(f){
        const fTokens = new Set(tokens((f.name||'') + ' ' + (f.description||'')));
        const storyScore = jaccard(fTokens, storyTokens);
        const legacyScore = jaccard(fTokens, legacyTokens);
  const overlapScore = Math.min(1, (storyScore + legacyScore)/2 + Math.min(storyScore, legacyScore)*0.15); // slightly stricter
        return {storyScore, legacyScore, overlapScore};
      }
      function classifyFunction(f){
        // Prefer backend-provided label if present
        const src = (f && typeof f.source === 'string') ? f.source.toLowerCase() : '';
        if (src === 'both' || src === 'user_story' || src === 'legacy_code') return src;
        const {storyScore, legacyScore, overlapScore} = computeScoresForFunction(f);
        const thr = (overlapThresholdPct||10)/100;
        // Mark as common only if overlap meets threshold; otherwise delta to stronger side
        if (overlapScore >= thr && storyScore >= thr && legacyScore >= thr) return 'both';
        return (storyScore >= legacyScore) ? 'user_story' : 'legacy_code';
      }
  // Removed chat panel; maintain only synthesis rendering

      // Render main function response
      function pct(v){ return (v*100).toFixed(0)+'%'; }
      function scoreBadges(scores){
        if (!showScores) return '';
        const bar = (label,val,color)=>`<div style="display:flex;align-items:center;gap:.35rem; margin:2px 0;">
            <span class="badge" style="background:${color}; min-width:54px;">${label}</span>
            <div style="flex:1; background:#eee; height:6px; border-radius:4px; overflow:hidden; position:relative;">
              <div style="width:${Math.min(100, Math.round(val*100))}%; background:${color}; height:100%;"></div>
            </div>
            <span style="font-size:.7rem; color:#555;">${pct(val)}</span>
          </div>`;
        return `<div style="min-width:140px;">${bar('Story',scores.storyScore,'#1976d2')}${bar('Legacy',scores.legacyScore,'#6a1b9a')}${bar('Overlap',scores.overlapScore,'#d32f2f')}</div>`;
      }

  function renderResponse(data) {
        if (Array.isArray(data)) {
          // Classify dynamically using adjustable overlap threshold
          const commonFuncs = [];
          const uncommonUser = [];
          const uncommonLegacy = [];
          for (const f of data) {
            const cls = classifyFunction(f);
            if (cls === 'both') commonFuncs.push(f);
            else if (cls === 'user_story') uncommonUser.push(f);
            else uncommonLegacy.push(f);
          }
          function renderFuncCard(item, highlight, idx, arrType) {
            const scores = computeScoresForFunction(item);
            // Add a remove button for each function
            return `<div class='card mb-3' style='background:#f5f5f5; border:none; box-shadow:0 2px 8px rgba(44,44,44,0.06);'>
              <div class='card-body p-3 d-flex justify-content-between align-items-center'>
                <div>
                  <div class='fw-bold' style='font-size:1.15rem; color:#d32f2f;'>${item.name || ''}</div>
                  <div class='mb-1' style='color:#23272b;'>${item.description ? item.description.replace(/([^.])$/, '$1.') : ''}</div>
                  ${item.source ? `<span class='badge bg-dark'>${item.source}</span>` : ''}
                  ${highlight ? `<span class='badge bg-warning text-dark ms-2'>Delta</span>` : ''}
                </div>
                <div class='d-flex flex-column align-items-end' style='gap:.35rem;'>
                  ${scoreBadges(scores)}
                  <button class='btn btn-outline-danger btn-sm remove-func-btn' data-arrtype='${arrType}' data-idx='${idx}' title='Remove function'><i class='bi bi-x-lg'></i></button>
                </div>
              </div>
            </div>`;
          }
          let mainSection = '';
          if (commonFuncs.length > 0) {
            mainSection = `
              <div class='mb-4'>
                <div class='p-3 bg-light rounded border mb-2'><b>Common Functions (User Story & Legacy Code)</b></div>
                <div class='p-3 bg-white rounded border' style='min-height:200px;'>
                  ${commonFuncs.map((item, idx) => renderFuncCard(item, false, idx, 'common')).join('')}
                </div>
              </div>
            `;
          }
            let deltaSection = '';
            if (uncommonUser.length > 0 || uncommonLegacy.length > 0) {
            deltaSection = `
              <div class='row mt-4'>
              <div class='col-md-6 col-12 mb-4 mb-md-0'>
              <div class='p-3 bg-light rounded border mb-2'><b>Delta: User Story Only</b></div>
              <div class='p-3 bg-white rounded border' style='min-height:100px;'>
              ${uncommonUser.length > 0 ? uncommonUser.map((item, idx) => renderFuncCard(item, true, idx, 'user')).join('') : '<span class="text-secondary">No unique user story functions.</span>'}
              </div>
              </div>
              <div class='col-md-6 col-12'>
              <div class='p-3 bg-light rounded border mb-2'><b>Delta: Legacy Code Only</b></div>
              <div class='p-3 bg-white rounded border' style='min-height:100px;'>
              ${uncommonLegacy.length > 0 ? uncommonLegacy.map((item, idx) => renderFuncCard(item, true, idx, 'legacy')).join('') : '<span class="text-secondary">No unique legacy code functions.</span>'}
              </div>
              </div>
              </div>
              <div class='mt-3'><b>Note:</b> <span class='badge bg-warning text-dark'>Delta</span> = overlap below <b>${Math.round(overlapThresholdPct)}%</b> based on context; shown under the stronger side.</div>
            `;
            }
            pretty = `
            <div style="background: linear-gradient(120deg, #f8f9fa 60%, #f1f3f4 100%); border-radius: 1.2rem; box-shadow: 0 2px 12px rgba(44,44,44,0.10); padding: 1.2rem 1vw 1.5rem 1vw; margin-bottom: 2.2rem; border: 2.5px solid #f1f3f4; width:100%; max-width:100%; margin-left:auto; margin-right:auto;">
              <div class='alert-modern' style="background: #d32f2f; color: #fff; border-radius: 0.8rem; padding: 0.7rem 1rem; font-size: 1.18rem; font-weight: 700; margin-bottom: 1.2rem; box-shadow: 0 2px 8px rgba(44,44,44,0.10); letter-spacing: 0.01em; min-height: 60px; display: flex; align-items: center;">Most Important Synthesized Functions (5-10):</div>
              ${mainSection}
              ${deltaSection}
            </div>
            `;
          // Attach remove button handlers after rendering
          setTimeout(() => {
            document.querySelectorAll('.remove-func-btn').forEach(btn => {
              btn.onclick = function(e) {
                e.preventDefault();
                const arrType = btn.getAttribute('data-arrtype');
                const idx = parseInt(btn.getAttribute('data-idx'));
                // Build current classified arrays to find the item to remove
                const currentCommon = [], currentUser = [], currentLegacy = [];
                for (const f of responseData) {
                  const c = classifyFunction(f);
                  if (c==='both') currentCommon.push(f); else if (c==='user_story') currentUser.push(f); else currentLegacy.push(f);
                }
                let itemToRemove;
                if (arrType === 'common') itemToRemove = currentCommon[idx];
                else if (arrType === 'user') itemToRemove = currentUser[idx];
                else itemToRemove = currentLegacy[idx];
                if (!itemToRemove) return;
                // Remove from responseData by name match (case-insensitive)
                responseData = responseData.filter(f => f.name?.toLowerCase() !== (itemToRemove.name||'').toLowerCase());
                // Persist to localStorage
                localStorage.setItem('latestSynthesisResult', JSON.stringify(responseData));
                // Re-render
                renderResponse(responseData);
                // Also refresh the legacy delta panel (Column 3) so removals reflect immediately
                renderLegacyDelta();
              };
            });
          }, 10);
        } else {
          pretty = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
        resultDiv.innerHTML = pretty;
      }
      renderResponse(responseData);

      function renderCoverage() {
        const el = document.getElementById('coverageSummary');
        if (!el) return;
        if (!coverageData || typeof coverageData !== 'object') { el.innerHTML = ''; return; }
        const s = coverageData.story || {}; const l = coverageData.legacy || {};
        const fmt = (obj)=>`<span class='badge bg-secondary me-2'>items: ${obj.total_items||0}</span><span class='badge bg-success me-2'>covered: ${obj.covered_after ?? obj.covered_before ?? 0}</span>${(obj.added?`<span class='badge bg-info text-dark'>added: ${obj.added}</span>`:'')}`;
        el.innerHTML = `
          <div class='alert alert-light border d-flex flex-wrap align-items-center gap-2' role='alert' style='border-radius:0.75rem;'>
            <b class='me-2' style='color:#d32f2f;'>Coverage</b>
            <span class='me-2'>User Story: ${fmt(s)}</span>
            <span>Legacy: ${fmt(l)}</span>
          </div>`;
      }
      renderCoverage();

      // Toggle similarity scores display
      if (scoresToggleBtn) {
        scoresToggleBtn.onclick = () => { showScores = !showScores; scoresToggleBtn.textContent = showScores ? 'Hide Scores' : 'Show Scores'; renderResponse(responseData); };
      }

      // Regenerate (lenient) using backend if user story + legacy available
      async function regenerate() {
        regenStatus.innerHTML = '<span class="text-secondary">Regenerating...</span>';
        const legacy = legacyPlain.trim();
        const story = storyPlain.trim();
        if (!legacy && !story) { regenStatus.innerHTML = '<span class="text-danger">Need legacy + user story content first.</span>'; return; }
        try {
          const res = await fetch('/api/synthesize-functions', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user_story: story, legacy_english: legacy }) });
          const data = await res.json();
          if (data.error) { regenStatus.innerHTML = `<span class='text-danger'>${data.error}</span>`; return; }
          let funcs = [];
          if (Array.isArray(data.functions)) funcs = data.functions; else if (Array.isArray(data.result)) funcs = data.result; else funcs = [];
          if (funcs.length === 0 && typeof data.raw === 'string') {
            try {
              const match = data.raw.match(/\[(.|\n|\r)*\]/); if (match) funcs = JSON.parse(match[0]);
            } catch(e) {}
          }
          responseData = funcs;
          coverageData = data.coverage || null;
          // Persist full payload for transparency
          localStorage.setItem('latestSynthesisResult', JSON.stringify({ functions: funcs, coverage: coverageData, raw: data.raw }));
          renderResponse(responseData);
          renderCoverage();
          regenStatus.innerHTML = `<span class='text-success'>Regenerated ${funcs.length} function(s).</span>`;
        } catch(err) {
          regenStatus.innerHTML = `<span class='text-danger'>${err.message||err}</span>`;
        }
      }
      if (regenerateBtn) regenerateBtn.onclick = regenerate;

      if (!responseData.length && (legacyPlain || storyPlain)) {
        // Auto-generate on first visit if nothing cached
        regenerate();
      }

      if (exportJsonBtn) {
        exportJsonBtn.onclick = () => {
          const blob = new Blob([JSON.stringify(responseData, null, 2)], {type:'application/json'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = 'synthesized_functions.json'; a.click();
          URL.revokeObjectURL(url);
        };
      }

      // Populate selected user story from localStorage (saved in Step 2)
  let __allStories = [];
  let __selectedStoryIndices = new Set(); // multi-select support
      function loadSelectedUserStories() {
        const raw = localStorage.getItem('selectedUserStories');
        if (!raw) return;
        try { __allStories = JSON.parse(raw) || []; } catch(e) { __allStories = []; }
        if (__allStories.length > 0 && __selectedStoryIndices.size === 0) { __selectedStoryIndices.add(0); }
        renderStoriesDropdown();
        if (__allStories.length > 0) selectStoryByIndex(Array.from(__selectedStoryIndices)[0] ?? 0);
        const dd = document.getElementById('storiesDropdown');
        if (dd) {
          dd.addEventListener('change', () => {
            __selectedStoryIndices.clear();
            Array.from(dd.selectedOptions).forEach(opt => { const i = parseInt(opt.value); if (!isNaN(i)) __selectedStoryIndices.add(i); });
            updateSelectedCount();
            const first = Array.from(__selectedStoryIndices)[0];
            if (typeof first === 'number') selectStoryByIndex(first, {highlightOnly:true});
            else {
              const metaDiv = document.getElementById('selectedStoryMeta');
              const contentDiv = document.getElementById('selectedStoryContent');
              if (metaDiv) metaDiv.textContent = '(Select a story)';
              if (contentDiv) contentDiv.textContent = '';
            }
          });
        }
      }

      function renderStoriesDropdown() {
        const dd = document.getElementById('storiesDropdown');
        if (!dd) return;
        dd.innerHTML = '';
        if (__allStories.length === 0) {
          const opt = document.createElement('option');
          opt.disabled = true; opt.textContent = 'No stories selected in Step 2.';
          dd.appendChild(opt);
          return;
        }
        __allStories.forEach((s,i)=>{
          const summary = (s.summary || '').replace(/\s+/g,' ').trim();
          const text = `${s.key} — ${summary}`;
          const opt = document.createElement('option');
          opt.value = String(i);
          opt.textContent = text;
          opt.title = summary;
          opt.selected = __selectedStoryIndices.has(i);
          dd.appendChild(opt);
        });
        updateSelectedCount();
      }

      function selectStoryByIndex(idx, opts={}) {
        if (idx < 0 || idx >= __allStories.length) return;
        const s = __allStories[idx];
        window.__selectedStoryKey = s.key;
        window.__selectedStoryIndex = idx;
        const metaDiv = document.getElementById('selectedStoryMeta');
        const contentDiv = document.getElementById('selectedStoryContent');
        // If multiple are selected, show count; otherwise show focused story
        if (__selectedStoryIndices.size > 1) {
          const keys = Array.from(__selectedStoryIndices).slice(0,3).map(i=>__allStories[i]?.key).filter(Boolean);
          metaDiv.textContent = `Selected: ${__selectedStoryIndices.size}${keys.length?` (${keys.join(', ')}${__selectedStoryIndices.size>3?', …':''})`:''}`;
        } else {
          metaDiv.textContent = `${s.key || ''}: ${s.summary || ''}`;
        }
        contentDiv.textContent = (s.description || '').trim();
  // no expand/collapse in dropdown mode
      }

      loadSelectedUserStories();

      // Extract legacy-only (delta) functions for display and potential JIRA update
      function computeLegacyDeltaFunctions() {
        if (!Array.isArray(responseData)) return [];
        return responseData.filter(f => classifyFunction(f) === 'legacy_code');
      }
      function renderLegacyDelta() {
        const deltaFns = computeLegacyDeltaFunctions();
        const deltaDiv = document.getElementById('deltaLegacyFunctions');
        if (deltaFns.length === 0) {
          deltaDiv.innerHTML = '<span class="text-secondary">No legacy-only functions detected.</span>';
          return;
        }
        deltaDiv.innerHTML = deltaFns.map(f => `<div>- <b>${f.name || ''}</b>: ${(f.description || '').replace(/([^.])$/, '$1.')}</div>`).join('');
        window.__deltaLegacyFunctions = deltaFns;
      }
      renderLegacyDelta();

      function updateSelectedCount(){
        const el = document.getElementById('selectedCount');
        if (el) el.textContent = `Selected: ${__selectedStoryIndices.size}`;
      }
      function updateSelectionUI(){
        const dd = document.getElementById('storiesDropdown');
        if (!dd) return;
        Array.from(dd.options).forEach(opt => {
          const idx = parseInt(opt.value);
          opt.selected = __selectedStoryIndices.has(idx);
        });
      }

      // Update JIRA button handler
      function buildDeltaPayload() {
        return (window.__deltaLegacyFunctions || []).map(f => ({ name: f.name, description: f.description }));
      }
      const JIRA_BROWSE_BASE = 'https://lalluluke.atlassian.net/browse/';
      async function updateSingleStory(storyKey, statusEl, includeLink=false) {
        const deltaFns = buildDeltaPayload();
        if (deltaFns.length === 0) { statusEl.innerHTML = '<div class="text-warning">No legacy-only delta functions to add.</div>'; return; }
        const res = await fetch('/api/update-jira-user-story', {
          method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ story_key: storyKey, delta_functions: deltaFns })
        });
        const data = await res.json();
        if (data.error) return `<div class='text-danger'>${storyKey}: ${data.error}</div>`;
        if (data.status === 'no_change') return `<div class='text-info'>${storyKey}: ${data.message}</div>`;
        const link = includeLink ? ` <a href='${JIRA_BROWSE_BASE + storyKey}' target='_blank' rel='noopener' style='text-decoration:underline; color:#0d6efd;'>View in JIRA</a>` : '';
        return `<div class='text-success'>${storyKey}: Added ${data.added_functions} function(s).${link}</div>`;
      }
      const updateBtn = document.getElementById('updateJiraBtn');
      const updateAllBtn = document.getElementById('updateAllJiraBtn');
      const selectAllBtn = document.getElementById('selectAllStoriesBtn');
      const clearSelectedBtn = document.getElementById('clearSelectedStoriesBtn');
      if (updateBtn) {
        updateBtn.onclick = async () => {
          const statusEl = document.getElementById('updateStatus');
          statusEl.innerHTML = '<div class="text-secondary">Updating selected...</div>';
          let targets = [];
          if (__selectedStoryIndices.size > 0) {
            targets = Array.from(__selectedStoryIndices).map(i => __allStories[i]).filter(Boolean);
          } else if (typeof window.__selectedStoryIndex === 'number') {
            targets = [__allStories[window.__selectedStoryIndex]].filter(Boolean);
          }
          if (targets.length === 0) { statusEl.innerHTML = '<div class="text-danger">No stories selected.</div>'; return; }
          const results = [];
          for (let i=0;i<targets.length;i++) {
            const st = targets[i];
            try { results.push(await updateSingleStory(st.key, statusEl, i===0)); } catch(err){ results.push(`<div class='text-danger'>${st.key}: ${err.message||err}</div>`); }
          }
          statusEl.innerHTML = results.join('');
        };
      }
      if (updateAllBtn) {
        updateAllBtn.onclick = async () => {
          const statusEl = document.getElementById('updateStatus');
            statusEl.innerHTML = '<div class="text-secondary">Updating all selected stories...</div>';
          if (!Array.isArray(__allStories) || __allStories.length===0) { statusEl.innerHTML = '<div class="text-danger">No stories loaded.</div>'; return; }
          const deltaFns = buildDeltaPayload();
          if (deltaFns.length === 0) { statusEl.innerHTML = '<div class="text-warning">No legacy-only delta functions to add.</div>'; return; }
          const results = [];
          for (const s of __allStories) {
            try { results.push(await updateSingleStory(s.key, statusEl)); } catch(err){ results.push(`<div class='text-danger'>${s.key}: ${err.message||err}</div>`); }
          }
          statusEl.innerHTML = results.join('');
        };
      }

      if (selectAllBtn) {
        selectAllBtn.onclick = () => {
          __selectedStoryIndices = new Set(Array.from({length: __allStories.length}, (_,i)=>i));
          updateSelectionUI();
          updateSelectedCount();
        };
      }
      if (clearSelectedBtn) {
        clearSelectedBtn.onclick = () => {
          __selectedStoryIndices.clear();
          updateSelectionUI();
          updateSelectedCount();
          const metaDiv = document.getElementById('selectedStoryMeta');
          const contentDiv = document.getElementById('selectedStoryContent');
          if (metaDiv) metaDiv.textContent = '(Select a story)';
          if (contentDiv) contentDiv.textContent = '';
        };
      }

  // (Removed deprecated chat-related logic)

      // Design element click handler (unchanged)
      document.querySelectorAll('.design-element-card').forEach(function(card) {
        card.addEventListener('click', function() {
          const elementName = card.getAttribute('data-element');
          fetch('/api/design-element-business-logic', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ element: elementName })
          })
          .then(res => res.json())
          .then(data => {
            const col3 = document.getElementById('business-logic-col');
            // Defensive: if not array, show JSON
            if (!Array.isArray(data)) {
              col3.innerHTML = `<pre style="color:#d32f2f; background:#f8f9fa; border-radius:0.7rem; padding:1rem;">${JSON.stringify(data, null, 2)}</pre>`;
              return;
            }
            if (data.length > 0 && typeof data[0] === 'object' && (data[0].name || data[0].description)) {
              col3.innerHTML = data.map(item => `<div class="mb-3" style="padding:1rem; border-radius:0.7rem; background:#f8f9fa; box-shadow:0 2px 8px rgba(44,44,44,0.06);">
                <div style="font-size:1.1rem; font-weight:500; color:#d32f2f;">${item.name || ''}</div>
                <div style="font-size:0.95rem; color:#23272b;">${item.description || ''}</div>
              </div>`).join('');
            } else if (data.length > 0) {
              // Array but not objects with name/description
              col3.innerHTML = `<pre style="color:#d32f2f; background:#f8f9fa; border-radius:0.7rem; padding:1rem;">${JSON.stringify(data, null, 2)}</pre>`;
            } else {
              col3.innerHTML = '<div style="color:#6c757d; font-size:0.9rem;">No business logic found for this design element.</div>';
            }
          })
          .catch(err => {
            const col3 = document.getElementById('business-logic-col');
            col3.innerHTML = `<div style='color:#d32f2f;'>Error: ${err && err.message ? err.message : err}</div>`;
            console.error(err);
          });
        });
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function(){
      function updateMarkedBox(){
        var box = document.querySelector('.marked-section');
        if(!box) return;
        var marks = document.querySelectorAll('mark[data-change]');
        var added=0, replaced=0, removed=0;
        marks.forEach(function(m){
          var t=(m.getAttribute('data-change')||'').toLowerCase();
          if(t==='add'||t==='added') added++;
          else if(t==='replace'||t==='replaced'||t==='update'||t==='updated') replaced++;
          else if(t==='remove'||t==='removed'||t==='del'||t==='deleted') removed++;
        });
        var total = marks.length;
        if(total===0){ box.style.display='none'; return; }
        box.style.display='';
        var label = box.querySelector('.marked-label');
        Array.from(box.childNodes).forEach(function(n){ if(n!==label) box.removeChild(n); });
        var summary = document.createElement('div');
        summary.className = 'small';
        summary.style.marginLeft = '0.25rem';
        summary.innerHTML = 'Changes: '+total + (added? ' • added: '+added:'') + (replaced? ' • updated: '+replaced:'') + (removed? ' • removed: '+removed:'') + ' <a href="#" id="jumpFirstChange" style="margin-left:.5rem;">Jump to first</a>';
        box.appendChild(summary);
        var link = summary.querySelector('#jumpFirstChange');
        if(link){
          link.onclick = function(e){ e.preventDefault(); var first = marks[0]; if(first){ first.scrollIntoView({behavior:'smooth', block:'center'}); first.classList.add('marked-pulse'); setTimeout(function(){ first.classList.remove('marked-pulse'); }, 1200); } };
        }
      }
      var style = document.createElement('style');
      style.textContent = 'mark[data-change].marked-pulse{ outline:2px solid #d32f2f; transition: outline 1.2s; }';
      document.head.appendChild(style);
      if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', updateMarkedBox); } else { updateMarkedBox(); }
      var obs = new MutationObserver(function(){ updateMarkedBox(); });
      obs.observe(document.body, { childList:true, subtree:true });
      window.updateMarkedBox = updateMarkedBox;
    })();
  </script>
</body>
</html>
