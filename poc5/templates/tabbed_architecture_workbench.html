<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>POC 5 - Architecture Workbench</title>
    <!-- Bootstrap + Custom Theme -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}">
    <!-- Mermaid for local diagram rendering -->
    <script src="https://unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
    <!-- Base styles -->
    <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--gradient-grey, linear-gradient(135deg, #343a40 0%, #495057 100%)); background-attachment: fixed; }
        .section { margin-bottom: 1.25rem; }
        label { font-weight: 600; color: var(--primary-red, #dc3545); }
        textarea, input[type="text"], select { width: 100%; padding: .5rem .75rem; border: 1px solid #e0e0e0; border-radius: .5rem; background: #fff; }
        textarea { min-height: 100px; }
        /* Tabs styled like POC2: underline with red active indicator */
        .nav-tabs { border-bottom: 2px solid rgba(220,53,69,.15); }
        .nav-tabs .nav-link { color: var(--primary-grey, #343a40); font-weight: 600; }
        .nav-tabs .nav-link:hover { border-color: transparent; color: var(--primary-red, #dc3545); }
        .nav-tabs .nav-link.active { color: var(--primary-red, #dc3545); border-color: transparent; border-bottom: 3px solid var(--primary-red, #dc3545); background: transparent; }
        /* Content panes */
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        /* Mermaid preview responsiveness */
        #mermaidPreview svg,
        #mermaidPreviewSystem svg,
        #mermaidPreviewData svg,
        #mermaidPreviewData2 svg,
        #mermaidPreviewServiceDecomp svg,
        #mermaidPreviewServiceDecomp2 svg { max-width: 100%; height: auto; }
        #mermaidPreview,
        #mermaidPreviewSystem,
        #mermaidPreviewData,
        #mermaidPreviewData2,
        #mermaidPreviewServiceDecomp,
        #mermaidPreviewServiceDecomp2 { overflow: auto; }
        /* Section cards to reduce clutter */
        .section-card { background:#fff; border:1px solid #e9ecef; border-radius: .5rem; padding:1rem; margin-bottom:1rem; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
        .section-card .section-title { font-size: 1.05rem; font-weight:700; color: var(--primary-grey, #343a40); margin-bottom:.5rem; }
        .help { color:#6c757d; font-size:.85rem; }
        .badge-approve { background: #198754; }
        .badge-light { background:#e9ecef; color:#6c757d; }
        /* Layout: two-column with sticky chat on the right */
        .sidebar-chat { position: sticky; top: 1rem; }
        .chat-history { display:none; min-height: 200px; }
        .chat-history.active { display:block; }
        /* Make page width and container width same */
        .container-fluid { padding-left: 1rem; padding-right: 1rem; }
        /* Sticky action bar under tabs */
        .action-bar { position: sticky; top: 0; z-index: 10; background: #fff; padding: .5rem .75rem; border: 1px solid #e9ecef; border-radius: .5rem; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
        /* Design & Review section hero header */
        .section-hero {
            background: linear-gradient(135deg, #ef475d 0%, #dc3545 100%);
            color: #fff;
            border-bottom: none;
        }
        .section-hero .h5,
        .section-hero small,
        .section-hero .btn,
        .section-hero .text-muted { color: #fff !important; }
        /* JSON Key-Value viewer */
        .kv-wrapper { position: relative; }
        .kv-toolbar { display:flex; gap:.5rem; justify-content:flex-end; align-items:center; margin:.25rem 0; }
        .kv-toolbar .btn { padding:.1rem .4rem; font-size:.75rem; }
        .kv-view { border:1px solid #e0e0e0; border-radius:.5rem; background:#fff; padding:.5rem .75rem; max-height: 300px; overflow:auto; font-size:.9rem; }
        .kv-view ul { list-style: none; padding-left: 1rem; border-left: 2px solid #f1f3f5; margin: .2rem 0; }
        .kv-view li { margin:.15rem 0; }
        .kv-key { color:#495057; font-weight:600; }
        .kv-primitive { color:#212529; }
        .kv-type-badge { display:inline-block; font-size:.7rem; padding:.05rem .35rem; border-radius:.25rem; background:#f8f9fa; color:#6c757d; margin-left:.35rem; }
        .kv-empty { color:#6c757d; font-style: italic; }
        /* Fullscreen zoom overlay */
        .diagram-zoom-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.75); z-index: 1050; display:none; }
        .diagram-zoom-toolbar { position: absolute; top: 12px; right: 12px; display:flex; gap:.5rem; }
        .diagram-zoom-toolbar .btn { padding:.25rem .5rem; font-size:.9rem; }
        .diagram-zoom-stage { position:absolute; inset:0; top:56px; overflow:auto; display:flex; justify-content:center; align-items:flex-start; padding:24px; }
        .diagram-zoom-canvas { transform-origin: 0 0; display:inline-block; background:#ffffff; padding:16px; border-radius:8px; box-shadow: 0 6px 24px rgba(0,0,0,.25); }
        .diagram-zoom-close { position:absolute; top:12px; left:12px; }
    </style>
</head>
<body>
    <!-- Banner (POC2-style) -->
    <nav class="navbar navbar-dark" style="background: var(--gradient-red, linear-gradient(135deg, #dc3545 0%, #c82333 100%));">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#" onclick="return false;">
                <img src="/static/processflow.png" alt="logo" width="36" height="36" class="me-2"/>
                <span>
                    <div class="fw-bold">Architecture Workbench</div>
                    <small class="text-light">POC 5 • Decisions → Blueprint</small>
                </span>
            </a>
            <div class="ms-auto">
                <a href="/?reset=1" class="btn btn-sm btn-outline-light" title="Start a fresh session (clears previous selections and uploads)">New Session</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid my-4">
    <!-- server-provided last action timing -->
    <span id="server_timing" class="d-none" data-last-action="{{ last_action or '' }}" data-last-elapsed="{{ last_elapsed_ms or 0 }}"></span>
    <div class="row g-3">
            <!-- Main content left -->
            <div class="col-xl-9 col-lg-8">
                <div class="card">
                    <div class="card-header section-hero">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <span class="h5 mb-0">Design & Review</span>
                                <div class="small">Upload PRD and System Mapping, extract decisions, and preview an initial diagram.</div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
        <ul class="nav nav-tabs mb-4">
                    <li class="nav-item">
            <a class="nav-link" href="#" data-index="0" onclick="showTab(0); return false;">
                            1. Context & Requirements
                            {% if approved_tab0 %}<span class="badge badge-approve ms-2">Approved</span>{% endif %}
                        </a>
                    </li>
                    <!-- Context Doc merged into Tab 1; removed separate tab -->
                    <li class="nav-item">
            <a class="nav-link" href="#" data-index="1" onclick="showTab(1); return false;">
                            2. Initial Blueprint
                            {% if approved_tab1 %}<span class="badge badge-approve ms-2">Approved</span>{% endif %}
                        </a>
                    </li>
                    <li class="nav-item">
            <a class="nav-link" href="#" data-index="2" onclick="showTab(2); return false;">
                            3. System Interaction
                            {% if approved_tab2 %}<span class="badge badge-approve ms-2">Approved</span>{% endif %}
                        </a>
                    </li>
                    <li class="nav-item">
            <a class="nav-link" href="#" data-index="5" onclick="showTab(5); return false;">
                            4. Database Solution Design
                            {% if approved_tab5 %}<span class="badge badge-approve ms-2">Approved</span>{% endif %}
                        </a>
                    </li>
                    <li class="nav-item">
            <a class="nav-link" href="#" data-index="6" onclick="showTab(6); return false;">
                            5. Service Solution Design
                            {% if approved_tab6 %}<span class="badge badge-approve ms-2">Approved</span>{% endif %}
                        </a>
                    </li>
                    <li class="nav-item">
            <a class="nav-link" href="#" data-index="3" onclick="showTab(3); return false;">
                            6. Decisions, Integration & Pros/Cons
                            {% if approved_tab3 %}<span class="badge badge-approve ms-2">Approved</span>{% endif %}
                        </a>
                    </li>
                    <li class="nav-item">
            <a class="nav-link" href="#" data-index="4" onclick="showTab(4); return false;">
                            7. Documentation & Review
                            {% if approved_tab4 %}<span class="badge badge-approve ms-2">Approved</span>{% endif %}
                        </a>
                    </li>
                </ul>
                <form method="post" enctype="multipart/form-data" onsubmit="return prepareActionSubmit(this);">
                    <input type="hidden" name="active_tab" id="active_tab_input" value="{{ active_tab }}"/>
                    <input type="hidden" name="action" id="action_input" />
                    <!-- Global action bar below tabs -->
                    <div class="action-bar d-flex flex-wrap gap-2 mb-3">
                        <input type="hidden" name="client_start_ts" id="client_start_ts" />
                        <span id="action_spinner" class="spinner-border spinner-border-sm text-danger d-none" role="status" aria-hidden="true"></span>
                        <span id="action_timer" class="text-danger small d-none" style="min-width:3em;display:inline-block;"></span>
                        <span id="action_status" class="text-muted small d-none"></span>
                        <button type="submit" class="btn btn-danger action-btn" name="action" value="extract_decisions" title="Parse PRD + System Mapping, fill all fields across tabs, and use educated guesses for anything missing." {% if lock_tab1 %}disabled{% endif %}>Generate Arch Context</button>
                        {% if not lock_tab1 %}
                            <button type="submit" class="btn btn-outline-secondary action-btn" name="action" value="lock_tab1" title="Lock editing of Context & Requirements inputs (Tab 1).">Lock Tab 1</button>
                        {% else %}
                            <button type="submit" class="btn btn-outline-secondary action-btn" name="action" value="unlock_tab1" title="Unlock editing of Context & Requirements inputs (Tab 1).">Unlock Tab 1</button>
                        {% endif %}
                        <button type="submit" class="btn btn-success action-btn" name="action" value="approve_and_next" title="Mark this tab as approved and advance along the flow (0 → 1 → 2 → 5 → 6 → 3 → 4).">Approve & Next Phase</button>
                        <!-- Download full Word export of all tabs -->
                        <button type="submit" class="btn btn-warning action-btn" name="action" value="download_share" title="Download a Word document containing all tabs">Download/Share</button>
                    </div>
        <!-- Tab 1 -->
    <div class="tab-pane section" id="tab1" data-index="0">
            <h2>Context & Requirements</h2>
            <div class="section-card">
                <div class="section-title">Inputs</div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label>Upload PRD Document (PDF/TXT/MD preferred)</label>
                        <input type="file" name="prd_file" accept=".txt,.md,.pdf,.doc,.docx" {% if lock_tab1 %}disabled{% endif %}>
                        {% if prd_file_name %}<div class="help">Uploaded: {{ prd_file_name }}</div>{% endif %}
                    </div>
                    <div class="col-md-6">
                        <label>Upload System Mapping (CSV/JSON/TXT)</label>
                        <input type="file" name="system_mapping_file" accept=".csv,.json,.txt" {% if lock_tab1 %}disabled{% endif %}>
                        {% if system_mapping_name %}
                            <div class="help">Uploaded: {{ system_mapping_name }}
                            {% if system_mapping_stats %}
                               <br>Parsed: {{ system_mapping_stats.node_count }} nodes, {{ system_mapping_stats.edge_count }} edges{% if system_mapping_stats.truncated %} (truncated){% endif %}
                            {% endif %}
                            </div>
                        {% endif %}
                        <div class="mt-2">
                            <button type="button" class="btn btn-danger btn-sm" onclick="window.open('/system-mapping','_blank')" {% if lock_tab1 %}disabled{% endif %}>Generate System Mapping</button>
                            <div class="help small text-muted mt-1">Open the mapping canvas, export CSV, then upload it here.</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-title">Core Context</div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label>Business Goals</label>
                        <textarea name="business_goals" {% if lock_tab1 %}readonly{% endif %}>{{ business_goals }}</textarea>
                    </div>
                    <div class="col-md-6">
                        <label>Legacy System Description</label>
                        <textarea name="legacy_system" {% if lock_tab1 %}readonly{% endif %}>{{ legacy_system }}</textarea>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-8">
                        <label>Constraints (tech stack, compliance, etc.)</label>
                        <textarea name="constraints" {% if lock_tab1 %}readonly{% endif %}>{{ constraints }}</textarea>
                    </div>
                    <div class="col-md-4">
                        <label>Desired Architecture Style</label>
                        <select name="architecture_style" id="architecture_style" class="form-select form-select-sm" {% if lock_tab1 %}disabled{% endif %}>
                            <option value="Monolith">Monolith</option>
                            <option value="Event Driven">Event Driven</option>
                            <option value="Microservices">Microservices</option>
                            <option value="Serverless">Serverless</option>
                            <option value="SOA">SOA</option>
                            <option value="Hexagonal">Hexagonal</option>
                            <option value="CQRS / Event Sourcing">CQRS / Event Sourcing</option>
                            <option value="Other">Other</option>
                        </select>
                        <script>
                            (function(){
                                var val = '{{ architecture_style|default("")|e }}';
                                var el = document.getElementById('architecture_style');
                                if (el && val) el.value = val;
                            })();
                        </script>
                        <label class="mt-2">Additional Requirements</label>
                        <textarea name="additional_requirements" {% if lock_tab1 %}readonly{% endif %}>{{ additional_requirements }}</textarea>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-title">Guardrails & Platform Selections</div>
                <div class="row g-3">
                            <div class="col-md-4">
                                <label>Cloud Provider</label>
                                <select name="cloud_provider" id="cloud_provider" class="form-select form-select-sm" {% if lock_tab1 %}disabled{% endif %}>
                                    <option value="">-- Select --</option>
                                    <option value="AWS">AWS</option>
                                    <option value="Azure">Azure</option>
                                    <option value="GCP">GCP</option>
                                    <option value="On-Prem">On-Prem</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label>Region Strategy</label>
                                <select name="region_strategy" id="region_strategy" class="form-select form-select-sm" {% if lock_tab1 %}disabled{% endif %}>
                                    <option value="">-- Select --</option>
                                    <option value="Single Region">Single Region</option>
                                    <option value="Multi-Region Active/Active">Multi-Region Active/Active</option>
                                    <option value="DR Warm Standby">DR Warm Standby</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label>Deployment Model</label>
                                <select name="deployment_model" id="deployment_model" class="form-select form-select-sm" {% if lock_tab1 %}disabled{% endif %}>
                                    <option value="">-- Select --</option>
                                    <option value="Kubernetes">Kubernetes</option>
                                    <option value="Serverless">Serverless</option>
                                    <option value="VMs">VMs</option>
                                </select>
                            </div>
                </div>
                <div class="row g-3 mt-1">
                            <div class="col-md-4">
                                <label>Database Family</label>
                                <select name="database_family" id="database_family" class="form-select form-select-sm" {% if lock_tab1 %}disabled{% endif %}>
                                    <option value="">-- Select --</option>
                                    <option value="PostgreSQL">PostgreSQL</option>
                                    <option value="MySQL">MySQL</option>
                                    <option value="SQL Server">SQL Server</option>
                                    <option value="MongoDB">MongoDB</option>
                                    <option value="DynamoDB">DynamoDB</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label>Messaging Backbone</label>
                                <select name="messaging_backbone" id="messaging_backbone" class="form-select form-select-sm" {% if lock_tab1 %}disabled{% endif %}>
                                    <option value="">-- Select --</option>
                                    <option value="Kafka">Kafka</option>
                                    <option value="RabbitMQ">RabbitMQ</option>
                                    <option value="SQS/SNS">SQS/SNS</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label>Identity Provider</label>
                                <select name="identity_provider" id="identity_provider" class="form-select form-select-sm" {% if lock_tab1 %}disabled{% endif %}>
                                    <option value="">-- Select --</option>
                                    <option value="Cognito">Cognito</option>
                                    <option value="Okta">Okta</option>
                                    <option value="Auth0">Auth0</option>
                                    <option value="ADFS">ADFS</option>
                                </select>
                            </div>
                </div>
                <div class="row g-3 mt-1">
                            <div class="col-md-4">
                                <label>API Style</label>
                                <select name="api_style" id="api_style" class="form-select form-select-sm" {% if lock_tab1 %}disabled{% endif %}>
                                    <option value="">-- Select --</option>
                                    <option value="REST">REST</option>
                                    <option value="GraphQL">GraphQL</option>
                                    <option value="gRPC">gRPC</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label>Caching Strategy</label>
                                <select name="caching_strategy" id="caching_strategy" class="form-select form-select-sm" {% if lock_tab1 %}disabled{% endif %}>
                                    <option value="">-- Select --</option>
                                    <option value="Redis">Redis</option>
                                    <option value="Memcached">Memcached</option>
                                    <option value="None">None</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label>Observability Stack</label>
                                <select name="observability_stack" id="observability_stack" class="form-select form-select-sm" {% if lock_tab1 %}disabled{% endif %}>
                                    <option value="">-- Select --</option>
                                    <option value="ELK">ELK</option>
                                    <option value="Grafana/Loki/Tempo">Grafana/Loki/Tempo</option>
                                    <option value="Datadog">Datadog</option>
                                </select>
                            </div>
                </div>
                <div class="row g-3 mt-1">
                            <div class="col-md-6">
                                <label>Data Residency</label>
                                <input type="text" name="data_residency" class="form-control form-control-sm" value="{{ data_residency }}" {% if lock_tab1 %}readonly{% endif %}>
                            </div>
                            <div class="col-md-6">
                                <label>Compliance Standards</label>
                                <input type="text" name="compliance_standards" class="form-control form-control-sm" value="{{ compliance_standards }}" {% if lock_tab1 %}readonly{% endif %}>
                            </div>
                </div>
                <script>
                    (function(){
                        function setVal(id, val){ var el = document.getElementById(id); if(el && val){ el.value = val; } }
                        setVal('cloud_provider', '{{ cloud_provider|default("")|e }}');
                        setVal('region_strategy', '{{ region_strategy|default("")|e }}');
                        setVal('deployment_model', '{{ deployment_model|default("")|e }}');
                        setVal('database_family', '{{ database_family|default("")|e }}');
                        setVal('messaging_backbone', '{{ messaging_backbone|default("")|e }}');
                        setVal('identity_provider', '{{ identity_provider|default("")|e }}');
                        setVal('api_style', '{{ api_style|default("")|e }}');
                        setVal('caching_strategy', '{{ caching_strategy|default("")|e }}');
                        setVal('observability_stack', '{{ observability_stack|default("")|e }}');
                    })();
                </script>
            </div>

            <div class="section-card">
                <div class="section-title">Advanced Architecture Details</div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label>Availability / SLA</label>
                        <input type="text" name="availability_sla" class="form-control form-control-sm" value="{{ availability_sla }}"/>
                    </div>
                    <div class="col-md-6">
                        <label>RPO / RTO</label>
                        <input type="text" name="rpo_rto" class="form-control form-control-sm" value="{{ rpo_rto }}"/>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-4">
                        <label>p95 Latency (ms)</label>
                        <input type="text" name="performance_targets" class="form-control form-control-sm" value="{{ performance_targets }}"/>
                    </div>
                    <div class="col-md-4">
                        <label>Throughput (TPS/QPS)</label>
                        <input type="text" name="throughput" class="form-control form-control-sm" value="{{ throughput }}"/>
                    </div>
                    <div class="col-md-4">
                        <label>Peak Concurrency</label>
                        <input type="text" name="peak_concurrency" class="form-control form-control-sm" value="{{ peak_concurrency }}"/>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label>Data Volume & Retention</label>
                        <input type="text" name="data_volume_retention" class="form-control form-control-sm" value="{{ data_volume_retention }}"/>
                    </div>
                    <div class="col-md-6">
                        <label>DR Strategy</label>
                        <input type="text" name="dr_strategy" class="form-control form-control-sm" value="{{ dr_strategy }}"/>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-4">
                        <label>Encryption at Rest</label>
                        <select name="encryption_at_rest" id="encryption_at_rest" class="form-select form-select-sm">
                            <option value="">-- Select --</option>
                            <option value="Enabled">Enabled</option>
                            <option value="Disabled">Disabled</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>Encryption in Transit</label>
                        <select name="encryption_in_transit" id="encryption_in_transit" class="form-select form-select-sm">
                            <option value="">-- Select --</option>
                            <option value="TLS 1.2+">TLS 1.2+</option>
                            <option value="mTLS">mTLS</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label>Key Management (KMS)</label>
                        <input type="text" name="kms" class="form-control form-control-sm" value="{{ kms }}"/>
                    </div>
                </div>
                <script>
                    (function(){
                        function setVal(id, val){ var el = document.getElementById(id); if(el && val){ el.value = val; } }
                        setVal('encryption_at_rest', '{{ encryption_at_rest|default("")|e }}');
                        setVal('encryption_in_transit', '{{ encryption_in_transit|default("")|e }}');
                    })();
                </script>
                <div class="row g-3 mt-1">
                    <div class="col-md-4">
                        <label>API Gateway Type</label>
                        <input type="text" name="api_gateway_type" class="form-control form-control-sm" value="{{ api_gateway_type }}"/>
                    </div>
                    <div class="col-md-4">
                        <label>Service Mesh</label>
                        <input type="text" name="service_mesh" class="form-control form-control-sm" value="{{ service_mesh }}"/>
                    </div>
                    <div class="col-md-4">
                        <label>Ingress / WAF / CDN</label>
                        <input type="text" name="edge_controls" class="form-control form-control-sm" value="{{ edge_controls }}" placeholder="Ingress, WAF, CDN"/>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-4">
                        <label>Secrets Manager</label>
                        <input type="text" name="secrets_manager" class="form-control form-control-sm" value="{{ secrets_manager }}"/>
                    </div>
                    <div class="col-md-4">
                        <label>Infra as Code</label>
                        <input type="text" name="iac_tool" class="form-control form-control-sm" value="{{ iac_tool }}" placeholder="Terraform, Bicep, Pulumi"/>
                    </div>
                    <div class="col-md-4">
                        <label>CI/CD</label>
                        <input type="text" name="ci_cd" class="form-control form-control-sm" value="{{ ci_cd }}" placeholder="GitHub Actions, Azure DevOps"/>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label>Environments</label>
                        <input type="text" name="environments" class="form-control form-control-sm" value="{{ environments }}"/>
                    </div>
                    <div class="col-md-6">
                        <label>Release Strategy</label>
                        <input type="text" name="release_strategy" class="form-control form-control-sm" value="{{ release_strategy }}"/>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label>Deployment Topology</label>
                        <input type="text" name="deployment_topology" class="form-control form-control-sm" value="{{ deployment_topology }}"/>
                    </div>
                    <div class="col-md-6">
                        <label>Tenancy Model</label>
                        <input type="text" name="tenancy_model" class="form-control form-control-sm" value="{{ tenancy_model }}"/>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <div class="section-title d-flex justify-content-between align-items-center">
                    <span>Architecture Context (Generated)</span>
                    <span class="d-flex gap-2">
                        <button type="button" id="copyContextBtn" class="btn btn-sm btn-outline-secondary" title="Copy markdown to clipboard">Copy</button>
                        <button type="button" id="downloadContextBtn" class="btn btn-sm btn-outline-danger" title="Download markdown as .md">Download .md</button>
                        <span id="contextCopyStatus" class="small text-muted" style="display:none;">Copied</span>
                    </span>
                </div>
                <label>Context Markdown:</label>
                <textarea name="architecture_context" style="min-height:280px">{{ architecture_context }}</textarea>
                <hr>
                <h5>Advanced Context Fields</h5>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label>Assumptions</label>
                        <textarea name="assumptions">{{ assumptions }}</textarea>
                    </div>
                    <div class="col-md-6">
                        <label>Stakeholders</label>
                        <textarea name="stakeholders">{{ stakeholders }}</textarea>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label>In Scope</label>
                        <textarea name="in_scope">{{ in_scope }}</textarea>
                    </div>
                    <div class="col-md-6">
                        <label>Out of Scope</label>
                        <textarea name="out_of_scope">{{ out_of_scope }}</textarea>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label>Availability / SLA</label>
                        <input type="text" name="availability_sla" class="form-control form-control-sm" value="{{ availability_sla }}"/>
                    </div>
                    <div class="col-md-6">
                        <label>RPO / RTO</label>
                        <input type="text" name="rpo_rto" class="form-control form-control-sm" value="{{ rpo_rto }}"/>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label>Performance Targets</label>
                        <input type="text" name="performance_targets" class="form-control form-control-sm" value="{{ performance_targets }}"/>
                    </div>
                    <div class="col-md-6">
                        <label>Security Posture</label>
                        <input type="text" name="security_posture" class="form-control form-control-sm" value="{{ security_posture }}"/>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label>Data Volume & Retention</label>
                        <input type="text" name="data_volume_retention" class="form-control form-control-sm" value="{{ data_volume_retention }}"/>
                    </div>
                    <div class="col-md-6">
                        <label>Workloads</label>
                        <input type="text" name="workloads" class="form-control form-control-sm" value="{{ workloads }}"/>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label>Environments</label>
                        <input type="text" name="environments" class="form-control form-control-sm" value="{{ environments }}"/>
                    </div>
                    <div class="col-md-6">
                        <label>Release Strategy</label>
                        <input type="text" name="release_strategy" class="form-control form-control-sm" value="{{ release_strategy }}"/>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label>Deployment Topology</label>
                        <input type="text" name="deployment_topology" class="form-control form-control-sm" value="{{ deployment_topology }}"/>
                    </div>
                    <div class="col-md-6">
                        <label>Tenancy Model</label>
                        <input type="text" name="tenancy_model" class="form-control form-control-sm" value="{{ tenancy_model }}"/>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label>Observability Requirements</label>
                        <textarea name="observability_requirements">{{ observability_requirements }}</textarea>
                    </div>
                    <div class="col-md-6">
                        <label>Cost Constraints</label>
                        <input type="text" name="cost_constraints" class="form-control form-control-sm" value="{{ cost_constraints }}"/>
                        <label class="mt-2">Capacity Estimates</label>
                        <input type="text" name="capacity_estimates" class="form-control form-control-sm" value="{{ capacity_estimates }}"/>
                    </div>
                </div>
                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label>Migration Strategy</label>
                        <textarea name="migration_strategy">{{ migration_strategy }}</textarea>
                    </div>
                    <div class="col-md-6">
                        <label>Risks</label>
                        <textarea name="risks">{{ risks }}</textarea>
                        <label class="mt-2">Open Questions</label>
                        <textarea name="open_questions">{{ open_questions }}</textarea>
                    </div>
                </div>
            </div>


                        <hr>
                        <h3>DecisionExtractorAgent Questions</h3>
                        <div class="section">
                            <label>High-Level Architecture Decision Points</label><br>
                            <textarea name="high_level_decision_points" placeholder="List key decision points here">{{ high_level_decision_points }}</textarea><br>
                            <label>List of One-way Door Decisions</label><br>
                            <textarea name="one_way_door_decisions" placeholder="Irreversible or costly-to-reverse decisions">{{ one_way_door_decisions }}</textarea><br>
                            <small style="display:block; color:#6c757d;">Examples: Primary database family, partitioning strategy, messaging backbone, region/multi-region strategy, identity provider, data residency & compliance posture, cloud provider selection.</small>
                            <label>Desired Architecture Style</label><br>
                            <input name="desired_architecture_style" value="{{ architecture_style }}"><br>
                            <label>Other Relevant Questions</label><br>
                            <textarea name="other_relevant_questions" placeholder="Capture any other clarifying questions">{{ other_relevant_questions }}</textarea><br>
                        </div>
                        <!-- Buttons moved to global action bar below tabs -->
    </div>
    <!-- Tab 2: Initial Blueprint (diagram only) -->
    <div class="tab-pane section" id="tab2" data-index="1">
            <h2>Initial Blueprint</h2>
            {% if decomposition_writeup %}
            <div class="alert alert-info" role="alert" style="white-space:pre-wrap">
                <div class="fw-semibold mb-1">PRD Decomposition Summary</div>
                {{ decomposition_writeup }}
            </div>
            {% endif %}
            {% if prd_file_name or prd_len %}
            <div class="small text-muted mb-2">Using PRD: {{ prd_file_name or 'N/A' }}{% if prd_len %} • parsed {{ prd_len }} chars{% endif %}</div>
            {% endif %}
            <label>High-level Architecture Diagram (Mermaid/PlantUML):</label><br>
            <div class="d-flex gap-2 mb-2">
                <button type="submit" name="action" value="generate_initial_blueprint" class="btn btn-sm btn-primary">Regenerate</button>
                <button type="submit" name="action" value="generate_initial_blueprint" class="btn btn-sm btn-outline-secondary" title="Simplify/clarify the graph layout">Simplify</button>
            </div>
                        <textarea name="architecture_diagram">{{ blueprint }}</textarea><br>
                        <div class="mb-2">
                            <button type="button" id="previewMermaidBtn" class="btn btn-sm btn-danger" title="Render the current Mermaid diagram locally without posting to the server.">Preview Diagram</button>
                        </div>
                        <div id="mermaidPreview" style="margin-top:1rem; background:#f8f9fa; border:1px solid #e0e0e0; border-radius:6px; padding:12px;"></div>
            <!-- Removed System Interaction, Data Model, and Service Decomposition from Initial -->
            <label>Major Components/Services:</label><br>
                        <textarea name="major_components">{{ major_components }}</textarea><br>
            <label>Interface Definitions:</label><br>
                        <textarea name="interface_definitions">{{ interface_definitions }}</textarea><br>
            <label>Reusable Patterns:</label><br>
                        <textarea name="reusable_patterns">{{ reusable_patterns }}</textarea><br>
    </div>
    <!-- Tab 3: System Interaction -->
    <div class="tab-pane section" id="tab3" data-index="2">
            <h2>System Interaction</h2>
            <label>System Interaction Diagram (Mermaid sequenceDiagram):</label><br>
            <textarea name="system_interaction_diagram">{{ system_interaction_diagram }}</textarea><br>
            <div class="mb-2">
                <button type="button" id="previewSystemBtn" class="btn btn-sm btn-outline-danger" title="Render the System Interaction diagram.">Preview System Interaction</button>
            </div>
            <div id="mermaidPreviewSystem" style="margin-top:1rem; background:#f8f9fa; border:1px solid #e0e0e0; border-radius:6px; padding:12px;"></div>
            <label class="mt-3">System Interaction Notes:</label><br>
            <textarea name="system_interaction_notes">{{ system_interaction_notes }}</textarea><br>
        </div>
    <!-- Tab 4: Database Solution Design -->
    <div class="tab-pane section" id="tab4" data-index="5">
            <h2>Database Solution Design</h2>
            <label>Data Model / ER Diagram (Mermaid erDiagram):</label><br>
            <textarea name="data_model_diagram">{{ data_model_diagram }}</textarea><br>
            <div class="mb-2">
                <button type="button" id="previewDataModelBtn2" class="btn btn-sm btn-outline-danger" title="Render the Data Model / ER diagram.">Preview Data Model</button>
            </div>
            <div id="mermaidPreviewData2" style="margin-top:1rem; background:#f8f9fa; border:1px solid #e0e0e0; border-radius:6px; padding:12px;"></div>
            <label class="mt-3">Data Schemas:</label><br>
            <textarea name="data_schemas">{{ data_schemas }}</textarea><br>
        </div>
    <!-- Tab 5: Service Solution Design -->
    <div class="tab-pane section" id="tab5" data-index="6">
            <h2>Service Solution Design</h2>
            <label>Service Decomposition (Mermaid flowchart):</label><br>
            <textarea name="service_decomposition_diagram">{{ service_decomposition_diagram }}</textarea><br>
            <div class="mb-2">
                <button type="button" id="previewServiceDecompBtn2" class="btn btn-sm btn-outline-danger" title="Render the Service Decomposition flowchart.">Preview Service Decomposition</button>
            </div>
            <div id="mermaidPreviewServiceDecomp2" style="margin-top:1rem; background:#f8f9fa; border:1px solid #e0e0e0; border-radius:6px; padding:12px;"></div>
            <label class="mt-3">Major Components/Services:</label><br>
            <textarea name="major_components">{{ major_components }}</textarea><br>
            <label>Interface Definitions:</label><br>
            <textarea name="interface_definitions">{{ interface_definitions }}</textarea><br>
            <label>Reusable Patterns:</label><br>
            <textarea name="reusable_patterns">{{ reusable_patterns }}</textarea><br>
        </div>
    <!-- Tab 6: Decisions, Integration & Pros/Cons (combined) -->
    <div class="tab-pane section" id="tab6" data-index="3">
            <h2>Decisions, Integration & Pros/Cons</h2>
            <label>Architectural Decisions:</label><br>
            <textarea name="architectural_decisions">{{ decisions }}</textarea><br>
            <label>Rationale & Trade-offs:</label><br>
            <textarea name="rationale_tradeoffs">{{ rationale_tradeoffs }}</textarea><br>
            <hr>
            <label>Communication Protocols (gRPC, REST, Kafka, etc.):</label><br>
            <textarea name="communication_protocols">{{ communication }}</textarea><br>
            <label>Data Flow Diagrams:</label><br>
            <textarea name="data_flow_diagrams">{{ data_flow_diagrams }}</textarea><br>
            <label>Integration Points:</label><br>
            <textarea name="integration_points">{{ integration_points }}</textarea><br>
            <hr>
            <label>SWOT Analysis (Strengths, Weaknesses, Opportunities, Threats):</label><br>
            <textarea name="swot_analysis">{{ pros_cons }}</textarea><br>
            <label>Risks & Mitigation Strategies:</label><br>
            <textarea name="risks_mitigation">{{ risks_mitigation }}</textarea><br>
        </div>
    <!-- Tab 7: Documentation & Review -->
    <div class="tab-pane section" id="tab7" data-index="4">
            <h2>Documentation & Review</h2>
            <label>Compiled Architecture Document:</label><br>
            <textarea name="compiled_document">{{ doc }}</textarea><br>
            <label>Stakeholder Checklist:</label><br>
            <textarea name="stakeholder_checklist">{{ stakeholder_checklist }}</textarea><br>
        </div>
                </form>
                    </div>
                </div>
            </div>
            <!-- Chat sidebar right -->
            <div class="col-xl-3 col-lg-4">
                <div class="section-card sidebar-chat">
                    <div class="section-title d-flex align-items-center justify-content-between">
                        <span>Assistant Chat</span>
                        <span class="badge badge-light">Tab <span id="chat_tab_label"></span></span>
                    </div>
              <span id="pending_flags" class="d-none"
                  data-t0="{{ '1' if pending_tab0 else '0' }}"
                  data-t1="{{ '1' if pending_tab1 else '0' }}"
                  data-t2="{{ '1' if pending_tab2 else '0' }}"
                  data-t3="{{ '1' if pending_tab3 else '0' }}"
                  data-t4="{{ '1' if pending_tab4 else '0' }}"
                  data-t5="{{ '1' if pending_tab5 else '0' }}"
                  data-t6="{{ '1' if pending_tab6 else '0' }}"
                  data-t7="{{ '1' if pending_tab7 else '0' }}"></span>
            <!-- Hidden element to store pending updates JSON per tab for preview modal -->
            <span id="pending_updates_json" class="d-none"
                data-tab0="{{ session['pending_updates_tab0']|default('') }}"
                data-tab1="{{ session['pending_updates_tab1']|default('') }}"
                data-tab2="{{ session['pending_updates_tab2']|default('') }}"
                data-tab3="{{ session['pending_updates_tab3']|default('') }}"
                data-tab4="{{ session['pending_updates_tab4']|default('') }}"
                data-tab5="{{ session['pending_updates_tab5']|default('') }}"
                data-tab6="{{ session['pending_updates_tab6']|default('') }}"
                data-tab7="{{ session['pending_updates_tab7']|default('') }}"
                data-tab8="{{ session['pending_updates_tab8']|default('') }}"></span>
                    <div class="text-muted small mb-2" id="chat_scope_label">Context & Requirements</div>
                    <!-- histories per tab -->
                    <div class="mb-2">
                        <textarea class="form-control form-control-sm chat-history" data-tab="0" readonly>{{ chat_tab0 }}</textarea>
                        <textarea class="form-control form-control-sm chat-history" data-tab="1" readonly>{{ chat_tab1 }}</textarea>
                        <textarea class="form-control form-control-sm chat-history" data-tab="2" readonly>{{ chat_tab2 }}</textarea>
                        <textarea class="form-control form-control-sm chat-history" data-tab="3" readonly>{{ chat_tab3 }}</textarea>
                        <textarea class="form-control form-control-sm chat-history" data-tab="4" readonly>{{ chat_tab4 }}</textarea>
                        <textarea class="form-control form-control-sm chat-history" data-tab="5" readonly>{{ chat_tab5 }}</textarea>
                        <textarea class="form-control form-control-sm chat-history" data-tab="6" readonly>{{ chat_tab6 }}</textarea>
                        <textarea class="form-control form-control-sm chat-history" data-tab="7" readonly>{{ chat_tab7 }}</textarea>
                    </div>
            <form method="post" onsubmit="return prepareChatSubmit(this);">
                        <input type="hidden" name="active_tab" id="chat_active_tab_input" value="{{ active_tab }}"/>
                        <input type="hidden" name="action" id="chat_action_input" />
                        <input type="hidden" name="client_start_ts" id="chat_client_start_ts" />
                        <!-- Target diagram selector (only relevant on Initial Blueprint tab) -->
                        <div class="input-group input-group-sm mb-2" id="chat_target_row" style="display:none">
                            <span class="input-group-text">Target</span>
                            <select class="form-select" id="chat_diagram_target" name="chat_diagram_target">
                                <option value="architecture_diagram">Architecture</option>
                                <option value="system_interaction_diagram">System Interaction</option>
                                <option value="data_model_diagram">Data Model</option>
                                <option value="service_decomposition_diagram">Service Decomposition</option>
                            </select>
                        </div>
                        <div class="input-group input-group-sm mb-2">
                            <input type="text" id="chat_message_input" class="form-control" placeholder="Message..."/>
                            <input type="hidden" id="chat_message_named" name="chat_message_0" />
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <span id="chat_spinner" class="spinner-border spinner-border-sm text-danger d-none" role="status" aria-hidden="true"></span>
                            <span id="chat_status" class="text-muted small d-none"></span>
                <button type="submit" class="btn btn-sm btn-outline-danger chat-action" name="action" value="chat_send" title="Ask the agent; updates apply only to fields allowed for this tab.">Send</button>
                            <button type="submit" class="btn btn-sm btn-danger chat-action" id="chat_apply_btn" name="action" value="chat_apply" title="Apply structured updates from the last agent response to this tab's fields">Apply</button>
                            <a href="#" id="view_changes_link" class="ms-1 small text-decoration-underline" style="display:none" data-bs-toggle="modal" data-bs-target="#pendingUpdatesModal">View Changes</a>
                            <!-- Modal for previewing pending chat updates -->
                            <div class="modal fade" id="pendingUpdatesModal" tabindex="-1" aria-labelledby="pendingUpdatesModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="pendingUpdatesModalLabel">Pending Changes</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div id="pendingUpdatesPreview" class="small"></div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
<script>
    // Initialize Mermaid safely once per page
    function initMermaid(){
        try {
            if (window.mermaid && !window.__mermaidInitialized) {
                // Theme is delegated to Mermaid defaults; startOnLoad is false as we render manually
                if (typeof mermaid.initialize === 'function') {
                    mermaid.initialize({ startOnLoad: false });
                }
                window.__mermaidInitialized = true;
            }
        } catch(e) { /* no-op */ }
    }
    async function renderMermaidRaw(raw, out){
        if (!out) return;
        if (!window.mermaid){
            // mermaid will be initialized by initMermaid()
        }
        const fenceMatch = raw.match(/```\s*mermaid\s*\n([\s\S]*?)```/i) || raw.match(/```\s*\n([\s\S]*?)```/i);
        if (fenceMatch && fenceMatch[1]) raw = fenceMatch[1].trim();
        // Determine first meaningful token (skip blanks and Mermaid comments starting with %%)
        const lines = raw.split(/\r?\n/).map(l => l.trim()).filter(l => l !== '' && !l.startsWith('%%'));
        const firstLine = lines[0] || '';
        const firstToken = (firstLine.split(/\s+/)[0] || '').toLowerCase();
        const allowed = new Set(['graph','flowchart','sequencediagram','classdiagram','erdiagram','statediagram','statediagram-v2','gantt','pie','journey','mindmap','timeline','gitgraph']);
        if (!allowed.has(firstToken)){
            out.innerHTML = '<div class="text-secondary">Enter Mermaid graph (e.g., <code>graph TD; A-->B;</code>) and click Preview.</div>';
            return;
        }
        initMermaid();
        // Nudge mermaid font size for readability in previews
        try {
            var style = document.createElement('style');
            style.innerHTML = '.mermaid svg { font-size: 12px; } .mermaid .label foreignObject { font-size: 12px; }';
            document.head.appendChild(style);
        } catch(e) {}
        out.innerHTML = '<div class="text-secondary">Rendering…</div>';
        const id = 'mmd-' + Date.now();
        try {
            if (typeof mermaid.render === 'function'){
                const res = await mermaid.render(id, raw);
                out.innerHTML = res.svg || '';
                if (res.bindFunctions) { try { res.bindFunctions(out); } catch(e){} }
            } else if (typeof mermaid.init === 'function'){
                // Fallback path for older versions
                out.innerHTML = '<div class="mermaid">'+raw.replace(/</g,'&lt;')+'</div>';
                mermaid.init(undefined, out.querySelectorAll('.mermaid'));
            } else {
                out.innerHTML = '<div class="text-danger">Mermaid API not available.</div>';
            }
        } catch (e) {
            out.innerHTML = '<div style="color:#b71c1c">Mermaid error: '+(e && e.message ? e.message : e)+'</div>';
        }
    }
    async function preview(){
        const ta = document.querySelector('textarea[name=architecture_diagram]');
        const out = document.getElementById('mermaidPreview');
        if (!ta || !out){ return; }
        await renderMermaidRaw(ta.value, out);
    }
    async function previewBySelector(textareaName, outputId){
        const ta = document.querySelector('textarea[name="'+textareaName+'"]');
        const out = document.getElementById(outputId);
        if (!ta || !out) return;
        await renderMermaidRaw(ta.value, out);
    }
    window.triggerMermaidPreview = function(){ return previewBySelector('architecture_diagram','mermaidPreview'); };
    window.addEventListener('DOMContentLoaded', function(){
        const btn = document.getElementById('previewMermaidBtn');
        if (btn) btn.addEventListener('click', function(){ previewBySelector('architecture_diagram','mermaidPreview'); });
        const btnSys = document.getElementById('previewSystemBtn');
        if (btnSys) btnSys.addEventListener('click', function(){ previewBySelector('system_interaction_diagram','mermaidPreviewSystem'); });
        const btnData = document.getElementById('previewDataModelBtn');
        if (btnData) btnData.addEventListener('click', function(){ previewBySelector('data_model_diagram','mermaidPreviewData'); });
    const btnSvc = document.getElementById('previewServiceDecompBtn');
    if (btnSvc) btnSvc.addEventListener('click', function(){ previewBySelector('service_decomposition_diagram','mermaidPreviewServiceDecomp'); });
        const btnData2 = document.getElementById('previewDataModelBtn2');
        if (btnData2) btnData2.addEventListener('click', function(){ previewBySelector('data_model_diagram','mermaidPreviewData2'); });
        const btnSvc2 = document.getElementById('previewServiceDecompBtn2');
        if (btnSvc2) btnSvc2.addEventListener('click', function(){ previewBySelector('service_decomposition_diagram','mermaidPreviewServiceDecomp2'); });
        // keep hidden active_tab input synced
        const input = document.getElementById('active_tab_input');
        const chatInput = document.getElementById('chat_active_tab_input');
        const chatMsg = document.getElementById('chat_message_input');
        const chatNamed = document.getElementById('chat_message_named');
        const chatLabel = document.getElementById('chat_tab_label');
        function tabName(idx){
            const names = {
                0: 'Context & Requirements',
                1: 'Initial Blueprint',
                2: 'System Interaction',
                5: 'Database Solution Design',
                6: 'Service Solution Design',
                3: 'Decisions, Integration & Pros/Cons',
                4: 'Documentation & Review'
            };
            return names[idx] || 'Tab';
        }
    function updateChatUI(idx){
            document.querySelectorAll('.chat-history').forEach(el => {
                el.classList.toggle('active', String(el.getAttribute('data-tab')) === String(idx));
            });
            if (chatInput) chatInput.value = idx;
            if (chatNamed) chatNamed.setAttribute('name', 'chat_message_' + idx);
            if (chatLabel) chatLabel.textContent = (idx+1);
            const scope = document.getElementById('chat_scope_label');
            if (scope) scope.textContent = tabName(idx);
            // Enable/disable Apply based on pending flags from server
            try {
                const pf = document.getElementById('pending_flags');
                const applyBtn = document.getElementById('chat_apply_btn');
                const viewLink = document.getElementById('view_changes_link');
                const v = pf ? (pf.dataset['t' + String(idx)] || '0') : '0';
                if (applyBtn) applyBtn.disabled = (v !== '1');
                if (viewLink) viewLink.style.display = (v === '1') ? '' : 'none';
            } catch(e) {}
            // Show target selector only on Initial Blueprint (tab index 1)
            try {
                const row = document.getElementById('chat_target_row');
                const sel = document.getElementById('chat_diagram_target');
                if (row) {
                    row.style.display = (idx === 1) ? '' : 'none';
                    if (idx === 1 && sel) {
                        // Initialize selection from server-provided default
                        const serverDefault = '{{ chat_target_tab1|default("architecture_diagram") }}';
                        if (serverDefault && !sel.dataset.init) {
                            sel.value = serverDefault;
                            sel.dataset.init = '1';
                        }
                    }
                }
            } catch(e) {}
        }
        // Hook View Changes modal click once DOM is ready
        const viewLink = document.getElementById('view_changes_link');
        if (viewLink) {
            viewLink.addEventListener('click', function(ev){
                ev.preventDefault();
                let idx = 0;
                try { idx = Number(document.getElementById('active_tab_input').value) || 0; } catch(e){}
                let updates = null;
                try {
                    const el = document.getElementById('pending_updates_json');
                    if (el && el.dataset) {
                        const raw = el.dataset['tab' + idx] || '';
                        if (raw) updates = JSON.parse(raw);
                    }
                } catch(e){}
                const out = document.getElementById('pendingUpdatesPreview');
                if (!out) return;
                if (!updates || (!updates.set && !updates.append)) {
                    out.textContent = 'No pending updates.';
                    return;
                }
                let html = '';
                if (updates.set) {
                    html += '<b>Set:</b><ul>';
                    for (const k in updates.set) {
                        html += `<li><b>${k}</b>: ${updates.set[k]}</li>`;
                    }
                    html += '</ul>';
                }
                if (updates.append) {
                    html += '<b>Append:</b><ul>';
                    for (const k in updates.append) {
                        html += `<li><b>${k}</b>: ${updates.append[k]}</li>`;
                    }
                    html += '</ul>';
                }
                out.innerHTML = html;
            });
        }
        window.showTab = function(idx){
            var tabs = document.querySelectorAll('.nav-tabs .nav-link');
            var panes = document.querySelectorAll('.tab-pane');
            tabs.forEach((t) => t.classList.toggle('active', String(t.dataset.index) === String(idx)));
            panes.forEach((p) => p.classList.toggle('active', String(p.dataset.index) === String(idx)));
            if (input) input.value = idx;
            updateChatUI(idx);
            if ((idx === 1 || idx === 2 || idx === 5 || idx === 6) && typeof window.triggerMermaidPreview === 'function') {
                setTimeout(function(){
                    previewBySelector('architecture_diagram','mermaidPreview');
                    previewBySelector('system_interaction_diagram','mermaidPreviewSystem');
                    previewBySelector('data_model_diagram','mermaidPreviewData2');
                    previewBySelector('service_decomposition_diagram','mermaidPreviewServiceDecomp2');
                }, 0);
            }
        }
        // initialize chat UI based on initial tab
        const initialTab = Number('{{ active_tab|default(0) }}') || 0;
        updateChatUI(initialTab);
        // Ensure correct tab is visible on first paint
        if (typeof window.showTab === 'function') {
            window.showTab(initialTab);
        }
        // prepare chat submit
        window.prepareChatSubmit = function(form){
            if (chatNamed && chatMsg){ chatNamed.value = chatMsg.value || ''; }
            // Ensure an action is always posted (Enter in the input should default to Send)
            try {
                const hiddenAct = document.getElementById('chat_action_input');
                if (hiddenAct && !hiddenAct.value) hiddenAct.value = 'chat_send';
            } catch(e) {}
            // set client start time, show spinner
            const ts = Date.now();
            const cts = document.getElementById('chat_client_start_ts');
            const spin = document.getElementById('chat_spinner');
            const stat = document.getElementById('chat_status');
            if (cts) cts.value = String(ts);
            if (spin) spin.classList.remove('d-none');
            if (stat) { stat.classList.add('d-none'); stat.textContent=''; }
            setAllActionButtons(true);
            return true;
        }

        // prepare main action submit
        window.prepareActionSubmit = function(form){
            const ts = Date.now();
            const cts = document.getElementById('client_start_ts');
            if (cts) cts.value = String(ts);
            const spin = document.getElementById('action_spinner');
            const stat = document.getElementById('action_status');
            if (spin) spin.classList.remove('d-none');
            if (stat) { stat.classList.add('d-none'); stat.textContent=''; }
            startActionTimer();
            setAllActionButtons(true);
            return true;
        }

        // Helper: robustly disable/enable all action and chat buttons (including those outside .action-bar or .sidebar-chat)
        function setAllActionButtons(disabled) {
            // All submit buttons in forms
            document.querySelectorAll('button[type="submit"]').forEach(btn => { btn.disabled = !!disabled; });
            // All action/chat buttons by class (for redundancy)
            document.querySelectorAll('button.action-btn, button.chat-action').forEach(btn => { btn.disabled = !!disabled; });
        }
        // Live timer for action spinner
        let actionTimerInterval = null;
        function startActionTimer() {
            const timer = document.getElementById('action_timer');
            if (!timer) return;
            timer.classList.remove('d-none');
            timer.textContent = '0.0s';
            let start = Date.now();
            actionTimerInterval = setInterval(() => {
                let elapsed = (Date.now() - start) / 1000;
                timer.textContent = elapsed.toFixed(1) + 's';
            }, 100);
        }
        function stopActionTimer() {
            const timer = document.getElementById('action_timer');
            if (timer) { timer.classList.add('d-none'); timer.textContent = ''; }
            if (actionTimerInterval) { clearInterval(actionTimerInterval); actionTimerInterval = null; }
        }
        // Hook main action bar and chat panel buttons to set timer, spinner, and disable all buttons
    function handleActionClick(ev, isChat) {
            const btn = ev.target.closest('button.action-btn,button.chat-action');
            if (!btn) return;
            // Set hidden action value for forms so server receives the right action
            if (isChat) {
                const hidden = document.getElementById('chat_action_input');
                if (hidden) hidden.value = btn.value || '';
            } else {
                const hidden = document.getElementById('action_input');
        if (hidden) hidden.value = btn.value || '';
        // Remove name attribute so an empty hidden action doesn't override button value in some browsers
        if (!hidden.value) hidden.removeAttribute('name');
            }
            const ts = Date.now();
            if (isChat) {
                const cts = document.getElementById('chat_client_start_ts');
                if (cts) cts.value = String(ts);
                const spin = document.getElementById('chat_spinner');
                const stat = document.getElementById('chat_status');
                if (spin) spin.classList.remove('d-none');
                if (stat) { stat.classList.add('d-none'); stat.textContent=''; }
            } else {
                const cts = document.getElementById('client_start_ts');
                if (cts) cts.value = String(ts);
                const spin = document.getElementById('action_spinner');
                const stat = document.getElementById('action_status');
                if (spin) spin.classList.remove('d-none');
                if (stat) { stat.classList.add('d-none'); stat.textContent=''; }
                startActionTimer();
            }
            // Do not disable buttons on click; disable on submit to avoid losing submitter
        }
        // Action bar
        const actionBar = document.querySelector('.action-bar');
        if (actionBar){
            actionBar.addEventListener('click', function(ev){ handleActionClick(ev, false); }, true);
        }
        // Chat panel
        const chatForm = document.querySelector('.sidebar-chat form');
        if (chatForm){
            chatForm.addEventListener('click', function(ev){ handleActionClick(ev, true); }, true);
        }

        // In case submission is triggered via keyboard (Enter), set hidden action to the default submitter button for each form
        const mainForm = document.querySelector('form[enctype="multipart/form-data"]');
        if (mainForm){
            mainForm.addEventListener('submit', function(ev){
                const hidden = document.getElementById('action_input');
                if (hidden){
                    // If no action set yet, pick it from the submitter button
                    if (!hidden.value && ev.submitter && ev.submitter.name === 'action'){
                        hidden.value = ev.submitter.value || '';
                    }
                    // Ensure hidden is posted as 'action'
                    hidden.setAttribute('name','action');
                }
            }, true);
        }
        if (chatForm){
            chatForm.addEventListener('submit', function(ev){
                const hidden = document.getElementById('chat_action_input');
                if (hidden && !hidden.value){
                    const defBtn = chatForm.querySelector('button.chat-action:not([disabled])');
                    if (defBtn) hidden.value = defBtn.value || '';
                }
            });
        }

        // On page render, show last timing if available, hide spinners/timers, and re-enable buttons
        try {
            const timingEl = document.getElementById('server_timing');
            const lastMs = Number(timingEl?.dataset.lastElapsed || 0);
            const lastAction = timingEl?.dataset.lastAction || '';
            if (lastMs > 0){
                const stat = document.getElementById('action_status');
                const cstat = document.getElementById('chat_status');
                if (stat){ stat.textContent = (lastAction ? (lastAction+': ') : '') + (lastMs/1000).toFixed(2) + 's'; stat.classList.remove('d-none'); }
                if (cstat && (lastAction==='chat_send' || lastAction==='chat_clear' || lastAction==='chat_apply')){ cstat.textContent = (lastMs/1000).toFixed(2) + 's'; cstat.classList.remove('d-none'); }
            }
        } catch(e){}
        document.getElementById('action_spinner')?.classList.add('d-none');
        document.getElementById('action_timer')?.classList.add('d-none');
        document.getElementById('chat_spinner')?.classList.add('d-none');
        stopActionTimer();
        setAllActionButtons(false);

        // Enhance textareas that contain JSON by rendering a beautified Key/Value view with a View/Edit toggle.
        (function enhanceJSONTextareas(){
            const EXCLUDE_NAMES = new Set([
                'architecture_diagram','system_interaction_diagram','data_model_diagram','service_decomposition_diagram'
            ]);
            const isChatHistory = (ta) => ta.classList.contains('chat-history');
            const tryParseJSON = (text) => {
                if (!text) return null;
                const trimmed = String(text).trim();
                // Quick gate to avoid slow parse on prose
                if (!(trimmed.startsWith('{') || trimmed.startsWith('['))) return null;
                try { return JSON.parse(trimmed); } catch(e){ return null; }
            };
            const escapeHtml = (s) => String(s)
                .replace(/&/g,'&amp;')
                .replace(/</g,'&lt;')
                .replace(/>/g,'&gt;')
                .replace(/"/g,'&quot;')
                .replace(/'/g,'&#39;');
            const renderKV = (val, depth=0) => {
                if (val === null) return `<span class="kv-primitive">null</span>`;
                const t = typeof val;
                if (t === 'string' || t === 'number' || t === 'boolean') {
                    return `<span class="kv-primitive">${escapeHtml(val)}</span>`;
                }
                if (Array.isArray(val)) {
                    if (val.length === 0) return `<span class="kv-empty">[empty array]</span>`;
                    const items = val.map((item, idx) => `<li><span class="kv-key">[${idx}]</span> ${renderKV(item, depth+1)}</li>`).join('');
                    return `<ul>${items}</ul>`;
                }
                if (t === 'object') {
                    const keys = Object.keys(val);
                    if (keys.length === 0) return `<span class="kv-empty">{empty object}</span>`;
                    const items = keys.map(k => `<li><span class="kv-key">${escapeHtml(k)}</span>: ${renderKV(val[k], depth+1)}</li>`).join('');
                    return `<ul>${items}</ul>`;
                }
                return `<span class="kv-primitive">${escapeHtml(String(val))}</span>`;
            };
            const makeToolbar = () => {
                const div = document.createElement('div');
                div.className = 'kv-toolbar';
                div.innerHTML = `
                    <div class="btn-group" role="group" aria-label="View/Edit">
                        <button type="button" class="btn btn-outline-secondary btn-sm kv-btn-view">View</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm kv-btn-edit">Edit</button>
                    </div>`;
                return div;
            };
            const applyViewer = (ta) => {
                if (!ta || ta.dataset.kvEnhanced === '1') return;
                if (EXCLUDE_NAMES.has(ta.name) || isChatHistory(ta)) return;
                const parsed = tryParseJSON(ta.value);
                if (!parsed || (typeof parsed !== 'object')) return;
                // Wrap with container
                const wrapper = document.createElement('div');
                wrapper.className = 'kv-wrapper';
                const toolbar = makeToolbar();
                const view = document.createElement('div');
                view.className = 'kv-view';
                view.innerHTML = renderKV(parsed);
                // Insert elements
                ta.parentNode.insertBefore(wrapper, ta);
                wrapper.appendChild(toolbar);
                wrapper.appendChild(view);
                wrapper.appendChild(ta);
                // Default to View mode
                ta.style.display = 'none';
                // Toggle handlers
                const btnView = toolbar.querySelector('.kv-btn-view');
                const btnEdit = toolbar.querySelector('.kv-btn-edit');
                const setMode = (mode) => {
                    if (mode === 'view') {
                        // Re-parse textarea value in case it changed elsewhere
                        const fresh = tryParseJSON(ta.value);
                        view.innerHTML = fresh ? renderKV(fresh) : '<span class="kv-empty">Not valid JSON</span>';
                        view.style.display = '';
                        ta.style.display = 'none';
                        btnView.classList.add('active');
                        btnEdit.classList.remove('active');
                    } else {
                        view.style.display = 'none';
                        ta.style.display = '';
                        btnEdit.classList.add('active');
                        btnView.classList.remove('active');
                    }
                };
                btnView.addEventListener('click', function(e){ e.preventDefault(); setMode('view'); });
                btnEdit.addEventListener('click', function(e){ e.preventDefault(); setMode('edit'); });
                // Start in view mode
                setMode('view');
                // Mark enhanced
                ta.dataset.kvEnhanced = '1';
                // If user edits raw and leaves, try to update viewer
                ta.addEventListener('blur', function(){ if (ta.style.display !== 'none') setMode('view'); });
            };
            // Apply to all textareas once on load
            document.querySelectorAll('textarea').forEach(applyViewer);
        })();

        // Click-to-zoom overlay for all diagram previews
        (function setupZoom(){
            const overlay = document.createElement('div');
            overlay.className = 'diagram-zoom-overlay';
            overlay.innerHTML = `
                <button type="button" class="btn btn-light diagram-zoom-close">Close</button>
                <div class="diagram-zoom-toolbar">
                    <button type="button" class="btn btn-outline-light" data-zoom="in">+</button>
                    <button type="button" class="btn btn-outline-light" data-zoom="out">-</button>
                    <button type="button" class="btn btn-outline-light" data-zoom="reset">100%</button>
                </div>
                <div class="diagram-zoom-stage"><div class="diagram-zoom-canvas"></div></div>`;
            document.body.appendChild(overlay);
            const stage = overlay.querySelector('.diagram-zoom-stage');
            const canvas = overlay.querySelector('.diagram-zoom-canvas');
            let zoom = 1.0;
            function applyZoom(){ canvas.style.transform = `scale(${zoom})`; }
            function openWith(svgHtml){
                canvas.innerHTML = svgHtml || '<div class="text-light">No diagram</div>';
                zoom = 1.0; applyZoom();
                overlay.style.display = 'block';
                // center content
                setTimeout(()=>{ stage.scrollTop = 0; stage.scrollLeft = 0; }, 0);
            }
            function close(){ overlay.style.display = 'none'; }
            overlay.querySelector('.diagram-zoom-close')?.addEventListener('click', close);
            overlay.addEventListener('click', function(ev){
                if (ev.target === overlay) close();
            });
            overlay.querySelector('[data-zoom="in"]').addEventListener('click', ()=>{ zoom = Math.min(zoom*1.25, 10); applyZoom(); });
            overlay.querySelector('[data-zoom="out"]').addEventListener('click', ()=>{ zoom = Math.max(zoom/1.25, 0.1); applyZoom(); });
            overlay.querySelector('[data-zoom="reset"]').addEventListener('click', ()=>{ zoom = 1.0; applyZoom(); });
            // Wheel zoom when overlay focused
            stage.addEventListener('wheel', function(ev){
                if (!ev.ctrlKey && !ev.altKey) return; // require modifier to avoid hijacking scroll
                ev.preventDefault();
                const delta = ev.deltaY || ev.wheelDelta;
                zoom = delta > 0 ? Math.max(zoom/1.1, 0.1) : Math.min(zoom*1.1, 10);
                applyZoom();
            }, { passive:false });
            function attach(id){
                const box = document.getElementById(id);
                if (!box) return;
                box.style.cursor = 'zoom-in';
                box.addEventListener('click', function(){
                    const svg = box.innerHTML.trim();
                    if (svg) openWith(svg);
                });
            }
            attach('mermaidPreview');
            attach('mermaidPreviewSystem');
            attach('mermaidPreviewData');
            attach('mermaidPreviewData2');
            attach('mermaidPreviewServiceDecomp');
            attach('mermaidPreviewServiceDecomp2');
        })();

        // Copy/Download for Context Markdown
        (function setupContextActions(){
            const ta = document.querySelector('textarea[name="architecture_context"]');
            const copyBtn = document.getElementById('copyContextBtn');
            const dlBtn = document.getElementById('downloadContextBtn');
            const status = document.getElementById('contextCopyStatus');
            if (copyBtn && ta) {
                copyBtn.addEventListener('click', async function(){
                    try {
                        await navigator.clipboard.writeText(ta.value || '');
                        if (status) { status.style.display = ''; status.textContent = 'Copied'; setTimeout(()=>{ status.style.display='none'; }, 1500); }
                    } catch(e) {
                        // Fallback: select and execCommand
                        try { ta.select(); document.execCommand('copy'); if (status) { status.style.display = ''; status.textContent = 'Copied'; setTimeout(()=>{ status.style.display='none'; }, 1500); } } catch(_) {}
                    }
                });
            }
            if (dlBtn && ta) {
                dlBtn.addEventListener('click', function(){
                    const blob = new Blob([ta.value || ''], { type: 'text/markdown;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = (document.title || 'context') + '_Context.md';
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
                });
            }
        })();
    });
    </script>
    <!-- Bootstrap JS (for modal, dropdowns, etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Overlay root created dynamically by script -->
    </body>
</html>
